<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HU Jama'aa - My Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a4d2e;
            --secondary-color: #4f6f52;
            --accent-color: #f5efe6;
            --light-color: #e8dfca;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --danger-zone: #8B0000;
            --border-radius: 12px;
            --box-padding: 16px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            font-size: 14px;
            color: #333;
            padding-bottom: 70px; /* Space for bottom navigation */
        }

        .container {
            width: 100%;
            max-width: 100%;
            padding: 0;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: var(--box-padding);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-icon:hover {
            opacity: 0.8;
        }

        /* Main Content Area */
        .main-content {
            padding: var(--box-padding);
            padding-bottom: 20px;
        }

        /* Card Styles */
        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: var(--box-padding);
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .card-title {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title i {
            font-size: 1rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 77, 46, 0.2);
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-block {
            width: 100%;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: #133d25;
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: rgba(26, 77, 46, 0.1);
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: black;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: black;
        }

        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .badge-info {
            background-color: var(--info-color);
            color: white;
        }

        .badge-google {
            background-color: #4285F4;
            color: white;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 8px;
            background-color: var(--light-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        /* Profile Section */
        .profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--light-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            border: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .profile-info {
            text-align: center;
            width: 100%;
        }

        .profile-info h2 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 1.5rem;
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            background-color: var(--light-color);
            padding: 12px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .detail-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: 500;
        }

        /* Courses List */
        .courses-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .course-item {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 12px;
            transition: var(--transition);
        }

        .course-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .course-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* Classmates List */
        .classmates-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .classmate-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 10px;
            border-radius: var(--border-radius);
            background-color: var(--light-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .classmate-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .classmate-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .classmate-name {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .classmate-department {
            font-size: 0.7rem;
            color: var(--secondary-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 500;
            color: var(--secondary-color);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab:hover:not(.active) {
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger-color);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 15px;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Confirmation Modal */
        .confirmation-modal .modal-body {
            text-align: center;
            padding: 20px;
        }

        .confirmation-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        /* Danger Zone */
        .danger-zone {
            border: 1px solid var(--danger-zone);
            border-radius: var(--border-radius);
            padding: var(--box-padding);
            margin-top: 20px;
            background-color: rgba(139, 0, 0, 0.05);
        }

        .danger-zone-title {
            color: var(--danger-zone);
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .danger-zone-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        /* Edit Form */
        .edit-form {
            display: grid;
            gap: 15px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: var(--warning-color);
            color: black;
        }

        .status-approved {
            background-color: var(--success-color);
            color: white;
        }

        /* First Time Setup */
        .setup-modal .modal-content {
            max-width: 600px;
        }

        .setup-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ddd;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin: 0 10px;
            position: relative;
        }

        .step.active {
            background-color: var(--primary-color);
            color: white;
        }

        .step.completed {
            background-color: var(--success-color);
            color: white;
        }

        .step:not(:last-child):after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 20px;
            height: 2px;
            background-color: #ddd;
        }

        .step.completed:after {
            background-color: var(--success-color);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--secondary-color);
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        /* Classmate Courses Modal */
        .classmate-courses {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
                margin: 0 auto;
            }
            
            .profile-section {
                flex-direction: row;
                align-items: flex-start;
                text-align: left;
            }
            
            .profile-avatar {
                margin-right: 20px;
                margin-bottom: 0;
            }
            
            .profile-info {
                text-align: left;
                flex: 1;
            }
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }
        .mb-3 {
            margin-bottom: 15px;
        }
        .mt-3 {
            margin-top: 15px;
        }
        .d-none {
            display: none;
        }
        .d-flex {
            display: flex;
        }
        .justify-between {
            justify-content: space-between;
        }
        .align-center {
            align-items: center;
        }
        .gap-2 {
            gap: 8px;
        }
        .w-100 {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>My Profile</h1>
            <div class="header-actions">
                <button class="btn-icon" id="notifications-btn">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="btn-icon" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Profile Section -->
            <div class="card">
                <div class="profile-section">
                    <div class="profile-avatar" id="profile-avatar">
                        <div id="avatar-initials">JD</div>
                        <div class="profile-avatar-edit" id="edit-avatar-btn">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h2 id="profile-name">John Doe</h2>
                        <p id="profile-id">HU1234/21</p>
                        <div class="d-flex justify-between align-center mt-3">
                            <button class="btn btn-primary" id="edit-profile-btn">
                                <i class="fas fa-edit"></i> Edit Profile
                            </button>
                            <span id="google-badge" class="badge badge-google d-none">
                                <i class="fab fa-google"></i> Google Account
                            </span>
                        </div>
                    </div>
                </div>

                <div class="profile-details">
                    <div class="detail-item">
                        <div class="detail-label">Email</div>
                        <div class="detail-value" id="profile-email">john.doe@haramaya.edu.et</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Department</div>
                        <div class="detail-value" id="profile-department">Computer Science</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Year</div>
                        <div class="detail-value" id="profile-year">3rd Year</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Phone</div>
                        <div class="detail-value" id="profile-phone">+251 912 345 678</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Gender</div>
                        <div class="detail-value" id="profile-gender">Male</div>
                    </div>
                </div>
            </div>

            <!-- Tabs Section -->
            <div class="card">
                <div class="tabs">
                    <div class="tab active" data-tab="courses">My Courses</div>
                    <div class="tab" data-tab="classmates">Classmates</div>
                    <div class="tab" data-tab="security">Security</div>
                </div>

                <!-- Courses Tab -->
                <div class="tab-content active" id="courses-tab">
                    <h3 class="card-title">Enrolled Courses <span class="badge badge-primary" id="enrolled-count">0</span></h3>
                    <div class="courses-list" id="enrolled-courses">
                        <!-- Courses will be loaded here -->
                        <div class="text-center" id="no-courses-message">
                            <p>You are not enrolled in any courses yet.</p>
                            <button class="btn btn-primary mt-2" id="browse-courses-btn">
                                <i class="fas fa-search"></i> Browse Courses
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Classmates Tab -->
                <div class="tab-content" id="classmates-tab">
                    <div class="form-group">
                        <select id="classmates-filter" class="form-control">
                            <option value="all">All Classmates</option>
                            <option value="current">Current Courses</option>
                            <option value="department">Same Department</option>
                            <option value="year">Same Year</option>
                        </select>
                    </div>
                    <div class="classmates-list" id="classmates-list">
                        <!-- Classmates will be loaded here -->
                    </div>
                </div>

                <!-- Security Tab -->
                <div class="tab-content" id="security-tab">
                    <div class="form-group">
                        <button class="btn btn-outline w-100" id="change-password-btn">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-outline w-100" id="logout-btn-2">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>

                    <!-- Danger Zone -->
                    <div class="danger-zone">
                        <h3 class="danger-zone-title">
                            <i class="fas fa-exclamation-triangle"></i> Danger Zone
                        </h3>
                        <p class="danger-zone-description">
                            These actions are irreversible. Please proceed with caution.
                        </p>
                        <div class="form-group">
                            <button class="btn btn-danger w-100" id="disconnect-google-btn">
                                <i class="fab fa-google"></i> Disconnect Google Account
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger w-100" id="delete-account-btn">
                                <i class="fas fa-trash-alt"></i> Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="dashboard.htm" class="nav-item">
            <i class="fas fa-book"></i>
            <span>Courses</span>
        </a>
        <a href="progress.html" class="nav-item">
            <i class="fas fa-chart-line"></i>
            <span>Progress</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Edit Profile Modal -->
    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="modal-close" id="close-edit-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profile-form" class="edit-form">
                    <div class="form-group">
                        <label for="edit-name">Full Name</label>
                        <input type="text" id="edit-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-student-id">Student ID (XXXX/YY)</label>
                        <input type="text" id="edit-student-id" class="form-control" pattern="\d{4}/\d{2}" required>
                        <small class="text-muted">Format: 1234/21</small>
                    </div>
                    <div class="form-group">
                        <label for="edit-department">Department</label>
                        <input type="text" id="edit-department" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-year">Year</label>
                        <select id="edit-year" class="form-control" required>
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                            <option value="5th Year">5th Year</option>
                            <option value="Graduate">Graduate</option>
                            <option value="Staff">Staff</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-phone">Phone Number</label>
                        <input type="tel" id="edit-phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-gender">Gender</label>
                        <select id="edit-gender" class="form-control" required>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="change-password-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <button class="modal-close" id="close-password-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="password-form" class="edit-form">
                    <div class="form-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" class="form-control" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirm New Password</label>
                        <input type="password" id="confirm-password" class="form-control" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-key"></i> Update Password
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Classmate Courses Modal -->
    <div class="modal" id="classmate-courses-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="classmate-modal-title">Classmate's Courses</h3>
                <button class="modal-close" id="close-classmate-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="classmate-info mb-3">
                    <div class="d-flex align-center gap-2">
                        <div class="classmate-avatar" id="modal-classmate-avatar">
                            JD
                        </div>
                        <div>
                            <h4 id="modal-classmate-name">John Doe</h4>
                            <div id="modal-classmate-details">
                                <span class="badge badge-primary" id="modal-classmate-year">3rd Year</span>
                                <span class="badge badge-info" id="modal-classmate-department">Computer Science</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="classmate-courses" id="classmate-courses-list">
                    <!-- Classmate's courses will be loaded here -->
                    <p class="text-center">Loading courses...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="close-classmate-courses">Close</button>
            </div>
        </div>
    </div>

    <!-- Unenroll Confirmation Modal -->
    <div class="modal confirmation-modal" id="unenroll-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Request Unenrollment</h3>
                <button class="modal-close" id="close-unenroll-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h4 id="unenroll-message">Are you sure you want to request unenrollment from this course?</h4>
                <p>Your request will be pending for 2 days before processing.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-unenroll">Cancel</button>
                <button class="btn btn-primary" id="confirm-unenroll">Request Unenrollment</button>
            </div>
        </div>
    </div>

    <!-- Unenroll Request Pending Modal -->
    <div class="modal confirmation-modal" id="unenroll-pending-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Unenrollment Pending</h3>
                <button class="modal-close" id="close-pending-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-icon">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <h4 id="pending-message">Your unenrollment request is pending</h4>
                <p>You can cancel this request within the next 2 days.</p>
                <div class="progress-container mt-3">
                    <div class="progress-label">
                        <span>Time remaining: <span id="time-remaining">48 hours</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="pending-progress" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="cancel-request-btn">
                    <i class="fas fa-times"></i> Cancel Request
                </button>
            </div>
        </div>
    </div>

    <!-- Request Submitted Modal -->
    <div class="modal confirmation-modal" id="request-submitted-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Request Submitted</h3>
                <button class="modal-close" id="close-request-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-icon">
                    <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                </div>
                <h4>Your unenrollment request has been submitted</h4>
                <p>You will be automatically unenrolled after 2 days.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="close-request-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Request Cancelled Modal -->
    <div class="modal confirmation-modal" id="request-cancelled-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Request Cancelled</h3>
                <button class="modal-close" id="close-cancelled-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-icon">
                    <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                </div>
                <h4>Your unenrollment request has been cancelled</h4>
                <p>You will remain enrolled in the course.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="close-cancelled-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Disconnect Google Confirmation Modal -->
    <div class="modal confirmation-modal" id="disconnect-google-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Disconnect Google Account</h3>
                <button class="modal-close" id="close-disconnect-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-icon">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger-zone);"></i>
                </div>
                <h4>Are you sure you want to disconnect your Google account?</h4>
                <p>This action will be processed after 3 days. You'll need to set up a password to log in.</p>
                <div class="form-group mt-3">
                    <label for="disconnect-password">Set New Password</label>
                    <input type="password" id="disconnect-password" class="form-control" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="disconnect-confirm">Confirm Password</label>
                    <input type="password" id="disconnect-confirm" class="form-control" required minlength="6">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-disconnect">Cancel</button>
                <button class="btn btn-danger" id="confirm-disconnect">Disconnect Account</button>
            </div>
        </div>
    </div>

    <!-- Disconnect Scheduled Modal -->
    <div class="modal confirmation-modal" id="disconnect-scheduled-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Disconnection Scheduled</h3>
                <button class="modal-close" id="close-scheduled-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-icon">
                    <i class="fas fa-clock" style="color: var(--warning-color);"></i>
                </div>
                <h4>Google account disconnection scheduled</h4>
                <p>Your Google account will be disconnected in 3 days. You'll be notified before this happens.</p>
                <div class="progress-container mt-3">
                    <div class="progress-label">
                        <span>Time remaining: <span id="disconnect-time-remaining">72 hours</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="disconnect-progress" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="cancel-disconnect-schedule">
                    <i class="fas fa-times"></i> Cancel Disconnection
                </button>
            </div>
        </div>
    </div>

    <!-- First Time Setup Modal -->
    <div class="modal setup-modal" id="setup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Complete Your Profile</h3>
            </div>
            <div class="modal-body">
                <div class="setup-steps">
                    <div class="step active" id="step1">1</div>
                    <div class="step" id="step2">2</div>
                    <div class="step" id="step3">3</div>
                </div>

                <div class="tab-content active" id="setup-tab1">
                    <h4 class="text-center mb-3">Welcome to HU Jama'aa!</h4>
                    <p class="text-center">Let's get your profile set up so you can start learning.</p>
                    <button class="btn btn-primary mt-3" id="setup-next1">Continue</button>
                </div>

                <div class="tab-content" id="setup-tab2">
                    <form id="setup-form" class="edit-form">
                        <div class="form-group">
                            <label for="setup-name">Full Name</label>
                            <input type="text" id="setup-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="setup-student-id">Student ID (XXXX/YY)</label>
                            <input type="text" id="setup-student-id" class="form-control" pattern="\d{4}/\d{2}" required>
                            <small class="text-muted">Format: 1234/21</small>
                        </div>
                        <div class="form-group">
                            <label for="setup-department">Department</label>
                            <input type="text" id="setup-department" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="setup-year">Year</label>
                            <select id="setup-year" class="form-control" required>
                                <option value="">Select Year</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                                <option value="3rd Year">3rd Year</option>
                                <option value="4th Year">4th Year</option>
                                <option value="5th Year">5th Year</option>
                                <option value="Graduate">Graduate</option>
                                <option value="Staff">Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="setup-phone">Phone Number</label>
                            <input type="tel" id="setup-phone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="setup-gender">Gender</label>
                            <select id="setup-gender" class="form-control" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="d-flex gap-2 mt-3">
                            <button type="button" class="btn btn-outline" id="setup-back2">Back</button>
                            <button type="submit" class="btn btn-primary" id="setup-next2">Save & Continue</button>
                        </div>
                    </form>
                </div>

                <div class="tab-content" id="setup-tab3">
                    <div class="confirmation-icon">
                        <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                    </div>
                    <h4 class="text-center mb-3">Profile Setup Complete!</h4>
                    <p class="text-center">You're now ready to explore HU Jama'aa and join courses.</p>
                    <button class="btn btn-primary mt-3" id="setup-complete">Get Started</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut,
            updatePassword,
            updateEmail,
            EmailAuthProvider,
            reauthenticateWithCredential,
            linkWithCredential,
            fetchSignInMethodsForEmail
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            arrayUnion,
            arrayRemove,
            query,
            where,
            getDocs,
            serverTimestamp,
            addDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo",
            authDomain: "pharma-quiz-b5a07.firebaseapp.com",
            projectId: "pharma-quiz-b5a07",
            storageBucket: "pharma-quiz-b5a07.appspot.com",
            messagingSenderId: "161067776789",
            appId: "1:161067776789:web:88b8a61145dc5f5c31471c",
            measurementId: "G-3QRQE9HQFB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM Elements
        const profileAvatar = document.getElementById('profile-avatar');
        const avatarInitials = document.getElementById('avatar-initials');
        const editAvatarBtn = document.getElementById('edit-avatar-btn');
        const profileName = document.getElementById('profile-name');
        const profileId = document.getElementById('profile-id');
        const profileEmail = document.getElementById('profile-email');
        const profileDepartment = document.getElementById('profile-department');
        const profileYear = document.getElementById('profile-year');
        const profilePhone = document.getElementById('profile-phone');
        const profileGender = document.getElementById('profile-gender');
        const googleBadge = document.getElementById('google-badge');
        const enrolledCoursesList = document.getElementById('enrolled-courses');
        const noCoursesMessage = document.getElementById('no-courses-message');
        const browseCoursesBtn = document.getElementById('browse-courses-btn');
        const enrolledCount = document.getElementById('enrolled-count');
        const classmatesList = document.getElementById('classmates-list');
        const classmatesFilter = document.getElementById('classmates-filter');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const editProfileModal = document.getElementById('edit-profile-modal');
        const closeEditModal = document.getElementById('close-edit-modal');
        const profileForm = document.getElementById('profile-form');
        const editName = document.getElementById('edit-name');
        const editStudentId = document.getElementById('edit-student-id');
        const editDepartment = document.getElementById('edit-department');
        const editYear = document.getElementById('edit-year');
        const editPhone = document.getElementById('edit-phone');
        const editGender = document.getElementById('edit-gender');
        const changePasswordBtn = document.getElementById('change-password-btn');
        const changePasswordModal = document.getElementById('change-password-modal');
        const closePasswordModal = document.getElementById('close-password-modal');
        const passwordForm = document.getElementById('password-form');
        const currentPassword = document.getElementById('current-password');
        const newPassword = document.getElementById('new-password');
        const confirmPassword = document.getElementById('confirm-password');
        const logoutBtn = document.getElementById('logout-btn');
        const logoutBtn2 = document.getElementById('logout-btn-2');
        const unenrollModal = document.getElementById('unenroll-modal');
        const closeUnenrollModal = document.getElementById('close-unenroll-modal');
        const cancelUnenroll = document.getElementById('cancel-unenroll');
        const confirmUnenroll = document.getElementById('confirm-unenroll');
        const unenrollMessage = document.getElementById('unenroll-message');
        const unenrollPendingModal = document.getElementById('unenroll-pending-modal');
        const closePendingModal = document.getElementById('close-pending-modal');
        const cancelRequestBtn = document.getElementById('cancel-request-btn');
        const timeRemaining = document.getElementById('time-remaining');
        const pendingProgress = document.getElementById('pending-progress');
        const requestSubmittedModal = document.getElementById('request-submitted-modal');
        const closeRequestModal = document.getElementById('close-request-modal');
        const closeRequestBtn = document.getElementById('close-request-btn');
        const requestCancelledModal = document.getElementById('request-cancelled-modal');
        const closeCancelledModal = document.getElementById('close-cancelled-modal');
        const closeCancelledBtn = document.getElementById('close-cancelled-btn');
        const disconnectGoogleBtn = document.getElementById('disconnect-google-btn');
        const disconnectGoogleModal = document.getElementById('disconnect-google-modal');
        const closeDisconnectModal = document.getElementById('close-disconnect-modal');
        const cancelDisconnect = document.getElementById('cancel-disconnect');
        const confirmDisconnect = document.getElementById('confirm-disconnect');
        const disconnectPassword = document.getElementById('disconnect-password');
        const disconnectConfirm = document.getElementById('disconnect-confirm');
        const disconnectScheduledModal = document.getElementById('disconnect-scheduled-modal');
        const closeScheduledModal = document.getElementById('close-scheduled-modal');
        const disconnectTimeRemaining = document.getElementById('disconnect-time-remaining');
        const disconnectProgress = document.getElementById('disconnect-progress');
        const cancelDisconnectSchedule = document.getElementById('cancel-disconnect-schedule');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const setupModal = document.getElementById('setup-modal');
        const setupNext1 = document.getElementById('setup-next1');
        const setupBack2 = document.getElementById('setup-back2');
        const setupNext2 = document.getElementById('setup-next2');
        const setupComplete = document.getElementById('setup-complete');
        const setupForm = document.getElementById('setup-form');
        const setupName = document.getElementById('setup-name');
        const setupStudentId = document.getElementById('setup-student-id');
        const setupDepartment = document.getElementById('setup-department');
        const setupYear = document.getElementById('setup-year');
        const setupPhone = document.getElementById('setup-phone');
        const setupGender = document.getElementById('setup-gender');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const setupTab1 = document.getElementById('setup-tab1');
        const setupTab2 = document.getElementById('setup-tab2');
        const setupTab3 = document.getElementById('setup-tab3');
        
        // Classmate modal elements
        const classmateCoursesModal = document.getElementById('classmate-courses-modal');
        const closeClassmateModal = document.getElementById('close-classmate-modal');
        const closeClassmateCourses = document.getElementById('close-classmate-courses');
        const modalClassmateName = document.getElementById('modal-classmate-name');
        const modalClassmateAvatar = document.getElementById('modal-classmate-avatar');
        const modalClassmateYear = document.getElementById('modal-classmate-year');
        const modalClassmateDepartment = document.getElementById('modal-classmate-department');
        const classmateCoursesList = document.getElementById('classmate-courses-list');
        
        // Tabs
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Current user data
        let currentUser = null;
        let userData = null;
        let enrolledCourses = [];
        let pendingUnenrollCourseId = null;
        let pendingUnenrollRequestId = null;
        let classmates = [];
        let isFirstTimeSetup = false;
        let unenrollInterval = null;
        let disconnectInterval = null;
        let currentClassmateId = null;

        // Initialize the application
        function initApp() {
            // Set up event listeners
            editProfileBtn.addEventListener('click', () => editProfileModal.classList.add('active'));
            closeEditModal.addEventListener('click', () => editProfileModal.classList.remove('active'));
            profileForm.addEventListener('submit', saveProfile);
            changePasswordBtn.addEventListener('click', () => changePasswordModal.classList.add('active'));
            closePasswordModal.addEventListener('click', () => changePasswordModal.classList.remove('active'));
            passwordForm.addEventListener('submit', changePassword);
            logoutBtn.addEventListener('click', handleLogout);
            logoutBtn2.addEventListener('click', handleLogout);
            cancelUnenroll.addEventListener('click', () => unenrollModal.classList.remove('active'));
            confirmUnenroll.addEventListener('click', submitUnenrollRequest);
            closeUnenrollModal.addEventListener('click', () => unenrollModal.classList.remove('active'));
            closeRequestBtn.addEventListener('click', () => requestSubmittedModal.classList.remove('active'));
            closeRequestModal.addEventListener('click', () => requestSubmittedModal.classList.remove('active'));
            cancelRequestBtn.addEventListener('click', cancelUnenrollRequest);
            closePendingModal.addEventListener('click', () => unenrollPendingModal.classList.remove('active'));
            closeCancelledBtn.addEventListener('click', () => requestCancelledModal.classList.remove('active'));
            closeCancelledModal.addEventListener('click', () => requestCancelledModal.classList.remove('active'));
            disconnectGoogleBtn.addEventListener('click', () => disconnectGoogleModal.classList.add('active'));
            closeDisconnectModal.addEventListener('click', () => disconnectGoogleModal.classList.remove('active'));
            cancelDisconnect.addEventListener('click', () => disconnectGoogleModal.classList.remove('active'));
            confirmDisconnect.addEventListener('click', scheduleGoogleDisconnect);
            closeScheduledModal.addEventListener('click', () => disconnectScheduledModal.classList.remove('active'));
            cancelDisconnectSchedule.addEventListener('click', cancelGoogleDisconnect);
            deleteAccountBtn.addEventListener('click', confirmDeleteAccount);
            browseCoursesBtn.addEventListener('click', () => window.location.href = 'courses.html');
            classmatesFilter.addEventListener('change', filterClassmates);
            editAvatarBtn.addEventListener('click', uploadAvatar);
            
            // Classmate modal events
            closeClassmateModal.addEventListener('click', () => classmateCoursesModal.classList.remove('active'));
            closeClassmateCourses.addEventListener('click', () => classmateCoursesModal.classList.remove('active'));
            
            // Setup modal events
            setupNext1.addEventListener('click', () => {
                setupTab1.classList.remove('active');
                setupTab2.classList.add('active');
                step1.classList.remove('active');
                step1.classList.add('completed');
                step2.classList.add('active');
            });
            
            setupBack2.addEventListener('click', () => {
                setupTab2.classList.remove('active');
                setupTab1.classList.add('active');
                step1.classList.add('active');
                step2.classList.remove('active');
                step1.classList.remove('completed');
            });
            
            setupNext2.addEventListener('click', (e) => {
                e.preventDefault();
                if (setupForm.checkValidity()) {
                    setupTab2.classList.remove('active');
                    setupTab3.classList.add('active');
                    step2.classList.remove('active');
                    step2.classList.add('completed');
                    step3.classList.add('active');
                } else {
                    setupForm.reportValidity();
                }
            });
            
            setupComplete.addEventListener('click', completeSetup);
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Check auth state
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData(user.uid);
                    
                    // Check if user needs to complete profile setup
                    if (!userData.studentId || !userData.department || !userData.year || !userData.phone || !userData.gender) {
                        isFirstTimeSetup = true;
                        setupModal.classList.add('active');
                    } else {
                        updateProfileUI();
                        displayEnrolledCourses();
                        loadClassmates();
                    }
                    
                    // Check if user is connected via Google
                    if (user.providerData.some(provider => provider.providerId === 'google.com')) {
                        googleBadge.classList.remove('d-none');
                    }
                } else {
                    // Redirect to login page if not authenticated
                    window.location.href = 'login.html';
                }
            });
        }

        // Switch between tabs
        function switchTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Load user data from Firestore
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    
                    // Initialize enrolledCourses if not exists
                    if (!userData.enrolledCourses) {
                        await updateDoc(doc(db, "users", userId), {
                            enrolledCourses: []
                        });
                        userData.enrolledCourses = [];
                    }
                    enrolledCourses = userData.enrolledCourses;
                    
                    // Check for pending unenrollment requests
                    await checkPendingUnenrollments(userId);
                    
                    // Check for pending Google disconnection
                    await checkPendingDisconnect(userId);
                    
                    // Load avatar if exists
                    if (userData.avatarUrl) {
                        profileAvatar.innerHTML = `<img src="${userData.avatarUrl}" alt="Profile Avatar">`;
                        avatarInitials.classList.add('d-none');
                    } else {
                        const displayName = userData?.name || currentUser.displayName || "User";
                        const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
                        avatarInitials.textContent = initials;
                        avatarInitials.classList.remove('d-none');
                    }
                } else {
                    // Create user document if not exists
                    const newUserData = {
                        name: currentUser.displayName || "User",
                        email: currentUser.email,
                        enrolledCourses: [],
                        studentId: "",
                        department: "",
                        year: "",
                        phone: "",
                        gender: "",
                        createdAt: serverTimestamp(),
                        isGoogleAccount: currentUser.providerData.some(provider => provider.providerId === 'google.com')
                    };
                    
                    await setDoc(doc(db, "users", userId), newUserData);
                    userData = newUserData;
                    enrolledCourses = [];
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                alert("Failed to load user data. Please try again.");
            }
        }

        // Check for pending unenrollment requests
        async function checkPendingUnenrollments(userId) {
            const q = query(
                collection(db, "unenrollmentRequests"),
                where("userId", "==", userId),
                where("status", "==", "pending")
            );
            
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const request = querySnapshot.docs[0].data();
                pendingUnenrollRequestId = querySnapshot.docs[0].id;
                
                // Find the course in enrolledCourses
                const courseIndex = enrolledCourses.findIndex(c => c.id === request.courseId);
                if (courseIndex !== -1) {
                    enrolledCourses[courseIndex].unenrollmentRequested = true;
                    enrolledCourses[courseIndex].requestTimestamp = request.requestedAt;
                    
                    // Show pending modal if request is still within 2 days
                    const requestTime = request.requestedAt.toDate();
                    const now = new Date();
                    const diffHours = (now - requestTime) / (1000 * 60 * 60);
                    
                    if (diffHours < 48) {
                        showPendingUnenrollModal(request.courseId, 48 - diffHours);
                    }
                }
            }
        }

        // Check for pending Google disconnection
        async function checkPendingDisconnect(userId) {
            const q = query(
                collection(db, "disconnectRequests"),
                where("userId", "==", userId),
                where("status", "==", "pending")
            );
            
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const request = querySnapshot.docs[0].data();
                
                // Show scheduled modal if request is still within 3 days
                const requestTime = request.requestedAt.toDate();
                const now = new Date();
                const diffHours = (now - requestTime) / (1000 * 60 * 60);
                
                if (diffHours < 72) {
                    showScheduledDisconnectModal(72 - diffHours, querySnapshot.docs[0].id);
                }
            }
        }

        // Update profile UI with user data
        function updateProfileUI() {
            const displayName = userData?.name || currentUser.displayName || "User";
            const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
            
            if (!userData.avatarUrl) {
                avatarInitials.textContent = initials;
                avatarInitials.classList.remove('d-none');
            }
            
            profileName.textContent = displayName;
            profileId.textContent = userData?.studentId || "No ID provided";
            profileEmail.textContent = currentUser.email;
            profileDepartment.textContent = userData?.department || "Not specified";
            profileYear.textContent = userData?.year || "Not specified";
            profilePhone.textContent = userData?.phone || "Not provided";
            profileGender.textContent = userData?.gender || "Not specified";

            // Fill edit form with current data
            if (editName) editName.value = displayName;
            if (editStudentId) editStudentId.value = userData?.studentId || "";
            if (editDepartment) editDepartment.value = userData?.department || "";
            if (editYear) editYear.value = userData?.year || "";
            if (editPhone) editPhone.value = userData?.phone || "";
            if (editGender) editGender.value = userData?.gender || "";
        }

        // Upload profile avatar
        async function uploadAvatar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // Create a reference to the storage location
                    const storageRef = ref(storage, `avatars/${currentUser.uid}`);
                    
                    // Upload the file
                    const snapshot = await uploadBytes(storageRef, file);
                    
                    // Get the download URL
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    
                    // Update user document with avatar URL
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        avatarUrl: downloadURL
                    });
                    
                    // Update local data
                    userData.avatarUrl = downloadURL;
                    
                    // Update UI
                    profileAvatar.innerHTML = `<img src="${downloadURL}" alt="Profile Avatar">`;
                    avatarInitials.classList.add('d-none');
                    
                    alert('Profile picture updated successfully!');
                } catch (error) {
                    console.error("Error uploading avatar:", error);
                    alert("Failed to upload profile picture. Please try again.");
                }
            };
            
            input.click();
        }

        // Save profile changes
        async function saveProfile(e) {
            e.preventDefault();
            
            try {
                const updates = {
                    name: editName.value,
                    studentId: editStudentId.value,
                    department: editDepartment.value,
                    year: editYear.value,
                    phone: editPhone.value,
                    gender: editGender.value,
                    lastUpdated: serverTimestamp()
                };
                
                // Update in Firestore
                await updateDoc(doc(db, "users", currentUser.uid), updates);
                
                // Update local data
                userData = { ...userData, ...updates };
                
                // Refresh UI
                updateProfileUI();
                
                // Close modal
                editProfileModal.classList.remove('active');
                
                // Show success message
                alert('Profile updated successfully!');
            } catch (error) {
                console.error("Error updating profile:", error);
                alert("Failed to update profile. Please try again.");
            }
        }

        // Change password
        async function changePassword(e) {
            e.preventDefault();
            
            if (newPassword.value !== confirmPassword.value) {
                alert("New passwords don't match!");
                return;
            }

            try {
                const user = auth.currentUser;
                const credential = EmailAuthProvider.credential(
                    user.email,
                    currentPassword.value
                );

                // Reauthenticate user
                await reauthenticateWithCredential(user, credential);
                
                // Update password
                await updatePassword(user, newPassword.value);
                
                // Clear form
                passwordForm.reset();
                
                // Close modal
                changePasswordModal.classList.remove('active');
                
                // Show success message
                alert("Password changed successfully!");
            } catch (error) {
                console.error("Error changing password:", error);
                alert("Failed to change password. Please check your current password and try again.");
            }
        }

        // Display enrolled courses
        function displayEnrolledCourses() {
            enrolledCoursesList.innerHTML = '';
            
            if (enrolledCourses.length === 0) {
                noCoursesMessage.classList.remove('d-none');
                enrolledCount.textContent = '0';
                return;
            }
            
            noCoursesMessage.classList.add('d-none');
            enrolledCount.textContent = enrolledCourses.length;

            enrolledCourses.forEach(course => {
                const courseItem = document.createElement('div');
                courseItem.className = 'course-item';
                
                // Check if unenrollment is pending
                const pendingRequest = course.unenrollmentRequested;
                
                courseItem.innerHTML = `
                    <div class="d-flex justify-between align-center">
                        <strong>${course.title}</strong>
                        ${pendingRequest ? '<span class="status-badge status-pending">Pending Unenroll</span>' : ''}
                    </div>
                    <div class="course-detail mt-1">
                        <strong>Instructor:</strong> ${course.instructor}
                    </div>
                    <div class="course-detail">
                        <strong>Schedule:</strong> ${course.schedule}
                    </div>
                    <div class="progress-container mt-2">
                        <div class="progress-label">
                            <span>Progress: ${course.progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${course.progress}%"></div>
                        </div>
                    </div>
                    <div class="course-actions mt-2">
                        <button class="btn btn-outline btn-sm" onclick="viewCourseProgress('${course.id}')">
                            <i class="fas fa-chart-line"></i> Progress
                        </button>
                        ${!pendingRequest ? `
                            <button class="btn btn-outline btn-sm" onclick="requestUnenroll('${course.id}')">
                                <i class="fas fa-sign-out-alt"></i> Unenroll
                            </button>
                        ` : `
                            <button class="btn btn-warning btn-sm" onclick="viewPendingRequest('${course.id}')">
                                <i class="fas fa-hourglass-half"></i> Pending
                            </button>
                        `}
                    </div>
                `;
                enrolledCoursesList.appendChild(courseItem);
            });
        }

        // Load classmates
        async function loadClassmates() {
            try {
                // First get all users in the same department
                const q = query(
                    collection(db, "users"),
                    where("department", "==", userData.department)
                );
                
                const querySnapshot = await getDocs(q);
                classmates = [];
                
                querySnapshot.forEach(doc => {
                    if (doc.id !== currentUser.uid) { // Exclude current user
                        const data = doc.data();
                        classmates.push({
                            id: doc.id,
                            name: data.name,
                            department: data.department,
                            year: data.year,
                            avatarUrl: data.avatarUrl,
                            email: data.email,
                            studentId: data.studentId
                        });
                    }
                });
                
                displayClassmates();
            } catch (error) {
                console.error("Error loading classmates:", error);
            }
        }

        // Display classmates
        function displayClassmates(filter = 'all') {
            classmatesList.innerHTML = '';
            
            let filteredClassmates = [...classmates];
            
            if (filter === 'department') {
                filteredClassmates = classmates.filter(mate => mate.department === userData.department);
            } else if (filter === 'year') {
                filteredClassmates = classmates.filter(mate => mate.year === userData.year);
            } else if (filter === 'current') {
                // Filter classmates who are in the same courses
                const courseIds = enrolledCourses.map(c => c.id);
                // This would need additional data structure to track who is in which courses
                // For now we'll just show all classmates
            }
            
            if (filteredClassmates.length === 0) {
                classmatesList.innerHTML = '<p>No classmates found matching your criteria.</p>';
                return;
            }
            
            filteredClassmates.forEach(mate => {
                const mateItem = document.createElement('div');
                mateItem.className = 'classmate-item';
                
                mateItem.innerHTML = `
                    <div class="classmate-avatar">
                        ${mate.avatarUrl ? 
                            `<img src="${mate.avatarUrl}" alt="${mate.name}">` : 
                            mate.name.split(' ').map(n => n[0]).join('').toUpperCase()
                        }
                    </div>
                    <div class="classmate-name">${mate.name}</div>
                    <div class="classmate-department">${mate.department}</div>
                    <div class="classmate-department">${mate.year}</div>
                `;
                
                mateItem.addEventListener('click', () => viewClassmateProfile(mate.id));
                classmatesList.appendChild(mateItem);
            });
        }

        // View classmate profile with their courses
        async function viewClassmateProfile(classmateId) {
            currentClassmateId = classmateId;
            
            try {
                // Get classmate data
                const classmateDoc = await getDoc(doc(db, "users", classmateId));
                if (!classmateDoc.exists()) {
                    alert("Classmate data not found");
                    return;
                }
                
                const classmateData = classmateDoc.data();
                
                // Update modal with classmate info
                modalClassmateName.textContent = classmateData.name;
                modalClassmateYear.textContent = classmateData.year || "Not specified";
                modalClassmateDepartment.textContent = classmateData.department || "Not specified";
                
                // Set avatar
                if (classmateData.avatarUrl) {
                    modalClassmateAvatar.innerHTML = `<img src="${classmateData.avatarUrl}" alt="${classmateData.name}">`;
                } else {
                    const initials = classmateData.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    modalClassmateAvatar.textContent = initials;
                }
                
                // Show loading state
                classmateCoursesList.innerHTML = '<p class="text-center">Loading courses...</p>';
                
                // Show modal
                classmateCoursesModal.classList.add('active');
                
                // Load classmate's enrolled courses
                const enrolledCourses = classmateData.enrolledCourses || [];
                
                if (enrolledCourses.length === 0) {
                    classmateCoursesList.innerHTML = '<p class="text-center">This classmate is not enrolled in any courses yet.</p>';
                    return;
                }
                
                // Display courses
                classmateCoursesList.innerHTML = '';
                enrolledCourses.forEach(course => {
                    const courseItem = document.createElement('div');
                    courseItem.className = 'course-item';
                    
                    courseItem.innerHTML = `
                        <div class="d-flex justify-between align-center">
                            <strong>${course.title}</strong>
                        </div>
                        <div class="course-detail mt-1">
                            <strong>Instructor:</strong> ${course.instructor}
                        </div>
                        <div class="course-detail">
                            <strong>Schedule:</strong> ${course.schedule}
                        </div>
                        <div class="progress-container mt-2">
                            <div class="progress-label">
                                <span>Progress: ${course.progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${course.progress}%"></div>
                            </div>
                        </div>
                    `;
                    classmateCoursesList.appendChild(courseItem);
                });
            } catch (error) {
                console.error("Error loading classmate profile:", error);
                alert("Failed to load classmate profile. Please try again.");
            }
        }

        // Filter classmates
        function filterClassmates() {
            const filterValue = classmatesFilter.value;
            displayClassmates(filterValue);
        }

        // Request to unenroll from a course
        function requestUnenroll(courseId) {
            pendingUnenrollCourseId = courseId;
            const course = enrolledCourses.find(c => c.id === courseId);
            if (!course) return;

            unenrollMessage.textContent = `Are you sure you want to request unenrollment from ${course.title}?`;
            unenrollModal.classList.add('active');
        }

        // View pending unenrollment request
        function viewPendingRequest(courseId) {
            const course = enrolledCourses.find(c => c.id === courseId);
            if (!course || !course.unenrollmentRequested) return;
            
            const requestTime = course.requestTimestamp.toDate();
            const now = new Date();
            const diffHours = (now - requestTime) / (1000 * 60 * 60);
            const remainingHours = 48 - diffHours;
            
            showPendingUnenrollModal(courseId, remainingHours);
        }

        // Show pending unenroll modal
        function showPendingUnenrollModal(courseId, remainingHours) {
            pendingUnenrollCourseId = courseId;
            
            // Update time remaining display
            updateUnenrollTimer(remainingHours);
            
            // Show modal
            unenrollPendingModal.classList.add('active');
            
            // Start countdown timer
            if (unenrollInterval) clearInterval(unenrollInterval);
            
            let hoursLeft = remainingHours;
            unenrollInterval = setInterval(() => {
                hoursLeft -= 0.1;
                if (hoursLeft <= 0) {
                    clearInterval(unenrollInterval);
                    unenrollPendingModal.classList.remove('active');
                    // The actual unenrollment would be handled by a backend process
                } else {
                    updateUnenrollTimer(hoursLeft);
                }
            }, 6 * 60 * 1000); // Update every 6 minutes
        }

        // Update unenroll timer display
        function updateUnenrollTimer(hoursLeft) {
            const hours = Math.floor(hoursLeft);
            const minutes = Math.floor((hoursLeft - hours) * 60);
            
            timeRemaining.textContent = `${hours} hours ${minutes} minutes`;
            pendingProgress.style.width = `${(hoursLeft / 48) * 100}%`;
        }

        // Submit unenrollment request
        async function submitUnenrollRequest() {
            if (!pendingUnenrollCourseId || !currentUser) return;

            try {
                const course = enrolledCourses.find(c => c.id === pendingUnenrollCourseId);
                if (!course) return;

                // Create unenrollment request in Firestore
                const requestRef = await addDoc(collection(db, "unenrollmentRequests"), {
                    userId: currentUser.uid,
                    courseId: pendingUnenrollCourseId,
                    courseTitle: course.title,
                    userName: userData.name,
                    userEmail: currentUser.email,
                    studentId: userData.studentId,
                    department: userData.department,
                    requestedAt: serverTimestamp(),
                    status: "pending",
                    processAt: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000) // 2 days from now
                });

                // Mark course as having pending unenrollment request
                const updatedCourses = enrolledCourses.map(c => {
                    if (c.id === pendingUnenrollCourseId) {
                        return { 
                            ...c, 
                            unenrollmentRequested: true,
                            requestId: requestRef.id,
                            requestTimestamp: serverTimestamp()
                        };
                    }
                    return c;
                });

                await updateDoc(doc(db, "users", currentUser.uid), {
                    enrolledCourses: updatedCourses
                });

                // Update local data
                enrolledCourses = updatedCourses;
                pendingUnenrollRequestId = requestRef.id;

                // Close modals and show success
                unenrollModal.classList.remove('active');
                requestSubmittedModal.classList.add('active');

                // Show pending modal
                showPendingUnenrollModal(pendingUnenrollCourseId, 48);
                
                // Refresh display
                displayEnrolledCourses();
            } catch (error) {
                console.error("Error submitting unenrollment request:", error);
                alert("Failed to submit unenrollment request. Please try again.");
            } finally {
                pendingUnenrollCourseId = null;
            }
        }

        // Cancel unenrollment request
        async function cancelUnenrollRequest() {
            if (!pendingUnenrollCourseId || !pendingUnenrollRequestId) return;
            
            try {
                // Delete the unenrollment request
                await deleteDoc(doc(db, "unenrollmentRequests", pendingUnenrollRequestId));
                
                // Update the course to remove pending status
                const updatedCourses = enrolledCourses.map(c => {
                    if (c.id === pendingUnenrollCourseId) {
                        const { unenrollmentRequested, requestId, requestTimestamp, ...rest } = c;
                        return rest;
                    }
                    return c;
                });
                
                await updateDoc(doc(db, "users", currentUser.uid), {
                    enrolledCourses: updatedCourses
                });
                
                // Update local data
                enrolledCourses = updatedCourses;
                
                // Close modals and show confirmation
                unenrollPendingModal.classList.remove('active');
                requestCancelledModal.classList.add('active');
                
                // Clear interval
                if (unenrollInterval) clearInterval(unenrollInterval);
                
                // Refresh display
                displayEnrolledCourses();
            } catch (error) {
                console.error("Error cancelling unenrollment request:", error);
                alert("Failed to cancel unenrollment request. Please try again.");
            } finally {
                pendingUnenrollCourseId = null;
                pendingUnenrollRequestId = null;
            }
        }

        // Schedule Google account disconnection
        async function scheduleGoogleDisconnect() {
            if (disconnectPassword.value !== disconnectConfirm.value) {
                alert("Passwords don't match!");
                return;
            }
            
            try {
                // Create disconnection request in Firestore
                const requestRef = await addDoc(collection(db, "disconnectRequests"), {
                    userId: currentUser.uid,
                    userName: userData.name,
                    userEmail: currentUser.email,
                    requestedAt: serverTimestamp(),
                    status: "pending",
                    processAt: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000), // 3 days from now
                    newPassword: disconnectPassword.value // Note: In production, you should never store passwords in plain text
                    // This is just for demonstration. In a real app, you would handle this differently
                });
                
                // Close modals and show scheduled modal
                disconnectGoogleModal.classList.remove('active');
                showScheduledDisconnectModal(72, requestRef.id);
                
                // Clear form
                disconnectPassword.value = '';
                disconnectConfirm.value = '';
            } catch (error) {
                console.error("Error scheduling Google disconnection:", error);
                alert("Failed to schedule Google account disconnection. Please try again.");
            }
        }

        // Show scheduled disconnect modal
        function showScheduledDisconnectModal(remainingHours, requestId) {
            // Update time remaining display
            updateDisconnectTimer(remainingHours);
            
            // Show modal
            disconnectScheduledModal.classList.add('active');
            
            // Start countdown timer
            if (disconnectInterval) clearInterval(disconnectInterval);
            
            let hoursLeft = remainingHours;
            disconnectInterval = setInterval(() => {
                hoursLeft -= 0.1;
                if (hoursLeft <= 0) {
                    clearInterval(disconnectInterval);
                    disconnectScheduledModal.classList.remove('active');
                    // The actual disconnection would be handled by a backend process
                } else {
                    updateDisconnectTimer(hoursLeft);
                }
            }, 6 * 60 * 1000); // Update every 6 minutes
        }

        // Update disconnect timer display
        function updateDisconnectTimer(hoursLeft) {
            const hours = Math.floor(hoursLeft);
            const minutes = Math.floor((hoursLeft - hours) * 60);
            
            disconnectTimeRemaining.textContent = `${hours} hours ${minutes} minutes`;
            disconnectProgress.style.width = `${(hoursLeft / 72) * 100}%`;
        }

        // Cancel Google account disconnection
        async function cancelGoogleDisconnect() {
            try {
                // Find the pending disconnection request
                const q = query(
                    collection(db, "disconnectRequests"),
                    where("userId", "==", currentUser.uid),
                    where("status", "==", "pending")
                );
                
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    // Delete the request
                    await deleteDoc(querySnapshot.docs[0].ref);
                }
                
                // Close modal
                disconnectScheduledModal.classList.remove('active');
                
                // Clear interval
                if (disconnectInterval) clearInterval(disconnectInterval);
                
                alert("Google account disconnection has been cancelled.");
            } catch (error) {
                console.error("Error cancelling Google disconnection:", error);
                alert("Failed to cancel Google account disconnection. Please try again.");
            }
        }

        // Confirm account deletion
        function confirmDeleteAccount() {
            if (confirm("Are you sure you want to delete your account? This action cannot be undone!")) {
                deleteAccount();
            }
        }

        // Delete user account
        async function deleteAccount() {
            try {
                // In a real app, you would need to:
                // 1. Reauthenticate the user
                // 2. Delete all user data from Firestore
                // 3. Delete the user from Firebase Auth
                
                alert("Account deletion would be processed here. This is just a demo.");
            } catch (error) {
                console.error("Error deleting account:", error);
                alert("Failed to delete account. Please try again.");
            }
        }

        // Complete first-time setup
        async function completeSetup() {
            try {
                const updates = {
                    name: setupName.value,
                    studentId: setupStudentId.value,
                    department: setupDepartment.value,
                    year: setupYear.value,
                    phone: setupPhone.value,
                    gender: setupGender.value,
                    lastUpdated: serverTimestamp(),
                    setupCompleted: true
                };
                
                // Update in Firestore
                await updateDoc(doc(db, "users", currentUser.uid), updates);
                
                // Update local data
                userData = { ...userData, ...updates };
                
                // Close setup modal
                setupModal.classList.remove('active');
                
                // Refresh UI
                updateProfileUI();
                displayEnrolledCourses();
                loadClassmates();
            } catch (error) {
                console.error("Error completing setup:", error);
                alert("Failed to complete setup. Please try again.");
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Failed to logout. Please try again.");
            }
        }

        // View course progress (would link to progress page)
        function viewCourseProgress(courseId) {
            // In a real app, this would redirect to the progress page
            alert(`Viewing progress for course ${courseId}`);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

        // Make functions available globally
        window.requestUnenroll = requestUnenroll;
        window.viewCourseProgress = viewCourseProgress;
        window.viewPendingRequest = viewPendingRequest;
    </script>
</body>
</html>
