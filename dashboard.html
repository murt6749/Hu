<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haramaya University Jama'aa - Course Registration</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a4d2e;
            --secondary-color: #4f6f52;
            --accent-color: #f5efe6;
            --light-color: #e8dfca;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }

        .sidebar {
            background-color: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: block;
            padding: 10px;
            color: var(--secondary-color);
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }

        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            background-color: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .section-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
        }

        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-color);
            border-radius: 5px;
            font-size: 1rem;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--light-color);
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .course-card {
            border: 1px solid var(--light-color);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .course-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
        }

        .course-header h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .course-body {
            padding: 15px;
        }

        .course-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .course-instructor {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .course-schedule {
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .course-schedule i {
            margin-right: 5px;
            color: var(--secondary-color);
        }

        .progress-container {
            margin-bottom: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 10px;
            background-color: var(--light-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 5px;
        }

        .course-actions {
            display: flex;
            gap: 10px;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light-color);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--secondary-color);
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .profile-section {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: var(--light-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            color: var(--primary-color);
        }

        .profile-info h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 5px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: 500;
        }

        .enrolled-courses {
            margin-top: 30px;
        }

        .course-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .course-table th, .course-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-color);
        }

        .course-table th {
            background-color: var(--primary-color);
            color: white;
        }

        .course-table tr:hover {
            background-color: rgba(79, 111, 82, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: black;
        }

        .classmates-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .classmate-card {
            text-align: center;
        }

        .classmate-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--light-color);
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }

        .classmate-name {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .classmate-progress {
            font-size: 0.8rem;
            color: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .profile-section {
                grid-template-columns: 1fr;
            }

            .profile-avatar {
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Haramaya University Jama'aa - Course Registration</h1>
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">JD</div>
                <span id="username">John Doe</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="sidebar">
                <ul class="sidebar-menu">
                    <li><a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="#"><i class="fas fa-book"></i> My Courses</a></li>
                    <li><a href="#"><i class="fas fa-calendar-alt"></i> Schedule</a></li>
                    <li><a href="#"><i class="fas fa-chart-line"></i> Progress</a></li>
                    <li><a href="#"><i class="fas fa-users"></i> Classmates</a></li>
                    <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
                    <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </div>

            <div class="main-content">
                <div class="tab-container">
                    <div class="tab active" onclick="switchTab('register')">Register for Courses</div>
                    <div class="tab" onclick="switchTab('profile')">My Profile</div>
                    <div class="tab" onclick="switchTab('progress')">My Progress</div>
                </div>

                <!-- Course Registration Tab -->
                <div id="register-tab" class="tab-content active">
                    <h2 class="section-title">Available Courses</h2>
                    
                    <div class="filter-container">
                        <div class="filter-group">
                            <label for="course-type">Course Type</label>
                            <select id="course-type">
                                <option value="all">All Types</option>
                                <option value="qirat">Qirat</option>
                                <option value="hifz">Hifz</option>
                                <option value="nezer">Nezer</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="language">Language</label>
                            <select id="language">
                                <option value="all">All Languages</option>
                                <option value="amharic">Amharic</option>
                                <option value="oromifa">Oromifa</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="level">Level</label>
                            <select id="level">
                                <option value="all">All Levels</option>
                                <option value="fresh">Fresh</option>
                                <option value="senior">Senior</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="gender">Gender</label>
                            <select id="gender">
                                <option value="all">All Genders</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>

                    <div class="courses-grid" id="courses-container">
                        <!-- Courses will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Profile Tab -->
                <div id="profile-tab" class="tab-content">
                    <div class="profile-section">
                        <div class="profile-avatar" id="profile-avatar">JD</div>
                        <div class="profile-info">
                            <h2 id="profile-name">John Doe</h2>
                            <div class="profile-details">
                                <div class="detail-item">
                                    <div class="detail-label">Student ID</div>
                                    <div class="detail-value" id="student-id">HU123456</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Email</div>
                                    <div class="detail-value" id="profile-email">john.doe@haramaya.edu.et</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Department</div>
                                    <div class="detail-value" id="department">Computer Science</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Year</div>
                                    <div class="detail-value" id="year">3rd Year</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="enrolled-courses">
                        <h2 class="section-title">My Enrolled Courses</h2>
                        <table class="course-table">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Type</th>
                                    <th>Instructor</th>
                                    <th>Schedule</th>
                                    <th>Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="enrolled-courses-table">
                                <!-- Enrolled courses will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Progress Tab -->
                <div id="progress-tab" class="tab-content">
                    <h2 class="section-title">My Course Progress</h2>
                    
                    <div id="course-progress-container">
                        <!-- Course progress will be dynamically inserted here -->
                    </div>

                    <div class="classmates-section" style="margin-top: 30px;">
                        <h3 class="section-title">Classmates in This Course</h3>
                        <div class="classmates-list" id="classmates-container">
                            <!-- Classmates will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            doc,
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo",
            authDomain: "pharma-quiz-b5a07.firebaseapp.com",
            projectId: "pharma-quiz-b5a07",
            storageBucket: "pharma-quiz-b5a07.appspot.com",
            messagingSenderId: "161067776789",
            appId: "1:161067776789:web:88b8a61145dc5f5c31471c",
            measurementId: "G-3QRQE9HQFB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const userAvatar = document.getElementById('user-avatar');
        const username = document.getElementById('username');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const studentId = document.getElementById('student-id');
        const profileEmail = document.getElementById('profile-email');
        const department = document.getElementById('department');
        const year = document.getElementById('year');
        const coursesContainer = document.getElementById('courses-container');
        const enrolledCoursesTable = document.getElementById('enrolled-courses-table');
        const courseProgressContainer = document.getElementById('course-progress-container');
        const classmatesContainer = document.getElementById('classmates-container');

        // Sample course data based on the provided document
        const coursesData = {
            qirat: [
                {
                    id: "q1",
                    title: "Sifetu Solah",
                    type: "qirat",
                    language: "amharic",
                    level: "all",
                    gender: "all",
                    instructor: "Ustaz Mekbul",
                    schedule: "Monday to Wednesday morning",
                    description: "Basic prayer learning course",
                    daysPerWeek: 3,
                    progressRate: 10
                },
                {
                    id: "q2",
                    title: "Usulu Selasah",
                    type: "qirat",
                    language: "amharic",
                    level: "all",
                    gender: "all",
                    instructor: "Ustaz Amir",
                    schedule: "Saturday and Sunday morning",
                    description: "Intermediate prayer learning course",
                    daysPerWeek: 2,
                    progressRate: 8
                },
                {
                    id: "q3",
                    title: "Tejwid Hidayetul Mustefid",
                    type: "qirat",
                    language: "amharic",
                    level: "all",
                    gender: "all",
                    instructor: "Ustaz Ahmed",
                    schedule: "Saturday and Sunday morning",
                    description: "Advanced tajweed course",
                    daysPerWeek: 2,
                    progressRate: 8
                },
                {
                    id: "q4",
                    title: "Tejwid Hidayetul Mustefid",
                    type: "qirat",
                    language: "oromifa",
                    level: "all",
                    gender: "all",
                    instructor: "Ustaz Oumer",
                    schedule: "Saturday and Sunday morning",
                    description: "Advanced tajweed course in Oromifa",
                    daysPerWeek: 2,
                    progressRate: 8
                },
                {
                    id: "q5",
                    title: "Riyadus Ualihin",
                    type: "qirat",
                    language: "oromifa",
                    level: "all",
                    gender: "all",
                    instructor: "Ustaz Abuki",
                    schedule: "Wednesday only",
                    description: "Spiritual development course",
                    daysPerWeek: 1,
                    progressRate: 5
                }
            ],
            hifz: [
                {
                    id: "h1",
                    title: "Hifz for Fresh Students (Female)",
                    type: "hifz",
                    language: "amharic",
                    level: "fresh",
                    gender: "female",
                    instructor: "Ustaz Aymen",
                    schedule: "Monday to Wednesday morning",
                    description: "Quran memorization for beginner female students",
                    daysPerWeek: 3,
                    progressRate: 10
                },
                {
                    id: "h2",
                    title: "Hifz for Fresh Students (Male)",
                    type: "hifz",
                    language: "amharic",
                    level: "fresh",
                    gender: "male",
                    instructor: "Ustaz Mekbul",
                    schedule: "Monday to Wednesday morning",
                    description: "Quran memorization for beginner male students",
                    daysPerWeek: 3,
                    progressRate: 10
                },
                {
                    id: "h3",
                    title: "Hifz for Senior Students (Female)",
                    type: "hifz",
                    language: "amharic",
                    level: "senior",
                    gender: "female",
                    instructor: "Ustaz Kamil",
                    schedule: "Monday to Friday morning",
                    description: "Advanced Quran memorization for female students",
                    daysPerWeek: 5,
                    progressRate: 15
                }
            ],
            nezer: [
                {
                    id: "n1",
                    title: "Nezer for Fresh Students (Female)",
                    type: "nezer",
                    language: "amharic",
                    level: "fresh",
                    gender: "female",
                    instructor: "Ustaz Hamza",
                    schedule: "Tuesday and Thursday afternoon",
                    description: "Quran recitation with tajweed for beginners",
                    daysPerWeek: 2,
                    progressRate: 8
                },
                {
                    id: "n2",
                    title: "Nezer for Fresh Students (Male)",
                    type: "nezer",
                    language: "oromifa",
                    level: "fresh",
                    gender: "male",
                    instructor: "Ustaz Fuad Aliyi",
                    schedule: "Tuesday and Thursday afternoon",
                    description: "Quran recitation with tajweed for beginners",
                    daysPerWeek: 2,
                    progressRate: 8
                },
                {
                    id: "n3",
                    title: "Nezer for Senior Students (Male)",
                    type: "nezer",
                    language: "amharic",
                    level: "senior",
                    gender: "male",
                    instructor: "Ustaz Marela",
                    schedule: "Monday, Wednesday, Friday",
                    description: "Advanced Quran recitation with tajweed",
                    daysPerWeek: 3,
                    progressRate: 10
                }
            ]
        };

        // Current user data
        let currentUser = null;
        let userData = null;
        let enrolledCourses = [];
        let selectedCourseForProgress = null;

        // Initialize the application
        function initApp() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData(user.uid);
                    updateUI();
                    displayAvailableCourses();
                    displayEnrolledCourses();
                } else {
                    // Redirect to login page if not authenticated
                    window.location.href = 'login.html';
                }
            });

            // Add event listeners for filters
            document.getElementById('course-type').addEventListener('change', displayAvailableCourses);
            document.getElementById('language').addEventListener('change', displayAvailableCourses);
            document.getElementById('level').addEventListener('change', displayAvailableCourses);
            document.getElementById('gender').addEventListener('change', displayAvailableCourses);
        }

        // Load user data from Firestore
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    // Initialize enrolledCourses if not exists
                    if (!userData.enrolledCourses) {
                        await setDoc(doc(db, "users", userId), {
                            enrolledCourses: []
                        }, { merge: true });
                        userData.enrolledCourses = [];
                    }
                    enrolledCourses = userData.enrolledCourses;
                } else {
                    // Create user document if not exists
                    await setDoc(doc(db, "users", userId), {
                        name: currentUser.displayName || "User",
                        email: currentUser.email,
                        enrolledCourses: []
                    });
                    userData = {
                        name: currentUser.displayName || "User",
                        email: currentUser.email,
                        enrolledCourses: []
                    };
                    enrolledCourses = [];
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        // Update UI with user data
        function updateUI() {
            const displayName = userData?.name || currentUser.displayName || "User";
            const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
            
            userAvatar.textContent = initials;
            username.textContent = displayName;
            profileAvatar.textContent = initials;
            profileName.textContent = displayName;
            profileEmail.textContent = currentUser.email;
            
            // Sample data - in a real app, this would come from user profile
            studentId.textContent = userData?.studentId || "HU" + Math.floor(100000 + Math.random() * 900000);
            department.textContent = userData?.department || "Not specified";
            year.textContent = userData?.year || "Not specified";
        }

        // Display available courses based on filters
        function displayAvailableCourses() {
            const courseType = document.getElementById('course-type').value;
            const language = document.getElementById('language').value;
            const level = document.getElementById('level').value;
            const gender = document.getElementById('gender').value;

            let filteredCourses = [];

            // Filter courses based on selections
            if (courseType === 'all') {
                filteredCourses = [...coursesData.qirat, ...coursesData.hifz, ...coursesData.nezer];
            } else {
                filteredCourses = [...coursesData[courseType]];
            }

            if (language !== 'all') {
                filteredCourses = filteredCourses.filter(course => course.language === language);
            }

            if (level !== 'all') {
                filteredCourses = filteredCourses.filter(course => course.level === level || course.level === 'all');
            }

            if (gender !== 'all') {
                filteredCourses = filteredCourses.filter(course => course.gender === gender || course.gender === 'all');
            }

            // Filter out already enrolled courses
            filteredCourses = filteredCourses.filter(course => 
                !enrolledCourses.some(ec => ec.id === course.id)
            );

            // Display courses
            coursesContainer.innerHTML = '';
            filteredCourses.forEach(course => {
                const courseCard = document.createElement('div');
                courseCard.className = 'course-card';
                courseCard.innerHTML = `
                    <div class="course-header">
                        <h3>${course.title}</h3>
                    </div>
                    <div class="course-body">
                        <div class="course-meta">
                            <span class="badge ${getBadgeClass(course.type)}">${course.type.toUpperCase()}</span>
                            <span>${course.language.toUpperCase()}</span>
                        </div>
                        <div class="course-instructor">
                            <strong>Instructor:</strong> ${course.instructor}
                        </div>
                        <div class="course-schedule">
                            <i class="far fa-calendar-alt"></i> ${course.schedule}
                        </div>
                        <p>${course.description}</p>
                        <div class="course-actions">
                            <button class="btn btn-primary" onclick="enrollInCourse('${course.id}')">Enroll</button>
                            <button class="btn btn-outline" onclick="viewCourseDetails('${course.id}')">Details</button>
                        </div>
                    </div>
                `;
                coursesContainer.appendChild(courseCard);
            });

            if (filteredCourses.length === 0) {
                coursesContainer.innerHTML = '<p>No courses available matching your filters.</p>';
            }
        }

        // Get badge class based on course type
        function getBadgeClass(type) {
            switch(type) {
                case 'qirat': return 'badge-primary';
                case 'hifz': return 'badge-success';
                case 'nezer': return 'badge-warning';
                default: return 'badge-primary';
            }
        }

        // Enroll in a course
        async function enrollInCourse(courseId) {
            if (!currentUser) return;

            // Find the course in our data
            let course = null;
            for (const type in coursesData) {
                course = coursesData[type].find(c => c.id === courseId);
                if (course) break;
            }

            if (!course) return;

            try {
                // Add course to user's enrolled courses
                await updateDoc(doc(db, "users", currentUser.uid), {
                    enrolledCourses: arrayUnion({
                        id: course.id,
                        title: course.title,
                        type: course.type,
                        instructor: course.instructor,
                        schedule: course.schedule,
                        progress: 0,
                        lastActive: new Date().toISOString(),
                        daysPerWeek: course.daysPerWeek,
                        progressRate: course.progressRate
                    })
                });

                // Update local data
                enrolledCourses.push({
                    id: course.id,
                    title: course.title,
                    type: course.type,
                    instructor: course.instructor,
                    schedule: course.schedule,
                    progress: 0,
                    lastActive: new Date().toISOString(),
                    daysPerWeek: course.daysPerWeek,
                    progressRate: course.progressRate
                });

                // Refresh displays
                displayAvailableCourses();
                displayEnrolledCourses();
                alert(`Successfully enrolled in ${course.title}`);
            } catch (error) {
                console.error("Error enrolling in course:", error);
                alert("Failed to enroll in course. Please try again.");
            }
        }

        // Display enrolled courses
        function displayEnrolledCourses() {
            enrolledCoursesTable.innerHTML = '';
            
            if (enrolledCourses.length === 0) {
                enrolledCoursesTable.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center;">You are not enrolled in any courses yet.</td>
                    </tr>
                `;
                return;
            }

            enrolledCourses.forEach(course => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${course.title}</td>
                    <td><span class="badge ${getBadgeClass(course.type)}">${course.type.toUpperCase()}</span></td>
                    <td>${course.instructor}</td>
                    <td>${course.schedule}</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>${course.progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${course.progress}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-outline" onclick="viewCourseProgress('${course.id}')">View Progress</button>
                        <button class="btn btn-outline" onclick="unenrollFromCourse('${course.id}')">Unenroll</button>
                    </td>
                `;
                enrolledCoursesTable.appendChild(row);
            });
        }

        // View course progress
        function viewCourseProgress(courseId) {
            const course = enrolledCourses.find(c => c.id === courseId);
            if (!course) return;

            selectedCourseForProgress = course;
            switchTab('progress');
            displayCourseProgress();
        }

        // Display course progress
        function displayCourseProgress() {
            if (!selectedCourseForProgress) return;

            courseProgressContainer.innerHTML = `
                <h3>${selectedCourseForProgress.title}</h3>
                <p><strong>Instructor:</strong> ${selectedCourseForProgress.instructor}</p>
                <p><strong>Schedule:</strong> ${selectedCourseForProgress.schedule}</p>
                
                <div class="progress-container" style="margin: 20px 0;">
                    <div class="progress-label">
                        <span>Overall Progress: ${selectedCourseForProgress.progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${selectedCourseForProgress.progress}%"></div>
                    </div>
                </div>
                
                <div class="progress-actions" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="updateProgress(${selectedCourseForProgress.progress + selectedCourseForProgress.progressRate})">
                        Mark as Completed Today (+${selectedCourseForProgress.progressRate}%)
                    </button>
                </div>
            `;

            // Display sample classmates (in a real app, this would come from the database)
            displayClassmates();
        }

        // Update course progress
        async function updateProgress(newProgress) {
            if (!currentUser || !selectedCourseForProgress) return;

            // Cap progress at 100%
            newProgress = Math.min(newProgress, 100);

            try {
                // Update in Firestore
                const userRef = doc(db, "users", currentUser.uid);
                const updatedCourses = enrolledCourses.map(course => {
                    if (course.id === selectedCourseForProgress.id) {
                        return {
                            ...course,
                            progress: newProgress,
                            lastActive: new Date().toISOString()
                        };
                    }
                    return course;
                });

                await updateDoc(userRef, {
                    enrolledCourses: updatedCourses
                });

                // Update local data
                enrolledCourses = updatedCourses;
                selectedCourseForProgress.progress = newProgress;

                // Refresh displays
                displayCourseProgress();
                displayEnrolledCourses();
            } catch (error) {
                console.error("Error updating progress:", error);
                alert("Failed to update progress. Please try again.");
            }
        }

        // Display classmates (sample data)
        function displayClassmates() {
            classmatesContainer.innerHTML = '';
            
            // Sample classmates data - in a real app, this would come from the database
            const sampleClassmates = [
                { name: "Ahmed Mohammed", progress: 45 },
                { name: "Fatima Ali", progress: 60 },
                { name: "Mohammed Hassan", progress: 30 },
                { name: "Amina Abdi", progress: 75 },
                { name: "Omar Yusuf", progress: 52 }
            ];

            sampleClassmates.forEach(classmate => {
                const classmateCard = document.createElement('div');
                classmateCard.className = 'classmate-card';
                const initials = classmate.name.split(' ').map(n => n[0]).join('').toUpperCase();
                classmateCard.innerHTML = `
                    <div class="classmate-avatar">${initials}</div>
                    <div class="classmate-name">${classmate.name}</div>
                    <div class="classmate-progress">Progress: ${classmate.progress}%</div>
                `;
                classmatesContainer.appendChild(classmateCard);
            });
        }

        // Unenroll from a course
        async function unenrollFromCourse(courseId) {
            if (!currentUser) return;

            if (!confirm("Are you sure you want to unenroll from this course?")) {
                return;
            }

            try {
                // Remove course from user's enrolled courses
                const courseToRemove = enrolledCourses.find(c => c.id === courseId);
                if (!courseToRemove) return;

                await updateDoc(doc(db, "users", currentUser.uid), {
                    enrolledCourses: arrayRemove(courseToRemove)
                });

                // Update local data
                enrolledCourses = enrolledCourses.filter(c => c.id !== courseId);

                // Refresh displays
                displayAvailableCourses();
                displayEnrolledCourses();
                alert("Successfully unenrolled from the course.");
            } catch (error) {
                console.error("Error unenrolling from course:", error);
                alert("Failed to unenroll from course. Please try again.");
            }
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab UI
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                if (tab.textContent.toLowerCase().includes(tabName)) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id.includes(tabName)) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            // If switching to progress tab and no course is selected, select the first one if available
            if (tabName === 'progress' && !selectedCourseForProgress && enrolledCourses.length > 0) {
                selectedCourseForProgress = enrolledCourses[0];
                displayCourseProgress();
            }
        }

        // View course details (placeholder)
        function viewCourseDetails(courseId) {
            let course = null;
            for (const type in coursesData) {
                course = coursesData[type].find(c => c.id === courseId);
                if (course) break;
            }

            if (course) {
                alert(`Course Details:\n\nTitle: ${course.title}\nType: ${course.type}\nLanguage: ${course.language}\nInstructor: ${course.instructor}\nSchedule: ${course.schedule}\nDescription: ${course.description}\n\nProgress Rate: ${course.progressRate}% per session`);
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

        // Make functions available globally
        window.enrollInCourse = enrollInCourse;
        window.viewCourseDetails = viewCourseDetails;
        window.viewCourseProgress = viewCourseProgress;
        window.updateProgress = updateProgress;
        window.unenrollFromCourse = unenrollFromCourse;
        window.switchTab = switchTab;
    </script>
</body>
</html>
