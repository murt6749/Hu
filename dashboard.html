<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HU Jama'aa - Super Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        :root {
            --primary-color: #1a4d2e;
            --secondary-color: #4f6f52;
            --accent-color: #f5efe6;
            --light-color: #e8dfca;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            font-size: 14px;
        }

        .super-admin-container {
            width: 100%;
            max-width: 100%;
            padding: 0;
        }

        /* Admin Header */
        .super-admin-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .super-admin-header h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .super-admin-actions {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Admin Sidebar */
        .super-admin-sidebar {
            position: fixed;
            top: 60px;
            left: 0;
            bottom: 0;
            width: 250px;
            background-color: var(--white);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 90;
            overflow-y: auto;
        }

        .super-admin-sidebar.active {
            transform: translateX(0);
        }

        .sidebar-menu {
            list-style: none;
            padding: 15px 0;
        }

        .sidebar-menu li a {
            display: block;
            padding: 12px 20px;
            color: var(--secondary-color);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .sidebar-menu li a:hover,
        .sidebar-menu li a.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }

        .sidebar-menu li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Admin Main Content */
        .super-admin-main {
            padding: 20px;
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }

        .super-admin-main.expanded {
            margin-left: 250px;
        }

        /* Tabs */
        .admin-tabs {
            display: flex;
            border-bottom: 2px solid var(--light-color);
            margin-bottom: 20px;
        }

        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--secondary-color);
            transition: all 0.3s ease;
        }

        .admin-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .admin-card {
            background-color: var(--white);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .admin-card-title {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Filter Section */
        .super-filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            margin-bottom: 0;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary-color);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: var(--white);
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: black;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--light-color);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        /* Data Table */
        .data-table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }

        tr:hover {
            background-color: rgba(79, 111, 82, 0.05);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background-color: var(--success-color);
            color: white;
        }

        .status-inactive {
            background-color: #6c757d;
            color: white;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: black;
        }

        .badge-info {
            background-color: var(--info-color);
            color: white;
        }

        /* Edit Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Confirmation Dialog */
        .confirmation-dialog {
            text-align: center;
            padding: 20px;
        }

        .confirmation-dialog p {
            margin-bottom: 20px;
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .super-admin-sidebar {
                transform: translateX(-100%);
            }
            
            .super-admin-main.expanded {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .super-filter-section {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .super-filter-section {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="super-admin-container">
        <!-- Admin Header -->
        <header class="super-admin-header">
            <button class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1>HU Jama'aa - Super Admin</h1>
            <div class="super-admin-actions">
                <button class="btn-icon" id="notifications-btn">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="btn-icon" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Admin Sidebar -->
        <aside class="super-admin-sidebar" id="super-admin-sidebar">
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" data-tab="users"><i class="fas fa-users"></i> User Management</a></li>
                <li><a href="#" data-tab="courses"><i class="fas fa-book"></i> Course Management</a></li>
                <li><a href="#" data-tab="enrollments"><i class="fas fa-clipboard-list"></i> Enrollments</a></li>
                <li><a href="#" data-tab="reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="#" data-tab="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </aside>

        <!-- Admin Main Content -->
        <main class="super-admin-main" id="super-admin-main">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="admin-card">
                    <h2 class="admin-card-title">System Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-users">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="active-courses">0</div>
                            <div class="stat-label">Active Courses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="enrollments-today">0</div>
                            <div class="stat-label">Today's Enrollments</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pending-requests">0</div>
                            <div class="stat-label">Pending Requests</div>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h2 class="admin-card-title">Recent Activity</h2>
                    <div class="activity-list" id="recent-activity">
                        <!-- Activity will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- User Management Tab -->
            <div id="users-tab" class="tab-content">
                <div class="admin-card">
                    <h2 class="admin-card-title">User Management</h2>
                    
                    <!-- User Filters -->
                    <div class="super-filter-section">
                        <div class="filter-group">
                            <label for="user-search">Search</label>
                            <input type="text" id="user-search" class="form-control" placeholder="Name, ID, Email...">
                        </div>
                        <div class="filter-group">
                            <label for="user-department">Department</label>
                            <select id="user-department" class="form-control">
                                <option value="all">All Departments</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Engineering">Engineering</option>
                                <option value="Business">Business</option>
                                <option value="Medicine">Medicine</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="user-year">Year</label>
                            <select id="user-year" class="form-control">
                                <option value="all">All Years</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                                <option value="3rd Year">3rd Year</option>
                                <option value="4th Year">4th Year</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="user-status">Status</label>
                            <select id="user-status" class="form-control">
                                <option value="all">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- User Actions -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="add-user">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                        <button class="btn btn-info" id="export-users">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                        <button class="btn btn-warning" id="print-users">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-danger" id="bulk-disable">
                            <i class="fas fa-user-slash"></i> Disable Selected
                        </button>
                    </div>
                    
                    <!-- Users Table -->
                    <div class="data-table-container">
                        <table id="users-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-users"></th>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Department</th>
                                    <th>Year</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-list">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Course Management Tab -->
            <div id="courses-tab" class="tab-content">
                <div class="admin-card">
                    <h2 class="admin-card-title">Course Management</h2>
                    
                    <!-- Course Filters -->
                    <div class="super-filter-section">
                        <div class="filter-group">
                            <label for="course-search">Search</label>
                            <input type="text" id="course-search" class="form-control" placeholder="Course Name, Code...">
                        </div>
                        <div class="filter-group">
                            <label for="course-type">Type</label>
                            <select id="course-type" class="form-control">
                                <option value="all">All Types</option>
                                <option value="qirat">Qirat</option>
                                <option value="hifz">Hifz</option>
                                <option value="nezer">Nezer</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="course-language">Language</label>
                            <select id="course-language" class="form-control">
                                <option value="all">All Languages</option>
                                <option value="amharic">Amharic</option>
                                <option value="oromifa">Oromifa</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="course-level">Level</label>
                            <select id="course-level" class="form-control">
                                <option value="all">All Levels</option>
                                <option value="fresh">Fresh</option>
                                <option value="senior">Senior</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="course-gender">Gender</label>
                            <select id="course-gender" class="form-control">
                                <option value="all">All Genders</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="course-status">Status</label>
                            <select id="course-status" class="form-control">
                                <option value="all">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Course Actions -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="add-course">
                            <i class="fas fa-plus"></i> Add Course
                        </button>
                        <button class="btn btn-info" id="export-courses">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                        <button class="btn btn-warning" id="print-courses">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-danger" id="bulk-deactivate">
                            <i class="fas fa-ban"></i> Deactivate Selected
                        </button>
                    </div>
                    
                    <!-- Courses Table -->
                    <div class="data-table-container">
                        <table id="courses-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-courses"></th>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Language</th>
                                    <th>Level</th>
                                    <th>Gender</th>
                                    <th>Instructor</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="courses-list">
                                <!-- Courses will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- [Additional tabs for enrollments, reports, settings would go here] -->
        </main>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="edit-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <button class="modal-close" id="close-edit-user-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    <div class="form-group">
                        <label for="edit-name">Full Name</label>
                        <input type="text" id="edit-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-student-id">Student ID</label>
                        <input type="text" id="edit-student-id" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-email">Email</label>
                        <input type="email" id="edit-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-department">Department</label>
                        <input type="text" id="edit-department" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-year">Year</label>
                        <select id="edit-year" class="form-control" required>
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                            <option value="Graduate">Graduate</option>
                            <option value="Staff">Staff</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-phone">Phone</label>
                        <input type="tel" id="edit-phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-status">Status</label>
                        <select id="edit-status" class="form-control" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-edit-user">Cancel</button>
                <button class="btn btn-primary" id="save-user-changes">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Course Modal -->
    <div class="modal" id="course-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="course-modal-title">Add New Course</h3>
                <button class="modal-close" id="close-course-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="course-form">
                    <input type="hidden" id="course-id">
                    <div class="form-group">
                        <label for="course-code">Course Code</label>
                        <input type="text" id="course-code" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="course-name">Course Name</label>
                        <input type="text" id="course-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-course-type">Type</label>
                        <select id="modal-course-type" class="form-control" required>
                            <option value="qirat">Qirat</option>
                            <option value="hifz">Hifz</option>
                            <option value="nezer">Nezer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-course-language">Language</label>
                        <select id="modal-course-language" class="form-control" required>
                            <option value="amharic">Amharic</option>
                            <option value="oromifa">Oromifa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-course-level">Level</label>
                        <select id="modal-course-level" class="form-control" required>
                            <option value="fresh">Fresh</option>
                            <option value="senior">Senior</option>
                            <option value="all">All Levels</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-course-gender">Gender</label>
                        <select id="modal-course-gender" class="form-control" required>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="all">All Genders</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="course-instructor">Instructor</label>
                        <input type="text" id="course-instructor" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="course-schedule">Schedule</label>
                        <input type="text" id="course-schedule" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="course-description">Description</label>
                        <textarea id="course-description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="course-status">Status</label>
                        <select id="course-status" class="form-control" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-course">Cancel</button>
                <button class="btn btn-primary" id="save-course">Save Course</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirm-modal-title">Confirmation</h3>
                <button class="modal-close" id="close-confirm-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-dialog">
                    <p id="confirm-message">Are you sure you want to perform this action?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-confirm">Cancel</button>
                <button class="btn btn-danger" id="confirm-action">Confirm</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            doc,
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            deleteDoc,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo",
            authDomain: "pharma-quiz-b5a07.firebaseapp.com",
            projectId: "pharma-quiz-b5a07",
            storageBucket: "pharma-quiz-b5a07.appspot.com",
            messagingSenderId: "161067776789",
            appId: "1:161067776789:web:88b8a61145dc5f5c31471c",
            measurementId: "G-3QRQE9HQFB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const menuToggle = document.getElementById('menu-toggle');
        const adminSidebar = document.getElementById('super-admin-sidebar');
        const adminMain = document.getElementById('super-admin-main');
        const logoutBtn = document.getElementById('logout-btn');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu li a');
        
        // User Management Elements
        const userSearch = document.getElementById('user-search');
        const userDepartment = document.getElementById('user-department');
        const userYear = document.getElementById('user-year');
        const userStatus = document.getElementById('user-status');
        const addUserBtn = document.getElementById('add-user');
        const exportUsersBtn = document.getElementById('export-users');
        const printUsersBtn = document.getElementById('print-users');
        const bulkDisableBtn = document.getElementById('bulk-disable');
        const selectAllUsers = document.getElementById('select-all-users');
        const usersList = document.getElementById('users-list');
        
        // Course Management Elements
        const courseSearch = document.getElementById('course-search');
        const courseType = document.getElementById('course-type');
        const courseLanguage = document.getElementById('course-language');
        const courseLevel = document.getElementById('course-level');
        const courseGender = document.getElementById('course-gender');
        const courseStatus = document.getElementById('course-status');
        const addCourseBtn = document.getElementById('add-course');
        const exportCoursesBtn = document.getElementById('export-courses');
        const printCoursesBtn = document.getElementById('print-courses');
        const bulkDeactivateBtn = document.getElementById('bulk-deactivate');
        const selectAllCourses = document.getElementById('select-all-courses');
        const coursesList = document.getElementById('courses-list');
        
        // Modal Elements
        const editUserModal = document.getElementById('edit-user-modal');
        const closeEditUserModal = document.getElementById('close-edit-user-modal');
        const cancelEditUser = document.getElementById('cancel-edit-user');
        const saveUserChanges = document.getElementById('save-user-changes');
        
        const courseModal = document.getElementById('course-modal');
        const closeCourseModal = document.getElementById('close-course-modal');
        const cancelCourse = document.getElementById('cancel-course');
        const saveCourse = document.getElementById('save-course');
        
        const confirmModal = document.getElementById('confirm-modal');
        const closeConfirmModal = document.getElementById('close-confirm-modal');
        const cancelConfirm = document.getElementById('cancel-confirm');
        const confirmAction = document.getElementById('confirm-action');
        const confirmMessage = document.getElementById('confirm-message');

        // Current admin data
        let currentAdmin = null;
        let allUsers = [];
        let allCourses = [];
        let selectedUserId = null;
        let selectedCourseId = null;
        let currentAction = null;

        // Initialize the application
        function initApp() {
            // Set up event listeners
            menuToggle.addEventListener('click', toggleSidebar);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Sidebar navigation
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab(link.getAttribute('data-tab'));
                });
            });
            
            // User management
            userSearch.addEventListener('input', filterUsers);
            userDepartment.addEventListener('change', filterUsers);
            userYear.addEventListener('change', filterUsers);
            userStatus.addEventListener('change', filterUsers);
            addUserBtn.addEventListener('click', () => openUserModal('add'));
            exportUsersBtn.addEventListener('click', exportUsers);
            printUsersBtn.addEventListener('click', printUserList);
            bulkDisableBtn.addEventListener('click', () => showConfirmation('disable'));
            selectAllUsers.addEventListener('change', toggleSelectAllUsers);
            
            // Course management
            courseSearch.addEventListener('input', filterCourses);
            courseType.addEventListener('change', filterCourses);
            courseLanguage.addEventListener('change', filterCourses);
            courseLevel.addEventListener('change', filterCourses);
            courseGender.addEventListener('change', filterCourses);
            courseStatus.addEventListener('change', filterCourses);
            addCourseBtn.addEventListener('click', () => openCourseModal('add'));
            exportCoursesBtn.addEventListener('click', exportCourses);
            printCoursesBtn.addEventListener('click', printCourseList);
            bulkDeactivateBtn.addEventListener('click', () => showConfirmation('deactivate'));
            selectAllCourses.addEventListener('change', toggleSelectAllCourses);
            
            // Modal events
            closeEditUserModal.addEventListener('click', () => editUserModal.classList.remove('active'));
            cancelEditUser.addEventListener('click', () => editUserModal.classList.remove('active'));
            saveUserChanges.addEventListener('click', saveUser);
            
            closeCourseModal.addEventListener('click', () => courseModal.classList.remove('active'));
            cancelCourse.addEventListener('click', () => courseModal.classList.remove('active'));
            saveCourse.addEventListener('click', saveCourseChanges);
            
            closeConfirmModal.addEventListener('click', () => confirmModal.classList.remove('active'));
            cancelConfirm.addEventListener('click', () => confirmModal.classList.remove('active'));
            confirmAction.addEventListener('click', performConfirmedAction);

            // Check auth state
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentAdmin = user;
                    await verifyAdmin(user.uid);
                    loadAllData();
                } else {
                    // Redirect to login page if not authenticated
                    window.location.href = 'login.html';
                }
            });
        }

        // Verify if user is admin
        async function verifyAdmin(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (!userData.isAdmin) {
                        window.location.href = 'dashboard.html';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error("Error verifying admin:", error);
                window.location.href = 'login.html';
            }
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            adminSidebar.classList.toggle('active');
            adminMain.classList.toggle('expanded');
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Update active tab in sidebar
            sidebarLinks.forEach(link => {
                if (link.getAttribute('data-tab') === tabName) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadAllUsers(),
                loadAllCourses()
            ]);
            
            updateDashboardStats();
        }

        // Load all users from Firestore
        async function loadAllUsers() {
            try {
                const usersQuery = query(collection(db, "users"));
                const querySnapshot = await getDocs(usersQuery);
                
                allUsers = [];
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    allUsers.push({
                        id: doc.id,
                        ...user
                    });
                });
                
                displayUsers(allUsers);
            } catch (error) {
                console.error("Error loading users:", error);
                alert("Failed to load users. Please try again.");
            }
        }

        // Load all courses from Firestore
        async function loadAllCourses() {
            try {
                const coursesQuery = query(collection(db, "courses"));
                const querySnapshot = await getDocs(coursesQuery);
                
                allCourses = [];
                querySnapshot.forEach((doc) => {
                    const course = doc.data();
                    allCourses.push({
                        id: doc.id,
                        ...course
                    });
                });
                
                displayCourses(allCourses);
            } catch (error) {
                console.error("Error loading courses:", error);
                alert("Failed to load courses. Please try again.");
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            document.getElementById('total-users').textContent = allUsers.length;
            document.getElementById('active-courses').textContent = allCourses.filter(c => c.status === 'active').length;
            // Add more stats as needed
        }

        // Display users in table
        function displayUsers(users) {
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersList.innerHTML = '<tr><td colspan="8" class="text-center">No users found</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const userRow = document.createElement('tr');
                userRow.innerHTML = `
                    <td><input type="checkbox" class="user-checkbox" data-id="${user.id}"></td>
                    <td>${user.studentId || 'N/A'}</td>
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.department || 'N/A'}</td>
                    <td>${user.year || 'N/A'}</td>
                    <td>
                        <span class="status-badge ${user.status === 'active' ? 'status-active' : 'status-inactive'}">
                            ${user.status || 'inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="showConfirmation('delete-user', '${user.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                usersList.appendChild(userRow);
            });
        }

        // Display courses in table
        function displayCourses(courses) {
            coursesList.innerHTML = '';
            
            if (courses.length === 0) {
                coursesList.innerHTML = '<tr><td colspan="10" class="text-center">No courses found</td></tr>';
                return;
            }
            
            courses.forEach(course => {
                const courseRow = document.createElement('tr');
                courseRow.innerHTML = `
                    <td><input type="checkbox" class="course-checkbox" data-id="${course.id}"></td>
                    <td>${course.code || 'N/A'}</td>
                    <td>${course.name || 'N/A'}</td>
                    <td><span class="badge ${getBadgeClass(course.type)}">${course.type || 'N/A'}</span></td>
                    <td>${course.language || 'N/A'}</td>
                    <td>${course.level || 'N/A'}</td>
                    <td>${course.gender || 'N/A'}</td>
                    <td>${course.instructor || 'N/A'}</td>
                    <td>
                        <span class="status-badge ${course.status === 'active' ? 'status-active' : 'status-inactive'}">
                            ${course.status || 'inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="editCourse('${course.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="showConfirmation('delete-course', '${course.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                coursesList.appendChild(courseRow);
            });
        }

        // Filter users based on search and filters
        function filterUsers() {
            const searchTerm = userSearch.value.toLowerCase();
            const departmentFilter = userDepartment.value;
            const yearFilter = userYear.value;
            const statusFilter = userStatus.value;
            
            let filteredUsers = allUsers;
            
            // Apply search filter
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user => 
                    (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                    (user.studentId && user.studentId.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply department filter
            if (departmentFilter !== 'all') {
                filteredUsers = filteredUsers.filter(user => 
                    user.department === departmentFilter
                );
            }
            
            // Apply year filter
            if (yearFilter !== 'all') {
                filteredUsers = filteredUsers.filter(user => 
                    user.year === yearFilter
                );
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filteredUsers = filteredUsers.filter(user => 
                    user.status === statusFilter
                );
            }
            
            displayUsers(filteredUsers);
        }

        // Filter courses based on search and filters
        function filterCourses() {
            const searchTerm = courseSearch.value.toLowerCase();
            const typeFilter = courseType.value;
            const languageFilter = courseLanguage.value;
            const levelFilter = courseLevel.value;
            const genderFilter = courseGender.value;
            const statusFilter = courseStatus.value;
            
            let filteredCourses = allCourses;
            
            // Apply search filter
            if (searchTerm) {
                filteredCourses = filteredCourses.filter(course => 
                    (course.name && course.name.toLowerCase().includes(searchTerm)) ||
                    (course.code && course.code.toLowerCase().includes(searchTerm)) ||
                    (course.instructor && course.instructor.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply type filter
            if (typeFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.type === typeFilter
                );
            }
            
            // Apply language filter
            if (languageFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.language === languageFilter
                );
            }
            
            // Apply level filter
            if (levelFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.level === levelFilter
                );
            }
            
            // Apply gender filter
            if (genderFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.gender === genderFilter
                );
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.status === statusFilter
                );
            }
            
            displayCourses(filteredCourses);
        }

        // Open user modal for add/edit
        function openUserModal(action, userId = null) {
            const modalTitle = document.getElementById('edit-user-modal').querySelector('.modal-title');
            
            if (action === 'add') {
                modalTitle.textContent = 'Add New User';
                document.getElementById('edit-user-form').reset();
                selectedUserId = null;
            } else if (action === 'edit' && userId) {
                modalTitle.textContent = 'Edit User';
                const user = allUsers.find(u => u.id === userId);
                if (user) {
                    selectedUserId = userId;
                    document.getElementById('edit-user-id').value = userId;
                    document.getElementById('edit-name').value = user.name || '';
                    document.getElementById('edit-student-id').value = user.studentId || '';
                    document.getElementById('edit-email').value = user.email || '';
                    document.getElementById('edit-department').value = user.department || '';
                    document.getElementById('edit-year').value = user.year || '';
                    document.getElementById('edit-phone').value = user.phone || '';
                    document.getElementById('edit-status').value = user.status || 'active';
                }
            }
            
            editUserModal.classList.add('active');
        }

        // Open course modal for add/edit
        function openCourseModal(action, courseId = null) {
            const modalTitle = document.getElementById('course-modal-title');
            
            if (action === 'add') {
                modalTitle.textContent = 'Add New Course';
                document.getElementById('course-form').reset();
                selectedCourseId = null;
            } else if (action === 'edit' && courseId) {
                modalTitle.textContent = 'Edit Course';
                const course = allCourses.find(c => c.id === courseId);
                if (course) {
                    selectedCourseId = courseId;
                    document.getElementById('course-id').value = courseId;
                    document.getElementById('course-code').value = course.code || '';
                    document.getElementById('course-name').value = course.name || '';
                    document.getElementById('modal-course-type').value = course.type || 'qirat';
                    document.getElementById('modal-course-language').value = course.language || 'amharic';
                    document.getElementById('modal-course-level').value = course.level || 'fresh';
                    document.getElementById('modal-course-gender').value = course.gender || 'male';
                    document.getElementById('course-instructor').value = course.instructor || '';
                    document.getElementById('course-schedule').value = course.schedule || '';
                    document.getElementById('course-description').value = course.description || '';
                    document.getElementById('course-status').value = course.status || 'active';
                }
            }
            
            courseModal.classList.add('active');
        }

        // Save user changes
        async function saveUser() {
            if (!selectedUserId && !confirm('Are you sure you want to create a new user?')) {
                return;
            }
            
            try {
                const userData = {
                    name: document.getElementById('edit-name').value,
                    studentId: document.getElementById('edit-student-id').value,
                    email: document.getElementById('edit-email').value,
                    department: document.getElementById('edit-department').value,
                    year: document.getElementById('edit-year').value,
                    phone: document.getElementById('edit-phone').value,
                    status: document.getElementById('edit-status').value,
                    lastUpdated: new Date().toISOString()
                };
                
                if (selectedUserId) {
                    // Update existing user
                    await updateDoc(doc(db, "users", selectedUserId), userData);
                    
                    // Update local data
                    const userIndex = allUsers.findIndex(u => u.id === selectedUserId);
                    if (userIndex !== -1) {
                        allUsers[userIndex] = { ...allUsers[userIndex], ...userData };
                    }
                } else {
                    // Add new user
                    const newUserRef = doc(collection(db, "users"));
                    await setDoc(newUserRef, {
                        ...userData,
                        createdAt: new Date().toISOString(),
                        isAdmin: false
                    });
                    
                    // Add to local data
                    allUsers.push({
                        id: newUserRef.id,
                        ...userData
                    });
                }
                
                // Refresh display
                filterUsers();
                
                // Close modal
                editUserModal.classList.remove('active');
                
                // Show success message
                alert(`User ${selectedUserId ? 'updated' : 'created'} successfully!`);
            } catch (error) {
                console.error("Error saving user:", error);
                alert("Failed to save user. Please try again.");
            }
        }

        // Save course changes
        async function saveCourseChanges() {
            if (!selectedCourseId && !confirm('Are you sure you want to create a new course?')) {
                return;
            }
            
            try {
                const courseData = {
                    code: document.getElementById('course-code').value,
                    name: document.getElementById('course-name').value,
                    type: document.getElementById('modal-course-type').value,
                    language: document.getElementById('modal-course-language').value,
                    level: document.getElementById('modal-course-level').value,
                    gender: document.getElementById('modal-course-gender').value,
                    instructor: document.getElementById('course-instructor').value,
                    schedule: document.getElementById('course-schedule').value,
                    description: document.getElementById('course-description').value,
                    status: document.getElementById('course-status').value,
                    lastUpdated: new Date().toISOString()
                };
                
                if (selectedCourseId) {
                    // Update existing course
                    await updateDoc(doc(db, "courses", selectedCourseId), courseData);
                    
                    // Update local data
                    const courseIndex = allCourses.findIndex(c => c.id === selectedCourseId);
                    if (courseIndex !== -1) {
                        allCourses[courseIndex] = { ...allCourses[courseIndex], ...courseData };
                    }
                } else {
                    // Add new course
                    const newCourseRef = doc(collection(db, "courses"));
                    await setDoc(newCourseRef, {
                        ...courseData,
                        createdAt: new Date().toISOString()
                    });
                    
                    // Add to local data
                    allCourses.push({
                        id: newCourseRef.id,
                        ...courseData
                    });
                }
                
                // Refresh display
                filterCourses();
                
                // Close modal
                courseModal.classList.remove('active');
                
                // Show success message
                alert(`Course ${selectedCourseId ? 'updated' : 'created'} successfully!`);
            } catch (error) {
                console.error("Error saving course:", error);
                alert("Failed to save course. Please try again.");
            }
        }

        // Show confirmation dialog
        function showConfirmation(action, id = null) {
            currentAction = action;
            
            switch(action) {
                case 'disable':
                    const selectedCount = document.querySelectorAll('.user-checkbox:checked').length;
                    if (selectedCount === 0) {
                        alert('Please select at least one user to disable.');
                        return;
                    }
                    confirmMessage.textContent = `Are you sure you want to disable ${selectedCount} selected user(s)?`;
                    break;
                    
                case 'deactivate':
                    const selectedCoursesCount = document.querySelectorAll('.course-checkbox:checked').length;
                    if (selectedCoursesCount === 0) {
                        alert('Please select at least one course to deactivate.');
                        return;
                    }
                    confirmMessage.textContent = `Are you sure you want to deactivate ${selectedCoursesCount} selected course(s)?`;
                    break;
                    
                case 'delete-user':
                    confirmMessage.textContent = 'Are you sure you want to delete this user? This action cannot be undone.';
                    selectedUserId = id;
                    break;
                    
                case 'delete-course':
                    confirmMessage.textContent = 'Are you sure you want to delete this course? This action cannot be undone.';
                    selectedCourseId = id;
                    break;
            }
            
            confirmModal.classList.add('active');
        }

        // Perform confirmed action
        async function performConfirmedAction() {
            try {
                switch(currentAction) {
                    case 'disable':
                        await disableSelectedUsers();
                        break;
                        
                    case 'deactivate':
                        await deactivateSelectedCourses();
                        break;
                        
                    case 'delete-user':
                        await deleteUser();
                        break;
                        
                    case 'delete-course':
                        await deleteCourse();
                        break;
                }
                
                confirmModal.classList.remove('active');
            } catch (error) {
                console.error("Error performing action:", error);
                alert("Failed to perform action. Please try again.");
            }
        }

        // Disable selected users
        async function disableSelectedUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const userIds = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-id'));
            
            try {
                const batch = userIds.map(userId => 
                    updateDoc(doc(db, "users", userId), {
                        status: 'inactive',
                        lastUpdated: new Date().toISOString()
                    })
                );
                
                await Promise.all(batch);
                
                // Update local data
                allUsers = allUsers.map(user => 
                    userIds.includes(user.id) ? { ...user, status: 'inactive' } : user
                );
                
                // Refresh display
                filterUsers();
                selectAllUsers.checked = false;
                
                // Show success message
                alert(`${userIds.length} user(s) disabled successfully!`);
            } catch (error) {
                console.error("Error disabling users:", error);
                throw error;
            }
        }

        // Deactivate selected courses
        async function deactivateSelectedCourses() {
            const checkboxes = document.querySelectorAll('.course-checkbox:checked');
            const courseIds = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-id'));
            
            try {
                const batch = courseIds.map(courseId => 
                    updateDoc(doc(db, "courses", courseId), {
                        status: 'inactive',
                        lastUpdated: new Date().toISOString()
                    })
                );
                
                await Promise.all(batch);
                
                // Update local data
                allCourses = allCourses.map(course => 
                    courseIds.includes(course.id) ? { ...course, status: 'inactive' } : course
                );
                
                // Refresh display
                filterCourses();
                selectAllCourses.checked = false;
                
                // Show success message
                alert(`${courseIds.length} course(s) deactivated successfully!`);
            } catch (error) {
                console.error("Error deactivating courses:", error);
                throw error;
            }
        }

        // Delete user
        async function deleteUser() {
            try {
                await deleteDoc(doc(db, "users", selectedUserId));
                
                // Remove from local data
                allUsers = allUsers.filter(user => user.id !== selectedUserId);
                
                // Refresh display
                filterUsers();
                
                // Show success message
                alert('User deleted successfully!');
            } catch (error) {
                console.error("Error deleting user:", error);
                throw error;
            }
        }

        // Delete course
        async function deleteCourse() {
            try {
                await deleteDoc(doc(db, "courses", selectedCourseId));
                
                // Remove from local data
                allCourses = allCourses.filter(course => course.id !== selectedCourseId);
                
                // Refresh display
                filterCourses();
                
                // Show success message
                alert('Course deleted successfully!');
            } catch (error) {
                console.error("Error deleting course:", error);
                throw error;
            }
        }

        // Toggle select all users
        function toggleSelectAllUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllUsers.checked;
            });
        }

        // Toggle select all courses
        function toggleSelectAllCourses() {
            const checkboxes = document.querySelectorAll('.course-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCourses.checked;
            });
        }

        // Export users to Excel
        function exportUsers() {
            const filteredUsers = getFilteredUsers();
            if (filteredUsers.length === 0) {
                alert('No users to export.');
                return;
            }
            
            const worksheet = XLSX.utils.json_to_sheet(filteredUsers.map(user => ({
                'Student ID': user.studentId,
                'Name': user.name,
                'Email': user.email,
                'Department': user.department,
                'Year': user.year,
                'Phone': user.phone,
                'Status': user.status
            })));
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Users');
            XLSX.writeFile(workbook, 'HU_Jamaaa_Users.xlsx');
        }

        // Export courses to Excel
        function exportCourses() {
            const filteredCourses = getFilteredCourses();
            if (filteredCourses.length === 0) {
                alert('No courses to export.');
                return;
            }
            
            const worksheet = XLSX.utils.json_to_sheet(filteredCourses.map(course => ({
                'Code': course.code,
                'Name': course.name,
                'Type': course.type,
                'Language': course.language,
                'Level': course.level,
                'Gender': course.gender,
                'Instructor': course.instructor,
                'Schedule': course.schedule,
                'Status': course.status
            })));
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Courses');
            XLSX.writeFile(workbook, 'HU_Jamaaa_Courses.xlsx');
        }

        // Print user list
        function printUserList() {
            window.print();
        }

        // Print course list
        function printCourseList() {
            window.print();
        }

        // Get filtered users for export
        function getFilteredUsers() {
            const searchTerm = userSearch.value.toLowerCase();
            const departmentFilter = userDepartment.value;
            const yearFilter = userYear.value;
            const statusFilter = userStatus.value;
            
            let filteredUsers = allUsers;
            
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user => 
                    (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                    (user.studentId && user.studentId.toLowerCase().includes(searchTerm))
                );
            }
            
            if (departmentFilter !== 'all') {
                filteredUsers = filteredUsers.filter(user => 
                    user.department === departmentFilter
                );
            }
            
            if (yearFilter !== 'all') {
                filteredUsers = filteredUsers.filter(user => 
                    user.year === yearFilter
                );
            }
            
            if (statusFilter !== 'all') {
                filteredUsers = filteredUsers.filter(user => 
                    user.status === statusFilter
                );
            }
            
            return filteredUsers;
        }

        // Get filtered courses for export
        function getFilteredCourses() {
            const searchTerm = courseSearch.value.toLowerCase();
            const typeFilter = courseType.value;
            const languageFilter = courseLanguage.value;
            const levelFilter = courseLevel.value;
            const genderFilter = courseGender.value;
            const statusFilter = courseStatus.value;
            
            let filteredCourses = allCourses;
            
            if (searchTerm) {
                filteredCourses = filteredCourses.filter(course => 
                    (course.name && course.name.toLowerCase().includes(searchTerm)) ||
                    (course.code && course.code.toLowerCase().includes(searchTerm)) ||
                    (course.instructor && course.instructor.toLowerCase().includes(searchTerm))
                );
            }
            
            if (typeFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.type === typeFilter
                );
            }
            
            if (languageFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.language === languageFilter
                );
            }
            
            if (levelFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.level === levelFilter
                );
            }
            
            if (genderFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.gender === genderFilter
                );
            }
            
            if (statusFilter !== 'all') {
                filteredCourses = filteredCourses.filter(course => 
                    course.status === statusFilter
                );
            }
            
            return filteredCourses;
        }

        // Get badge class based on course type
        function getBadgeClass(type) {
            switch(type) {
                case 'qirat': return 'badge-primary';
                case 'hifz': return 'badge-success';
                case 'nezer': return 'badge-warning';
                default: return 'badge-info';
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Failed to logout. Please try again.");
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

        // Make functions available globally
        window.editUser = (userId) => openUserModal('edit', userId);
        window.editCourse = (courseId) => openCourseModal('edit', courseId);
    </script>
</body>
</html>
