<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HU Jama'aa - User Management [Enhanced]</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* --- Cosmic Dusk Theme --- */
    :root {
      --primary-color: #8a2be2;  /* BlueViolet */
      --primary-light: #9370db; /* MediumPurple */
      --secondary-color: #4682b4; /* SteelBlue */
      --accent-color: #ff69b4; /* HotPink */
      --bg-dark: #1a1a2e;    /* Dark Navy */
      --bg-medium: #162447;  /* Slightly Lighter Navy */
      --bg-light: #1f4068;   /* Bluish */
      --text-primary: #e0fbfc; /* Light Cyan */
      --text-secondary: #a7a7d1;/* Lavender Gray */
      --white: #ffffff;
      --gray-light: #f8f9fa; /* Kept for contrast if needed */
      --gray-medium: #4e4e6a; /* Darker Gray for borders */
      --gray-dark: #33334d;   /* Even Darker Gray */
      --success-color: #00b894; /* Mint Green */
      --info-color: #0984e3;    /* Bright Blue */
      --warning-color: #fdcb6e; /* Yellow */
      --danger-color: #d63031;  /* Red */
      --shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.3);
      --border-radius: 10px;
      --box-padding: 25px;
      --transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif; /* Changed Font */
    }

    body {
      background-color: var(--bg-dark); /* Dark Background */
      min-height: 100vh;
      font-size: 15px;
      color: var(--text-secondary); /* Default Text Color */
      line-height: 1.6;
    }

    .container {
      width: 100%;
      max-width: 100%;
      padding: 0;
    }

    /* Header Styles */
    .header {
      background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
      color: var(--text-primary);
      padding: 18px var(--box-padding);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      border-bottom: 1px solid var(--primary-light);
    }

    .header h1 {
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--white);
    }

    .header h1 i {
      font-size: 1.3rem;
      color: var(--accent-color);
    }

    .header-actions {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .btn-icon {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 1.5rem;
      cursor: pointer;
      position: relative;
      transition: var(--transition);
    }

    .btn-icon:hover {
      color: var(--accent-color);
      transform: scale(1.1);
    }

    /* Admin Panel Indicator */
    .admin-badge {
      background-color: var(--accent-color);
      color: var(--bg-dark);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Account Dropdown */
    .account-dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: calc(100% + 10px); /* Position below the button */
      background-color: var(--bg-light);
      min-width: 220px;
      box-shadow: var(--shadow-hover);
      z-index: 1000;
      border-radius: var(--border-radius);
      overflow: hidden;
      animation: fadeIn 0.2s ease-out;
      border: 1px solid var(--primary-light);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-content a {
      color: var(--text-primary);
      padding: 14px 20px;
      text-decoration: none;
      display: block;
      font-size: 0.9rem;
      transition: var(--transition);
      border-left: 4px solid transparent;
    }

    .dropdown-content a:hover {
      background-color: rgba(138, 43, 226, 0.2); /* Primary color hover */
      border-left: 4px solid var(--accent-color);
      color: var(--white);
    }

    .dropdown-content a i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
      color: var(--primary-light);
      transition: var(--transition);
    }
     .dropdown-content a:hover i {
        color: var(--accent-color);
     }

    .account-dropdown:hover .dropdown-content {
      display: block;
    }

    .user-name {
      margin-right: 10px;
      font-size: 0.95rem;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Main Content Area */
    .main-content {
      padding: var(--box-padding);
      padding-bottom: 40px;
    }

    /* Card Styles */
    .card {
      background-color: var(--bg-medium); /* Darker Card */
      border-radius: var(--border-radius);
      padding: var(--box-padding);
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid var(--gray-medium);
    }

    .card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-3px);
      border-color: var(--primary-light);
    }

    .card-title {
      color: var(--primary-light);
      margin-bottom: 25px;
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-medium);
    }

    .card-title i {
      font-size: 1.2rem;
      color: var(--accent-color);
    }

    /* Table Styles */
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      border-radius: var(--border-radius);
      box-shadow: 0 0 0 1px var(--gray-medium);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1100px; /* Adjusted for new column */
      background-color: var(--bg-light);
    }

    .data-table th, .data-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid var(--gray-medium);
      color: var(--text-secondary);
      white-space: nowrap; /* Prevent wrapping in cells */
    }

    .data-table th {
      background-color: var(--bg-medium); /* Darker header */
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover {
      background-color: rgba(70, 130, 180, 0.1); /* Secondary color tint on hover */
    }

    .data-table td strong {
        color: var(--text-primary);
        font-weight: 500;
    }
    .data-table td small {
        color: var(--text-secondary);
        opacity: 0.8;
        font-size: 0.85em;
        display: block; /* Make small text block */
    }
    .data-table td .badge { /* Styling for badges within tables */
        margin-bottom: 3px;
        margin-right: 3px;
    }
    .data-table td .user-contact div { /* Stack email/phone */
        line-height: 1.4;
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.4px;
      text-transform: capitalize;
    }

    .badge-primary { background-color: var(--primary-color); color: var(--white); }
    .badge-secondary { background-color: var(--secondary-color); color: var(--white); }
    .badge-info { background-color: var(--info-color); color: var(--white); } /* Student Role */
    .badge-warning { background-color: var(--warning-color); color: var(--bg-dark); } /* Moderator Role */
    .badge-success { background-color: var(--success-color); color: var(--white); }
    .badge-danger { background-color: var(--danger-color); color: var(--white); } /* Admin Role */
    .badge-light { background-color: var(--gray-medium); color: var(--text-primary); }
    .badge-custom { background-color: var(--accent-color); color: var(--bg-dark); }

    /* Buttons */
    .btn {
      padding: 12px 22px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
     .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
        transform: none !important; /* Prevent hover effect */
     }

    .btn-block {
      width: 100%;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: var(--white);
    }
    .btn-primary:hover:not(:disabled) {
      background-color: var(--primary-light);
      box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
      transform: translateY(-2px);
    }

    .btn-outline {
      background-color: transparent;
      border: 2px solid var(--primary-light);
      color: var(--primary-light);
      box-shadow: none;
    }
    .btn-outline:hover:not(:disabled) {
      background-color: rgba(138, 43, 226, 0.1);
      color: var(--white);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .btn-sm {
      padding: 8px 15px;
      font-size: 0.8rem;
      gap: 5px;
    }

    .btn-danger { background-color: var(--danger-color); color: white; }
    .btn-danger:hover:not(:disabled) { background-color: #e74c3c; box-shadow: 0 5px 15px rgba(214, 48, 49, 0.4); transform: translateY(-2px); }
    .btn-success { background-color: var(--success-color); color: white; } /* Promote Button */
    .btn-success:hover:not(:disabled) { background-color: #00cec9; box-shadow: 0 5px 15px rgba(0, 184, 148, 0.4); transform: translateY(-2px); }
    .btn-warning { background-color: var(--warning-color); color: var(--bg-dark); } /* Edit Button */
    .btn-warning:hover:not(:disabled) { background-color: #ffeaa7; box-shadow: 0 5px 15px rgba(253, 203, 110, 0.4); transform: translateY(-2px); }


    /* Form Elements */
    .form-group {
      margin-bottom: 22px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--primary-light);
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--gray-medium);
      border-radius: var(--border-radius);
      font-size: 0.95rem;
      transition: var(--transition);
      background-color: var(--bg-light);
      color: var(--text-primary);
    }
     .form-control::placeholder {
        color: var(--text-secondary);
        opacity: 0.7;
     }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(138, 43, 226, 0.2);
      background-color: var(--bg-medium);
    }

    textarea.form-control {
      min-height: 120px;
      resize: vertical;
    }
    .d-none { display: none !important; } /* Utility class */


    /* Filter Section */
    .filter-section {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      padding: 20px;
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }
    .filter-item {
      flex: 1;
      min-width: 200px;
    }
    .filter-item label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--primary-light);
      font-size: 0.85rem;
    }


    /* Export Section */
    .export-section {
      background: var(--bg-light);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 30px;
      border: 1px solid var(--gray-medium);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .export-section h3 {
      font-size: 1.1rem;
      color: var(--primary-light);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid var(--gray-medium);
      padding-bottom: 10px;
    }
    .export-section h3 i {
      font-size: 1rem;
      color: var(--accent-color);
    }

    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 15px; /* Space before button */
    }

    .export-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-medium);
      padding: 8px 12px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }
    .export-checkbox:hover {
        background-color: var(--gray-medium);
    }

    .export-checkbox input[type="checkbox"] {
      accent-color: var(--accent-color);
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .export-checkbox label {
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-primary);
      flex-grow: 1; /* Allow label to take space */
    }


    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 30px;
      color: var(--text-secondary);
      background-color: rgba(31, 64, 104, 0.3); /* bg-light tint */
      border-radius: var(--border-radius);
      border: 1px dashed var(--gray-medium);
    }

    .empty-state i {
      font-size: 3.5rem;
      margin-bottom: 25px;
      color: var(--secondary-color);
      opacity: 0.6;
    }

    .empty-state p {
      font-size: 1.1rem;
      max-width: 450px;
      margin: 0 auto 25px;
    }

    /* Loading State */
    .loading-state {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px;
      min-height: 150px; /* Ensure it takes some space */
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(138, 43, 226, 0.2); /* Primary color tint */
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(10, 10, 20, 0.7); /* Darker overlay */
      backdrop-filter: blur(5px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.active {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background-color: var(--bg-medium);
      border-radius: var(--border-radius);
      width: 100%;
      max-width: 850px; /* Wider modal for user details */
      max-height: 90vh;
      display: flex; /* Use flex for vertical layout */
      flex-direction: column;
      transform: translateY(20px) scale(0.95);
      transition: transform 0.3s ease, opacity 0.3s ease;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
      border: 1px solid var(--primary-light);
      opacity: 0;
    }

    .modal.active .modal-content {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .modal-header {
      padding: 20px 30px;
      border-bottom: 1px solid var(--gray-medium);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, var(--bg-light), var(--bg-medium));
      border-top-left-radius: var(--border-radius);
      border-top-right-radius: var(--border-radius);
      flex-shrink: 0; /* Prevent header from shrinking */
    }

    .modal-title {
      font-size: 1.5rem;
      color: var(--white);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }
     .modal-title i { color: var(--accent-color); }

    .modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: var(--transition);
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--danger-color);
      transform: rotate(90deg) scale(1.1);
    }

    .modal-body {
      padding: 30px;
      overflow-y: auto; /* Allow body to scroll */
      flex-grow: 1; /* Allow body to take available space */
    }

    .modal-footer {
      padding: 20px 30px;
      border-top: 1px solid var(--gray-medium);
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      background-color: var(--bg-light);
      border-bottom-left-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
      flex-shrink: 0; /* Prevent footer from shrinking */
    }

    /* User Detail Styles (Inside Modal) */
    .user-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive columns */
      gap: 25px;
      margin-bottom: 30px;
    }

    .user-detail-card {
      background: var(--bg-light); /* Slightly lighter card inside modal */
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-medium);
    }

    .user-detail-card h3 {
      color: var(--primary-light);
      margin-bottom: 18px;
      font-size: 1.1rem;
      border-bottom: 1px solid var(--gray-medium);
      padding-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
     .user-detail-card h3 i {
        color: var(--accent-color);
        font-size: 1rem;
     }

    .user-detail-row {
      display: flex;
      margin-bottom: 14px;
      font-size: 0.95rem;
    }

    .user-detail-label {
      font-weight: 600;
      color: var(--text-primary);
      opacity: 0.8;
      min-width: 110px; /* Adjust as needed */
      flex-shrink: 0; /* Prevent label from shrinking */
      margin-right: 10px;
    }

    .user-detail-value {
      flex-grow: 1;
      color: var(--text-primary);
      word-break: break-word; /* Break long values like IDs */
    }
     .user-detail-value .badge { /* Ensure badges fit well */
        font-size: 0.8rem;
        padding: 5px 10px;
     }

    /* Modal Course Table Specific Styles */
    #user-courses-table th, #user-courses-table td {
        padding: 12px 15px; /* Slightly less padding */
        font-size: 0.9rem;
    }
    #user-courses-table .badge {
        font-size: 0.7rem; /* Smaller badges in modal table */
        padding: 4px 8px;
    }
    #user-courses-body .empty-state { /* Less padding for empty state in modal */
        padding: 30px 15px;
    }

    /* Notification */
    .notification {
      position: fixed;
      bottom: 30px; /* Position bottom */
      right: 30px;
      padding: 18px 26px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-hover);
      z-index: 3000;
      display: flex;
      align-items: center;
      gap: 15px;
      transform: translateY(150%); /* Slide from bottom */
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      color: var(--white);
      max-width: 400px;
    }

    .notification.show {
      transform: translateY(0);
    }

    .notification i {
      font-size: 1.5rem;
      flex-shrink: 0;
    }
     .notification span {
        font-weight: 500;
     }

    .notification-success {
      background: linear-gradient(135deg, var(--success-color), #00b894);
    }

    .notification-error {
      background: linear-gradient(135deg, var(--danger-color), #e74c3c);
    }

    /* Responsive */
    @media (max-width: 992px) {
      .filter-section { gap: 15px; }
      .filter-item { min-width: calc(50% - 10px); } /* Two columns */
       .export-options { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));}
       .data-table { min-width: 900px; } /* Adjust min-width */
    }

    @media (max-width: 768px) {
      :root { --box-padding: 20px; }
      .header h1 { font-size: 1.2rem; }
      .main-content { padding: 20px; }
      .filter-section { flex-direction: column; gap: 15px; }
      .filter-item { min-width: 100%; }
      .card-title { font-size: 1.3rem; }
      .modal-content { max-width: 95%; max-height: 85vh;}
      .modal-header, .modal-body, .modal-footer { padding: 20px; }
       .user-detail-grid { grid-template-columns: 1fr; } /* Single column */
       .data-table { min-width: 800px; }
    }

    @media (max-width: 576px) {
      .header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; }
      .header-actions { margin-top: 10px; align-self: flex-end;}
      .user-name { max-width: 120px; }
      .modal-footer { flex-direction: column; }
      .modal-footer .btn { width: 100%; }
      .notification { right: 15px; bottom: 15px; width: calc(100% - 30px); max-width: none;}
      .data-table th, .data-table td { padding: 12px 15px; white-space: normal;} /* Allow wrapping on small screens */
      .data-table { min-width: 100%; } /* Allow table to shrink */
      .export-options { grid-template-columns: 1fr; } /* Stack export options */
    }

  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 id="page-title">
        <i class="fas fa-users-cog"></i> User Management
        <span class="admin-badge">ADMIN</span> </h1>
      <div class="header-actions">
        <div class="account-dropdown">
          <div style="display: flex; align-items: center; cursor: pointer;">
            <span class="user-name" id="user-name-display">Loading...</span>
            <button class="btn-icon" id="account-btn">
               <i class="fas fa-user-astronaut"></i> </button>
          </div>
          <div class="dropdown-content" id="account-dropdown">
            <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="courses.html"><i class="fas fa-book-journal-whills"></i> Courses</a>
            <a href="enrollments.html"><i class="fas fa-clipboard-list"></i> Enrollments</a>
            <hr style="border-color: var(--gray-medium); margin: 5px 0;">
            <a href="index.html"><i class="fas fa-door-open"></i> Exit Portal</a>
            <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </header>

    <main class="main-content" id="main-content">
      <div class="filter-section">
        <div class="filter-item">
          <label for="user-type-filter">Filter by Role</label>
          <select id="user-type-filter" class="form-control">
            <option value="all">All Roles</option>
            <option value="student">Students</option>
            <option value="moderator">Moderators</option>
            <option value="admin">Admins</option>
          </select>
        </div>
        <div class="filter-item">
          <label for="user-department-filter">Filter by Department</label>
          <select id="user-department-filter" class="form-control">
            <option value="all">All Departments</option>
            </select>
        </div>
        <div class="filter-item">
          <label for="user-search">Search Users</label>
          <input type="text" id="user-search" class="form-control" placeholder="Name, email, phone, ID...">
        </div>
      </div>

      <div class="export-section">
        <h3><i class="fas fa-file-excel"></i> Export User Data</h3> <div class="export-options">
          <div class="export-checkbox">
            <input type="checkbox" id="export-studentid" checked>
            <label for="export-studentid">Student ID</label>
          </div>
          <div class="export-checkbox">
            <input type="checkbox" id="export-name" checked>
            <label for="export-name">Name</label>
          </div>
          <div class="export-checkbox">
            <input type="checkbox" id="export-email" checked>
            <label for="export-email">Email</label>
          </div>
          <div class="export-checkbox">
            <input type="checkbox" id="export-phone" checked>
            <label for="export-phone">Phone</label>
          </div>
          <div class="export-checkbox">
            <input type="checkbox" id="export-department" checked>
            <label for="export-department">Department</label>
          </div>
          <div class="export-checkbox">
            <input type="checkbox" id="export-role" checked>
            <label for="export-role">Role</label>
          </div>
          <div class="export-checkbox">
            <input type="checkbox" id="export-courses">
            <label for="export-courses">Enrolled Courses</label>
          </div>
        </div>
        <button class="btn btn-success btn-sm mt-2" id="export-users-btn"> <i class="fas fa-download"></i> Export Visible Users
        </button>
      </div>

      <div class="card">
        <h2 class="card-title">
          <i class="fas fa-users"></i>
          Registered Users List
        </h2>
        <div class="table-responsive">
          <table class="data-table" id="users-table">
            <thead>
              <tr>
                <th>Student ID</th> <th>Name</th>
                <th>Contact</th>
                <th>Department</th>
                <th>Role</th>
                <th>Courses Enrolled</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                  <td colspan="7" class="loading-state">
                  <div class="spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <div class="modal" id="user-detail-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="user-detail-title">
          <i class="fas fa-id-badge"></i> User Details
        </h3>
        <button class="modal-close" id="close-user-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="user-detail-grid" id="user-detail-content">
          <div class="user-detail-card"><h3>Loading...</h3></div>
        </div>

        <h3 style="margin-top: 25px; margin-bottom: 15px; font-size: 1.2rem; color: var(--primary-light); border-top: 1px solid var(--gray-medium); padding-top: 20px;">
          <i class="fas fa-book-reader" style="color: var(--accent-color);"></i> Enrolled Courses
        </h3>
        <div class="table-responsive">
          <table class="data-table" id="user-courses-table">
            <thead>
              <tr>
                <th>Course Title</th>
                <th>Type</th>
                <th>Language</th>
                <th>Enrolled On</th>
                <th>Verification</th>
              </tr>
            </thead>
            <tbody id="user-courses-body">
              </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="close-user-detail">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="edit-user-modal">
    <div class="modal-content" style="max-width: 650px;"> <div class="modal-header">
        <h3 class="modal-title" id="edit-user-title">
          <i class="fas fa-user-edit"></i>
          Edit User
        </h3>
        <button class="modal-close" id="close-edit-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="edit-user-form">
          <input type="hidden" id="edit-user-id">
          <div class="form-group">
            <label for="edit-name">Full Name *</label>
            <input type="text" id="edit-name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="edit-email">Email *</label>
            <input type="email" id="edit-email" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="edit-phone">Phone Number</label>
            <input type="tel" id="edit-phone" class="form-control" placeholder="e.g., 09...">
          </div>
          <div class="form-group">
            <label for="edit-department">Department</label>
            <input type="text" id="edit-department" class="form-control" placeholder="e.g., Computer Science">
          </div>
          <div class="form-group">
            <label for="edit-role">Role *</label>
            <select id="edit-role" class="form-control" required>
              <option value="student">Student</option>
              <option value="moderator">Moderator</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <small class="text-muted">* Required fields</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancel-edit">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="btn btn-primary" id="save-user">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="confirm-modal">
    <div class="modal-content" style="max-width: 550px;"> <div class="modal-header">
        <h3 class="modal-title" id="confirm-title">
          <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>
          Confirm Action
        </h3>
        <button class="modal-close" id="close-confirm-modal">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirm-message" style="font-size: 1.05rem; line-height: 1.7;">Are you sure you want to perform this action?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancel-confirm">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="btn btn-danger" id="confirm-action">
          <i class="fas fa-check"></i> Confirm
        </button>
      </div>
    </div>
  </div>

  <div class="notification d-none" id="notification">
     <i class="fas fa-check-circle"></i> <span id="notification-message">Success!</span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      // setDoc, // setDoc not typically needed for user management updates
      updateDoc,
      deleteDoc, // Keep if user deletion is planned
      query,
      // where, // Keep if server-side filtering is planned
      serverTimestamp,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- IMPORTANT: Keep your original Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo", // USE YOUR KEY
      authDomain: "pharma-quiz-b5a07.firebaseapp.com", // USE YOUR DOMAIN
      projectId: "pharma-quiz-b5a07",              // USE YOUR PROJECT ID
      storageBucket: "pharma-quiz-b5a07.appspot.com", // USE YOUR BUCKET
      messagingSenderId: "161067776789",            // USE YOUR SENDER ID
      appId: "1:161067776789:web:88b8a61145dc5f5c31471c", // USE YOUR APP ID
      measurementId: "G-3QRQE9HQFB" // USE YOUR MEASUREMENT ID (Optional)
    };
    // -----------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const mainContent = document.getElementById('main-content');
    const pageTitle = document.getElementById('page-title').querySelector('span.admin-badge'); // Target badge specifically
    const userNameDisplay = document.getElementById('user-name-display');
    const logoutBtn = document.getElementById('logout-btn');
    // accountDropdown is not needed as a variable now

    // Tables
    const usersTableBody = document.getElementById('users-table').querySelector('tbody');

    // Filter elements
    const userTypeFilter = document.getElementById('user-type-filter');
    const userDepartmentFilter = document.getElementById('user-department-filter');
    const userSearch = document.getElementById('user-search');

    // Export elements
    const exportUsersBtn = document.getElementById('export-users-btn');

    // Modals
    const userDetailModal = document.getElementById('user-detail-modal');
    const userDetailTitle = document.getElementById('user-detail-title');
    const userDetailContent = document.getElementById('user-detail-content');
    const userCoursesBody = document.getElementById('user-courses-body');
    const closeUserModal = document.getElementById('close-user-modal');
    const closeUserDetail = document.getElementById('close-user-detail');

    const editUserModal = document.getElementById('edit-user-modal');
    const editUserTitle = document.getElementById('edit-user-title');
    const editUserForm = document.getElementById('edit-user-form');
    const editUserId = document.getElementById('edit-user-id');
    const editName = document.getElementById('edit-name');
    const editEmail = document.getElementById('edit-email');
    const editPhone = document.getElementById('edit-phone');
    const editDepartment = document.getElementById('edit-department');
    const editRole = document.getElementById('edit-role');
    const saveUserBtn = document.getElementById('save-user');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const closeEditModal = document.getElementById('close-edit-modal');

    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const cancelConfirmBtn = document.getElementById('cancel-confirm');
    const confirmActionBtn = document.getElementById('confirm-action');
    const closeConfirmModalBtn = document.getElementById('close-confirm-modal');

    // Notification
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    const notificationIcon = notification.querySelector('i'); // Get icon element

    // App State
    let currentUser = null;
    let currentUserData = null; // Renamed from userData for clarity
    let allUsers = []; // Holds all user data fetched
    let allCourses = []; // Holds all course data fetched
    let allEnrollments = []; // Holds processed enrollment info
    let displayedUsers = []; // Holds the currently filtered/displayed users for export
    let pendingAction = null; // For confirmation modal
    let isAdmin = false;

    // Initialize app
    function initApp() {
      // Remove Navigation event listeners - No longer needed

      // Logout button
      logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        showConfirmation('Confirm Logout', 'Are you sure you want to logout?', async () => {
             try {
                await signOut(auth);
                window.location.href = 'login.html'; // Redirect to login page
            } catch (error) {
                console.error("Error signing out:", error);
                showNotification('Error signing out. Please try again.', 'error');
            }
        });
      });

      // Filter event listeners
      userTypeFilter.addEventListener('change', filterAndDisplayUsers);
      userDepartmentFilter.addEventListener('change', filterAndDisplayUsers);
      userSearch.addEventListener('input', debounce(filterAndDisplayUsers, 300)); // Add debounce

      // Export button
      exportUsersBtn.addEventListener('click', exportVisibleUsersToExcel); // Changed function called

      // Modal buttons
      closeUserModal.addEventListener('click', () => userDetailModal.classList.remove('active'));
      closeUserDetail.addEventListener('click', () => userDetailModal.classList.remove('active'));
      cancelEditBtn.addEventListener('click', () => editUserModal.classList.remove('active'));
      closeEditModal.addEventListener('click', () => editUserModal.classList.remove('active'));
      saveUserBtn.addEventListener('click', saveUser);

      // Confirm modal buttons
      cancelConfirmBtn.addEventListener('click', () => confirmModal.classList.remove('active'));
      confirmActionBtn.addEventListener('click', executePendingAction);
      closeConfirmModalBtn.addEventListener('click', () => confirmModal.classList.remove('active'));

      // Check auth state
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          try {
            await loadCurrentUserData(user.uid); // Load logged-in user's data

            if (!currentUserData) {
                showNotification('Could not load your user data. Redirecting...', 'error');
                setTimeout(() => window.location.href = 'login.html', 2500);
                return;
            }

            // Check privileges for accessing this page
            if (currentUserData.role !== 'moderator' && currentUserData.role !== 'admin') {
              showNotification('Access Denied: You do not have permission to view User Management.', 'error');
              setTimeout(() => {
                // Redirect non-admins/mods away from this page
                window.location.href = 'dashboard.html'; // Or courses.html or index.html
              }, 3000);
              return;
            }

            isAdmin = currentUserData.role === 'admin';
            userNameDisplay.textContent = currentUserData.name || user.displayName || "User";
            pageTitle.textContent = isAdmin ? 'ADMIN' : 'MODERATOR'; // Update badge text

            await loadAllData(); // Load main user/course data

          } catch(error) {
              console.error("Initialization Error:", error);
              showNotification("Error initializing page. Please try again.", "error");
              // Consider redirecting or showing a permanent error message
          }

        } else {
          // No user logged in, redirect to login
          window.location.href = 'login.html';
        }
      });
    }

    async function loadCurrentUserData(userId) {
      try {
        const userDocRef = doc(db, "users", userId);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists()) {
          currentUserData = userDocSnap.data();
        } else {
          console.warn("Logged-in user document not found for UID:", userId);
          currentUserData = null;
        }
      } catch (error) {
        console.error("Error loading current user data:", error);
        showNotification('Error fetching your user profile.', 'error');
        currentUserData = null;
      }
    }

    async function loadAllData() {
      showLoadingState();
      try {
        // Parallel fetching
        const [usersSnapshot, coursesSnapshot] = await Promise.all([
          getDocs(query(collection(db, "users"), orderBy("name"))),
          getDocs(query(collection(db, "courses"), orderBy("title")))
        ]);

        // Process Users
        allUsers = usersSnapshot.docs.map(doc => {
           const user = doc.data();
           user.id = doc.id; // Assign the document ID
           // Ensure role exists, default to student
           user.role = user.role || 'student';
           // **Generate Student ID (Assumption: No dedicated field)**
           // If you have a 'studentId' field in Firestore, use: user.studentId || 'N/A'
           user.generatedStudentId = doc.id.substring(0, 8).toUpperCase();
           return user;
        });


        // Process Courses
        allCourses = coursesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const courseMap = new Map(allCourses.map(c => [c.id, c])); // Map for quick lookup

        // Process Enrollments (Simplified - just store basic info)
        allEnrollments = [];
        allUsers.forEach(user => {
          if (user.enrolledCourses && Array.isArray(user.enrolledCourses)) {
            user.enrolledCourses.forEach(enrollment => {
              const course = courseMap.get(enrollment.id);
              if (course && enrollment.id) { // Check if enrollment has an ID
                 allEnrollments.push({
                    userId: user.id,
                    courseId: enrollment.id,
                    courseTitle: course.title,
                    courseType: course.type,
                    courseLanguage: course.language,
                    enrollmentDate: enrollment.enrollmentDate?.toDate ? enrollment.enrollmentDate.toDate() : (enrollment.enrollmentDate || new Date(0)),
                    // Keep verification status if needed
                    isVerified: enrollment.overflow === true // Assuming 'overflow' field means verified
                 });
              } else {
                  // console.warn(`User ${user.id} has enrollment with invalid/missing course ID:`, enrollment);
              }
            });
          }
        });

        updateDepartmentFilter();
        filterAndDisplayUsers(); // Initial display

      } catch (error) {
        console.error("Error loading data:", error);
        showNotification('Error loading user/course data. Please refresh.', 'error');
        usersTableBody.innerHTML = `<tr><td colspan="7" class="empty-state"><p>Error loading data.</p></td></tr>`;
      } finally {
        hideLoadingState();
      }
    }

    function updateDepartmentFilter() {
      const departments = [...new Set(allUsers.map(user => user.department).filter(Boolean))].sort();
       userDepartmentFilter.innerHTML = '<option value="all">All Departments</option>'; // Reset
      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        userDepartmentFilter.appendChild(option);
      });
    }

    function showLoadingState() {
       usersTableBody.innerHTML = `<tr><td colspan="7" class="loading-state"><div class="spinner"></div></td></tr>`;
    }

    function hideLoadingState() {
      // Content will be replaced by displayUsers
    }

    // --- USER MANAGEMENT DISPLAY & FILTERING ---

    function filterAndDisplayUsers() {
        const roleFilter = userTypeFilter.value; // 'all', 'student', 'moderator', 'admin'
        const departmentFilter = userDepartmentFilter.value; // 'all' or specific department name
        const searchTerm = userSearch.value.toLowerCase().trim();

        displayedUsers = allUsers.filter(user => {
            // Role Filter
            const roleMatch = roleFilter === 'all' || user.role === roleFilter;

            // Department Filter
            const departmentMatch = departmentFilter === 'all' || (user.department && user.department === departmentFilter);

            // Search Term Filter (checks name, email, phone, generated ID, department)
            const searchMatch = searchTerm === '' ||
                                (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                                (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                                (user.phone && user.phone.toLowerCase().includes(searchTerm)) ||
                                (user.generatedStudentId && user.generatedStudentId.toLowerCase().includes(searchTerm)) ||
                                (user.department && user.department.toLowerCase().includes(searchTerm));

            return roleMatch && departmentMatch && searchMatch;
        });

        displayUsers(displayedUsers); // Call display function with filtered users
    }


    function displayUsers(usersToDisplay) {
      usersTableBody.innerHTML = ''; // Clear previous results

      if (usersToDisplay.length === 0) {
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-user-slash"></i>
              <p>No users match the current filters.</p>
            </td>
          </tr>
        `;
        return;
      }

      usersToDisplay.forEach(user => {
        const userEnrollments = allEnrollments.filter(e => e.userId === user.id);
        const row = document.createElement('tr');
        row.setAttribute('data-user-id', user.id);

        // Determine Role Badge Class
        let roleBadgeClass = 'badge-info'; // Default (student)
        if (user.role === 'admin') roleBadgeClass = 'badge-danger';
        else if (user.role === 'moderator') roleBadgeClass = 'badge-warning';

        row.innerHTML = `
          <td>${user.generatedStudentId || 'N/A'}</td>
          <td>
            <strong>${user.name || 'Unknown'}</strong>
          </td>
          <td class="user-contact">
            <div>${user.email || 'No Email'}</div>
            <small>${user.phone || 'No Phone'}</small>
          </td>
          <td>${user.department || 'N/A'}</td>
          <td>
            <span class="badge ${roleBadgeClass}">
              ${user.role || 'student'}
            </span>
          </td>
          <td>
            ${userEnrollments.length > 0
                ? userEnrollments.slice(0, 2).map(enr => // Show first 2 courses max
                     `<span class="badge badge-light" title="${enr.courseType} / ${enr.courseLanguage}">${enr.courseTitle}</span>`
                  ).join('') +
                  (userEnrollments.length > 2 ? `<span class="badge badge-secondary">+${userEnrollments.length - 2} more</span>` : '')
                : '<span class="badge badge-light">None</span>'
             }
          </td>
          <td>
             <div style="display: flex; gap: 8px; align-items: center;">
              <button class="btn btn-sm btn-primary" onclick="viewUserDetails('${user.id}')" title="View Details">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-warning" onclick="editUser('${user.id}')" ${!isAdmin ? 'disabled title="Admin only"' : 'title="Edit User"'} >
                <i class="fas fa-edit"></i>
              </button>
              ${user.role === 'student' ? // Show promote only for students
                `<button class="btn btn-sm btn-success" onclick="confirmPromoteToModerator('${user.id}')" ${!isAdmin ? 'disabled title="Admin only"' : 'title="Promote to Moderator"'}>
                  <i class="fas fa-user-shield"></i>
                </button>` :
                user.role === 'moderator' && isAdmin ? // Show demote only for mods (if current user is admin)
                  `<button class="btn btn-sm btn-danger" onclick="confirmDemoteModerator('${user.id}')" title="Demote Moderator">
                    <i class="fas fa-user-minus"></i>
                  </button>` :
                  '' // Don't show promote/demote for admins or mods if current user is not admin
              }
            </div>
          </td>
        `;
        usersTableBody.appendChild(row);
      });
    }


    // --- USER DETAIL MODAL ---
    function viewUserDetails(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) {
        showNotification('User not found', 'error');
        return;
      }

      // Determine Role Badge Class
      let roleBadgeClass = 'badge-info';
      if (user.role === 'admin') roleBadgeClass = 'badge-danger';
      else if (user.role === 'moderator') roleBadgeClass = 'badge-warning';

      // Set modal title
      userDetailTitle.innerHTML = `
        <i class="fas fa-id-badge"></i>
        ${user.name || 'User Details'}
      `;

      // Populate user details grid
      userDetailContent.innerHTML = `
        <div class="user-detail-card">
          <h3><i class="fas fa-info-circle"></i> Basic Info</h3>
          <div class="user-detail-row">
            <div class="user-detail-label">Name:</div>
            <div class="user-detail-value">${user.name || 'N/A'}</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">Student ID:</div>
            <div class="user-detail-value">${user.generatedStudentId || 'N/A'}</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">Role:</div>
            <div class="user-detail-value"><span class="badge ${roleBadgeClass}">${user.role || 'student'}</span></div>
          </div>
           <div class="user-detail-row">
            <div class="user-detail-label">System UID:</div>
            <div class="user-detail-value" style="font-size: 0.85em; opacity: 0.7;">${user.id}</div>
          </div>
        </div>

        <div class="user-detail-card">
          <h3><i class="fas fa-address-book"></i> Contact</h3>
          <div class="user-detail-row">
            <div class="user-detail-label">Email:</div>
            <div class="user-detail-value">${user.email || 'N/A'}</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">Phone:</div>
            <div class="user-detail-value">${user.phone || 'N/A'}</div>
          </div>
        </div>

        <div class="user-detail-card">
           <h3><i class="fas fa-university"></i> Institutional</h3>
           <div class="user-detail-row">
            <div class="user-detail-label">Department:</div>
            <div class="user-detail-value">${user.department || 'N/A'}</div>
          </div>
           <div class="user-detail-row">
            <div class="user-detail-label">Registered:</div>
            <div class="user-detail-value">${formatDate(user.createdAt?.toDate ? user.createdAt.toDate() : user.createdAt)}</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">Last Update:</div>
            <div class="user-detail-value">${formatDate(user.updatedAt?.toDate ? user.updatedAt.toDate() : user.updatedAt)}</div>
          </div>
        </div>
      `;

      // Populate enrolled courses table in modal
      const userEnrollments = allEnrollments.filter(e => e.userId === userId);
      userCoursesBody.innerHTML = ''; // Clear previous

      if (userEnrollments.length === 0) {
        userCoursesBody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">
              <i class="fas fa-book-open"></i>
              <p>No enrolled courses found for this user.</p>
            </td>
          </tr>
        `;
      } else {
        userEnrollments.forEach(enrollment => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${enrollment.courseTitle || 'Unknown Course'}</td>
            <td><span class="badge ${getTypeBadgeClass(enrollment.courseType)}">${enrollment.courseType || '?'}</span></td>
            <td><span class="badge ${getLanguageBadgeClass(enrollment.courseLanguage)}">${enrollment.courseLanguage || '?'}</span></td>
            <td>${formatDate(enrollment.enrollmentDate)}</td>
            <td>
               ${enrollment.isVerified
                 ? '<span class="badge badge-success"><i class="fas fa-check"></i> Verified</span>'
                 : '<span class="badge badge-light"><i class="fas fa-hourglass-half"></i> Pending</span>'
               }
            </td>
          `;
          userCoursesBody.appendChild(row);
        });
      }

      userDetailModal.classList.add('active');
    }


    // --- EDIT USER MODAL ---
    function editUser(userId) {
       if (!isAdmin) {
            showNotification("Only Admins can edit users.", "error");
            return;
        }
      const user = allUsers.find(u => u.id === userId);
      if (!user) {
        showNotification('User not found', 'error');
        return;
      }

      editUserTitle.innerHTML = `
        <i class="fas fa-user-edit"></i>
        Edit ${user.name || 'User'} (${user.generatedStudentId})
      `;

      editUserId.value = user.id;
      editName.value = user.name || '';
      editEmail.value = user.email || '';
      editPhone.value = user.phone || '';
      editDepartment.value = user.department || '';
      editRole.value = user.role || 'student';

      // Disable role editing for admins if the current user is not an admin
      // (or potentially disable editing admins altogether)
      if (user.role === 'admin' && !isAdmin) {
          editRole.disabled = true;
      } else {
          editRole.disabled = false; // Ensure it's enabled otherwise
      }

      editUserModal.classList.add('active');
    }

    async function saveUser() {
      if (!isAdmin) {
            showNotification("Unauthorized action.", "error");
            return;
      }
      const userId = editUserId.value;
      const name = editName.value.trim();
      const email = editEmail.value.trim(); // Add validation if needed
      const phone = editPhone.value.trim();
      const department = editDepartment.value.trim();
      const role = editRole.value;

      if (!userId || !name || !email || !role) {
        showNotification('Please fill in all required fields (*).', 'error');
        return;
      }

      saveUserBtn.disabled = true;
      saveUserBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

      try {
        await updateDoc(doc(db, "users", userId), {
          name: name,
          email: email, // Consider if email should be editable (impacts auth?)
          phone: phone || null, // Store null if empty
          department: department || null,
          role: role,
          updatedAt: serverTimestamp(),
          updatedBy: currentUser.uid // Track who made the change
        });

        showNotification('User updated successfully!', 'success');
        await loadAllData(); // Reload data
        editUserModal.classList.remove('active');

      } catch (error) {
        console.error("Error updating user:", error);
        showNotification(`Failed to update user: ${error.message}`, 'error');
      } finally {
          saveUserBtn.disabled = false;
          saveUserBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
      }
    }


    // --- ROLE CHANGE ACTIONS ---

    function confirmPromoteToModerator(userId) {
         if (!isAdmin) {
            showNotification("Only Admins can promote users.", "error");
            return;
        }
        const user = allUsers.find(u => u.id === userId);
        if (!user || user.role !== 'student') {
            showNotification("Can only promote students.", "error");
            return;
        }

        showConfirmation(
            'Promote to Moderator',
            `Grant <strong>${user.name || 'this user'}</strong> Moderator privileges? They will gain access to admin panels.`,
            async () => { await updateUserRole(userId, 'moderator', 'promoted'); }
        );
    }

    function confirmDemoteModerator(userId) {
        if (!isAdmin) {
            showNotification("Only Admins can demote moderators.", "error");
            return;
        }
        const user = allUsers.find(u => u.id === userId);
        if (!user || user.role !== 'moderator') {
             showNotification("User is not a moderator.", "error");
            return;
        }
         // Prevent admin from demoting themselves (if applicable)
         if (user.id === currentUser.uid) {
             showNotification("You cannot change your own role here.", "error");
             return;
         }

        showConfirmation(
            'Remove Moderator Role',
            `Remove Moderator privileges from <strong>${user.name || 'this user'}</strong>? They will revert to Student role and lose admin access.`,
            async () => { await updateUserRole(userId, 'student', 'demoted'); }
        );
    }


    async function updateUserRole(userId, newRole, actionVerb) {
         if (!isAdmin) {
            showNotification("Unauthorized action.", "error");
            return;
        }
        try {
            await updateDoc(doc(db, "users", userId), {
            role: newRole,
            updatedAt: serverTimestamp(),
            updatedBy: currentUser.uid
            });

            showNotification(`User ${actionVerb} to ${newRole} successfully!`, 'success');
            await loadAllData(); // Refresh the user list

        } catch (error) {
            console.error(`Error ${actionVerb} user:`, error);
            showNotification(`Failed to ${actionVerb} user: ${error.message}`, 'error');
        }
    }


    // --- EXPORT FUNCTIONALITY ---
    function exportVisibleUsersToExcel() {
      // Get selected fields
      const includeStudentId = document.getElementById('export-studentid').checked;
      const includeName = document.getElementById('export-name').checked;
      const includeEmail = document.getElementById('export-email').checked;
      const includePhone = document.getElementById('export-phone').checked;
      const includeDepartment = document.getElementById('export-department').checked;
      const includeRole = document.getElementById('export-role').checked;
      const includeCourses = document.getElementById('export-courses').checked;

      if (!includeStudentId && !includeName && !includeEmail && !includePhone && !includeDepartment && !includeRole && !includeCourses) {
          showNotification("Please select at least one field to export.", "warning");
          return;
      }

      // Prepare data from the *currently displayed* users
      const dataToExport = displayedUsers.map(user => {
        const row = {};

        if (includeStudentId) row['Student ID'] = user.generatedStudentId || '';
        if (includeName) row['Name'] = user.name || '';
        if (includeEmail) row['Email'] = user.email || '';
        if (includePhone) row['Phone'] = user.phone || '';
        if (includeDepartment) row['Department'] = user.department || '';
        if (includeRole) row['Role'] = user.role || 'student';

        if (includeCourses) {
          const userEnrollments = allEnrollments.filter(e => e.userId === user.id);
          row['Enrolled Courses'] = userEnrollments.map(enr =>
              `${enr.courseTitle || '?'} (${enr.courseType || '?'}/${enr.courseLanguage || '?'})`
          ).join('; '); // Semicolon separated list
        }

        return row;
      });

       if (dataToExport.length === 0) {
           showNotification("No users are currently visible to export based on filters.", "info");
           return;
       }

      try {
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Visible Users");

        const today = new Date();
        const dateString = `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
        XLSX.writeFile(wb, `HU_Jamaaa_Users_${dateString}.xlsx`);

        showNotification(`Exported ${dataToExport.length} users successfully.`, 'success');
      } catch (error) {
        console.error("Error exporting data:", error);
        showNotification('Failed to export data. Please try again.', 'error');
      }
    }


    // --- UTILITY FUNCTIONS ---
    function getTypeBadgeClass(type) {
      if (!type) return 'badge-secondary';
      switch(type.toLowerCase()) {
        case 'qirat': return 'badge-info';
        case 'hifz': return 'badge-primary';
        case 'nezer': return 'badge-warning';
        default: return 'badge-custom'; // Use custom for others
      }
    }
     function getLanguageBadgeClass(language) {
         if (!language) return 'badge-light';
         switch(language.toLowerCase()) {
            case 'amharic': return 'badge-success';
            case 'oromifa': return 'badge-secondary';
            case 'arabic': return 'badge-info';
            case 'english': return 'badge-primary';
            default: return 'badge-custom';
         }
     }


    function formatDate(dateInput) {
        if (!dateInput) return 'N/A'; // Handle null/undefined/empty dates
        let date;
        // Check if it's a Firestore Timestamp object
        if (dateInput && typeof dateInput.toDate === 'function') {
            date = dateInput.toDate();
        } else {
            // Otherwise, try creating a Date object (might be string, number)
            try {
                date = new Date(dateInput);
            } catch (e) {
                return 'Invalid Date'; // Error during Date creation
            }
        }
        // Check if the created Date object is valid
        if (isNaN(date.getTime())) {
            return 'Invalid Date';
        }

        try {
             // Format valid date
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        } catch (e) {
            return 'Formatting Error';
        }
    }

    // Debounce function to limit filter calls on search input
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showNotification(message, type = 'success') {
      notification.className = `notification notification-${type}`;
      notificationMessage.textContent = message;
      notificationIcon.className = `fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}`;

      notification.classList.remove('d-none');
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);

      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
           if (!notification.classList.contains('show')) {
              notification.classList.add('d-none');
           }
        }, 500);
      }, 4000);
    }

    // Reusable Confirmation Modal
    function showConfirmation(title, message, onConfirmCallback) {
        confirmTitle.innerHTML = `<i class="fas fa-question-circle" style="color: var(--info-color);"></i> ${title}`;
        confirmMessage.innerHTML = message;
        pendingAction = onConfirmCallback;
        confirmModal.classList.add('active');
    }


    function executePendingAction() {
      if (typeof pendingAction === 'function') {
        try {
            pendingAction(); // Execute the stored callback
        } catch(error) {
            console.error("Error executing pending action:", error);
            showNotification("An error occurred while confirming.", "error");
        }
      }
      confirmModal.classList.remove('active');
      pendingAction = null; // Clear the action
    }

    // Make functions globally accessible ONLY for inline onclick handlers
    // Best practice is to use addEventListener, but keeping these for the current HTML structure
    window.viewUserDetails = viewUserDetails;
    window.editUser = editUser;
    window.confirmPromoteToModerator = confirmPromoteToModerator; // Changed name for clarity
    window.confirmDemoteModerator = confirmDemoteModerator;     // Changed name for clarity

    // Initialize the application
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
