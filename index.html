<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haramaya Jama'aa Home</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ====== CORE STRUCTURE & RESETS ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: #333;
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.5s ease, color 0.5s ease;
      /* No left padding needed anymore */
      padding-top: 70px; /* Add padding for fixed header */
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* ====== ENHANCED HEADER ====== */
    header {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.5rem; /* Adjusted padding */
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 300;
      box-shadow: 0 5px 25px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.2);
      transition: background 0.3s ease;
    }

    #header-logo {
        max-height: 40px; /* Control logo size */
        width: auto;
        display: block; /* Prevents extra space below image */
        transition: transform 0.3s ease;
    }
     #header-logo:hover {
         transform: scale(1.05);
     }


    .header-title {
      font-size: 1.4rem; /* Slightly smaller */
      font-weight: 600; /* Slightly lighter */
      text-align: center;
      flex-grow: 1; /* Take up space */
      margin: 0 1rem; /* Space around title */
      text-shadow: 0 1px 5px rgba(0,0,0,0.15);
      letter-spacing: 0.5px;
      background: linear-gradient(to right, #fff 0%, #ffda77 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* ====== ACCOUNT DROPDOWN (Styles mostly preserved) ====== */
    .account-wrapper {
      position: relative;
      cursor: pointer;
    }

    .account-icon {
      width: 45px; /* Slightly smaller */
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
      border: 2px solid rgba(255,255,255,0.6); /* Thinner border */
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem; /* Adjusted icon size */
      color: rgba(255, 255, 255, 0.8);
    }

    .account-icon:hover {
      transform: scale(1.1);
      box-shadow: 0 0 0 4px rgba(255, 204, 0, 0.4);
      filter: brightness(1.1);
    }
    .account-icon:hover i {
        color: white;
    }

    .account-dropdown {
      position: absolute;
      top: 60px; /* Adjusted position */
      right: 0;
      background: rgba(255,255,255,0.98); /* Slightly less transparent */
      border-radius: 12px; /* Softer radius */
      overflow: hidden;
      display: none;
      z-index: 400;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      min-width: 230px;
      animation: fadeInDropdown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(0,0,0,0.05);
      transform-origin: top right;
    }

    @keyframes fadeInDropdown { /* Renamed animation */
      from { opacity: 0; transform: translateY(-15px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .account-dropdown a,
    .account-dropdown div {
      color: #444; /* Darker text */
      padding: 0.9rem 1.2rem; /* Adjusted padding */
      display: flex;
      align-items: center;
      gap: 12px; /* Slightly less gap */
      border-bottom: 1px solid rgba(0,0,0,0.05);
      transition: background-color 0.2s ease, color 0.2s ease, padding-left 0.2s ease;
      font-weight: 500;
      font-size: 0.95rem; /* Slightly smaller font */
    }

    #user-role-display {
      font-size: 0.85em;
      color: #6a11cb;
      font-weight: bold;
      background-color: rgba(106, 17, 203, 0.04);
      border-bottom: 1px solid rgba(106, 17, 203, 0.1);
    }
    #user-role-display i { color: #6a11cb; }

    .account-dropdown a:last-child,
    .account-dropdown div:last-child { border-bottom: none; }

    .account-dropdown a:hover,
    .account-dropdown div:not(#user-role-display):hover {
      background: linear-gradient(90deg, rgba(106, 17, 203, 0.08) 0%, rgba(37, 117, 252, 0.08) 100%);
      padding-left: 1.5rem;
      color: #6a11cb;
    }

    .account-dropdown i {
      width: 18px; /* Slightly smaller icon width */
      color: #8a3ffc; /* Adjusted icon color */
      text-align: center;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .account-dropdown a:hover i,
    .account-dropdown div:not(#user-role-display):hover i {
        color: #6a11cb; /* Icon color on hover */
    }

    /* ====== SIDEBAR REMOVED ====== */
    /* All .sidebar, .sidebar-header, .sidebar ul/li styles are removed */

    /* ====== MAIN CONTENT AREA ====== */
    .content {
      /* No margin-left needed */
      padding: 2.5rem; /* Adjusted padding */
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .content::before { /* Subtle background pattern */
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: radial-gradient(rgba(0, 0, 0, 0.02) 1px, transparent 1px);
      background-size: 15px 15px;
      opacity: 0.5;
      z-index: -1;
      pointer-events: none;
    }

    .content h2 {
      color: #2c3e50;
      margin-bottom: 1.5rem;
      font-size: 2.2rem; /* Adjusted size */
      border-bottom: 3px solid #ffcc00;
      padding-bottom: 0.5rem;
      display: inline-block;
      font-weight: 700; /* Slightly bolder */
      position: relative;
    }

    .content h2::after { /* Subtle gradient underline accent */
      content: '';
      position: absolute;
      bottom: -3px; /* Align with border */
      left: 0;
      width: 60%;
      height: 3px;
      background: linear-gradient(to right, #8e44ad, #3498db);
      border-radius: 3px;
    }

    .content p {
      line-height: 1.7; /* Adjusted line height */
      margin-bottom: 2rem;
      font-size: 1.05rem; /* Adjusted size */
      color: #555;
      max-width: 750px;
    }

    /* ====== DASHBOARD WIDGETS ====== */
    .dashboard-widgets {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Slightly smaller min width */
      gap: 1.8rem; /* Adjusted gap */
      margin-bottom: 3rem;
    }

    .widget {
      background: #ffffff; /* Solid white background */
      border-radius: 12px;
      padding: 1.8rem; /* Adjusted padding */
      box-shadow: 0 8px 25px rgba(0,0,0,0.08); /* Softer shadow */
      transition: all 0.4s ease-in-out; /* Smoother transition */
      border-left: 4px solid #8e44ad; /* Accent color */
      position: relative;
      overflow: hidden;
    }

    /* Removed widget::before pseudo-element */

    .widget:hover {
      transform: translateY(-8px) scale(1.01); /* Adjusted hover effect */
      box-shadow: 0 12px 35px rgba(0,0,0,0.1);
    }

    .widget-header {
      display: flex;
      align-items: flex-start; /* Align items top */
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .widget-title {
      font-size: 1.1rem; /* Adjusted size */
      font-weight: 600;
      color: #34495e; /* Adjusted color */
      margin-bottom: 0.5rem; /* Space below title */
    }

    .widget-icon {
      width: 45px; /* Adjusted size */
      height: 45px;
      border-radius: 12px; /* Match widget radius */
      background: linear-gradient(135deg, #8e44ad 0%, #3498db 100%); /* Updated gradient */
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      flex-shrink: 0; /* Prevent icon from shrinking */
      margin-left: 1rem; /* Space between title/text and icon */
      box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
      transition: all 0.3s ease;
    }

    .widget:hover .widget-icon {
      transform: scale(1.1) rotate(10deg);
      box-shadow: 0 6px 15px rgba(142, 68, 173, 0.4);
    }

    .widget-value {
      font-size: 2.2rem; /* Adjusted size */
      font-weight: 700;
      color: #2c3e50;
      margin: 0.5rem 0 0.8rem 0; /* Adjusted margin */
      line-height: 1.2;
      /* Using solid color instead of gradient text for better readability */
    }

    .widget-description {
      font-size: 0.9rem; /* Adjusted size */
      color: #7f8c8d;
      line-height: 1.5;
    }

    /* Floating particles decoration */
    .particle {
      position: fixed; /* Fixed position so they don't scroll */
      background: rgba(142, 68, 173, 0.08); /* Use accent color */
      border-radius: 50%;
      pointer-events: none;
      z-index: 0; /* Behind content but above body background */
      animation: particleFloat 20s linear infinite; /* Updated animation name */
    }

    @keyframes particleFloat { /* Simple floating up animation */
        0% { transform: translateY(100vh) scale(0.5); opacity: 0; }
        50% { opacity: 1; }
        100% { transform: translateY(-100px) scale(1); opacity: 0; }
    }


    /* ====== RESPONSIVENESS ====== */
    @media (max-width: 768px) {
      body {
          padding-top: 60px; /* Adjust for smaller header */
      }
      header {
          padding: 0.6rem 1rem; /* Smaller padding */
      }
       #header-logo {
           max-height: 35px; /* Smaller logo */
       }
      .header-title {
        display: none; /* Hide title text on small screens */
      }
      .account-icon {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
      }
      .account-dropdown {
          top: 55px; /* Adjust dropdown position */
          min-width: 210px;
      }
      .content {
        padding: 1.5rem;
      }
       .content h2 {
           font-size: 1.8rem;
       }
        .content p {
            font-size: 1rem;
        }
      .dashboard-widgets {
        grid-template-columns: 1fr; /* Stack widgets */
        gap: 1.5rem;
      }
      .widget {
        padding: 1.5rem;
      }
       .widget-value {
           font-size: 2rem;
       }
    }

    @media (max-width: 480px) {
        .content h2 {
           font-size: 1.6rem;
        }
        .widget {
           padding: 1.2rem;
        }
        .widget-icon {
           width: 40px;
           height: 40px;
           font-size: 1.3rem;
        }
        .widget-value {
           font-size: 1.8rem;
        }
         .widget-description {
           font-size: 0.85rem;
       }
    }


    /* ====== DARK THEME STYLES ====== */
    body.dark {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); /* Dark blue/purple */
      color: #e0e0e0;
    }
    body.dark header {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* Darker header */
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    body.dark .header-title {
         background: linear-gradient(to right, #e0e0e0 0%, #a78bfa 100%); /* Light title for dark mode */
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    body.dark .account-icon {
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        border: 2px solid rgba(255,255,255,0.3);
        color: rgba(255, 255, 255, 0.8);
    }
    body.dark .account-dropdown {
      background: rgba(30, 41, 59, 0.98); /* Dark slate background */
      color: #e0e0e0;
      border: 1px solid rgba(255,255,255,0.1);
    }
    body.dark .account-dropdown a,
    body.dark .account-dropdown div {
      color: #e0e0e0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
     body.dark #user-role-display {
        color: #c4b5fd; /* Lighter purple */
        background-color: rgba(196, 181, 253, 0.08);
        border-bottom: 1px solid rgba(196, 181, 253, 0.1);
    }
    body.dark #user-role-display i { color: #c4b5fd; }

    body.dark .account-dropdown a:hover,
    body.dark .account-dropdown div:not(#user-role-display):hover {
      color: #facc15; /* Yellow accent */
      background: rgba(255, 255, 255, 0.05);
    }
    body.dark .account-dropdown i { color: #c4b5fd; }
    body.dark .account-dropdown a:hover i,
    body.dark .account-dropdown div:not(#user-role-display):hover i {
         color: #facc15;
    }

    body.dark .content { color: #cbd5e1; } /* Lighter gray */
    body.dark .content::before { /* Dark pattern */
        background-image: radial-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    }
    body.dark .content h2 {
        color: #f1f5f9; /* Off-white */
        border-bottom-color: #facc15; /* Yellow accent */
    }
     body.dark .content h2::after {
          background: linear-gradient(to right, #c084fc, #60a5fa); /* Purple/Blue gradient */
     }
    body.dark .content p { color: #94a3b8; } /* Medium gray */

    body.dark .widget {
      background: #1e293b; /* Dark slate */
      color: #e0e0e0;
      border-left: 4px solid #c084fc; /* Purple accent */
      box-shadow: 0 8px 25px rgba(0,0,0,0.2); /* Darker shadow */
    }
    body.dark .widget-title { color: #f1f5f9; }
    body.dark .widget-value { color: #f8fafc; } /* Brighter white */
    body.dark .widget-description { color: #94a3b8; }
    body.dark .widget-icon {
         background: linear-gradient(135deg, #c084fc 0%, #60a5fa 100%);
         box-shadow: 0 4px 12px rgba(192, 132, 252, 0.2);
    }
     body.dark .widget:hover {
         box-shadow: 0 12px 35px rgba(0,0,0,0.25);
     }
     body.dark .widget:hover .widget-icon {
          box-shadow: 0 6px 15px rgba(192, 132, 252, 0.3);
     }
     body.dark .particle {
        background: rgba(196, 181, 253, 0.06); /* Dark theme particle color */
     }


    /* ====== UTILITIES ====== */
    /* Theme toggle button (Styles preserved) */
    .theme-toggle {
      position: fixed;
      bottom: 25px; /* Adjusted position */
      right: 25px;
      width: 45px; /* Slightly smaller */
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem; /* Adjusted size */
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      z-index: 500;
      transition: all 0.3s ease;
    }
    .theme-toggle:hover {
      transform: scale(1.1) rotate(15deg);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
     body.dark .theme-toggle { /* Adjust colors for dark mode button */
         background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
         box-shadow: 0 5px 15px rgba(0,0,0,0.3);
     }
     body.dark .theme-toggle:hover {
          box-shadow: 0 8px 20px rgba(0,0,0,0.4);
     }

    /* Loading animation (Styles preserved) */
    .loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
     body.dark .loading { /* Dark loading screen */
         background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
     }
    .loading-circle {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body class=""> <div class="loading" id="loading">
    <div class="loading-circle"></div>
  </div>

  <header>
    <img src="haramaya.png" alt="Haramaya Logo" id="header-logo">
    <div class="header-title" id="header-title">Haramaya Jama'aa</div> <div class="account-wrapper" id="account-btn">
      <div class="account-icon" id="account-img">
          <i class="fas fa-user"></i>
      </div>
      <div class="account-dropdown" id="account-dropdown">
        <div id="not-logged-in">
          <a href="login.html"><i class="fas fa-sign-in-alt"></i> Log In</a>
          <a href="explore.html"><i class="fas fa-compass"></i> Explore Courses</a>
        </div>
        <div id="logged-in" style="display: none;">
          <div id="user-role-display" style="display: none;">
             <i class="fas fa-shield-halved"></i> <span id="role-text">Admin</span>
          </div>
          <a href="profile.html" id="profile-link"><i class="fas fa-user-circle"></i> My Profile</a>
          <a href="dashboard.html"><i class="fas fa-book-open"></i> Enrollment</a>
          <a href="progress.html"><i class="fas fa-chart-line"></i> Progression</a>
          <a href="interact.html"><i class="fas fa-comments"></i> Interact</a>
          <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </div>
  </header>

  <main class="content" id="content"> <h2>Welcome to Haramaya Jama'aa Group</h2>
    <p>Access your courses, track progress, and connect with others using the account menu. Enjoy the enhanced experience!</p>

    <div class="dashboard-widgets">
      <div class="widget">
        <div class="widget-header">
           <div> <h3 class="widget-title">Active Courses</h3>
               <p class="widget-description">Courses you're currently enrolled in</p>
           </div>
           <div class="widget-icon"><i class="fas fa-book-open"></i></div>
        </div>
        <div class="widget-value" id="active-courses">0</div>
      </div>

      <div class="widget">
        <div class="widget-header">
           <div>
                <h3 class="widget-title">Completed Lessons</h3>
                <p class="widget-description">Lessons you've finished</p>
           </div>
          <div class="widget-icon"><i class="fas fa-check-circle"></i></div>
        </div>
        <div class="widget-value" id="completed-lessons">0</div>
      </div>

      <div class="widget">
        <div class="widget-header">
            <div>
                <h3 class="widget-title">Study Streak</h3>
                <p class="widget-description">Consecutive days active</p>
            </div>
           <div class="widget-icon"><i class="fas fa-fire"></i></div>
        </div>
        <div class="widget-value" id="streak-days">0</div>
      </div>
    </div>
  </main>

  <div class="theme-toggle" id="theme-toggle">
    <i class="fas fa-moon"></i>
  </div>

  <div id="particles-js"></div>


  <script type="module">
    // Firebase modules.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    // Firebase config – replace with your Firebase project configuration.
    const firebaseConfig = {
          apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo",  
       authDomain: "pharma-quiz-b5a07.firebaseapp.com",  
      databaseURL: "https://pharma-quiz-b5a07-default-rtdb.firebaseio.com",  
      projectId: "pharma-quiz-b5a07",  
      storageBucket: "pharma-quiz-b5a07.firebasestorage.app",  
      messagingSenderId: "161067776789",  
      appId: "1:161067776789:web:88b8a61145dc5f5c31471c",  
      measurementId: "G-3QRQE9HQFB"  
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth();
    const db = getFirestore(app);

    // --- Global Variables ---
    let currentUserRole = null; // To store the user's role

    // --- DOM Elements ---
    const loadingScreen = document.getElementById('loading');
    const themeToggle = document.getElementById('theme-toggle');
    const accountBtn = document.getElementById("account-btn");
    const accountDropdown = document.getElementById("account-dropdown");
    const notLoggedInDiv = document.getElementById("not-logged-in");
    const loggedInDiv = document.getElementById("logged-in");
    const logoutBtn = document.getElementById("logout-btn");
    const profileLink = document.getElementById("profile-link");
    const userRoleDisplay = document.getElementById("user-role-display");
    const activeCoursesEl = document.getElementById("active-courses");
    const completedLessonsEl = document.getElementById("completed-lessons");
    const streakDaysEl = document.getElementById("streak-days");

    // --- Initial Setup ---

    // Check for saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    } else {
        document.body.classList.remove('dark');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
    }


    // Hide loading screen
    setTimeout(() => {
      loadingScreen.style.opacity = '0';
      loadingScreen.style.visibility = 'hidden';
      loadingScreen.style.pointerEvents = 'none'; // Prevent interaction after hiding
    }, 1000); // Faster fade out


    // Create floating particles (Modified for fixed positioning)
    function createParticles() {
      const colorsLight = ['rgba(142, 68, 173, 0.06)', 'rgba(52, 152, 219, 0.06)', 'rgba(241, 196, 15, 0.06)'];
      const colorsDark = ['rgba(196, 181, 253, 0.05)', 'rgba(96, 165, 250, 0.05)', 'rgba(250, 204, 21, 0.05)'];
      const isDark = document.body.classList.contains('dark');
      const colors = isDark ? colorsDark : colorsLight;

      // Clear existing particles if any
      document.querySelectorAll('.particle').forEach(p => p.remove());
      const particleContainer = document.body; // Append directly to body

      for (let i = 0; i < 15; i++) { // Reduced number of particles
        const particle = document.createElement('div');
        particle.classList.add('particle');

        const size = Math.random() * 8 + 4; // Smaller particles
        const startX = Math.random() * 100; // Start anywhere horizontally
        const duration = Math.random() * 20 + 15; // Slower animation
        const delay = Math.random() * 10;

        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${startX}vw`; // Use vw for horizontal positioning
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        particle.style.animation = `particleFloat ${duration}s linear ${delay}s infinite`;
        // Set initial position at the bottom
        particle.style.bottom = `-${size}px`; // Start just below the viewport

        particleContainer.appendChild(particle);
      }
    }

    // Theme toggle functionality
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');

      if (isDark) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
         localStorage.setItem('theme', 'dark'); // Save preference
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
         localStorage.setItem('theme', 'light'); // Save preference
      }
      // Recreate particles with appropriate theme colors
      createParticles();
    });

    // Initialize particles on load
    createParticles();

    /* ACCOUNT DROPDOWN */
    accountBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isDisplayed = accountDropdown.style.display === "block";
      accountDropdown.style.display = isDisplayed ? "none" : "block";
       // Optional: Add class for animation trigger if needed
      // if (!isDisplayed) {
      //    accountDropdown.classList.add('open');
      // } else {
      //    accountDropdown.classList.remove('open');
      // }
    });

    document.addEventListener("click", (e) => {
      if (!accountBtn.contains(e.target) && !accountDropdown.contains(e.target)) {
        accountDropdown.style.display = "none";
        // accountDropdown.classList.remove('open');
      }
    });

    /* AUTHENTICATION */
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loggedInDiv.style.display = "block";
        notLoggedInDiv.style.display = "none";
        loadUserData(user.uid);
      } else {
        loggedInDiv.style.display = "none";
        notLoggedInDiv.style.display = "block";
        currentUserRole = null;
        profileLink.href = "profile.html";
        userRoleDisplay.style.display = "none";
        activeCoursesEl.textContent = '0';
        completedLessonsEl.textContent = '0';
        streakDaysEl.textContent = '0';
      }
       accountDropdown.style.display = "none"; // Close dropdown on auth change
    });

    /* LOGOUT FUNCTION */
    async function handleLogout() {
      try {
          await signOut(auth);
          console.log("Logout successful");
          sessionStorage.removeItem('adminNotified');
      } catch (error) {
          console.error("Logout failed:", error);
          alert("Logout failed. Please try again.");
      }
    }

    logoutBtn.addEventListener("click", handleLogout);

    /* Load User Data from Firestore */
    async function loadUserData(userId) {
      try {
        const userDocRef = doc(db, "users", userId);
        const userDocSnap = await getDoc(userDocRef);

        if (userDocSnap.exists()) {
          const userData = userDocSnap.data();

          // --- ROLE HANDLING ---
          currentUserRole = userData.role || 'user';

          if (currentUserRole === 'admin') {
            profileLink.href = "admin.html";
            userRoleDisplay.style.display = "flex";

            if (!sessionStorage.getItem('adminNotified')) {
              // Use a more subtle notification method if desired
              // Example: show a temporary banner instead of alert
              // showAdminNotification("Welcome, Admin! Privileges active.");
               alert("Welcome, Admin! You have administrative privileges."); // Keeping alert for now
              sessionStorage.setItem('adminNotified', 'true');
            }
          } else {
            profileLink.href = "profile.html";
            userRoleDisplay.style.display = "none";
          }

          // --- DASHBOARD STATS ---
          activeCoursesEl.textContent = (userData.enrolledCourses && Array.isArray(userData.enrolledCourses)) ? userData.enrolledCourses.length : '0';

          let completedLessons = 0;
          if (userData.enrolledCourses && Array.isArray(userData.enrolledCourses)) {
              userData.enrolledCourses.forEach(course => {
                if (course && typeof course.completedLessons === 'number') {
                  completedLessons += course.completedLessons;
                }
              });
          }
           completedLessonsEl.textContent = completedLessons;


          // --- STUDY STREAK (Logic remains the same) ---
          let currentStreak = 0;
           if (userData.lastLogin && userData.lastLogin.toDate) {
               const lastLogin = userData.lastLogin.toDate();
               const today = new Date();
               const yesterday = new Date(today);
               yesterday.setDate(today.getDate() - 1);

               const lastLoginDate = new Date(lastLogin.getFullYear(), lastLogin.getMonth(), lastLogin.getDate());
               const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
              // const yesterdayDate = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate()); // Not directly needed for diff calculation

               const diffTime = todayDate - lastLoginDate;
               const diffDays = diffTime / (1000 * 60 * 60 * 24);

               const savedStreak = userData.streakDays || 0;

                if (diffDays === 0) { // Logged in again today (or multiple times today)
                     currentStreak = savedStreak > 0 ? savedStreak : 1; // Keep saved streak or start at 1 if it was 0
                 } else if (diffDays === 1) { // Logged in yesterday
                    currentStreak = savedStreak + 1; // Increment streak
                 } else { // Gap in login days
                    currentStreak = 1; // Reset streak to 1 for today's login
                 }
                // Placeholder: Ideally update Firestore with new streak and lastLogin=todayDate here
           } else {
               currentStreak = 1; // First login or no timestamp
           }
           streakDaysEl.textContent = currentStreak;


        } else {
          console.log("No such user document!");
          currentUserRole = 'user';
          profileLink.href = "profile.html";
          userRoleDisplay.style.display = "none";
          // Reset stats explicitly if user doc doesn't exist
          activeCoursesEl.textContent = 'N/A';
          completedLessonsEl.textContent = 'N/A';
          streakDaysEl.textContent = 'N/A';
        }
      } catch (error) {
        console.error("Error loading user data:", error);
        currentUserRole = 'user';
        profileLink.href = "profile.html";
        userRoleDisplay.style.display = "none";
        activeCoursesEl.textContent = 'Error';
        completedLessonsEl.textContent = 'Error';
        streakDaysEl.textContent = 'Error';
      }
    }

  </script>
</body>
</html>
