<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haramaya Jama'aa Home</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ====== PRESERVED CORE STRUCTURE ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: #333;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      transition: all 0.5s cubic-bezier(0.65, 0.05, 0.36, 1);
      /* Adjust body padding to account for static sidebar width if kept */
      padding-left: 280px; /* Width of the sidebar */
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* ====== ENHANCED HEADER ====== */
    header {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between; /* Keeps title centered between logo area (now empty) and account */
      padding: 0.75rem 2rem;
      position: fixed;
      width: 100%; /* Full width */
      top: 0;
      left: 0; /* Align header to the very left */
      z-index: 300;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    /* Removed Hamburger Styles */

    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      flex: 1; /* Allows title to take center space */
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      letter-spacing: 1px;
      background: linear-gradient(to right, #fff 0%, #ffcc00 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      /* Adjust margin if needed to center properly without hamburger */
      margin-left: 50px; /* Add some space on the left if needed */
    }

    /* ====== ENHANCED ACCOUNT DROPDOWN ====== */
    .account-wrapper {
      position: relative;
      cursor: pointer;
      transition: all 0.3s;
    }

    .account-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
      /* Removed background-image placeholder */
      background-size: cover;
      background-position: center;
      border: 3px solid rgba(255,255,255,0.5);
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      /* Styles for the icon inside */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem; /* Adjust icon size */
      color: rgba(255, 255, 255, 0.8); /* Icon color */
    }

    .account-icon:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 0 0 5px rgba(255, 204, 0, 0.5);
      filter: brightness(1.1);
    }
    .account-icon:hover i {
        color: white; /* Icon color on hover */
    }

    .account-dropdown {
      position: absolute;
      top: 65px;
      right: 0;
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      overflow: hidden;
      display: none;
      z-index: 400;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
      min-width: 220px;
      animation: fadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      transform-origin: top right;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .account-dropdown a,
    .account-dropdown div { /* Apply to both links and the role display div */
      color: #333;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      transition: all 0.3s ease-out;
      font-weight: 500;
    }

    /* Style for the role display */
    #user-role-display {
      font-size: 0.9em;
      color: #6a11cb; /* Highlight admin role */
      font-weight: bold;
      background-color: rgba(106, 17, 203, 0.05); /* Subtle background */
      border-bottom: 1px solid rgba(106, 17, 203, 0.1);
    }
    #user-role-display i { /* Icon for the role display */
        color: #6a11cb;
    }


    .account-dropdown a:last-child,
    .account-dropdown div:last-child {
      border-bottom: none;
    }

    .account-dropdown a:hover,
    .account-dropdown div:not(#user-role-display):hover { /* Exclude role display from hover effect */
      background: linear-gradient(to right, rgba(106, 17, 203, 0.1) 0%, rgba(37, 117, 252, 0.1) 100%);
      padding-left: 1.5rem;
      color: #6a11cb;
      transform: translateX(5px);
    }

    .account-dropdown i {
      width: 20px;
      color: #6a11cb;
      text-align: center;
      font-size: 1.1rem;
      transition: all 0.3s;
    }


    /* ====== REPURPOSED SIDEBAR (FOR LOGO ONLY) ====== */
    .sidebar {
      background: linear-gradient(135deg, rgba(42, 39, 79, 0.95) 0%, rgba(37, 117, 252, 0.95) 100%);
      color: #fff;
      position: fixed;
      top: 0; /* Align with top */
      left: 0;
      height: 100%; /* Full height */
      width: 280px; /* Keep original width */
      /* Removed transform - sidebar is always visible */
      transition: none; /* No transition needed */
      overflow-y: auto; /* Allow scrolling if content overflows (e.g., tall logo) */
      z-index: 250;
      box-shadow: 5px 0 30px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255,255,255,0.1);
      padding-top: 80px; /* Add padding to push content below fixed header */
    }

    /* Removed .sidebar.open styles */

    /* Sidebar Header with Logo */
    .sidebar-header {
      padding: 2rem 1rem;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }

    .sidebar-header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(45deg, rgba(106, 17, 203, 0.3) 0%, rgba(37, 117, 252, 0.3) 100%);
      z-index: -1;
    }

    .sidebar-header img {
      max-width: 80%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      transition: all 0.5s;
    }

    .sidebar-header:hover img {
      transform: scale(1.05) rotate(2deg);
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }

    /* Removed sidebar ul, li, dropdown styles */


    /* ====== ENHANCED MAIN CONTENT ====== */
    .content {
      /* margin-top adjusted to account for fixed header */
      margin-top: 70px; /* Height of header */
      /* margin-left removed - body padding handles this */
      margin-left: 0;
      padding: 3rem;
      width: 100%; /* Takes remaining width */
      transition: none; /* No transition needed */
      position: relative;
      z-index: 1;
    }

    /* Removed .content.full and media query adjusting margin-left */

    .content::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://www.transparenttextures.com/patterns/arabesque.png');
      opacity: 0.03;
      z-index: -1;
      pointer-events: none;
    }

    .content h2 {
      color: #2c3e50;
      margin-bottom: 2rem;
      font-size: 2.5rem;
      border-bottom: 3px solid #ffcc00;
      padding-bottom: 0.5rem;
      display: inline-block;
      font-weight: 800;
      text-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }

    .content h2::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50%;
      height: 3px;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      border-radius: 3px;
    }

    .content p {
      line-height: 1.8;
      margin-bottom: 2rem;
      font-size: 1.1rem;
      color: #555;
      max-width: 800px;
    }

    /* ====== ENHANCED DASHBOARD WIDGETS ====== */
    .dashboard-widgets {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .widget {
      background: rgba(255,255,255,0.9);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      border-left: 5px solid #6a11cb;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.3);
    }

    .widget::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(106, 17, 203, 0.05) 0%, rgba(37, 117, 252, 0.05) 100%);
      z-index: -1;
    }

    .widget:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    .widget-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .widget-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #2c3e50;
      position: relative;
    }

    .widget-icon {
      width: 50px;
      height: 50px;
      border-radius: 15px;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
      transition: all 0.3s;
    }

    .widget:hover .widget-icon {
      transform: rotate(15deg) scale(1.1);
    }

    .widget-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: #2c3e50;
      margin: 1rem 0;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .widget-description {
      font-size: 1rem;
      color: #7f8c8d;
      line-height: 1.6;
    }

    /* Floating particles decoration */
    .particle {
      position: absolute;
      background: rgba(106, 17, 203, 0.1);
      border-radius: 50%;
      pointer-events: none;
      z-index: -1; /* Ensure particles are behind content */
    }


    /* ====== PRESERVED RESPONSIVENESS (Simplified) ====== */
    @media (max-width: 992px) { /* Adjust breakpoint if sidebar width changes */
        body {
             padding-left: 0; /* Remove sidebar padding on smaller screens */
        }
        .sidebar {
            transform: translateX(-100%); /* Hide sidebar off-screen */
            /* Optionally add a button to toggle sidebar visibility on mobile if needed */
        }
        .content {
            /* Content takes full width */
        }
         .header-title {
             margin-left: 0; /* Center title properly when sidebar is hidden */
         }
    }

    @media (max-width: 768px) {
      .content {
        padding: 2rem;
      }
      .dashboard-widgets {
        grid-template-columns: 1fr;
      }
      .widget {
        padding: 1.5rem;
      }
    }

    /* ====== DARK THEME STYLES ====== */
    body.dark {
      background: linear-gradient(135deg, #121212 0%, #1a1a1a 100%);
      color: #eee;
    }
    body.dark header {
      background: linear-gradient(135deg, #000 0%, #222 100%);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    body.dark .sidebar { /* Dark theme for sidebar */
      background: linear-gradient(135deg, rgba(30, 30, 40, 0.95) 0%, rgba(50, 50, 70, 0.95) 100%);
      border-right: 1px solid rgba(255,255,255,0.1);
    }
    body.dark .sidebar-header {
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    body.dark .sidebar-header::before {
       background: linear-gradient(45deg, rgba(106, 17, 203, 0.1) 0%, rgba(37, 117, 252, 0.1) 100%);
    }
    body.dark .content { color: #ddd; }
    body.dark .content h2 { color: #fff; }
    body.dark .content p { color: #bbb; }
    body.dark .widget {
      background: rgba(30, 30, 40, 0.8);
      color: #eee;
      border-left: 5px solid #9b59b6; /* Dark theme accent */
      border: 1px solid rgba(255,255,255,0.1);
    }
    body.dark .widget::before {
         background: linear-gradient(135deg, rgba(155, 89, 182, 0.05) 0%, rgba(88, 122, 214, 0.05) 100%);
    }
    body.dark .widget-title { color: #fff; }
    body.dark .widget-value {
         background: linear-gradient(135deg, #9b59b6 0%, #587ad6 100%);
         -webkit-background-clip: text;
         -webkit-text-fill-color: transparent;
    }
    body.dark .widget-description { color: #aaa; }
    body.dark .account-icon {
        background: linear-gradient(135deg, #444 0%, #666 100%);
        border: 3px solid rgba(255,255,255,0.3);
        color: rgba(255, 255, 255, 0.7);
    }
     body.dark .account-icon:hover i {
         color: white;
     }
    body.dark .account-dropdown {
      background: rgba(30, 30, 40, 0.95);
      color: #eee;
      border: 1px solid rgba(255,255,255,0.1);
    }
    body.dark .account-dropdown a,
    body.dark .account-dropdown div {
      color: #eee;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
     body.dark #user-role-display {
        color: #bb86fc; /* Dark theme admin color */
        background-color: rgba(187, 134, 252, 0.08);
        border-bottom: 1px solid rgba(187, 134, 252, 0.1);
    }
    body.dark #user-role-display i {
        color: #bb86fc;
    }
    body.dark .account-dropdown a:hover,
    body.dark .account-dropdown div:not(#user-role-display):hover {
      color: #ffcc00;
       background: rgba(255, 255, 255, 0.05);
    }
    body.dark .account-dropdown i { color: #ffcc00; }
     body.dark .particle {
        background: rgba(187, 134, 252, 0.05); /* Dark theme particles */
     }


    /* Floating animation for widgets */
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    .widget:nth-child(1) { animation: float 6s ease-in-out infinite; }
    .widget:nth-child(2) { animation: float 6s ease-in-out infinite 1s; }
    .widget:nth-child(3) { animation: float 6s ease-in-out infinite 2s; }

    /* Theme toggle button */
    .theme-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 500;
      transition: all 0.3s;
    }
    .theme-toggle:hover {
      transform: scale(1.1) rotate(30deg);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    /* Loading animation */
    .loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s, visibility 0.5s;
    }
    .loading-circle {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="loading-circle"></div>
  </div>

  <header>
    <div style="width: 50px;"></div> <div class="header-title" id="header-title">Haramaya Jama'aa Home</div>
    <div class="account-wrapper" id="account-btn">
       <div class="account-icon" id="account-img">
          <i class="fas fa-user"></i>
      </div>
      <div class="account-dropdown" id="account-dropdown">
        <div id="not-logged-in">
          <a href="login.html"><i class="fas fa-sign-in-alt"></i> Log In</a>
          <a href="explore.html"><i class="fas fa-compass"></i> Explore Courses</a>
        </div>
        <div id="logged-in" style="display: none;">
          <div id="user-role-display" style="display: none;">
             <i class="fas fa-shield-halved"></i> <span id="role-text">Admin</span>
          </div>
          <a href="profile.html" id="profile-link"><i class="fas fa-user-circle"></i> My Profile</a>
          <a href="dashboard.html"><i class="fas fa-book-open"></i> Enrollment</a>
          <a href="progress.html"><i class="fas fa-chart-line"></i> Progression</a>
          <a href="interact.html"><i class="fas fa-comments"></i> Interact</a>
          <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </div>
  </header>

  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
       <img src="haramaya.png" alt="Haramaya Logo">
    </div>
    </nav>

  <div class="content" id="content">
    <h2>Welcome to Haramaya Jama'aa Group</h2>
    <p>This is the home page for Haramaya University Jama'aa students. Use the account menu to access your profile and other sections. Enjoy the experience!</p>

    <div class="dashboard-widgets">
      <div class="widget">
        <div class="widget-header">
          <h3 class="widget-title">Active Courses</h3>
          <div class="widget-icon"><i class="fas fa-book-open"></i></div>
        </div>
        <div class="widget-value" id="active-courses">0</div>
        <p class="widget-description">Courses you're currently enrolled in</p>
      </div>

      <div class="widget">
        <div class="widget-header">
          <h3 class="widget-title">Completed Lessons</h3>
          <div class="widget-icon"><i class="fas fa-check-circle"></i></div>
        </div>
        <div class="widget-value" id="completed-lessons">0</div>
        <p class="widget-description">Lessons you've completed</p>
      </div>

      <div class="widget">
        <div class="widget-header">
          <h3 class="widget-title">Study Streak</h3>
          <div class="widget-icon"><i class="fas fa-fire"></i></div>
        </div>
        <div class="widget-value" id="streak-days">0</div>
        <p class="widget-description">Consecutive days of learning</p>
      </div>
    </div>
  </div>

  <div class="theme-toggle" id="theme-toggle">
    <i class="fas fa-moon"></i>
  </div>

  <script type="module">
    // Firebase modules.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    // Firebase config – replace with your Firebase project configuration.
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY", // Replace with your actual API key
        authDomain: "YOUR_AUTH_DOMAIN",
        databaseURL: "YOUR_DATABASE_URL", // Optional for RTDB
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
        measurementId: "YOUR_MEASUREMENT_ID" // Optional
    };


    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth();
    const db = getFirestore(app);

    // --- Global Variables ---
    let currentUserRole = null; // To store the user's role

    // --- DOM Elements ---
    const loadingScreen = document.getElementById('loading');
    const themeToggle = document.getElementById('theme-toggle');
    const accountBtn = document.getElementById("account-btn");
    const accountDropdown = document.getElementById("account-dropdown");
    const notLoggedInDiv = document.getElementById("not-logged-in");
    const loggedInDiv = document.getElementById("logged-in");
    const logoutBtn = document.getElementById("logout-btn");
    // const settingsLogoutBtn = document.getElementById("settings-logout-btn"); // Removed from HTML
    const profileLink = document.getElementById("profile-link");
    const userRoleDisplay = document.getElementById("user-role-display");
    const activeCoursesEl = document.getElementById("active-courses");
    const completedLessonsEl = document.getElementById("completed-lessons");
    const streakDaysEl = document.getElementById("streak-days");


    // --- Initial Setup ---

    // Hide loading screen
    setTimeout(() => {
      loadingScreen.style.opacity = '0';
      loadingScreen.style.visibility = 'hidden';
    }, 1500);

    // Create floating particles
    function createParticles() {
      const colorsLight = ['rgba(106, 17, 203, 0.1)', 'rgba(37, 117, 252, 0.1)', 'rgba(255, 204, 0, 0.1)'];
      const colorsDark = ['rgba(187, 134, 252, 0.05)', 'rgba(88, 122, 214, 0.08)', 'rgba(255, 204, 0, 0.05)'];
      const isDark = document.body.classList.contains('dark');
      const colors = isDark ? colorsDark : colorsLight;

      // Clear existing particles if any
      document.querySelectorAll('.particle').forEach(p => p.remove());

      for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');

        const size = Math.random() * 20 + 5;
        const posX = Math.random() * 100;
        const posY = Math.random() * 100;
        const color = colors[Math.floor(Math.random() * colors.length)];
        const duration = Math.random() * 20 + 10;
        const delay = Math.random() * 5;

        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${posX}%`;
        particle.style.top = `${posY}%`;
        particle.style.background = color;
        particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;

        document.body.appendChild(particle);
      }
    }


    // Theme toggle functionality
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');

      if (isDark) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        themeToggle.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        themeToggle.style.background = 'linear-gradient(135deg, #6a11cb 0%, #2575fc 100%)';
      }
      // Recreate particles with appropriate theme colors
      createParticles();
    });

    // Initialize particles on load
    createParticles();


    /* SIDEBAR TOGGLE REMOVED */

    /* ACCOUNT DROPDOWN */
    accountBtn.addEventListener("click", (e) => {
      e.stopPropagation(); // Prevent click from immediately closing dropdown
      accountDropdown.style.display = (accountDropdown.style.display === "block") ? "none" : "block";
    });

    // Close dropdown if clicking outside
    document.addEventListener("click", (e) => {
      if (!accountBtn.contains(e.target) && !accountDropdown.contains(e.target)) {
        accountDropdown.style.display = "none";
      }
    });

    /* AUTHENTICATION */
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loggedInDiv.style.display = "block";
        notLoggedInDiv.style.display = "none";
        loadUserData(user.uid); // Load data and handle role logic
      } else {
        loggedInDiv.style.display = "none";
        notLoggedInDiv.style.display = "block";
        currentUserRole = null; // Reset role on logout
        // Reset UI elements that depend on user data/role
        profileLink.href = "profile.html";
        userRoleDisplay.style.display = "none";
        activeCoursesEl.textContent = '0';
        completedLessonsEl.textContent = '0';
        streakDaysEl.textContent = '0';
      }
      // Close dropdown after auth state changes
       accountDropdown.style.display = "none";
    });

    /* LOGOUT FUNCTION */
    async function handleLogout() {
      // Optional: confirmation prompt
      // if (!confirm("Are you sure you want to logout?")) {
      //   return;
      // }
      try {
          await signOut(auth);
          // Redirect happens via onAuthStateChanged listener
          console.log("Logout successful");
          // Clear session storage flag on logout
          sessionStorage.removeItem('adminNotified');
      } catch (error) {
          console.error("Logout failed:", error);
          alert("Logout failed. Please try again.");
      }
    }

    logoutBtn.addEventListener("click", handleLogout);
    // settingsLogoutBtn removed


    /* SIDEBAR DROPDOWN TOGGLERS REMOVED */


    /* Load User Data from Firestore */
    async function loadUserData(userId) {
      try {
        const userDocRef = doc(db, "users", userId);
        const userDocSnap = await getDoc(userDocRef);

        if (userDocSnap.exists()) {
          const userData = userDocSnap.data();

          // --- ROLE HANDLING ---
          currentUserRole = userData.role || 'user'; // Default to 'user' if role is not set

          if (currentUserRole === 'admin') {
            profileLink.href = "admin.html"; // Change link for admins
            userRoleDisplay.style.display = "flex"; // Show role display

            // One-time admin notification per session
            if (!sessionStorage.getItem('adminNotified')) {
              alert("Welcome, Admin! You have administrative privileges.");
              sessionStorage.setItem('adminNotified', 'true');
            }
          } else {
            profileLink.href = "profile.html"; // Standard profile link
            userRoleDisplay.style.display = "none"; // Hide role display
          }

          // --- DASHBOARD STATS ---
          if (userData.enrolledCourses && Array.isArray(userData.enrolledCourses)) {
             activeCoursesEl.textContent = userData.enrolledCourses.length;

            let completedLessons = 0;
            userData.enrolledCourses.forEach(course => {
              // Ensure course and completedLessons are valid before adding
              if (course && typeof course.completedLessons === 'number') {
                completedLessons += course.completedLessons;
              }
            });
            completedLessonsEl.textContent = completedLessons;
          } else {
             activeCoursesEl.textContent = '0';
             completedLessonsEl.textContent = '0';
          }

          // --- STUDY STREAK (Basic Example) ---
          let currentStreak = 0;
          if (userData.lastLogin && userData.lastLogin.toDate) { // Check if lastLogin is a Firebase Timestamp
            const lastLogin = userData.lastLogin.toDate();
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

             // Normalize dates to compare day, month, year only
            const lastLoginDate = new Date(lastLogin.getFullYear(), lastLogin.getMonth(), lastLogin.getDate());
            const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const yesterdayDate = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());

            const diffTime = todayDate - lastLoginDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);

            if (diffDays === 0) { // Logged in again today
                currentStreak = userData.streakDays || 0; // Continue streak from saved value
            } else if (diffDays === 1) { // Logged in yesterday
                currentStreak = (userData.streakDays || 0) + 1; // Increment streak
            } else { // Gap in login days
                currentStreak = 1; // Reset streak to 1 for today's login
            }

            // Note: You'd typically update the streak and lastLogin in Firestore here
            // For now, just displaying the calculated potential streak
             streakDaysEl.textContent = currentStreak;

          } else {
              // If no lastLogin or streak, start streak at 1 for this login
              streakDaysEl.textContent = 1;
          }


        } else {
          console.log("No such user document!");
          // Handle case where user exists in Auth but not Firestore
          currentUserRole = 'user';
          profileLink.href = "profile.html";
          userRoleDisplay.style.display = "none";
        }
      } catch (error) {
        console.error("Error loading user data:", error);
        // Set defaults in case of error
        currentUserRole = 'user';
        profileLink.href = "profile.html";
        userRoleDisplay.style.display = "none";
        activeCoursesEl.textContent = 'Error';
        completedLessonsEl.textContent = 'Error';
        streakDaysEl.textContent = 'Error';
      }
    }

  </script>
</body>
</html>
