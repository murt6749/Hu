<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Support Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Basic Setup & Variables (reuse from previous CSS) --- */
        :root {
            --primary: #4361ee; /* Blue */
            --primary-dark: #3a56d4;
            --secondary: #3f37c9; /* Darker Blue/Purple */
            --success: #198754; /* Green */
            --danger: #dc3545;  /* Red */
            --warning: #ffc107; /* Yellow */
            --info: #0dcaf0;   /* Cyan */
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --white: #ffffff;
            --header-height: 60px;
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5; /* Slightly different background */
            color: var(--dark);
            line-height: 1.6;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; } /* Wider container */

        /* --- Header --- */
        .header {
            background-color: var(--dark); /* Admin header */
            color: white;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: var(--header-height);
        }
        .header-left h1 { font-size: 1.5rem; margin: 0; display: flex; align-items: center; gap: 0.5rem; }
        .header-right { display: flex; align-items: center; gap: 1.5rem; }
        .user-info { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;}
        .user-info i { font-size: 1.2rem; }
        .nav-buttons { display: flex; gap: 1rem; }

        /* --- Buttons --- */
        .btn {
            padding: 0.5rem 1rem; border-radius: 5px; border: none; cursor: pointer;
            font-weight: 500; transition: var(--transition); display: inline-flex;
            align-items: center; gap: 0.5rem; text-decoration: none; color: white;
        }
        .btn-sm { padding: 0.3rem 0.8rem; font-size: 0.9rem; }
        .btn-primary { background-color: var(--primary); }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--gray); }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #157347; }
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover { background-color: #bb2d3b; }
        .btn-warning { background-color: var(--warning); color: var(--dark);}
        .btn-warning:hover { background-color: #ffca2c;}
        .btn-light { background-color: var(--gray-light); color: var(--dark); border: 1px solid #ccc;}
        .btn-light:hover { background-color: #dee2e6; }

        /* --- Admin Content Area --- */
        .admin-panel {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-top: 2rem;
        }
        .admin-panel h2 { color: var(--dark); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;}

        /* --- Filters & Search --- */
         .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-light);
        }
        .filter-group, .search-group { display: flex; align-items: center; gap: 0.5rem; }
        .search-group input, .filter-group select {
             padding: 0.5rem 0.75rem;
             border: 1px solid #ccc;
             border-radius: 5px;
             font-size: 0.95rem;
        }
        .search-group input { min-width: 250px; }
        .filter-group select { min-width: 150px; }

        /* --- Ticket Table --- */
        .tickets-table-container { overflow-x: auto; } /* For responsiveness */
        .tickets-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .tickets-table th, .tickets-table td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
            vertical-align: middle;
        }
        .tickets-table th {
            background-color: var(--light);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--gray);
        }
        .tickets-table td { font-size: 0.95rem; }
        .tickets-table tr:hover { background-color: #f8f9fa; }

        .ticket-subject { font-weight: 500; color: var(--primary); }
        .ticket-email { color: var(--secondary); font-size: 0.9rem;}
        .ticket-status-badge {
            padding: 0.2rem 0.6rem; border-radius: 15px; font-size: 0.8rem;
            font-weight: 600; text-transform: capitalize; border: 1px solid transparent;
            display: inline-block; min-width: 70px; text-align: center;
        }
        /* Reusing status colors from user page, adjusted */
        .status-open { background-color: #e0f7fa; color: #00796b; border-color: #b2ebf2; }
        .status-pending { background-color: #fff9c4; color: #f57f17; border-color: #fff176; }
        .status-resolved { background-color: #dcedc8; color: #33691e; border-color: #c5e1a5;}
        .status-closed { background-color: #f1f1f1; color: #616161; border-color: #e0e0e0;}

        .priority-badge {
            font-size: 0.8rem; padding: 0.1rem 0.5rem; border-radius: 4px;
            text-transform: capitalize; font-weight: 500;
        }
        .priority-low { background-color: #cfe2ff; color: #0a367e;}
        .priority-medium { background-color: #fff3cd; color: #664d03;}
        .priority-high { background-color: #f8d7da; color: #58151c;}
        .priority-urgent { background-color: #f72585; color: white;}


        .actions-cell button { margin-right: 0.5rem; }

        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1050;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Dim background */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* Centered */
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px; /* Max width */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(-20px)} to {opacity: 1; transform: translateY(0)} }

        .modal-header {
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { margin: 0; color: var(--primary); }
        .modal-close {
            color: #aaa; font-size: 28px; font-weight: bold;
            background: none; border: none; cursor: pointer;
        }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }

        .modal-body { padding: 20px 0; }
        .modal-body .detail-item { margin-bottom: 1rem; }
        .modal-body .detail-item strong {
             display: inline-block;
             width: 100px; /* Fixed width for label */
             color: var(--gray);
             font-weight: 500;
        }
         .modal-body .message-box, .modal-body .response-box {
             background-color: var(--light);
             border: 1px solid #ddd;
             border-radius: 5px;
             padding: 10px;
             margin-top: 0.5rem;
             max-height: 150px; /* Scrollable */
             overflow-y: auto;
             white-space: pre-wrap; /* Preserve line breaks */
             word-wrap: break-word;
         }

        .modal-footer {
            padding-top: 15px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            align-items: center;
        }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control {
            width: 100%; padding: 0.75rem; border: 1px solid #ccc;
            border-radius: 5px; font-size: 1rem;
        }
        textarea.form-control { min-height: 100px; resize: vertical; }

        /* --- Loading / No Data --- */
        .loading-indicator, .no-data-message {
            text-align: center; padding: 3rem; color: var(--gray);
        }
        .loading-indicator i { font-size: 2rem; margin-bottom: 1rem; display: block;}

        /* --- Toast --- */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            padding: 1rem 1.5rem; background-color: var(--dark); color: white;
            border-radius: 5px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1100; opacity: 0; transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            max-width: 350px;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-success { background-color: var(--success); }
        .toast-danger { background-color: var(--danger); }
        .toast-warning { background-color: var(--warning); color: var(--dark); }
        .toast-info { background-color: var(--info); }

        /* --- Responsive --- */
        @media (max-width: 992px) {
             .controls-bar { flex-direction: column; align-items: stretch; }
             .filter-group, .search-group { width: 100%; }
             .search-group input { width: auto; flex-grow: 1;}
        }
         @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header { flex-direction: column; gap: 1rem; padding: 1rem; height: auto; }
            .header-left, .header-right { width: 100%; justify-content: space-between;}
            .admin-panel { padding: 1rem; }
            .modal-content { width: 90%; margin: 10% auto;}
            .tickets-table { font-size: 0.9rem; }
            .tickets-table th, .tickets-table td { padding: 0.6rem 0.8rem; }
            .tickets-table th:nth-child(3), /* Hide email on small screens */
            .tickets-table td:nth-child(3),
            .tickets-table th:nth-child(5), /* Hide Date */
            .tickets-table td:nth-child(5) { display: none; }
         }
          @media (max-width: 480px) {
             .nav-buttons { flex-direction: column; width: 100%; align-items: stretch; }
             .nav-buttons .btn { justify-content: center;}
             .modal-footer { flex-direction: column; align-items: stretch;}
          }

    </style>
</head>
<body>
    <div id="auth-layer" style="padding: 2rem; text-align: center;">
        <p>Verifying access...</p>
        <i class="fas fa-spinner fa-spin fa-2x"></i>
    </div>

    <div id="admin-content" style="display: none;"> <header class="header">
            <div class="header-left">
                 <h1><i class="fas fa-user-shield"></i> Admin Support Panel</h1>
            </div>
            <div class="header-right">
                 <div id="adminUserInfo" class="user-info">
                    </div>
                 <nav class="nav-buttons">
                     <a href="index.html" class="btn btn-light btn-sm">
                         <i class="fas fa-home"></i> Home
                     </a>
                     <a href="support.html" class="btn btn-primary btn-sm"> <i class="fas fa-headset"></i> User View
                     </a>
                 </nav>
            </div>
        </header>

        <div class="container">
            <div class="admin-panel">
                <h2><i class="fas fa-tasks"></i> Manage Support Tickets</h2>

                <div class="controls-bar">
                    <div class="filter-group">
                        <label for="adminStatusFilter"><i class="fas fa-filter"></i> Status:</label>
                        <select id="adminStatusFilter" class="form-control">
                            <option value="all">All Statuses</option>
                            <option value="open">Open</option>
                            <option value="pending">Pending</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div class="search-group">
                       <label for="adminTicketSearch"><i class="fas fa-search"></i> Search:</label>
                       <input type="text" id="adminTicketSearch" placeholder="Search Subject or User Email...">
                    </div>
                </div>

                <div class="tickets-table-container">
                    <table class="tickets-table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>User Email</th>
                                <th>Priority</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminTicketsContainer">
                            <tr class="loading-indicator">
                                <td colspan="6">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading tickets...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="ticketDetailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTicketSubject">Ticket Details</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalTicketId"> <div class="detail-item"><strong>Ticket ID:</strong> <span id="modalTicketIdDisplay"></span></div>
                    <div class="detail-item"><strong>User Email:</strong> <span id="modalUserEmail"></span></div>
                    <div class="detail-item"><strong>Created:</strong> <span id="modalCreatedAt"></span></div>
                    <div class="detail-item"><strong>Priority:</strong> <span id="modalPriority"></span></div>
                    <div class="detail-item">
                        <strong>Message:</strong>
                        <div id="modalTicketMessage" class="message-box"></div>
                    </div>

                    <hr style="margin: 1.5rem 0;">

                    <h4>Admin Response</h4>
                    <div class="form-group">
                        <label for="adminResponseText">Your Response:</label>
                        <textarea id="adminResponseText" class="form-control" placeholder="Enter your response here..."></textarea>
                        <small id="modalLastResponse" style="color: var(--gray); margin-top: 5px; display: block;"></small>
                    </div>
                    <div class="form-group">
                         <label for="adminUpdateStatus">Update Status:</label>
                         <select id="adminUpdateStatus" class="form-control">
                            <option value="open">Open</option>
                            <option value="pending">Pending</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-success" onclick="saveTicketChanges()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div> <div id="toast" class="toast"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        // IMPORTANT: MOVE TO SECURE CONFIGURATION IN PRODUCTION
        const firebaseConfig = {
           apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo", // Replace with your actual config
           authDomain: "pharma-quiz-b5a07.firebaseapp.com",
           databaseURL: "https://pharma-quiz-b5a07-default-rtdb.firebaseio.com",
           projectId: "pharma-quiz-b5a07",
           storageBucket: "pharma-quiz-b5a07.appspot.com",
           messagingSenderId: "161067776789",
           appId: "1:161067776789:web:88b8a61145dc5f5c31471c",
           measurementId: "G-3QRQE9HQFB"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authLayer = document.getElementById('auth-layer');
        const adminContent = document.getElementById('admin-content');
        const adminTicketsContainer = document.getElementById('adminTicketsContainer');
        const adminUserInfoDiv = document.getElementById('adminUserInfo');
        const statusFilter = document.getElementById('adminStatusFilter');
        const ticketSearch = document.getElementById('adminTicketSearch');
        const toast = document.getElementById('toast');
        const modal = document.getElementById('ticketDetailModal');
        const modalTicketId = document.getElementById('modalTicketId'); // Hidden input
        const modalTicketIdDisplay = document.getElementById('modalTicketIdDisplay');
        const modalTicketSubject = document.getElementById('modalTicketSubject');
        const modalUserEmail = document.getElementById('modalUserEmail');
        const modalCreatedAt = document.getElementById('modalCreatedAt');
        const modalPriority = document.getElementById('modalPriority');
        const modalTicketMessage = document.getElementById('modalTicketMessage');
        const modalLastResponse = document.getElementById('modalLastResponse');
        const adminResponseText = document.getElementById('adminResponseText');
        const adminUpdateStatus = document.getElementById('adminUpdateStatus');


        // --- Global State ---
        let currentAdminUser = null;
        let allTicketsCache = []; // Cache tickets locally for faster filtering/searching

        // --- Authentication & Authorization ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const isAdmin = await checkAdminRole(user);
                if (isAdmin) {
                    currentAdminUser = user;
                    updateAdminUserInfo(user);
                    authLayer.style.display = 'none'; // Hide verification message
                    adminContent.style.display = 'block'; // Show admin content
                    setupAdminEventListeners();
                    loadAllTickets(); // Initial load
                } else {
                    // Logged in but not admin
                    authLayer.innerHTML = `<p style="color: var(--danger);">Access Denied. You do not have admin privileges.</p><a href="index.html">Go Home</a>`;
                }
            } else {
                // Not logged in
                 authLayer.innerHTML = `<p style="color: var(--danger);">Access Denied. Please log in as an admin.</p><a href="login.html">Go to Login</a>`;
                // Optionally redirect: window.location.href = 'login.html';
            }
        });

        async function checkAdminRole(user) {
            // *** THIS IS A CLIENT-SIDE CHECK FOR UI ONLY ***
            // *** SERVER-SIDE SECURITY VIA FIRESTORE RULES IS MANDATORY ***
            if (!user) return false;
            const userRef = doc(db, "users", user.uid); // Assuming user doc ID is user.uid
             // Alternative: Query by email if doc ID is not UID
             // const q = query(collection(db, "users"), where("email", "==", user.email));
             // const querySnapshot = await getDocs(q);
             // if (querySnapshot.empty) return false;
             // const userRef = querySnapshot.docs[0].ref;

            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists() && docSnap.data().role === 'admin') {
                     console.log("Admin access verified for:", user.email);
                     return true;
                } else {
                     console.warn("User is not an admin or user document not found:", user.email);
                     return false;
                }
            } catch (error) {
                console.error("Error checking admin role:", error);
                showToast("Error verifying admin status.", "danger");
                return false;
            }
        }

        function updateAdminUserInfo(user) {
            const displayName = user.displayName || user.email;
            adminUserInfoDiv.innerHTML = `
                <i class="fas fa-user-cog"></i> <span>${escapeHTML(displayName)}</span>
            `;
        }

        // --- Event Listeners ---
        function setupAdminEventListeners() {
            statusFilter.addEventListener('change', filterAndRenderTickets);
            ticketSearch.addEventListener('input', debounce(filterAndRenderTickets, 500));
            // Click outside modal to close
            window.addEventListener('click', (event) => {
                if (event.target == modal) {
                    closeModal();
                }
            });
        }

         // Debounce function
         function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
         }


        // --- Load All Tickets ---
        async function loadAllTickets() {
             adminTicketsContainer.innerHTML = `<tr class="loading-indicator"><td colspan="6"><i class="fas fa-spinner fa-spin"></i><p>Loading tickets...</p></td></tr>`;
             allTicketsCache = []; // Clear cache

             try {
                 const ticketsQuery = query(
                     collection(db, "supportTickets"),
                     orderBy("createdAt", "desc") // Fetch newest first
                     // Add more server-side filtering if needed, e.g., by status
                     // where("status", "!=", "closed") // Example: exclude closed tickets initially
                 );
                 const querySnapshot = await getDocs(ticketsQuery);

                 querySnapshot.forEach((doc) => {
                     allTicketsCache.push({ id: doc.id, ...doc.data() });
                 });

                 filterAndRenderTickets(); // Render based on default filters
                 console.log(`Loaded ${allTicketsCache.length} tickets.`);


             } catch (error) {
                console.error("Error loading all tickets:", error);
                showToast("Failed to load support tickets.", "danger");
                 adminTicketsContainer.innerHTML = `<tr class="no-data-message"><td colspan="6"><i class="fas fa-exclamation-triangle"></i><p>Could not load tickets. Please refresh.</p></td></tr>`;
             }
        }

        // --- Filter & Render Tickets (using local cache) ---
        function filterAndRenderTickets() {
            const selectedStatus = statusFilter.value;
            const searchTerm = ticketSearch.value.trim().toLowerCase();

            const filteredTickets = allTicketsCache.filter(ticket => {
                 const matchesStatus = selectedStatus === 'all' || ticket.status === selectedStatus;
                 const matchesSearch = !searchTerm ||
                                       ticket.subject.toLowerCase().includes(searchTerm) ||
                                       (ticket.userEmail && ticket.userEmail.toLowerCase().includes(searchTerm)); // Search email too
                 return matchesStatus && matchesSearch;
            });

             renderTicketTable(filteredTickets);
        }


        // --- Render Ticket Table ---
        function renderTicketTable(tickets) {
             adminTicketsContainer.innerHTML = ''; // Clear existing rows or loading indicator

             if (tickets.length === 0) {
                 adminTicketsContainer.innerHTML = `<tr class="no-data-message"><td colspan="6"><i class="fas fa-inbox"></i><p>No tickets found matching your criteria.</p></td></tr>`;
                 return;
             }

             tickets.forEach(ticket => {
                 const tr = document.createElement('tr');
                 tr.dataset.ticketId = ticket.id;

                 const createdAt = ticket.createdAt?.toDate ? ticket.createdAt.toDate().toLocaleDateString() : 'N/A';
                 const statusClass = `status-${ticket.status || 'open'}`;
                 const priorityClass = `priority-${ticket.priority || 'medium'}`;

                 tr.innerHTML = `
                     <td><span class="ticket-subject">${escapeHTML(ticket.subject)}</span></td>
                     <td><span class="ticket-status-badge ${statusClass}">${escapeHTML(ticket.status)}</span></td>
                     <td><span class="ticket-email">${escapeHTML(ticket.userEmail || 'N/A')}</span></td>
                     <td><span class="priority-badge ${priorityClass}">${escapeHTML(ticket.priority)}</span></td>
                     <td>${createdAt}</td>
                     <td class="actions-cell">
                         <button class="btn btn-primary btn-sm" onclick="openTicketModal('${ticket.id}')">
                             <i class="fas fa-eye"></i> View/Edit
                         </button>
                         </td>
                 `;
                 adminTicketsContainer.appendChild(tr);
             });
        }

        // --- Modal Logic ---
        window.openTicketModal = function(ticketId) {
            const ticket = allTicketsCache.find(t => t.id === ticketId);
            if (!ticket) {
                showToast("Could not find ticket details.", "danger");
                return;
            }

            modalTicketId.value = ticket.id; // Store ID in hidden input
            modalTicketIdDisplay.textContent = ticket.id;
            modalTicketSubject.textContent = escapeHTML(ticket.subject);
            modalUserEmail.textContent = escapeHTML(ticket.userEmail || 'N/A');
            modalCreatedAt.textContent = ticket.createdAt?.toDate ? ticket.createdAt.toDate().toLocaleString() : 'N/A';
            modalPriority.textContent = escapeHTML(ticket.priority);
            modalTicketMessage.textContent = escapeHTML(ticket.message); // Display message safely

            // Handle existing response
            adminResponseText.value = ticket.response || ''; // Populate response textarea
            if (ticket.response && ticket.respondedAt?.toDate) {
                 modalLastResponse.textContent = `Last response: ${ticket.respondedAt.toDate().toLocaleString()}`;
                 modalLastResponse.style.display = 'block';
            } else {
                 modalLastResponse.style.display = 'none';
            }

            adminUpdateStatus.value = ticket.status; // Set current status in dropdown

            modal.style.display = "block"; // Show modal
        }

        window.closeModal = function() {
            modal.style.display = "none";
            // Clear sensitive data from modal form on close (optional but good practice)
            // modalTicketId.value = '';
            // adminResponseText.value = '';
        }

        window.saveTicketChanges = async function() {
             const ticketId = modalTicketId.value;
             if (!ticketId) return;

             const newStatus = adminUpdateStatus.value;
             const newResponse = adminResponseText.value.trim(); // Get response text

             const ticketRef = doc(db, "supportTickets", ticketId);

             try {
                 const dataToUpdate = {
                     status: newStatus,
                     updatedAt: serverTimestamp() // Always update this timestamp
                 };

                 // Only update response fields if a new response was entered or existing one modified
                 const originalTicket = allTicketsCache.find(t => t.id === ticketId);
                 if (newResponse && newResponse !== (originalTicket?.response || '')) {
                     dataToUpdate.response = newResponse;
                     dataToUpdate.respondedAt = serverTimestamp(); // Set response time
                     dataToUpdate.responderId = currentAdminUser.uid; // Optional: track who responded
                     dataToUpdate.responderEmail = currentAdminUser.email; // Optional
                 } else if (!newResponse && originalTicket?.response) {
                      // If admin cleared the response, update it to null
                      dataToUpdate.response = null;
                      dataToUpdate.respondedAt = null; // Clear response time
                 }

                 await updateDoc(ticketRef, dataToUpdate);

                 showToast("Ticket updated successfully!", "success");
                 closeModal();
                 // Update local cache and re-render (more efficient than full reload)
                 const index = allTicketsCache.findIndex(t => t.id === ticketId);
                 if (index > -1) {
                      // Merge updated data (approximate, fetch fresh doc for perfect sync if needed)
                      allTicketsCache[index] = {
                           ...allTicketsCache[index], // Keep original data
                           ...dataToUpdate, // Overwrite with updates
                           respondedAt: dataToUpdate.respondedAt ? Timestamp.now() : allTicketsCache[index].respondedAt, // Estimate timestamp
                           updatedAt: Timestamp.now()
                      };
                      filterAndRenderTickets(); // Re-render the table with updated cache
                 } else {
                      loadAllTickets(); // Fallback to full reload if cache update fails
                 }


             } catch (error) {
                 console.error("Error updating ticket:", error);
                 showToast("Failed to update ticket. Please try again.", "danger");
             }
        }


        // --- Toast Notifications ---
        let toastTimeout;
        function showToast(message, type = 'info') {
             clearTimeout(toastTimeout);
             toast.textContent = message;
             toast.className = `toast toast-${type}`;
             toast.offsetHeight; // Trigger reflow
             toast.classList.add('show');
             toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3500); // Longer display time
        }

        // --- Utility Function ---
        function escapeHTML(str) {
             if (str === null || str === undefined) return '';
             return String(str).replace(/[&<>"']/g, function (match) {
                 return {
                     '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                 }[match];
             });
        }

    </script>
</body>
</html>
