<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <style>
        /* --- Variables --- */
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56d4;
            --secondary-color: #3f37c9;
            --danger-color: #f72585;
            --danger-hover: #e5177b;
            --success-color: #4cc9f0;
            --success-hover: #2fb5e0;
            --warning-color: #f8961e;
            --warning-hover: #e68a1a;
            --info-color: #4895ef;
            --info-hover: #3a7bc8;
            --dark-color: #212529;
            --light-color: #f8f9fa;
            --gray-color: #6c757d;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --sidebar-width: 250px;
        }

        /* --- Dark Mode Variables --- */
        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #f5f5f5;
            --text-muted: #b0b0b0;
            --border-color: #333;
            --table-header: #2a2a2a;
            --table-row: #252525;
            --table-row-hover: #333;
            --input-bg: #2a2a2a;
            --input-border: #444;
            --nav-bg: #1a1a1a;
        }

        [data-theme="light"] {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --table-header: #e9ecef;
            --table-row: #ffffff;
            --table-row-hover: #f1f1f1;
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --nav-bg: #343a40;
        }

        /* --- Base Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        button, input, select, textarea {
            font-family: inherit;
            font-size: inherit;
        }

        /* --- Layout --- */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--nav-bg);
            color: white;
            position: fixed;
            height: 100vh;
            padding: 20px 0;
            transition: var(--transition);
            z-index: 100;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: var(--transition);
            padding: 20px;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* --- Navigation --- */
        .nav-menu {
            list-style: none;
            padding: 0;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--primary-color);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--primary-color);
            font-weight: 600;
        }

        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .nav-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin: 15px 20px;
        }

        /* --- Cards --- */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* --- Tables --- */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--card-bg);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--table-header);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr {
            background-color: var(--table-row);
            transition: var(--transition);
        }

        tr:hover {
            background-color: var(--table-row-hover);
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius);
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
        }

        .btn i {
            margin-right: 5px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-hover);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--success-hover);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: var(--warning-hover);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: var(--info-hover);
        }

        .btn-secondary {
            background-color: var(--gray-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-outline:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* --- Badges --- */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }

        .badge-success {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success-color);
        }

        .badge-danger {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
        }

        .badge-warning {
            background-color: rgba(248, 150, 30, 0.1);
            color: var(--warning-color);
        }

        /* --- Alerts --- */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .alert i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .alert-success {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .alert-danger {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .alert-warning {
            background-color: rgba(248, 150, 30, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
            position: relative;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-muted);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }

        .close:hover {
            color: var(--text-color);
        }

        /* --- Toolbar --- */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .toolbar-item {
            flex: 1;
            min-width: 200px;
        }

        /* --- Checkbox --- */
        .checkbox-container {
            display: block;
            position: relative;
            padding-left: 30px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
        }

        .checkbox-container:hover input ~ .checkmark {
            background-color: var(--table-row-hover);
        }

        .checkbox-container input:checked ~ .checkmark {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .checkbox-container .checkmark:after {
            left: 7px;
            top: 3px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* --- Charts --- */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .slide-in {
            animation: slideIn 0.5s ease forwards;
        }

        .rotate {
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- Loading Spinner --- */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            animation: rotate 1s linear infinite;
            margin: 20px auto;
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .p-10 {
            padding: 10px;
        }

        .p-20 {
            padding: 20px;
        }

        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .gap-10 {
            gap: 10px;
        }

        /* --- Responsive --- */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }

            .sidebar:hover {
                width: var(--sidebar-width);
            }

            .nav-link span {
                display: none;
            }

            .sidebar:hover .nav-link span {
                display: inline;
            }

            .main-content {
                margin-left: 70px;
            }

            .sidebar:hover ~ .main-content {
                margin-left: var(--sidebar-width);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                padding: 0;
            }

            .sidebar.show {
                width: var(--sidebar-width);
                padding: 20px 0;
            }

            .main-content {
                margin-left: 0;
            }

            .toolbar-item {
                min-width: 100%;
            }

            .modal-content {
                max-width: 100%;
            }

            .btn-group {
                flex-direction: column;
                gap: 5px;
            }

            .btn-group .btn {
                width: 100%;
            }
        }

        /* --- Print Styles --- */
        @media print {
            .sidebar, .header-actions, .actions, .no-print {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
                padding: 0;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th, td {
                border: 1px solid #ddd;
                padding: 8px;
            }

            tr:nth-child(even) {
                background-color: #f2f2f2;
            }
        }
    </style>
</head>
<body>
    <div id="auth-status" class="alert alert-info">
        <i class="fas fa-circle-notch rotate"></i> Checking login status...
    </div>

    <div id="login-container" class="card" style="max-width: 500px; margin: 50px auto;">
        <h2 class="card-title text-center">Admin Login</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" required placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" required>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Login</button>
            <div id="login-error" class="alert alert-danger mt-10 hidden"></div>
        </form>
    </div>

    <div id="dashboard-container" class="hidden">
        <div class="sidebar">
            <div class="p-20 text-center">
                <h3>Admin Dashboard</h3>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-target="dashboard" onclick="showSection('dashboard')">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="users" onclick="showSection('users')">
                        <i class="fas fa-users"></i>
                        <span>Users</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="enrollments" onclick="showSection('enrollments')">
                        <i class="fas fa-user-graduate"></i>
                        <span>Enrollments</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="courses" onclick="showSection('courses')">
                        <i class="fas fa-book"></i>
                        <span>Courses</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="requests" onclick="showSection('requests')">
                        <i class="fas fa-envelope"></i>
                        <span>Requests</span>
                    </a>
                </li>
                <li class="nav-divider"></li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="settings" onclick="showSection('settings')">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-title" id="current-section-title">Dashboard</div>
                <div class="header-actions">
                    <button id="theme-toggle" class="btn btn-outline">
                        <i class="fas fa-moon"></i> Dark Mode
                    </button>
                    <button id="logout-button" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Dashboard Overview -->
            <div id="dashboard" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">System Overview</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-10 mb-20">
                            <div class="card" style="flex: 1; min-width: 200px;">
                                <div class="card-body">
                                    <h4 class="text-muted">Total Users</h4>
                                    <h2 id="total-users">0</h2>
                                    <div class="text-success">
                                        <i class="fas fa-arrow-up"></i> <span id="users-change">0%</span> from last month
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="flex: 1; min-width: 200px;">
                                <div class="card-body">
                                    <h4 class="text-muted">Active Courses</h4>
                                    <h2 id="total-courses">0</h2>
                                    <div class="text-success">
                                        <i class="fas fa-arrow-up"></i> <span id="courses-change">0%</span> from last month
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="flex: 1; min-width: 200px;">
                                <div class="card-body">
                                    <h4 class="text-muted">Enrollments</h4>
                                    <h2 id="total-enrollments">0</h2>
                                    <div class="text-success">
                                        <i class="fas fa-arrow-up"></i> <span id="enrollments-change">0%</span> from last month
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="flex: 1; min-width: 200px;">
                                <div class="card-body">
                                    <h4 class="text-muted">Pending Requests</h4>
                                    <h2 id="total-requests">0</h2>
                                    <div class="text-danger">
                                        <i class="fas fa-arrow-down"></i> <span id="requests-change">0%</span> from last month
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex flex-wrap gap-10">
                            <div class="card" style="flex: 2; min-width: 300px;">
                                <div class="card-header">
                                    <h4>Recent Enrollments</h4>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="recent-enrollments-table">
                                            <thead>
                                                <tr>
                                                    <th>User</th>
                                                    <th>Course</th>
                                                    <th>Date</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="4" class="text-center">Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="flex: 1; min-width: 300px;">
                                <div class="card-header">
                                    <h4>User Distribution</h4>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="userDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users" class="section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">User Management</h3>
                        <div class="header-actions">
                            <button onclick="openAddUserModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add User
                            </button>
                            <button id="export-users" class="btn btn-secondary">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="toolbar">
                            <div class="toolbar-item">
                                <label for="filterRole">Role:</label>
                                <select id="filterRole" class="form-control">
                                    <option value="">All Roles</option>
                                    <option value="admin">Admin</option>
                                    <option value="student">Student</option>
                                    <option value="instructor">Instructor</option>
                                </select>
                            </div>
                            <div class="toolbar-item">
                                <label for="filterDepartment">Department:</label>
                                <select id="filterDepartment" class="form-control">
                                    <option value="">All Departments</option>
                                </select>
                            </div>
                            <div class="toolbar-item">
                                <label for="filterCourse">Course:</label>
                                <select id="filterCourse" class="form-control">
                                    <option value="">All Courses</option>
                                </select>
                            </div>
                            <div class="toolbar-item">
                                <label for="searchUsers">Search:</label>
                                <input type="text" id="searchUsers" placeholder="Name, Email, ID..." class="form-control">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="users-table">
                                <thead>
                                    <tr>
                                        <th width="40px">
                                            <input type="checkbox" id="select-all-users" onclick="toggleSelectAll('users')">
                                        </th>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Department</th>
                                        <th>Courses</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="9" class="text-center">Loading users...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-20">
                            <div class="text-muted" id="users-pagination-info">Showing 0 of 0 users</div>
                            <div class="btn-group">
                                <button id="prev-users-page" class="btn btn-outline" disabled>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <button id="next-users-page" class="btn btn-outline" disabled>
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enrollments Section -->
            <div id="enrollments" class="section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Enrollments for <span id="enroll-user"></span></h3>
                        <div class="header-actions">
                            <button onclick="openAddEnrollmentModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Enrollment
                            </button>
                            <button onclick="showSection('users')" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Users
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="toolbar">
                            <div class="toolbar-item">
                                <label for="filterEnrollmentStatus">Status:</label>
                                <select id="filterEnrollmentStatus" class="form-control">
                                    <option value="">All Statuses</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="dropped">Dropped</option>
                                </select>
                            </div>
                            <div class="toolbar-item">
                                <label for="filterEnrollmentDate">Date Range:</label>
                                <select id="filterEnrollmentDate" class="form-control">
                                    <option value="">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <div class="toolbar-item">
                                <label for="searchEnrollments">Search:</label>
                                <input type="text" id="searchEnrollments" placeholder="Course, Status..." class="form-control">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="enroll-table">
                                <thead>
                                    <tr>
                                        <th>Course</th>
                                        <th>Enroll Date</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Score</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center">Select a user to view enrollments</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Courses Section -->
            <div id="courses" class="section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Course Management</h3>
                        <div class="header-actions">
                            <button onclick="openAddCourseModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Course
                            </button>
                            <button id="export-courses" class="btn btn-secondary">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="toolbar">
                            <div class="toolbar-item">
                                <label for="filterCourseType">Type:</label>
                                <select id="filterCourseType" class="form-control">
                                    <option value="">All Types</option>
                                    <option value="online">Online</option>
                                    <option value="in-person">In-Person</option>
                                    <option value="hybrid">Hybrid</option>
                                </select>
                            </div>
                            <div class="toolbar-item">
                                <label for="filterCourseLanguage">Language:</label>
                                <select id="filterCourseLanguage" class="form-control">
                                    <option value="">All Languages</option>
                                </select>
                            </div>
                            <div class="toolbar-item">
                                <label for="searchCourses">Search:</label>
                                <input type="text" id="searchCourses" placeholder="Title, Instructor..." class="form-control">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="courses-table">
                                <thead>
                                    <tr>
                                        <th width="40px">
                                            <input type="checkbox" id="select-all-courses" onclick="toggleSelectAll('courses')">
                                        </th>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Type</th>
                                        <th>Language</th>
                                        <th>Instructor</th>
                                        <th>Students</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="8" class="text-center">Loading courses...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-20">
                            <div class="text-muted" id="courses-pagination-info">Showing 0 of 0 courses</div>
                            <div class="btn-group">
                                <button id="prev-courses-page" class="btn btn-outline" disabled>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <button id="next-courses-page" class="btn btn-outline" disabled>
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requests Section -->
            <div id="requests" class="section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Unenrollment Requests</h3>
                        <div class="header-actions">
                            <button id="refresh-requests" class="btn btn-secondary">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="toolbar">
                            <div class="toolbar-item">
                                <label for="filterRequestStatus">Status:</label>
                                <select id="filterRequestStatus" class="form-control">
                                    <option value="">All Requests</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="toolbar-item">
                                <label for="filterRequestDate">Date Range:</label>
                                <select id="filterRequestDate" class="form-control">
                                    <option value="">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="requests-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Course</th>
                                        <th>Requested At</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center">Loading requests...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">System Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Configure system-wide settings and preferences.
                        </div>

                        <form id="settings-form">
                            <div class="form-group">
                                <label for="system-name">System Name</label>
                                <input type="text" id="system-name" class="form-control" placeholder="Enter system name">
                            </div>

                            <div class="form-group">
                                <label for="default-role">Default User Role</label>
                                <select id="default-role" class="form-control">
                                    <option value="student">Student</option>
                                    <option value="instructor">Instructor</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="enrollment-duration">Default Enrollment Duration (days)</label>
                                <input type="number" id="enrollment-duration" class="form-control" min="1" value="365">
                            </div>

                            <div class="form-group">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="email-notifications">
                                    <span class="checkmark"></span>
                                    Enable Email Notifications
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="approval-required">
                                    <span class="checkmark"></span>
                                    Require Approval for New Users
                                </label>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="showSection('dashboard')">
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-primary" id="save-settings">
                                    Save Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="userModalLabel">Add New User</h4>
                <button type="button" class="close" onclick="closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label for="userStudentId">Student ID</label>
                        <input type="text" id="userStudentId" class="form-control" placeholder="Enter student ID">
                    </div>
                    <div class="form-group">
                        <label for="userName">Full Name*</label>
                        <input type="text" id="userName" class="form-control" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email*</label>
                        <input type="email" id="userEmail" class="form-control" placeholder="Enter email" required>
                    </div>
                    <div class="form-group">
                        <label for="userPhone">Phone</label>
                        <input type="tel" id="userPhone" class="form-control" placeholder="Enter phone number">
                    </div>
                    <div class="form-group">
                        <label for="userDepartment">Department</label>
                        <select id="userDepartment" class="form-control">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userGender">Gender</label>
                        <select id="userGender" class="form-control">
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userRole">Role*</label>
                        <select id="userRole" class="form-control" required>
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="instructor">Instructor</option>
                            <option value="student">Student</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userStatus">Status</label>
                        <select id="userStatus" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Cancel</button>
                <button type="button" class="btn btn-primary" id="userSaveBtn">Save User</button>
            </div>
        </div>
    </div>

    <!-- Enrollment Modal -->
    <div id="enrollmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="enrollmentModalLabel">Add New Enrollment</h4>
                <button type="button" class="close" onclick="closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="enrollmentForm">
                    <input type="hidden" id="enrollmentIndex">
                    <div class="form-group">
                        <label for="enrollCourseTitle">Course*</label>
                        <select id="enrollCourseTitle" class="form-control" required>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="enrollmentDate">Enrollment Date*</label>
                        <input type="date" id="enrollmentDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="enrollmentCompletionDate">Completion Date</label>
                        <input type="date" id="enrollmentCompletionDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="enrollmentStatus">Status*</label>
                        <select id="enrollmentStatus" class="form-control" required>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="dropped">Dropped</option>
                            <option value="on-hold">On Hold</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="enrollmentProgress">Progress (%)</label>
                        <input type="range" id="enrollmentProgress" class="form-control" min="0" max="100" value="0">
                        <div class="d-flex justify-content-between">
                            <span>0%</span>
                            <span id="progress-value">0%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="enrollmentScore">Score/Grade</label>
                        <input type="text" id="enrollmentScore" class="form-control" placeholder="Enter score or grade">
                    </div>
                    <div class="form-group">
                        <label for="enrollmentNotes">Notes</label>
                        <textarea id="enrollmentNotes" class="form-control" rows="3" placeholder="Additional notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Cancel</button>
                <button type="button" class="btn btn-primary" id="enrollmentSaveBtn">Save Enrollment</button>
            </div>
        </div>
    </div>

    <!-- Course Modal -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="courseModalLabel">Add New Course</h4>
                <button type="button" class="close" onclick="closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="courseForm">
                    <input type="hidden" id="courseId">
                    <div class="form-group">
                        <label for="courseTitle">Title*</label>
                        <input type="text" id="courseTitle" class="form-control" placeholder="Enter course title" required>
                    </div>
                    <div class="form-group">
                        <label for="courseDescription">Description*</label>
                        <textarea id="courseDescription" class="form-control" rows="3" placeholder="Enter course description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="courseType">Type*</label>
                        <select id="courseType" class="form-control" required>
                            <option value="">Select Type</option>
                            <option value="online">Online</option>
                            <option value="in-person">In-Person</option>
                            <option value="hybrid">Hybrid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="courseCategory">Category</label>
                        <input type="text" id="courseCategory" class="form-control" placeholder="Enter course category">
                    </div>
                    <div class="form-group">
                        <label for="courseLanguage">Language*</label>
                        <select id="courseLanguage" class="form-control" required>
                            <option value="">Select Language</option>
                            <option value="english">English</option>
                            <option value="spanish">Spanish</option>
                            <option value="french">French</option>
                            <option value="german">German</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="courseDuration">Duration (weeks)*</label>
                        <input type="number" id="courseDuration" class="form-control" min="1" placeholder="Enter duration in weeks" required>
                    </div>
                    <div class="form-group">
                        <label for="coursePrice">Price</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">$</span>
                            </div>
                            <input type="number" id="coursePrice" class="form-control" min="0" step="0.01" placeholder="Enter price">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="courseInstructor">Instructor</label>
                        <select id="courseInstructor" class="form-control">
                            <option value="">Select Instructor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="coursePrerequisites">Prerequisites</label>
                        <select id="coursePrerequisites" class="form-control" multiple>
                            <option value="">Select Prerequisites</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="courseImage">Course Image URL</label>
                        <input type="url" id="courseImage" class="form-control" placeholder="Enter image URL">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Cancel</button>
                <button type="button" class="btn btn-primary" id="courseSaveBtn">Save Course</button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div id="bulkActionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Bulk Actions</h4>
                <button type="button" class="close" onclick="closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bulkAction">Action</label>
                    <select id="bulkAction" class="form-control">
                        <option value="">Select Action</option>
                        <option value="activate">Activate</option>
                        <option value="deactivate">Deactivate</option>
                        <option value="delete">Delete</option>
                        <option value="change-role">Change Role</option>
                        <option value="assign-course">Assign Course</option>
                        <option value="export">Export Selected</option>
                    </select>
                </div>
                <div id="bulkActionOptions" class="hidden">
                    <div id="changeRoleOption" class="form-group hidden">
                        <label for="newRole">New Role</label>
                        <select id="newRole" class="form-control">
                            <option value="student">Student</option>
                            <option value="instructor">Instructor</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div id="assignCourseOption" class="form-group hidden">
                        <label for="courseToAssign">Course</label>
                        <select id="courseToAssign" class="form-control">
                            <option value="">Select Course</option>
                        </select>
                    </div>
                </div>
                <div class="alert alert-warning mt-10 hidden" id="bulkActionWarning">
                    <i class="fas fa-exclamation-triangle"></i> This action will affect <span id="selectedCount">0</span> items.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmBulkAction">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="confirmationTitle">Confirm Action</h4>
                <button type="button" class="close" onclick="closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmAction">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal">
        <div class="modal-content" style="background: transparent; box-shadow: none; display: flex; justify-content: center; align-items: center;">
            <div class="spinner"></div>
            <div class="text-muted mt-10" id="loadingText">Processing...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import {
            getFirestore, collection, doc, getDoc, getDocs,
            updateDoc, deleteDoc, addDoc, query, where, Timestamp, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo",
            authDomain: "pharma-quiz-b5a07.firebaseapp.com",
            databaseURL: "https://pharma-quiz-b5a07-default-rtdb.firebaseio.com",
            projectId: "pharma-quiz-b5a07",
            storageBucket: "pharma-quiz-b5a07.appspot.com",
            messagingSenderId: "161067776789",
            appId: "1:161067776789:web:88b8a61145dc5f5c31471c",
            measurementId: "G-3QRQE9HQFB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        const USERS_COLLECTION = 'users';
        const COURSES_COLLECTION = 'courses';
        const REQUESTS_COLLECTION = 'requests';
        const SESSIONS_COLLECTION = 'sessions';
        const SETTINGS_COLLECTION = 'settings';
        
        let currentUserId = null;
        let currentEnrollmentIndex = null;
        let currentCourseId = null;
        let selectedUsers = [];
        let selectedCourses = [];
        let currentPage = {
            users: 1,
            courses: 1
        };
        const itemsPerPage = 10;
        let totalItems = {
            users: 0,
            courses: 0
        };
        let userDistributionChart = null;

        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const authStatus = document.getElementById('auth-status');
        const logoutButton = document.getElementById('logout-button');
        const themeToggle = document.getElementById('theme-toggle');
        const currentSectionTitle = document.getElementById('current-section-title');

        // Initialize the dashboard
        function initDashboard() {
            // Set up event listeners
            setupEventListeners();
            
            // Load initial data
            loadDashboardData();
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            // Initialize charts
            initCharts();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Login form
            loginForm.addEventListener('submit', handleLogin);
            
            // Logout button
            logoutButton.addEventListener('click', handleLogout);
            
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);
            
            // Pagination buttons
            document.getElementById('prev-users-page').addEventListener('click', () => navigatePage('users', -1));
            document.getElementById('next-users-page').addEventListener('click', () => navigatePage('users', 1));
            document.getElementById('prev-courses-page').addEventListener('click', () => navigatePage('courses', -1));
            document.getElementById('next-courses-page').addEventListener('click', () => navigatePage('courses', 1));
            
            // Search and filter inputs
            document.getElementById('searchUsers').addEventListener('input', () => loadUsers(currentPage.users));
            document.getElementById('filterRole').addEventListener('change', () => loadUsers(currentPage.users));
            document.getElementById('filterDepartment').addEventListener('change', () => loadUsers(currentPage.users));
            document.getElementById('filterCourse').addEventListener('change', () => loadUsers(currentPage.users));
            
            document.getElementById('searchCourses').addEventListener('input', () => loadCourses(currentPage.courses));
            document.getElementById('filterCourseType').addEventListener('change', () => loadCourses(currentPage.courses));
            document.getElementById('filterCourseLanguage').addEventListener('change', () => loadCourses(currentPage.courses));
            
            document.getElementById('filterEnrollmentStatus').addEventListener('change', loadEnrollments);
            document.getElementById('filterEnrollmentDate').addEventListener('change', loadEnrollments);
            document.getElementById('searchEnrollments').addEventListener('input', loadEnrollments);
            
            document.getElementById('filterRequestStatus').addEventListener('change', loadRequests);
            document.getElementById('filterRequestDate').addEventListener('change', loadRequests);
            
            // Modal buttons
            document.getElementById('userSaveBtn').addEventListener('click', saveUser);
            document.getElementById('enrollmentSaveBtn').addEventListener('click', saveEnrollment);
            document.getElementById('courseSaveBtn').addEventListener('click', saveCourse);
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            
            // Progress slider
            document.getElementById('enrollmentProgress').addEventListener('input', function() {
                document.getElementById('progress-value').textContent = `${this.value}%`;
            });
            
            // Bulk actions
            document.getElementById('bulkAction').addEventListener('change', showBulkActionOptions);
            document.getElementById('confirmBulkAction').addEventListener('click', executeBulkAction);
            
            // Export buttons
            document.getElementById('export-users').addEventListener('click', exportUsers);
            document.getElementById('export-courses').addEventListener('click', exportCourses);
            
            // Refresh buttons
            document.getElementById('refresh-requests').addEventListener('click', loadRequests);
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    closeModals();
                }
            });
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            
            showLoading('Logging in...');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                hideLoading();
                showError(loginError, `Login failed: ${error.message}`);
                console.error("Login failed:", error);
            }
        }

        async function handleLogout() {
            try {
                showLoading('Logging out...');
                await signOut(auth);
                // Clear any sensitive data
                currentUserId = null;
                currentEnrollmentIndex = null;
                currentCourseId = null;
                selectedUsers = [];
                selectedCourses = [];
            } catch (error) {
                console.error("Logout failed:", error);
                showAlert('error', `Logout failed: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function checkAdminRole(user) {
            if (!user) return false;
            
            try {
                const q = query(collection(db, USERS_COLLECTION), where("email", "==", user.email));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    console.warn(`No user document found for email: ${user.email}`);
                    return false;
                }
                
                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();
                return userData.role === 'admin';
            } catch (error) {
                console.error("Error checking admin role:", error);
                showAlert('error', `Error checking permissions: ${error.message}`);
                return false;
            }
        }

        // Theme functions
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update button text
            const icon = theme === 'dark' ? 'fa-sun' : 'fa-moon';
            themeToggle.innerHTML = `<i class="fas ${icon}"></i> ${theme === 'dark' ? 'Light' : 'Dark'} Mode`;
        }

        // Section navigation
        function showSection(id) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show the selected section
            const section = document.getElementById(id);
            if (section) {
                section.classList.remove('hidden');
                
                // Update active nav link
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.target === id) {
                        link.classList.add('active');
                    }
                });
                
                // Update section title
                const title = section.querySelector('.card-title')?.textContent || 'Dashboard';
                currentSectionTitle.textContent = title;
                
                // Load section data if needed
                switch (id) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'users':
                        loadUsers(currentPage.users);
                        break;
                    case 'courses':
                        loadCourses(currentPage.courses);
                        break;
                    case 'enrollments':
                        if (!currentUserId) {
                            showAlert('warning', 'Please select a user first from the Users tab.');
                            showSection('users');
                        }
                        break;
                    case 'requests':
                        loadRequests();
                        break;
                }
            }
        }

        // Pagination
        function navigatePage(type, direction) {
            currentPage[type] += direction;
            if (type === 'users') {
                loadUsers(currentPage.users);
            } else if (type === 'courses') {
                loadCourses(currentPage.courses);
            }
        }

        function updatePagination(type, currentPage, totalItems) {
            const start = ((currentPage - 1) * itemsPerPage) + 1;
            const end = Math.min(currentPage * itemsPerPage, totalItems);
            document.getElementById(`${type}-pagination-info`).textContent = `Showing ${start}-${end} of ${totalItems} ${type}`;
            
            // Update button states
            document.getElementById(`prev-${type}-page`).disabled = currentPage <= 1;
            document.getElementById(`next-${type}-page`).disabled = currentPage * itemsPerPage >= totalItems;
        }

        // Selection functions
        function toggleSelectAll(type) {
            const checkbox = document.getElementById(`select-all-${type}`);
            const checkboxes = document.querySelectorAll(`#${type}-table tbody input[type="checkbox"]`);
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                handleRowSelection(cb, type);
            });
            
            updateBulkActionButton(type);
        }

        function handleRowSelection(checkbox, type) {
            const id = checkbox.value;
            const array = type === 'users' ? selectedUsers : selectedCourses;
            
            if (checkbox.checked) {
                if (!array.includes(id)) {
                    array.push(id);
                }
            } else {
                const index = array.indexOf(id);
                if (index > -1) {
                    array.splice(index, 1);
                }
            }
            
            // Update "select all" checkbox
            const allCheckboxes = document.querySelectorAll(`#${type}-table tbody input[type="checkbox"]`);
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            document.getElementById(`select-all-${type}`).checked = allChecked;
            
            updateBulkActionButton(type);
        }

        function updateBulkActionButton(type) {
            const count = type === 'users' ? selectedUsers.length : selectedCourses.length;
            const button = document.getElementById(`${type}-bulk-actions`);
            
            if (button) {
                button.disabled = count === 0;
                button.innerHTML = `<i class="fas fa-tasks"></i> Bulk Actions (${count})`;
            }
        }

        // Bulk actions
        function showBulkActionOptions() {
            const action = document.getElementById('bulkAction').value;
            const options = document.getElementById('bulkActionOptions');
            const warning = document.getElementById('bulkActionWarning');
            
            // Hide all options first
            document.querySelectorAll('#bulkActionOptions > div').forEach(div => {
                div.classList.add('hidden');
            });
            
            if (action) {
                options.classList.remove('hidden');
                warning.classList.remove('hidden');
                
                // Show relevant options
                if (action === 'change-role') {
                    document.getElementById('changeRoleOption').classList.remove('hidden');
                } else if (action === 'assign-course') {
                    document.getElementById('assignCourseOption').classList.remove('hidden');
                    populateCourseDropdown('courseToAssign');
                }
                
                // Update count
                const isUsers = document.getElementById('bulkAction').dataset.type === 'users';
                document.getElementById('selectedCount').textContent = isUsers ? selectedUsers.length : selectedCourses.length;
            } else {
                options.classList.add('hidden');
                warning.classList.add('hidden');
            }
        }

        async function executeBulkAction() {
            const action = document.getElementById('bulkAction').value;
            const type = document.getElementById('bulkAction').dataset.type;
            const ids = type === 'users' ? selectedUsers : selectedCourses;
            
            if (!action || ids.length === 0) return;
            
            showLoading(`Processing ${ids.length} ${type}...`);
            
            try {
                const batch = writeBatch(db);
                
                if (type === 'users') {
                    for (const userId of ids) {
                        const userRef = doc(db, USERS_COLLECTION, userId);
                        
                        switch (action) {
                            case 'activate':
                                batch.update(userRef, { status: 'active' });
                                break;
                            case 'deactivate':
                                batch.update(userRef, { status: 'inactive' });
                                break;
                            case 'delete':
                                batch.delete(userRef);
                                break;
                            case 'change-role':
                                const newRole = document.getElementById('newRole').value;
                                batch.update(userRef, { role: newRole });
                                break;
                            case 'assign-course':
                                const courseId = document.getElementById('courseToAssign').value;
                                if (courseId) {
                                    // Get course info
                                    const courseRef = doc(db, COURSES_COLLECTION, courseId);
                                    const courseSnap = await getDoc(courseRef);
                                    
                                    if (courseSnap.exists()) {
                                        const courseData = courseSnap.data();
                                        
                                        // Get user's current enrollments
                                        const userSnap = await getDoc(userRef);
                                        const userData = userSnap.exists() ? userSnap.data() : {};
                                        const enrollments = userData.enrolledCourses || [];
                                        
                                        // Check if already enrolled
                                        const alreadyEnrolled = enrollments.some(e => e.courseId === courseId);
                                        
                                        if (!alreadyEnrolled) {
                                            enrollments.push({
                                                courseId: courseId,
                                                title: courseData.title,
                                                enrollmentdate: new Date().toISOString().split('T')[0],
                                                status: 'active',
                                                progress: '0%'
                                            });
                                            
                                            batch.update(userRef, { enrolledCourses: enrollments });
                                        }
                                    }
                                }
                                break;
                        }
                    }
                } else if (type === 'courses') {
                    for (const courseId of ids) {
                        const courseRef = doc(db, COURSES_COLLECTION, courseId);
                        
                        switch (action) {
                            case 'activate':
                                batch.update(courseRef, { status: 'active' });
                                break;
                            case 'deactivate':
                                batch.update(courseRef, { status: 'inactive' });
                                break;
                            case 'delete':
                                batch.delete(courseRef);
                                break;
                        }
                    }
                }
                
                await batch.commit();
                showAlert('success', `Successfully updated ${ids.length} ${type}.`);
                
                // Refresh data
                if (type === 'users') {
                    loadUsers(currentPage.users);
                    selectedUsers = [];
                } else {
                    loadCourses(currentPage.courses);
                    selectedCourses = [];
                }
                
                closeModals();
            } catch (error) {
                console.error("Error executing bulk action:", error);
                showAlert('error', `Failed to complete bulk action: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Data loading functions
        async function loadDashboardData() {
            showLoading('Loading dashboard data...');
            
            try {
                // Load counts in parallel
                const [usersCount, coursesCount, enrollmentsCount, requestsCount] = await Promise.all([
                    getCollectionCount(USERS_COLLECTION),
                    getCollectionCount(COURSES_COLLECTION),
                    getTotalEnrollments(),
                    getCollectionCount(REQUESTS_COLLECTION, where('status', '==', 'pending'))
                ]);
                
                // Update dashboard counters
                document.getElementById('total-users').textContent = usersCount;
                document.getElementById('total-courses').textContent = coursesCount;
                document.getElementById('total-enrollments').textContent = enrollmentsCount;
                document.getElementById('total-requests').textContent = requestsCount;
                
                // Load recent enrollments
                loadRecentEnrollments();
                
                // Load user distribution chart data
                loadUserDistributionData();
                
                // Simulate changes (in a real app, you'd compare with previous data)
                document.getElementById('users-change').textContent = '5%';
                document.getElementById('courses-change').textContent = '2%';
                document.getElementById('enrollments-change').textContent = '12%';
                document.getElementById('requests-change').textContent = '-3%';
                
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                showAlert('error', 'Failed to load dashboard data.');
            } finally {
                hideLoading();
            }
        }

        async function loadUsers(page = 1) {
            showLoading('Loading users...');
            
            try {
                const roleFilter = document.getElementById('filterRole').value;
                const departmentFilter = document.getElementById('filterDepartment').value;
                const courseFilter = document.getElementById('filterCourse').value;
                const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
                
                // Build the query
                let q = collection(db, USERS_COLLECTION);
                const conditions = [];
                
                if (roleFilter) conditions.push(where('role', '==', roleFilter));
                if (departmentFilter) conditions.push(where('department', '==', departmentFilter));
                
                // Apply conditions if any
                if (conditions.length > 0) {
                    q = query(q, ...conditions);
                }
                
                const snapshot = await getDocs(q);
                const users = [];
                
                // Process users with optional course filter
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userId = doc.id;
                    
                    // Apply search filter
                    const userString = `${user.studentId || ''} ${user.name || ''} ${user.email || ''}`.toLowerCase();
                    if (searchTerm && !userString.includes(searchTerm)) return;
                    
                    // Apply course filter if needed
                    if (courseFilter) {
                        const enrolledCourses = user.enrolledCourses || [];
                        const hasCourse = enrolledCourses.some(c => c.title === courseFilter);
                        if (!hasCourse) return;
                    }
                    
                    users.push({
                        id: userId,
                        ...user
                    });
                });
                
                // Update total count
                totalItems.users = users.length;
                updatePagination('users', page, totalItems.users);
                
                // Paginate results
                const start = (page - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const paginatedUsers = users.slice(start, end);
                
                // Render users
                renderUsersTable(paginatedUsers);
                
                // Populate filters if needed
                if (document.getElementById('filterDepartment').options.length <= 1) {
                    populateFilterOptions('department', USERS_COLLECTION, 'department');
                }
                
                if (document.getElementById('filterCourse').options.length <= 1) {
                    populateCourseFilter();
                }
                
            } catch (error) {
                console.error("Error loading users:", error);
                showAlert('error', 'Failed to load users.');
            } finally {
                hideLoading();
            }
        }

        async function loadCourses(page = 1) {
            showLoading('Loading courses...');
            
            try {
                const typeFilter = document.getElementById('filterCourseType').value;
                const languageFilter = document.getElementById('filterCourseLanguage').value;
                const searchTerm = document.getElementById('searchCourses').value.toLowerCase();
                
                // Build the query
                let q = collection(db, COURSES_COLLECTION);
                const conditions = [];
                
                if (typeFilter) conditions.push(where('type', '==', typeFilter));
                if (languageFilter) conditions.push(where('language', '==', languageFilter));
                
                // Apply conditions if any
                if (conditions.length > 0) {
                    q = query(q, ...conditions);
                }
                
                const snapshot = await getDocs(q);
                const courses = [];
                
                snapshot.forEach(doc => {
                    const course = doc.data();
                    const courseId = doc.id;
                    
                    // Apply search filter
                    const courseString = `${course.title || ''} ${course.description || ''} ${course.instructor || ''}`.toLowerCase();
                    if (searchTerm && !courseString.includes(searchTerm)) return;
                    
                    courses.push({
                        id: courseId,
                        ...course
                    });
                });
                
                // Update total count
                totalItems.courses = courses.length;
                updatePagination('courses', page, totalItems.courses);
                
                // Paginate results
                const start = (page - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const paginatedCourses = courses.slice(start, end);
                
                // Render courses
                renderCoursesTable(paginatedCourses);
                
                // Populate filters if needed
                if (document.getElementById('filterCourseLanguage').options.length <= 1) {
                    populateFilterOptions('language', COURSES_COLLECTION, 'language');
                }
                
            } catch (error) {
                console.error("Error loading courses:", error);
                showAlert('error', 'Failed to load courses.');
            } finally {
                hideLoading();
            }
        }

        async function loadEnrollments() {
            if (!currentUserId) return;
            
            showLoading('Loading enrollments...');
            
            try {
                const statusFilter = document.getElementById('filterEnrollmentStatus').value;
                const dateFilter = document.getElementById('filterEnrollmentDate').value;
                const searchTerm = document.getElementById('searchEnrollments').value.toLowerCase();
                
                // Get user document
                const userRef = doc(db, USERS_COLLECTION, currentUserId);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    showAlert('error', 'User not found.');
                    return;
                }
                
                const userData = userSnap.data();
                const enrollments = userData.enrolledCourses || [];
                
                // Apply filters
                let filteredEnrollments = enrollments;
                
                if (statusFilter) {
                    filteredEnrollments = filteredEnrollments.filter(e => e.status === statusFilter);
                }
                
                if (dateFilter) {
                    const now = new Date();
                    let startDate;
                    
                    switch (dateFilter) {
                        case 'today':
                            startDate = new Date(now.setHours(0, 0, 0, 0));
                            break;
                        case 'week':
                            startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case 'month':
                            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            break;
                        case 'year':
                            startDate = new Date(now.getFullYear(), 0, 1);
                            break;
                    }
                    
                    if (startDate) {
                        filteredEnrollments = filteredEnrollments.filter(e => {
                            const enrollDate = new Date(e.enrollmentdate);
                            return enrollDate >= startDate;
                        });
                    }
                }
                
                if (searchTerm) {
                    filteredEnrollments = filteredEnrollments.filter(e => 
                        (e.title && e.title.toLowerCase().includes(searchTerm)) ||
                        (e.status && e.status.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Render enrollments
                renderEnrollmentsTable(filteredEnrollments);
                
            } catch (error) {
                console.error("Error loading enrollments:", error);
                showAlert('error', 'Failed to load enrollments.');
            } finally {
                hideLoading();
            }
        }

        async function loadRequests() {
            showLoading('Loading requests...');
            
            try {
                const statusFilter = document.getElementById('filterRequestStatus').value;
                const dateFilter = document.getElementById('filterRequestDate').value;
                
                // Build the query
                let q = collection(db, REQUESTS_COLLECTION);
                const conditions = [];
                
                if (statusFilter) conditions.push(where('status', '==', statusFilter));
                
                // Apply conditions if any
                if (conditions.length > 0) {
                    q = query(q, ...conditions);
                }
                
                const snapshot = await getDocs(q);
                const requests = [];
                
                // Process requests and fetch user/course details
                for (const doc of snapshot.docs) {
                    const request = doc.data();
                    const requestId = doc.id;
                    
                    // Apply date filter if needed
                    if (dateFilter) {
                        const now = new Date();
                        let startDate;
                        
                        switch (dateFilter) {
                            case 'today':
                                startDate = new Date(now.setHours(0, 0, 0, 0));
                                break;
                            case 'week':
                                startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                                startDate.setHours(0, 0, 0, 0);
                                break;
                            case 'month':
                                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                                break;
                        }
                        
                        if (startDate) {
                            const requestDate = request.requestedAt?.toDate();
                            if (!requestDate || requestDate < startDate) continue;
                        }
                    }
                    
                    // Fetch user details
                    let userName = 'Unknown User';
                    if (request.userId) {
                        try {
                            const userSnap = await getDoc(doc(db, USERS_COLLECTION, request.userId));
                            if (userSnap.exists()) {
                                userName = userSnap.data().name || 'Unnamed User';
                            }
                        } catch (e) {
                            console.warn(`Could not fetch user ${request.userId}:`, e);
                        }
                    }
                    
                    // Fetch course details
                    let courseTitle = 'Unknown Course';
                    if (request.courseId) {
                        try {
                            const courseSnap = await getDoc(doc(db, COURSES_COLLECTION, request.courseId));
                            if (courseSnap.exists()) {
                                courseTitle = courseSnap.data().title || 'Unnamed Course';
                            }
                        } catch (e) {
                            console.warn(`Could not fetch course ${request.courseId}:`, e);
                        }
                    }
                    
                    requests.push({
                        id: requestId,
                        userId: request.userId,
                        userName: userName,
                        courseId: request.courseId,
                        courseTitle: courseTitle,
                        status: request.status || 'pending',
                        requestedAt: request.requestedAt?.toDate() || new Date(),
                        reason: request.reason || ''
                    });
                }
                
                // Sort by date (newest first)
                requests.sort((a, b) => b.requestedAt - a.requestedAt);
                
                // Render requests
                renderRequestsTable(requests);
                
            } catch (error) {
                console.error("Error loading requests:", error);
                showAlert('error', 'Failed to load requests.');
            } finally {
                hideLoading();
            }
        }

        async function loadRecentEnrollments() {
            try {
                // Get all users with enrollments
                const q = query(collection(db, USERS_COLLECTION), where('enrolledCourses', '!=', []));
                const snapshot = await getDocs(q);
                
                const recentEnrollments = [];
                
                // Process users and their enrollments
                snapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const enrollments = userData.enrolledCourses || [];
                    
                    enrollments.forEach(enrollment => {
                        recentEnrollments.push({
                            userId: userDoc.id,
                            userName: userData.name || 'Unknown User',
                            courseId: enrollment.courseId,
                            courseTitle: enrollment.title || 'Unknown Course',
                            date: enrollment.enrollmentdate || 'N/A',
                            status: enrollment.status || 'active'
                        });
                    });
                });
                
                // Sort by date (newest first) and take top 5
                recentEnrollments.sort((a, b) => new Date(b.date) - new Date(a.date));
                const topEnrollments = recentEnrollments.slice(0, 5);
                
                // Render recent enrollments
                renderRecentEnrollmentsTable(topEnrollments);
                
            } catch (error) {
                console.error("Error loading recent enrollments:", error);
            }
        }

        async function loadUserDistributionData() {
            try {
                const snapshot = await getDocs(collection(db, USERS_COLLECTION));
                const roleCounts = {
                    admin: 0,
                    instructor: 0,
                    student: 0,
                    other: 0
                };
                
                snapshot.forEach(doc => {
                    const role = doc.data().role || 'student';
                    if (roleCounts.hasOwnProperty(role)) {
                        roleCounts[role]++;
                    } else {
                        roleCounts.other++;
                    }
                });
                
                // Update chart
                updateUserDistributionChart(roleCounts);
                
            } catch (error) {
                console.error("Error loading user distribution data:", error);
            }
        }

        // Data rendering functions
        function renderUsersTable(users) {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center">No users found matching your criteria.</td>
                    </tr>
                `;
                return;
            }
            
            users.forEach(user => {
                const enrolledCourses = user.enrolledCourses || [];
                const courseCount = enrolledCourses.length;
                const courseNames = enrolledCourses.map(c => c.title).join(', ');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" value="${user.id}" onclick="handleRowSelection(this, 'users')">
                    </td>
                    <td>${user.studentId || 'N/A'}</td>
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>
                        <span class="badge ${getRoleBadgeClass(user.role)}">
                            ${user.role || 'N/A'}
                        </span>
                    </td>
                    <td>${user.department || 'N/A'}</td>
                    <td>
                        ${courseCount > 0 ? `
                            <span title="${courseNames}">${courseCount} course${courseCount !== 1 ? 's' : ''}</span>
                        ` : 'None'}
                    </td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(user.status)}">
                            ${user.status || 'active'}
                        </span>
                    </td>
                    <td class="actions">
                        <button class="btn btn-sm btn-info" onclick="viewEnrollments('${user.id}')" title="View Enrollments">
                            <i class="fas fa-user-graduate"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editUser('${user.id}')" title="Edit User">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')" title="Delete User">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderCoursesTable(courses) {
            const tbody = document.querySelector('#courses-table tbody');
            tbody.innerHTML = '';
            
            if (courses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">No courses found matching your criteria.</td>
                    </tr>
                `;
                return;
            }
            
            courses.forEach(course => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" value="${course.id}" onclick="handleRowSelection(this, 'courses')">
                    </td>
                    <td>${course.title || 'N/A'}</td>
                    <td>${course.description ? course.description.substring(0, 50) + (course.description.length > 50 ? '...' : '') : 'N/A'}</td>
                    <td>${course.type || 'N/A'}</td>
                    <td>${course.language || 'N/A'}</td>
                    <td>${course.instructor || 'N/A'}</td>
                    <td>${course.studentCount || '0'}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-warning" onclick="editCourse('${course.id}')" title="Edit Course">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCourse('${course.id}')" title="Delete Course">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderEnrollmentsTable(enrollments) {
            const tbody = document.querySelector('#enroll-table tbody');
            tbody.innerHTML = '';
            
            if (enrollments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">No enrollments found matching your criteria.</td>
                    </tr>
                `;
                return;
            }
            
            enrollments.forEach((enrollment, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${enrollment.title || 'N/A'}</td>
                    <td>${enrollment.enrollmentdate || 'N/A'}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" style="width: ${enrollment.progress || '0%'};" 
                                aria-valuenow="${parseInt(enrollment.progress) || 0}" aria-valuemin="0" aria-valuemax="100">
                                ${enrollment.progress || '0%'}
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(enrollment.status)}">
                            ${enrollment.status || 'active'}
                        </span>
                    </td>
                    <td>${enrollment.score || 'N/A'}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-warning" onclick="editEnrollment(${index})" title="Edit Enrollment">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEnrollment(${index})" title="Delete Enrollment">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderRequestsTable(requests) {
            const tbody = document.querySelector('#requests-table tbody');
            tbody.innerHTML = '';
            
            if (requests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">No requests found matching your criteria.</td>
                    </tr>
                `;
                return;
            }
            
            requests.forEach(request => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${request.userName} ${request.userId ? `(${request.userId})` : ''}</td>
                    <td>${request.courseTitle} ${request.courseId ? `(${request.courseId})` : ''}</td>
                    <td>${formatDate(request.requestedAt)}</td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(request.status)}">
                            ${request.status}
                        </span>
                    </td>
                    <td class="actions">
                        ${request.status === 'pending' ? `
                            <button class="btn btn-sm btn-success" onclick="handleRequest('${request.id}', 'approve')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="handleRequest('${request.id}', 'reject')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-info" onclick="viewRequestDetails('${request.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderRecentEnrollmentsTable(enrollments) {
            const tbody = document.querySelector('#recent-enrollments-table tbody');
            tbody.innerHTML = '';
            
            if (enrollments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">No recent enrollments found.</td>
                    </tr>
                `;
                return;
            }
            
            enrollments.forEach(enrollment => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${enrollment.userName}</td>
                    <td>${enrollment.courseTitle}</td>
                    <td>${formatDate(enrollment.date)}</td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(enrollment.status)}">
                            ${enrollment.status}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Modal functions
        function openAddUserModal() {
            document.getElementById('userModalLabel').textContent = 'Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userRole').value = 'student';
            document.getElementById('userStatus').value = 'active';
            showModal('userModal');
        }

        async function editUser(id) {
            showLoading('Loading user data...');
            
            try {
                const userRef = doc(db, USERS_COLLECTION, id);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    showAlert('error', 'User not found!');
                    return;
                }
                
                const user = userSnap.data();
                
                document.getElementById('userModalLabel').textContent = 'Edit User';
                document.getElementById('userId').value = id;
                document.getElementById('userStudentId').value = user.studentId || '';
                document.getElementById('userName').value = user.name || '';
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userPhone').value = user.phone || '';
                document.getElementById('userDepartment').value = user.department || '';
                document.getElementById('userGender').value = user.gender || '';
                document.getElementById('userRole').value = user.role || 'student';
                document.getElementById('userStatus').value = user.status || 'active';
                
                showModal('userModal');
                
            } catch (error) {
                console.error("Error loading user for edit:", error);
                showAlert('error', 'Failed to load user data.');
            } finally {
                hideLoading();
            }
        }

        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const userData = {
                studentId: document.getElementById('userStudentId').value.trim(),
                name: document.getElementById('userName').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                phone: document.getElementById('userPhone').value.trim(),
                department: document.getElementById('userDepartment').value.trim(),
                gender: document.getElementById('userGender').value.trim(),
                role: document.getElementById('userRole').value.trim(),
                status: document.getElementById('userStatus').value.trim(),
                updatedAt: Timestamp.now()
            };
            
            // Validation
            if (!userData.name || !userData.email) {
                showAlert('error', 'Name and Email are required!');
                return;
            }
            
            if (!/^\S+@\S+\.\S+$/.test(userData.email)) {
                showAlert('error', 'Please enter a valid email address.');
                return;
            }
            
            showLoading(userId ? 'Updating user...' : 'Adding user...');
            
            try {
                if (userId) {
                    // Update existing user
                    await updateDoc(doc(db, USERS_COLLECTION, userId), userData);
                    showAlert('success', 'User updated successfully!');
                } else {
                    // Add new user
                    userData.createdAt = Timestamp.now();
                    await addDoc(collection(db, USERS_COLLECTION), userData);
                    showAlert('success', 'User added successfully!');
                }
                
                closeModals();
                loadUsers(currentPage.users);
                populateCourseFilter();
                
            } catch (error) {
                console.error("Error saving user:", error);
                showAlert('error', `Error saving user: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function deleteUser(id) {
            showConfirmation(
                'Delete User',
                'Are you sure you want to delete this user? This action cannot be undone.',
                async () => {
                    showLoading('Deleting user...');
                    
                    try {
                        await deleteDoc(doc(db, USERS_COLLECTION, id));
                        
                        // If the deleted user is the one whose enrollments we're viewing
                        if (id === currentUserId) {
                            currentUserId = null;
                            document.querySelector('#enroll-table tbody').innerHTML = '';
                            document.getElementById('enroll-user').textContent = '';
                            showSection('users');
                        }
                        
                        showAlert('success', 'User deleted successfully!');
                        loadUsers(currentPage.users);
                        populateCourseFilter();
                        
                    } catch (error) {
                        console.error("Error deleting user:", error);
                        showAlert('error', `Error deleting user: ${error.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            );
        }

        async function viewEnrollments(userId) {
            currentUserId = userId;
            
            // Get user name for display
            showLoading('Loading user data...');
            
            try {
                const userRef = doc(db, USERS_COLLECTION, userId);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    showAlert('error', 'User not found!');
                    return;
                }
                
                const userData = userSnap.data();
                document.getElementById('enroll-user').textContent = userData.name || 'Unknown User';
                
                // Show enrollments section and load data
                showSection('enrollments');
                loadEnrollments();
                
            } catch (error) {
                console.error("Error loading user:", error);
                showAlert('error', 'Failed to load user data.');
            } finally {
                hideLoading();
            }
        }

        function openAddEnrollmentModal() {
            if (!currentUserId) {
                showAlert('warning', 'Please select a user first from the Users tab.');
                showSection('users');
                return;
            }
            
            document.getElementById('enrollmentModalLabel').textContent = 'Add New Enrollment';
            document.getElementById('enrollmentForm').reset();
            document.getElementById('enrollmentIndex').value = '';
            document.getElementById('enrollmentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('enrollmentStatus').value = 'active';
            document.getElementById('enrollmentProgress').value = 0;
            document.getElementById('progress-value').textContent = '0%';
            
            // Populate course dropdown
            populateCourseDropdown('enrollCourseTitle');
            
            showModal('enrollmentModal');
        }

        async function editEnrollment(index) {
            if (!currentUserId) {
                showAlert('error', 'No user selected.');
                return;
            }
            
            currentEnrollmentIndex = index;
            
            showLoading('Loading enrollment data...');
            
            try {
                const userRef = doc(db, USERS_COLLECTION, currentUserId);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    showAlert('error', 'User not found!');
                    return;
                }
                
                const enrollments = userSnap.data().enrolledCourses || [];
                
                if (index < 0 || index >= enrollments.length) {
                    showAlert('error', 'Enrollment not found!');
                    return;
                }
                
                const enrollment = enrollments[index];
                
                document.getElementById('enrollmentModalLabel').textContent = 'Edit Enrollment';
                document.getElementById('enrollmentIndex').value = index;
                
                // Populate course dropdown and select the current course
                await populateCourseDropdown('enrollCourseTitle');
                const courseSelect = document.getElementById('enrollCourseTitle');
                
                // Try to find the course by ID first
                let found = false;
                for (let i = 0; i < courseSelect.options.length; i++) {
                    if (courseSelect.options[i].value === enrollment.courseId) {
                        courseSelect.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                
                // If not found by ID, try by title
                if (!found && enrollment.title) {
                    for (let i = 0; i < courseSelect.options.length; i++) {
                        if (courseSelect.options[i].text === enrollment.title) {
                            courseSelect.selectedIndex = i;
                            found = true;
                            break;
                        }
                    }
                }
                
                // Set other fields
                document.getElementById('enrollmentDate').value = enrollment.enrollmentdate || '';
                document.getElementById('enrollmentCompletionDate').value = enrollment.completionDate || '';
                document.getElementById('enrollmentStatus').value = enrollment.status || 'active';
                
                const progress = parseInt(enrollment.progress) || 0;
                document.getElementById('enrollmentProgress').value = progress;
                document.getElementById('progress-value').textContent = `${progress}%`;
                
                document.getElementById('enrollmentScore').value = enrollment.score || '';
                document.getElementById('enrollmentNotes').value = enrollment.notes || '';
                
                showModal('enrollmentModal');
                
            } catch (error) {
                console.error("Error loading enrollment:", error);
                showAlert('error', 'Failed to load enrollment data.');
            } finally {
                hideLoading();
            }
        }

        async function saveEnrollment() {
            const indexStr = document.getElementById('enrollmentIndex').value;
            const index = indexStr !== '' ? parseInt(indexStr) : null;
            
            const courseSelect = document.getElementById('enrollCourseTitle');
            const selectedOption = courseSelect.options[courseSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                showAlert('error', 'Please select a course.');
                return;
            }
            
            if (!document.getElementById('enrollmentDate').value) {
                showAlert('error', 'Enrollment Date is required.');
                return;
            }
            
            const enrollmentData = {
                courseId: selectedOption.value,
                title: selectedOption.text,
                enrollmentdate: document.getElementById('enrollmentDate').value,
                completionDate: document.getElementById('enrollmentCompletionDate').value || null,
                status: document.getElementById('enrollmentStatus').value,
                progress: `${document.getElementById('enrollmentProgress').value}%`,
                score: document.getElementById('enrollmentScore').value.trim() || null,
                notes: document.getElementById('enrollmentNotes').value.trim() || null,
                updatedAt: new Date().toISOString()
            };
            
            showLoading(index !== null ? 'Updating enrollment...' : 'Adding enrollment...');
            
            try {
                const userRef = doc(db, USERS_COLLECTION, currentUserId);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    throw new Error("User document not found during save.");
                }
                
                const enrolledCourses = userSnap.data().enrolledCourses || [];
                
                if (index !== null && index >= 0 && index < enrolledCourses.length) {
                    // Update existing enrollment
                    enrolledCourses[index] = enrollmentData;
                    showAlert('success', 'Enrollment updated successfully!');
                } else {
                    // Add new enrollment
                    // Check for duplicate course enrollment
                    if (enrolledCourses.some(ec => ec.courseId === enrollmentData.courseId)) {
                        const confirmAdd = await showConfirmation(
                            'Duplicate Enrollment',
                            'This user is already enrolled in this course. Add another enrollment record anyway?',
                            null, // No automatic action
                            true // Return promise
                        );
                        
                        if (!confirmAdd) {
                            hideLoading();
                            return;
                        }
                    }
                    
                    enrolledCourses.push(enrollmentData);
                    showAlert('success', 'Enrollment added successfully!');
                }
                
                await updateDoc(userRef, { enrolledCourses: enrolledCourses });
                
                closeModals();
                loadEnrollments();
                populateCourseFilter();
                
            } catch (error) {
                console.error("Error saving enrollment:", error);
                showAlert('error', `Error saving enrollment: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function deleteEnrollment(index) {
            showConfirmation(
                'Delete Enrollment',
                'Are you sure you want to delete this enrollment record?',
                async () => {
                    showLoading('Deleting enrollment...');
                    
                    try {
                        const userRef = doc(db, USERS_COLLECTION, currentUserId);
                        const userSnap = await getDoc(userRef);
                        
                        if (!userSnap.exists()) {
                            throw new Error("User not found.");
                        }
                        
                        const enrolledCourses = userSnap.data().enrolledCourses || [];
                        
                        if (index >= 0 && index < enrolledCourses.length) {
                            const deletedTitle = enrolledCourses[index].title;
                            enrolledCourses.splice(index, 1);
                            
                            await updateDoc(userRef, { enrolledCourses: enrolledCourses });
                            
                            showAlert('success', `Enrollment for "${deletedTitle}" deleted successfully!`);
                            loadEnrollments();
                            populateCourseFilter();
                        } else {
                            showAlert('error', 'Invalid enrollment index. Could not delete.');
                        }
                        
                    } catch (error) {
                        console.error("Error deleting enrollment:", error);
                        showAlert('error', `Error deleting enrollment: ${error.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            );
        }

        function openAddCourseModal() {
            document.getElementById('courseModalLabel').textContent = 'Add New Course';
            document.getElementById('courseForm').reset();
            document.getElementById('courseId').value = '';
            document.getElementById('courseType').value = 'online';
            document.getElementById('courseLanguage').value = 'english';
            document.getElementById('courseDuration').value = '12';
            
            // Populate instructor dropdown
            populateInstructorDropdown();
            
            // Populate prerequisites dropdown
            populateCourseDropdown('coursePrerequisites');
            
            showModal('courseModal');
        }

        async function editCourse(id) {
            showLoading('Loading course data...');
            
            try {
                const courseRef = doc(db, COURSES_COLLECTION, id);
                const courseSnap = await getDoc(courseRef);
                
                if (!courseSnap.exists()) {
                    showAlert('error', 'Course not found!');
                    return;
                }
                
                const course = courseSnap.data();
                
                document.getElementById('courseModalLabel').textContent = 'Edit Course';
                document.getElementById('courseId').value = id;
                document.getElementById('courseTitle').value = course.title || '';
                document.getElementById('courseDescription').value = course.description || '';
                document.getElementById('courseType').value = course.type || 'online';
                document.getElementById('courseCategory').value = course.category || '';
                document.getElementById('courseLanguage').value = course.language || 'english';
                document.getElementById('courseDuration').value = course.duration || '12';
                document.getElementById('coursePrice').value = course.price || '';
                
                // Populate instructor dropdown and select current instructor
                await populateInstructorDropdown();
                const instructorSelect = document.getElementById('courseInstructor');
                
                if (course.instructor) {
                    for (let i = 0; i < instructorSelect.options.length; i++) {
                        if (instructorSelect.options[i].value === course.instructor) {
                            instructorSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                // Populate prerequisites dropdown and select current prerequisites
                await populateCourseDropdown('coursePrerequisites');
                const prereqSelect = document.getElementById('coursePrerequisites');
                
                if (course.prerequisites && course.prerequisites.length > 0) {
                    const prereqIds = course.prerequisites;
                    for (let i = 0; i < prereqSelect.options.length; i++) {
                        if (prereqIds.includes(prereqSelect.options[i].value)) {
                            prereqSelect.options[i].selected = true;
                        }
                    }
                }
                
                document.getElementById('courseImage').value = course.imageUrl || '';
                
                showModal('courseModal');
                
            } catch (error) {
                console.error("Error loading course:", error);
                showAlert('error', 'Failed to load course data.');
            } finally {
                hideLoading();
            }
        }

        async function saveCourse() {
            const courseId = document.getElementById('courseId').value;
            const courseData = {
                title: document.getElementById('courseTitle').value.trim(),
                description: document.getElementById('courseDescription').value.trim(),
                type: document.getElementById('courseType').value,
                category: document.getElementById('courseCategory').value.trim(),
                language: document.getElementById('courseLanguage').value,
                duration: document.getElementById('courseDuration').value,
                price: document.getElementById('coursePrice').value.trim(),
                instructor: document.getElementById('courseInstructor').value,
                prerequisites: Array.from(document.getElementById('coursePrerequisites').selectedOptions)
                    .map(option => option.value),
                imageUrl: document.getElementById('courseImage').value.trim(),
                updatedAt: Timestamp.now()
            };
            
            // Validation
            if (!courseData.title || !courseData.description) {
                showAlert('error', 'Title and Description are required!');
                return;
            }
            
            showLoading(courseId ? 'Updating course...' : 'Adding course...');
            
            try {
                if (courseId) {
                    // Update existing course
                    await updateDoc(doc(db, COURSES_COLLECTION, courseId), courseData);
                    showAlert('success', 'Course updated successfully!');
                } else {
                    // Add new course
                    courseData.createdAt = Timestamp.now();
                    courseData.studentCount = 0;
                    await addDoc(collection(db, COURSES_COLLECTION), courseData);
                    showAlert('success', 'Course added successfully!');
                }
                
                closeModals();
                loadCourses(currentPage.courses);
                populateCourseFilter();
                populateCourseDropdown('enrollCourseTitle');
                
            } catch (error) {
                console.error("Error saving course:", error);
                showAlert('error', `Error saving course: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function deleteCourse(id) {
            showConfirmation(
                'Delete Course',
                'Are you sure you want to delete this course? This will not automatically unenroll users. This action cannot be undone.',
                async () => {
                    showLoading('Deleting course...');
                    
                    try {
                        await deleteDoc(doc(db, COURSES_COLLECTION, id));
                        
                        showAlert('success', 'Course deleted successfully!');
                        loadCourses(currentPage.courses);
                        populateCourseFilter();
                        populateCourseDropdown('enrollCourseTitle');
                        
                    } catch (error) {
                        console.error("Error deleting course:", error);
                        showAlert('error', `Error deleting course: ${error.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            );
        }

        async function handleRequest(requestId, action) {
            showConfirmation(
                `${action === 'approve' ? 'Approve' : 'Reject'} Request`,
                `Are you sure you want to ${action} this unenrollment request?`,
                async () => {
                    showLoading(`${action === 'approve' ? 'Approving' : 'Rejecting'} request...`);
                    
                    try {
                        const requestRef = doc(db, REQUESTS_COLLECTION, requestId);
                        const requestSnap = await getDoc(requestRef);
                        
                        if (!requestSnap.exists()) {
                            throw new Error("Request not found.");
                        }
                        
                        const requestData = requestSnap.data();
                        const userId = requestData.userId;
                        const courseId = requestData.courseId;
                        
                        if (action === 'approve') {
                            // Get user's current enrollments
                            const userRef = doc(db, USERS_COLLECTION, userId);
                            const userSnap = await getDoc(userRef);
                            
                            if (userSnap.exists()) {
                                let enrolledCourses = userSnap.data().enrolledCourses || [];
                                const initialLength = enrolledCourses.length;
                                
                                // Remove the enrollment
                                enrolledCourses = enrolledCourses.filter(ec => ec.courseId !== courseId);
                                
                                if (enrolledCourses.length < initialLength) {
                                    await updateDoc(userRef, { enrolledCourses: enrolledCourses });
                                    
                                    // If the currently viewed user's enrollments were changed, refresh view
                                    if (currentUserId === userId) {
                                        loadEnrollments();
                                    }
                                    
                                    populateCourseFilter();
                                }
                            }
                        }
                        
                        // Update request status
                        await updateDoc(requestRef, { 
                            status: action === 'approve' ? 'approved' : 'rejected',
                            processedAt: Timestamp.now()
                        });
                        
                        showAlert('success', `Request ${action === 'approve' ? 'approved' : 'rejected'} successfully!`);
                        loadRequests();
                        
                    } catch (error) {
                        console.error(`Error handling request (${action}):`, error);
                        showAlert('error', `Error handling request: ${error.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            );
        }

        async function viewRequestDetails(requestId) {
            showLoading('Loading request details...');
            
            try {
                const requestRef = doc(db, REQUESTS_COLLECTION, requestId);
                const requestSnap = await getDoc(requestRef);
                
                if (!requestSnap.exists()) {
                    showAlert('error', 'Request not found!');
                    return;
                }
                
                const requestData = requestSnap.data();
                
                // Fetch user details
                let userName = 'Unknown User';
                if (requestData.userId) {
                    const userSnap = await getDoc(doc(db, USERS_COLLECTION, requestData.userId));
                    if (userSnap.exists()) {
                        userName = userSnap.data().name || 'Unnamed User';
                    }
                }
                
                // Fetch course details
                let courseTitle = 'Unknown Course';
                if (requestData.courseId) {
                    const courseSnap = await getDoc(doc(db, COURSES_COLLECTION, requestData.courseId));
                    if (courseSnap.exists()) {
                        courseTitle = courseSnap.data().title || 'Unnamed Course';
                    }
                }
                
                // Show details in modal
                document.getElementById('confirmationTitle').textContent = 'Request Details';
                document.getElementById('confirmationMessage').innerHTML = `
                    <div class="mb-10">
                        <strong>User:</strong> ${userName} (${requestData.userId || 'N/A'})
                    </div>
                    <div class="mb-10">
                        <strong>Course:</strong> ${courseTitle} (${requestData.courseId || 'N/A'})
                    </div>
                    <div class="mb-10">
                        <strong>Status:</strong> <span class="badge ${getStatusBadgeClass(requestData.status)}">
                            ${requestData.status}
                        </span>
                    </div>
                    <div class="mb-10">
                        <strong>Requested At:</strong> ${formatDate(requestData.requestedAt?.toDate())}
                    </div>
                    ${requestData.processedAt ? `
                        <div class="mb-10">
                            <strong>Processed At:</strong> ${formatDate(requestData.processedAt?.toDate())}
                        </div>
                    ` : ''}
                    ${requestData.reason ? `
                        <div class="mb-10">
                            <strong>Reason:</strong> ${requestData.reason}
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('confirmAction').classList.add('hidden');
                showModal('confirmationModal');
                
            } catch (error) {
                console.error("Error loading request details:", error);
                showAlert('error', 'Failed to load request details.');
            } finally {
                hideLoading();
            }
        }

        async function saveSettings() {
            const settingsData = {
                systemName: document.getElementById('system-name').value.trim(),
                defaultRole: document.getElementById('default-role').value,
                enrollmentDuration: parseInt(document.getElementById('enrollment-duration').value) || 365,
                emailNotifications: document.getElementById('email-notifications').checked,
                approvalRequired: document.getElementById('approval-required').checked,
                updatedAt: Timestamp.now()
            };
            
            showLoading('Saving settings...');
            
            try {
                // In a real app, you might have a single settings document
                // Here we're assuming there's a settings collection with a single document
                const settingsQuery = query(collection(db, SETTINGS_COLLECTION));
                const snapshot = await getDocs(settingsQuery);
                
                if (snapshot.empty) {
                    settingsData.createdAt = Timestamp.now();
                    await addDoc(collection(db, SETTINGS_COLLECTION), settingsData);
                } else {
                    const docId = snapshot.docs[0].id;
                    await updateDoc(doc(db, SETTINGS_COLLECTION, docId), settingsData);
                }
                
                showAlert('success', 'Settings saved successfully!');
                showSection('dashboard');
                
            } catch (error) {
                console.error("Error saving settings:", error);
                showAlert('error', `Error saving settings: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Helper functions
        async function getCollectionCount(collectionName, ...conditions) {
            let q = collection(db, collectionName);
            
            if (conditions.length > 0) {
                q = query(q, ...conditions);
            }
            
            const snapshot = await getDocs(q);
            return snapshot.size;
        }

        async function getTotalEnrollments() {
            const q = query(collection(db, USERS_COLLECTION), where('enrolledCourses', '!=', []));
            const snapshot = await getDocs(q);
            
            let count = 0;
            snapshot.forEach(doc => {
                count += (doc.data().enrolledCourses || []).length;
            });
            
            return count;
        }

        async function populateFilterOptions(filterId, collectionName, fieldName) {
            const select = document.getElementById(filterId);
            if (!select) return;
            
            try {
                const snapshot = await getDocs(collection(db, collectionName));
                const values = new Set();
                
                snapshot.forEach(doc => {
                    const value = doc.data()[fieldName];
                    if (value) values.add(value);
                });
                
                // Keep current selection
                const currentValue = select.value;
                select.innerHTML = '';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = filterId === 'filterDepartment' ? 'All Departments' : 'All Languages';
                select.appendChild(defaultOption);
                
                // Add options
                Array.from(values).sort().forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
                
                // Restore selection if it still exists
                if (currentValue && Array.from(select.options).some(o => o.value === currentValue)) {
                    select.value = currentValue;
                }
                
            } catch (error) {
                console.error(`Error populating ${filterId} filter:`, error);
            }
        }

        async function populateCourseFilter() {
            try {
                const snapshot = await getDocs(collection(db, COURSES_COLLECTION));
                const select = document.getElementById('filterCourse');
                
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'All Courses';
                select.appendChild(defaultOption);
                
                // Add courses
                const courses = [];
                snapshot.forEach(doc => {
                    const title = doc.data().title;
                    if (title) courses.push(title);
                });
                
                courses.sort().forEach(title => {
                    const option = document.createElement('option');
                    option.value = title;
                    option.textContent = title;
                    select.appendChild(option);
                });
                
                // Restore selection if it still exists
                if (currentValue && Array.from(select.options).some(o => o.value === currentValue)) {
                    select.value = currentValue;
                }
                
            } catch (error) {
                console.error("Error populating course filter:", error);
            }
        }

        async function populateCourseDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            try {
                const snapshot = await getDocs(collection(db, COURSES_COLLECTION));
                const currentValue = select.multiple ? Array.from(select.selectedOptions).map(o => o.value) : select.value;
                
                select.innerHTML = '';
                
                if (!select.multiple) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select Course';
                    select.appendChild(defaultOption);
                }
                
                const courses = [];
                snapshot.forEach(doc => {
                    courses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                courses.sort((a, b) => a.title.localeCompare(b.title)).forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.title || 'Unnamed Course';
                    select.appendChild(option);
                });
                
                // Restore selection
                if (select.multiple && currentValue.length > 0) {
                    Array.from(select.options).forEach(option => {
                        option.selected = currentValue.includes(option.value);
                    });
                } else if (!select.multiple && currentValue) {
                    select.value = currentValue;
                }
                
            } catch (error) {
                console.error("Error populating course dropdown:", error);
            }
        }

        async function populateInstructorDropdown() {
            const select = document.getElementById('courseInstructor');
            if (!select) return;
            
            try {
                const q = query(collection(db, USERS_COLLECTION), where('role', '==', 'instructor'));
                const snapshot = await getDocs(q);
                const currentValue = select.value;
                
                select.innerHTML = '';
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select Instructor';
                select.appendChild(defaultOption);
                
                const instructors = [];
                snapshot.forEach(doc => {
                    const user = doc.data();
                    instructors.push({
                        id: doc.id,
                        name: user.name,
                        email: user.email
                    });
                });
                
                instructors.sort((a, b) => a.name.localeCompare(b.name)).forEach(instructor => {
                    const option = document.createElement('option');
                    option.value = instructor.id;
                    option.textContent = `${instructor.name} (${instructor.email})`;
                    select.appendChild(option);
                });
                
                // Restore selection
                if (currentValue && Array.from(select.options).some(o => o.value === currentValue)) {
                    select.value = currentValue;
                }
                
            } catch (error) {
                console.error("Error populating instructor dropdown:", error);
            }
        }

        function initCharts() {
            const ctx = document.getElementById('userDistributionChart').getContext('2d');
            
            userDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Admins', 'Instructors', 'Students', 'Others'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#4361ee',
                            '#3f37c9',
                            '#4cc9f0',
                            '#f72585'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateUserDistributionChart(data) {
            if (userDistributionChart) {
                userDistributionChart.data.datasets[0].data = [
                    data.admin || 0,
                    data.instructor || 0,
                    data.student || 0,
                    data.other || 0
                ];
                userDistributionChart.update();
            }
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            
            const d = new Date(date);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
        }

        function getRoleBadgeClass(role) {
            switch (role) {
                case 'admin': return 'badge-danger';
                case 'instructor': return 'badge-warning';
                case 'student': return 'badge-primary';
                default: return 'badge-secondary';
            }
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'active': return 'badge-success';
                case 'completed': return 'badge-primary';
                case 'pending': return 'badge-warning';
                case 'rejected':
                case 'dropped':
                case 'inactive': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }

        // UI Helper functions
        function showModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
            document.body.style.overflow = '';
        }

        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} fade-in`;
            alert.innerHTML = `
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 
                                 type === 'success' ? 'fa-check-circle' : 
                                 'fa-info-circle'}"></i>
                ${message}
            `;
            
            // Add to top of main content
            const mainContent = document.querySelector('.main-content');
            if (mainContent.firstChild) {
                mainContent.insertBefore(alert, mainContent.firstChild);
            } else {
                mainContent.appendChild(alert);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                alert.classList.add('hidden');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        function showError(element, message) {
            if (!element) return;
            
            element.textContent = message;
            element.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        function showConfirmation(title, message, confirmCallback, returnPromise = false) {
            if (returnPromise) {
                return new Promise((resolve) => {
                    document.getElementById('confirmationTitle').textContent = title;
                    document.getElementById('confirmationMessage').textContent = message;
                    document.getElementById('confirmAction').classList.remove('hidden');
                    
                    const handler = () => {
                        document.getElementById('confirmAction').removeEventListener('click', handler);
                        closeModals();
                        resolve(true);
                    };
                    
                    document.getElementById('confirmAction').addEventListener('click', handler);
                    
                    const cancelHandler = () => {
                        document.getElementById('confirmAction').removeEventListener('click', handler);
                        closeModals();
                        resolve(false);
                    };
                    
                    document.querySelector('#confirmationModal .btn-secondary').addEventListener('click', cancelHandler);
                    
                    showModal('confirmationModal');
                });
            } else {
                document.getElementById('confirmationTitle').textContent = title;
                document.getElementById('confirmationMessage').textContent = message;
                document.getElementById('confirmAction').classList.remove('hidden');
                
                document.getElementById('confirmAction').onclick = function() {
                    closeModals();
                    if (confirmCallback) confirmCallback();
                };
                
                showModal('confirmationModal');
            }
        }

        // Export functions
        async function exportUsers() {
            showLoading('Preparing user data for export...');
            
            try {
                const snapshot = await getDocs(collection(db, USERS_COLLECTION));
                const users = [];
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    users.push({
                        id: doc.id,
                        studentId: user.studentId || '',
                        name: user.name || '',
                        email: user.email || '',
                        phone: user.phone || '',
                        department: user.department || '',
                        gender: user.gender || '',
                        role: user.role || '',
                        status: user.status || 'active',
                        createdAt: user.createdAt?.toDate().toISOString() || '',
                        updatedAt: user.updatedAt?.toDate().toISOString() || '',
                        enrolledCourses: (user.enrolledCourses || []).map(c => c.title).join(', ')
                    });
                });
                
                // Create CSV
                const csv = Papa.unparse(users);
                downloadFile(csv, 'users.csv', 'text/csv');
                
            } catch (error) {
                console.error("Error exporting users:", error);
                showAlert('error', 'Failed to export user data.');
            } finally {
                hideLoading();
            }
        }

        async function exportCourses() {
            showLoading('Preparing course data for export...');
            
            try {
                const snapshot = await getDocs(collection(db, COURSES_COLLECTION));
                const courses = [];
                
                snapshot.forEach(doc => {
                    const course = doc.data();
                    courses.push({
                        id: doc.id,
                        title: course.title || '',
                        description: course.description || '',
                        type: course.type || '',
                        category: course.category || '',
                        language: course.language || '',
                        duration: course.duration || '',
                        price: course.price || '',
                        instructor: course.instructor || '',
                        prerequisites: (course.prerequisites || []).join(', '),
                        studentCount: course.studentCount || 0,
                        createdAt: course.createdAt?.toDate().toISOString() || '',
                        updatedAt: course.updatedAt?.toDate().toISOString() || ''
                    });
                });
                
                // Create Excel workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(courses);
                XLSX.utils.book_append_sheet(wb, ws, "Courses");
                XLSX.writeFile(wb, "courses.xlsx");
                
            } catch (error) {
                console.error("Error exporting courses:", error);
                showAlert('error', 'Failed to export course data.');
            } finally {
                hideLoading();
            }
        }

        function downloadFile(data, filename, type) {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Set up auth state observer
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    authStatus.textContent = `Checking permissions for ${user.email}...`;
                    authStatus.className = 'alert alert-info';
                    loginError.classList.add('hidden');
                    
                    const isAdmin = await checkAdminRole(user);
                    
                    if (isAdmin) {
                        authStatus.textContent = `Logged in as Admin: ${user.email}`;
                        authStatus.className = 'alert alert-success';
                        loginContainer.classList.add('hidden');
                        dashboardContainer.classList.remove('hidden');
                        
                        // Initialize dashboard
                        initDashboard();
                        
                        // Track session
                        trackSession(user.uid);
                    } else {
                        authStatus.textContent = `Access Denied. User ${user.email} is not an administrator.`;
                        authStatus.className = 'alert alert-danger';
                        loginContainer.classList.add('hidden');
                        dashboardContainer.classList.add('hidden');
                        
                        // Sign out non-admin users
                        await signOut(auth);
                    }
                } else {
                    // User is signed out
                    authStatus.textContent = 'You are not logged in.';
                    authStatus.className = 'alert alert-warning';
                    loginContainer.classList.remove('hidden');
                    dashboardContainer.classList.add('hidden');
                }
            });
        });

        // Track user session
        async function trackSession(userId) {
            try {
                await addDoc(collection(db, SESSIONS_COLLECTION), {
                    userId: userId,
                    loginTime: Timestamp.now(),
                    userAgent: navigator.userAgent,
                    ipAddress: '' // In a real app, you'd get this from the request
                });
            } catch (error) {
                console.error("Error tracking session:", error);
            }
        }

        // Make functions available globally
        window.showSection = showSection;
        window.closeModals = closeModals;
        window.openAddUserModal = openAddUserModal;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.viewEnrollments = viewEnrollments;
        window.openAddEnrollmentModal = openAddEnrollmentModal;
        window.editEnrollment = editEnrollment;
        window.deleteEnrollment = deleteEnrollment;
        window.openAddCourseModal = openAddCourseModal;
        window.editCourse = editCourse;
        window.deleteCourse = deleteCourse;
        window.handleRequest = handleRequest;
        window.viewRequestDetails = viewRequestDetails;
        window.toggleSelectAll = toggleSelectAll;
        window.handleRowSelection = handleRowSelection;

    </script>
</body>
</html>
