<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
    nav { background: #333; padding: 10px; display: flex; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    nav button { color: #fff; background: transparent; border: none; margin: 0 15px; cursor: pointer; font-size: 17px; padding: 8px 12px; transition: background-color 0.3s ease; border-radius: 4px; }
    nav button:hover { background-color: #555; }
    nav button.active { font-weight: bold; text-decoration: underline; background-color: #555; }
    .section { padding: 20px; max-width: 1200px; margin: 20px auto; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
    h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #e2e2e2; font-weight: bold; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #e9e9e9; cursor: pointer; }
    .actions button { margin-right: 5px; padding: 5px 10px; cursor: pointer; border: none; border-radius: 4px; transition: background-color 0.3s ease; }
    .actions button.edit { background-color: #ffc107; color: #333; }
    .actions button.edit:hover { background-color: #ffda6a; }
    .actions button.delete { background-color: #dc3545; color: white; }
    .actions button.delete:hover { background-color: #e96671; }
    .actions button.view { background-color: #007bff; color: white; }
    .actions button.view:hover { background-color: #0056b3; }
    .actions button.approve { background-color: #28a745; color: white; }
    .actions button.approve:hover { background-color: #218838; }
    .actions button.reject { background-color: #6c757d; color: white; }
    .actions button.reject:hover { background-color: #5a6268; }
    select, input[type="text"], input[type="email"], input[type="number"], input[type="date"], textarea { padding: 8px; margin: 5px 0 15px 0; width: calc(100% - 18px); border: 1px solid #ccc; border-radius: 4px; display: block; }
    label { font-weight: bold; margin-bottom: 5px; display: block; }
    .hidden { display: none; }
    .header-actions { margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
    .header-actions label { margin-bottom: 0; font-weight: normal; }
    .header-actions button { padding: 8px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
    .header-actions button:hover { background-color: #218838; }
    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; position: relative; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; cursor: pointer; }
    .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }
    .modal-buttons { text-align: right; margin-top: 20px; }
    .modal-buttons button { padding: 10px 20px; margin-left: 10px; border: none; border-radius: 4px; cursor: pointer; }
    .modal-buttons button.save { background-color: #007bff; color: white; }
    .modal-buttons button.save:hover { background-color: #0056b3; }
    .modal-buttons button.cancel { background-color: #6c757d; color: white; }
    .modal-buttons button.cancel:hover { background-color: #5a6268; }
    #enroll-user { font-weight: bold; color: #007bff;}
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .access-denied {
      text-align: center;
      padding: 50px;
    }
    .access-denied h2 {
      color: red;
    }
  </style>
</head>
<body>
  <!-- Loading screen (shown by default) -->
  <div id="loadingScreen" class="loading-screen">
    <div>
      <h2>Loading Admin Dashboard...</h2>
    </div>
  </div>

  <!-- Access denied screen (hidden by default) -->
  <div id="accessDenied" class="hidden">
    <div class="access-denied">
      <h2>Access Denied</h2>
      <p>You don't have admin privileges.</p>
      <button onclick="window.location.href='index.html'">Go to Home</button>
    </div>
  </div>

  <!-- Admin Dashboard (hidden by default) -->
  <div id="adminDashboard" class="hidden">
    <nav>
      <button data-target="users" onclick="showSection('users')">Users</button>
      <button data-target="enrollments" onclick="showSection('enrollments')">Enrollments</button>
      <button data-target="courses" onclick="showSection('courses')">Courses</button>
      <button data-target="requests" onclick="showSection('requests')">Unenrollment Requests</button>
      <button onclick="logout()" style="margin-left: auto; background-color: #dc3545;">Logout</button>
    </nav>

    <div id="users" class="section">
      <h2>Users</h2>
      <div class="header-actions">
        <label for="filterCourse">Filter by Course:</label>
        <select id="filterCourse"></select>
        <label for="searchUsers">Search:</label>
        <input type="text" id="searchUsers" placeholder="Name, Email, Student ID...">
        <button onclick="openAddUserModal()">Add User</button>
      </div>
      <table id="users-table">
        <thead>
          <tr>
            <th>Student ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Dept</th>
            <th>Gender</th>
            <th>Role</th>
            <th>Progress</th>
            <th>Courses</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="10">Loading users...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="enrollments" class="section hidden">
      <h2>Enrollments for <span id="enroll-user"></span></h2>
      <div class="header-actions">
        <button onclick="openAddEnrollmentModal()">Add Enrollment</button>
        <button onclick="showSection('users')">Back to Users</button>
      </div>
      <table id="enroll-table">
        <thead>
          <tr>
            <th>Course Title</th>
            <th>Enrollment Date</th>
            <th>Enrollment ID</th>
            <th>Language</th>
            <th>Progress</th>
            <th>Type</th>
            <th>Completion Status</th>
            <th>Score</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="9">No enrollments found</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="courses" class="section hidden">
      <h2>Courses</h2>
      <div class="header-actions">
        <label for="filterCoursesList">Filter:</label>
        <select id="filterCoursesList"></select>
        <label for="searchCourses">Search:</label>
        <input type="text" id="searchCourses" placeholder="Title, Description, Instructor...">
        <button onclick="openAddCourseModal()">Add Course</button>
      </div>
      <table id="courses-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Type</th>
            <th>Language</th>
            <th>Duration</th>
            <th>Price</th>
            <th>Instructor</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="10">Loading courses...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="requests" class="section hidden">
      <h2>Unenrollment Requests</h2>
      <table id="requests-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Course</th>
            <th>Requested At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4">Loading requests...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Modals -->
    <div id="userModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModals()">&times;</span>
        <h2 id="userModalLabel">Add/Edit User</h2>
        <form id="userForm">
          <input type="hidden" id="userId">
          <label for="userStudentId">Student/Staff ID:</label>
          <input type="text" id="userStudentId" placeholder="Enter ID">
          <label for="userName">Full Name*</label>
          <input type="text" id="userName" placeholder="Enter full name" required>
          <label for="userEmail">Email*</label>
          <input type="email" id="userEmail" placeholder="Enter email" required>
          <label for="userPhone">Phone</label>
          <input type="tel" id="userPhone" placeholder="Enter phone number">
          <label for="userDepartment">Department</label>
          <input type="text" id="userDepartment" placeholder="Enter department">
          <label for="userGender">Gender</label>
          <select id="userGender">
            <option value="">Select Gender</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
            <option value="prefer-not-to-say">Prefer not to say</option>
          </select>
          <label for="userRole">Role*</label>
          <select id="userRole" required>
            <option value="">Select Role</option>
            <option value="student">Student</option>
            <option value="instructor">Instructor</option>
            <option value="admin">Admin</option>
          </select>
          <label for="userStatus">Status</label>
          <select id="userStatus">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="suspended">Suspended</option>
          </select>
          <div id="userPasswordGroup">
            <label for="userPassword">Password</label>
            <input type="password" id="userPassword" placeholder="Enter password">
            <div class="password-strength">
              <div class="password-strength-bar" id="passwordStrengthBar"></div>
            </div>
            <small class="text-muted">Leave blank to generate random password</small>
          </div>
          <div class="modal-buttons">
            <button type="button" class="cancel" onclick="closeModals()">Cancel</button>
            <button type="button" class="save" id="userSaveBtn">Save User</button>
          </div>
        </form>
      </div>
    </div>

    <div id="enrollmentModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModals()">&times;</span>
        <h2 id="enrollmentModalLabel">Add/Edit Enrollment</h2>
        <form id="enrollmentForm">
          <input type="hidden" id="enrollmentIndex">
          <label for="enrollCourseTitle">Course*</label>
          <select id="enrollCourseTitle" required>
            <option value="">Select Course</option>
          </select>
          <label for="enrollmentDate">Enrollment Date*</label>
          <input type="date" id="enrollmentDate" required>
          <label for="enrollmentId">Enrollment ID</label>
          <input type="text" id="enrollmentId" placeholder="Enter enrollment ID">
          <label for="enrollmentLanguage">Language</label>
          <input type="text" id="enrollmentLanguage" placeholder="Enter language">
          <label for="enrollmentProgress">Progress (%)</label>
          <input type="number" id="enrollmentProgress" min="0" max="100" placeholder="Enter progress">
          <label for="enrollmentType">Type</label>
          <select id="enrollmentType">
            <option value="online">Online</option>
            <option value="in-person">In-Person</option>
            <option value="hybrid">Hybrid</option>
          </select>
          <label for="enrollmentCompletionStatus">Completion Status</label>
          <select id="enrollmentCompletionStatus">
            <option value="not-started">Not Started</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
          </select>
          <label for="enrollmentScore">Score/Grade</label>
          <input type="text" id="enrollmentScore" placeholder="Enter score or grade">
          <div class="modal-buttons">
            <button type="button" class="cancel" onclick="closeModals()">Cancel</button>
            <button type="button" class="save" id="enrollmentSaveBtn">Save Enrollment</button>
          </div>
        </form>
      </div>
    </div>

    <div id="courseModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModals()">&times;</span>
        <h2 id="courseModalLabel">Add/Edit Course</h2>
        <form id="courseForm">
          <input type="hidden" id="courseId">
          <label for="courseTitle">Title*</label>
          <input type="text" id="courseTitle" placeholder="Enter course title" required>
          <label for="courseDescription">Description*</label>
          <textarea id="courseDescription" placeholder="Enter course description" rows="4" required></textarea>
          <label for="courseType">Type</label>
          <select id="courseType">
            <option value="lecture">Lecture</option>
            <option value="workshop">Workshop</option>
            <option value="seminar">Seminar</option>
            <option value="lab">Lab</option>
            <option value="online">Online</option>
          </select>
          <label for="courseLanguage">Language</label>
          <input type="text" id="courseLanguage" placeholder="Enter language">
          <label for="courseDuration">Duration</label>
          <input type="text" id="courseDuration" placeholder="e.g., 8 weeks, 6 months">
          <label for="coursePrice">Price</label>
          <input type="text" id="coursePrice" placeholder="e.g., $500, Free">
          <label for="courseInstructor">Instructor</label>
          <input type="text" id="courseInstructor" placeholder="Enter instructor name">
          <label for="courseStatus">Status</label>
          <select id="courseStatus">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="draft">Draft</option>
            <option value="archived">Archived</option>
          </select>
          <div class="modal-buttons">
            <button type="button" class="cancel" onclick="closeModals()">Cancel</button>
            <button type="button" class="save" id="courseSaveBtn">Save Course</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      onAuthStateChanged, 
      signOut,
      createUserWithEmailAndPassword,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      doc, 
      getDoc, 
      getDocs,
      setDoc,
      updateDoc, 
      deleteDoc, 
      addDoc, 
      query, 
      where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo",
      authDomain: "pharma-quiz-b5a07.firebaseapp.com",
      databaseURL: "https://pharma-quiz-b5a07-default-rtdb.firebaseio.com",
      projectId: "pharma-quiz-b5a07",
      storageBucket: "pharma-quiz-b5a07.appspot.com",
      messagingSenderId: "161067776789",
      appId: "1:161067776789:web:88b8a61145dc5f5c31471c",
      measurementId: "G-3QRQE9HQFB"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Global state
    const sections = ['users', 'enrollments', 'courses', 'requests'];
    let currentUserId = null;
    let currentEnrollmentIndex = null;
    let currentCourseId = null;
    let currentUser = null;
    
    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
      const loadingScreen = document.getElementById('loadingScreen');
      const accessDenied = document.getElementById('accessDenied');
      const adminDashboard = document.getElementById('adminDashboard');
      
      if (user) {
        // User is signed in
        currentUser = user;
        
        try {
          // Check user document
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          
          if (userDoc.exists()) {
            const userData = userDoc.data();
            
            if (userData.role === 'admin') {
              // Check if admin password is set
              const adminDoc = await getDoc(doc(db, 'admin', user.uid));
              
              if (!adminDoc.exists()) {
                // Prompt admin to create password
                const password = prompt("Please set your admin password:");
                if (password && password.trim() !== "") {
                  await setDoc(doc(db, 'admin', user.uid), {
                    password: password,
                    createdAt: serverTimestamp()
                  });
                  // Show dashboard
                  loadingScreen.classList.add('hidden');
                  adminDashboard.classList.remove('hidden');
                  initDashboard();
                } else {
                  alert("Admin password is required");
                  await signOut(auth);
                  window.location.href = "login.html";
                }
              } else {
                // Show dashboard
                loadingScreen.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                initDashboard();
              }
            } else {
              // Not an admin - show access denied
              loadingScreen.classList.add('hidden');
              accessDenied.classList.remove('hidden');
              await signOut(auth);
            }
          } else {
            // User document doesn't exist
            await signOut(auth);
            window.location.href = "login.html";
          }
        } catch (error) {
          console.error("Authentication check failed:", error);
          loadingScreen.classList.add('hidden');
          accessDenied.classList.remove('hidden');
          await signOut(auth);
        }
      } else {
        // No user signed in - redirect to login
        window.location.href = "login.html";
      }
    });
    
    // Initialize dashboard
    function initDashboard() {
      // Hide all sections initially
      sections.forEach(s => document.getElementById(s).classList.add('hidden'));
      // Show the default section (Users)
      showSection('users');
      // Populate filters on page load
      populateCourseFilter();
      populateCourseListFilter();
      
      // Event listeners
      document.getElementById('userSaveBtn').addEventListener('click', saveUser);
      document.getElementById('enrollmentSaveBtn').addEventListener('click', saveEnrollment);
      document.getElementById('courseSaveBtn').addEventListener('click', saveCourse);
      document.getElementById('searchUsers').addEventListener('input', loadUsers);
      document.getElementById('searchCourses').addEventListener('input', loadCourses);
    }

    // Navigation and Section Display
    window.showSection = function(id) {
      sections.forEach(s => document.getElementById(s).classList.toggle('hidden', s !== id));
      document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active', b.dataset.target === id));

      // Load data when section is shown
      if (id === 'users') loadUsers();
      if (id === 'courses') loadCourses();
      if (id === 'requests') loadRequests();
    }

    // Close all modals
    function closeModals() {
      document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
    }
    window.closeModals = closeModals;

    // Populate course filter dropdown
    async function populateCourseFilter() {
      const sel = document.getElementById('filterCourse');
      sel.innerHTML = '<option value="">All Courses</option>';
      
      try {
        const coursesSnap = await getDocs(collection(db, 'courses'));
        const usersSnap = await getDocs(collection(db, 'users'));
        const titles = new Set();
        
        coursesSnap.forEach(c => titles.add(c.data().title));
        usersSnap.forEach(u => (u.data().enrolledCourses || []).forEach(ec => titles.add(ec.title)));
        
        Array.from(titles).sort().forEach(title => {
          const o = document.createElement('option');
          o.value = title;
          o.textContent = title;
          sel.appendChild(o);
        });
        
        sel.onchange = loadUsers;
      } catch (error) {
        console.error("Error populating course filter:", error);
      }
    }

    async function populateCourseListFilter() {
      const sel = document.getElementById('filterCoursesList');
      sel.innerHTML = '<option value="">All Courses</option>';
      
      try {
        const snap = await getDocs(collection(db, 'courses'));
        snap.forEach(d => {
          const o = document.createElement('option');
          o.value = d.data().title;
          o.textContent = d.data().title;
          sel.appendChild(o);
        });
        sel.onchange = loadCourses;
      } catch (error) {
        console.error("Error populating course list filter:", error);
      }
    }

    async function populateCourseDropdown(selectId) {
      const sel = document.getElementById(selectId);
      sel.innerHTML = '<option value="">Select Course</option>';
      
      try {
        const snap = await getDocs(collection(db, 'courses'));
        snap.forEach(d => {
          const o = document.createElement('option');
          o.value = d.id;
          o.textContent = d.data().title || 'Unnamed Course';
          sel.appendChild(o);
        });
      } catch (error) {
        console.error("Error populating course dropdown:", error);
      }
    }

    // User management functions
    async function loadUsers() {
      const filter = document.getElementById('filterCourse').value;
      const searchInput = document.getElementById('searchUsers').value.toLowerCase();
      const tbody = document.querySelector('#users-table tbody');
      tbody.innerHTML = '<tr><td colspan="10">Loading users...</td></tr>';

      try {
        const snap = await getDocs(collection(db, 'users'));
        tbody.innerHTML = '';

        snap.forEach(d => {
          const u = d.data();
          const userId = d.id;

          // Apply filters
          if (filter && !(u.enrolledCourses || []).some(ec => ec.title === filter)) return;
          
          const userString = `${u.studentId || ''} ${u.name || ''} ${u.email || ''}`.toLowerCase();
          if (searchInput && !userString.includes(searchInput)) return;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.studentId || ''}</td>
            <td>${u.name || ''}</td>
            <td>${u.email || ''}</td>
            <td>${u.phone || ''}</td>
            <td>${u.department || ''}</td>
            <td>${u.gender || ''}</td>
            <td>${u.role || ''}</td>
            <td>${u.progress || ''}</td>
            <td>${(u.enrolledCourses || []).map(ec => ec.title).join(', ')}</td>
            <td class="actions">
              <button class="view" onclick="viewEnrollments('${userId}')">Enrollments</button>
              <button class="edit" onclick="editUser('${userId}')">Edit</button>
              <button class="delete" onclick="deleteUser('${userId}')">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });

        if (tbody.innerHTML === '') {
          tbody.innerHTML = '<tr><td colspan="10">No users found</td></tr>';
        }
      } catch (error) {
        console.error("Error loading users:", error);
        tbody.innerHTML = '<tr><td colspan="10" style="color:red;">Error loading users</td></tr>';
      }
    }

    window.openAddUserModal = function() {
      document.getElementById('userModalLabel').textContent = 'Add New User';
      document.getElementById('userForm').reset();
      document.getElementById('userId').value = '';
      document.getElementById('userModal').style.display = 'block';
    };

    window.editUser = async function(id) {
      const ref = doc(db, 'users', id);
      
      try {
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          alert("User not found!");
          return;
        }

        const u = snap.data();
        document.getElementById('userModalLabel').textContent = 'Edit User';
        document.getElementById('userId').value = id;
        document.getElementById('userStudentId').value = u.studentId || '';
        document.getElementById('userName').value = u.name || '';
        document.getElementById('userEmail').value = u.email || '';
        document.getElementById('userPhone').value = u.phone || '';
        document.getElementById('userDepartment').value = u.department || '';
        document.getElementById('userGender').value = u.gender || '';
        document.getElementById('userRole').value = u.role || '';
        document.getElementById('userStatus').value = u.status || 'active';
        document.getElementById('userPasswordGroup').style.display = 'none';
        
        document.getElementById('userModal').style.display = 'block';
      } catch (error) {
        console.error("Error editing user:", error);
        alert("Error loading user data");
      }
    };

    async function saveUser() {
      const userId = document.getElementById('userId').value;
      const studentId = document.getElementById('userStudentId').value;
      const name = document.getElementById('userName').value;
      const email = document.getElementById('userEmail').value;
      const phone = document.getElementById('userPhone').value;
      const department = document.getElementById('userDepartment').value;
      const gender = document.getElementById('userGender').value;
      const role = document.getElementById('userRole').value;
      const status = document.getElementById('userStatus').value;
      const password = document.getElementById('userPassword').value;

      if (!name || !email || !role) {
        alert("Name, email, and role are required");
        return;
      }

      try {
        const userData = {
          studentId,
          name,
          email,
          phone,
          department,
          gender,
          role,
          status,
          updatedAt: serverTimestamp()
        };

        if (userId) {
          // Update existing user
          await updateDoc(doc(db, 'users', userId), userData);
          alert("User updated successfully");
        } else {
          // Add new user
          if (password) {
            // Create auth user if password is provided
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, { displayName: name });
            userId = userCredential.user.uid;
          }
          
          userData.createdAt = serverTimestamp();
          await setDoc(doc(db, 'users', userId), userData);
          alert("User added successfully");
        }

        closeModals();
        loadUsers();
        populateCourseFilter();
      } catch (error) {
        console.error("Error saving user:", error);
        alert(`Error saving user: ${error.message}`);
      }
    }

    window.deleteUser = async function(id) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      
      try {
        await deleteDoc(doc(db, 'users', id));
        alert("User deleted successfully");
        loadUsers();
        populateCourseFilter();
      } catch (error) {
        console.error("Error deleting user:", error);
        alert(`Error deleting user: ${error.message}`);
      }
    };

    // Enrollment management
    window.viewEnrollments = async function(uid) {
      currentUserId = uid;
      
      try {
        const userRef = doc(db, 'users', uid);
        const userSnap = await getDoc(userRef);
        
        if (!userSnap.exists()) {
          alert("User not found");
          return;
        }

        const userData = userSnap.data();
        document.getElementById('enroll-user').textContent = userData.name || 'User';
        
        const tbody = document.querySelector('#enroll-table tbody');
        tbody.innerHTML = '';
        
        if (!userData.enrolledCourses || userData.enrolledCourses.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9">No enrollments found</td></tr>';
        } else {
          userData.enrolledCourses.forEach((ec, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${ec.title || ''}</td>
              <td>${ec.enrollmentdate || ''}</td>
              <td>${ec.Id || ''}</td>
              <td>${ec.language || ''}</td>
              <td>${ec.progress || ''}</td>
              <td>${ec.type || ''}</td>
              <td>${ec.completionStatus || ''}</td>
              <td>${ec.score || ''}</td>
              <td class="actions">
                <button class="edit" onclick="editEnrollment(${i})">Edit</button>
                <button class="delete" onclick="deleteEnrollment(${i})">Delete</button>
              </td>`;
            tbody.appendChild(tr);
          });
        }

        showSection('enrollments');
        populateCourseDropdown('enrollCourseTitle');
      } catch (error) {
        console.error("Error viewing enrollments:", error);
        alert("Error loading enrollments");
      }
    };

    window.openAddEnrollmentModal = function() {
      document.getElementById('enrollmentModalLabel').textContent = 'Add New Enrollment';
      document.getElementById('enrollmentForm').reset();
      document.getElementById('enrollmentIndex').value = '';
      document.getElementById('enrollmentModal').style.display = 'block';
      populateCourseDropdown('enrollCourseTitle');
    };

    window.editEnrollment = async function(index) {
      currentEnrollmentIndex = index;
      
      try {
        const userRef = doc(db, 'users', currentUserId);
        const userSnap = await getDoc(userRef);
        
        if (!userSnap.exists() || !userSnap.data().enrolledCourses || 
            !userSnap.data().enrolledCourses[index]) {
          alert("Enrollment not found");
          return;
        }

        const ec = userSnap.data().enrolledCourses[index];
        document.getElementById('enrollmentModalLabel').textContent = 'Edit Enrollment';
        document.getElementById('enrollmentIndex').value = index;
        
        // Populate form
        const courseSelect = document.getElementById('enrollCourseTitle');
        for (let i = 0; i < courseSelect.options.length; i++) {
          if (courseSelect.options[i].text === ec.title) {
            courseSelect.selectedIndex = i;
            break;
          }
        }
        
        document.getElementById('enrollmentDate').value = ec.enrollmentdate || '';
        document.getElementById('enrollmentId').value = ec.Id || '';
        document.getElementById('enrollmentLanguage').value = ec.language || '';
        document.getElementById('enrollmentProgress').value = ec.progress || '';
        document.getElementById('enrollmentType').value = ec.type || '';
        document.getElementById('enrollmentCompletionStatus').value = ec.completionStatus || '';
        document.getElementById('enrollmentScore').value = ec.score || '';
        
        document.getElementById('enrollmentModal').style.display = 'block';
      } catch (error) {
        console.error("Error editing enrollment:", error);
        alert("Error loading enrollment data");
      }
    };

    async function saveEnrollment() {
      const index = document.getElementById('enrollmentIndex').value;
      const courseSelect = document.getElementById('enrollCourseTitle');
      const courseId = courseSelect.value;
      const courseTitle = courseSelect.options[courseSelect.selectedIndex].text;
      const enrollmentDate = document.getElementById('enrollmentDate').value;
      const enrollmentId = document.getElementById('enrollmentId').value;
      const language = document.getElementById('enrollmentLanguage').value;
      const progress = document.getElementById('enrollmentProgress').value;
      const type = document.getElementById('enrollmentType').value;
      const completionStatus = document.getElementById('enrollmentCompletionStatus').value;
      const score = document.getElementById('enrollmentScore').value;

      if (!courseId || !enrollmentDate) {
        alert("Course and enrollment date are required");
        return;
      }

      try {
        const userRef = doc(db, 'users', currentUserId);
        const userSnap = await getDoc(userRef);
        
        if (!userSnap.exists()) {
          alert("User not found");
          return;
        }

        const enrolledCourses = userSnap.data().enrolledCourses || [];
        const newEnrollment = {
          courseId,
          title: courseTitle,
          enrollmentdate: enrollmentDate,
          Id: enrollmentId,
          language,
          progress,
          type,
          completionStatus,
          score
        };

        if (index !== '') {
          // Update existing
          enrolledCourses[index] = newEnrollment;
        } else {
          // Add new
          enrolledCourses.push(newEnrollment);
        }

        await updateDoc(userRef, { enrolledCourses });
        closeModals();
        viewEnrollments(currentUserId);
        populateCourseFilter();
      } catch (error) {
        console.error("Error saving enrollment:", error);
        alert(`Error saving enrollment: ${error.message}`);
      }
    }

    window.deleteEnrollment = async function(index) {
      if (!confirm('Are you sure you want to delete this enrollment?')) return;
      
      try {
        const userRef = doc(db, 'users', currentUserId);
        const userSnap = await getDoc(userRef);
        
        if (!userSnap.exists()) {
          alert("User not found");
          return;
        }

        const enrolledCourses = userSnap.data().enrolledCourses || [];
        if (index >= 0 && index < enrolledCourses.length) {
          enrolledCourses.splice(index, 1);
          await updateDoc(userRef, { enrolledCourses });
          viewEnrollments(currentUserId);
          populateCourseFilter();
        } else {
          alert("Invalid enrollment index");
        }
      } catch (error) {
        console.error("Error deleting enrollment:", error);
        alert(`Error deleting enrollment: ${error.message}`);
      }
    };

    // Course management
    async function loadCourses() {
      const filter = document.getElementById('filterCoursesList').value;
      const searchInput = document.getElementById('searchCourses').value.toLowerCase();
      const tbody = document.querySelector('#courses-table tbody');
      tbody.innerHTML = '<tr><td colspan="10">Loading courses...</td></tr>';

      try {
        const snap = await getDocs(collection(db, 'courses'));
        tbody.innerHTML = '';

        snap.forEach(d => {
          const c = d.data();
          const courseId = d.id;

          if (filter && c.title !== filter) return;
          
          const courseString = `${c.title || ''} ${c.description || ''} ${c.instructor || ''}`.toLowerCase();
          if (searchInput && !courseString.includes(searchInput)) return;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.title || ''}</td>
            <td>${c.description || ''}</td>
            <td>${c.type || ''}</td>
            <td>${c.language || ''}</td>
            <td>${c.duration || ''}</td>
            <td>${c.price || ''}</td>
            <td>${c.instructor || ''}</td>
            <td>${c.createdAt?.toDate().toLocaleDateString() || ''}</td>
            <td>${c.updatedAt?.toDate().toLocaleDateString() || ''}</td>
            <td class="actions">
              <button class="edit" onclick="editCourse('${courseId}')">Edit</button>
              <button class="delete" onclick="deleteCourse('${courseId}')">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });

        if (tbody.innerHTML === '') {
          tbody.innerHTML = '<tr><td colspan="10">No courses found</td></tr>';
        }
      } catch (error) {
        console.error("Error loading courses:", error);
        tbody.innerHTML = '<tr><td colspan="10" style="color:red;">Error loading courses</td></tr>';
      }
    }

    window.openAddCourseModal = function() {
      document.getElementById('courseModalLabel').textContent = 'Add New Course';
      document.getElementById('courseForm').reset();
      document.getElementById('courseId').value = '';
      document.getElementById('courseModal').style.display = 'block';
    };

    window.editCourse = async function(id) {
      currentCourseId = id;
      
      try {
        const ref = doc(db, 'courses', id);
        const snap = await getDoc(ref);
        
        if (!snap.exists()) {
          alert("Course not found!");
          return;
        }

        const c = snap.data();
        document.getElementById('courseModalLabel').textContent = 'Edit Course';
        document.getElementById('courseId').value = id;
        document.getElementById('courseTitle').value = c.title || '';
        document.getElementById('courseDescription').value = c.description || '';
        document.getElementById('courseType').value = c.type || '';
        document.getElementById('courseLanguage').value = c.language || '';
        document.getElementById('courseDuration').value = c.duration || '';
        document.getElementById('coursePrice').value = c.price || '';
        document.getElementById('courseInstructor').value = c.instructor || '';
        document.getElementById('courseStatus').value = c.status || 'active';
        
        document.getElementById('courseModal').style.display = 'block';
      } catch (error) {
        console.error("Error editing course:", error);
        alert("Error loading course data");
      }
    };

    async function saveCourse() {
      const courseId = document.getElementById('courseId').value;
      const title = document.getElementById('courseTitle').value;
      const description = document.getElementById('courseDescription').value;
      const type = document.getElementById('courseType').value;
      const language = document.getElementById('courseLanguage').value;
      const duration = document.getElementById('courseDuration').value;
      const price = document.getElementById('coursePrice').value;
      const instructor = document.getElementById('courseInstructor').value;
      const status = document.getElementById('courseStatus').value;

      if (!title || !description) {
        alert("Title and description are required");
        return;
      }

      try {
        const courseData = {
          title,
          description,
          type,
          language,
          duration,
          price,
          instructor,
          status,
          updatedAt: serverTimestamp()
        };

        if (courseId) {
          // Update existing course
          await updateDoc(doc(db, 'courses', courseId), courseData);
          alert("Course updated successfully");
        } else {
          // Add new course
          courseData.createdAt = serverTimestamp();
          await addDoc(collection(db, 'courses'), courseData);
          alert("Course added successfully");
        }

        closeModals();
        loadCourses();
        populateCourseFilter();
        populateCourseListFilter();
      } catch (error) {
        console.error("Error saving course:", error);
        alert(`Error saving course: ${error.message}`);
      }
    }

    window.deleteCourse = async function(id) {
      if (!confirm('Are you sure you want to delete this course?')) return;
      
      try {
        await deleteDoc(doc(db, 'courses', id));
        alert("Course deleted successfully");
        loadCourses();
        populateCourseFilter();
        populateCourseListFilter();
      } catch (error) {
        console.error("Error deleting course:", error);
        alert(`Error deleting course: ${error.message}`);
      }
    };

    // Request management
    async function loadRequests() {
      const tbody = document.querySelector('#requests-table tbody');
      tbody.innerHTML = '<tr><td colspan="4">Loading requests...</td></tr>';

      try {
        const q = query(collection(db, 'requests'), where('status', '==', 'pending'));
        const snap = await getDocs(q);
        tbody.innerHTML = '';

        if (snap.empty) {
          tbody.innerHTML = '<tr><td colspan="4">No pending requests</td></tr>';
          return;
        }

        const requests = await Promise.all(snap.docs.map(async d => {
          const req = d.data();
          let userName = 'N/A';
          let courseTitle = 'N/A';

          if (req.userId) {
            const userSnap = await getDoc(doc(db, 'users', req.userId));
            if (userSnap.exists()) {
              userName = userSnap.data().name || 'Unknown User';
            }
          }

          if (req.courseId) {
            const courseSnap = await getDoc(doc(db, 'courses', req.courseId));
            if (courseSnap.exists()) {
              courseTitle = courseSnap.data().title || 'Unknown Course';
            }
          }

          return {
            id: d.id,
            userName,
            courseTitle,
            requestedAt: req.requestedAt?.toDate().toLocaleString() || 'N/A'
          };
        }));

        requests.forEach(req => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${req.userName}</td>
            <td>${req.courseTitle}</td>
            <td>${req.requestedAt}</td>
            <td class="actions">
              <button class="approve" onclick="handleRequest('${req.id}', 'approve')">Approve</button>
              <button class="reject" onclick="handleRequest('${req.id}', 'reject')">Reject</button>
            </td>`;
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error("Error loading requests:", error);
        tbody.innerHTML = '<tr><td colspan="4" style="color:red;">Error loading requests</td></tr>';
      }
    }

    window.handleRequest = async function(requestId, action) {
      if (!confirm(`Are you sure you want to ${action} this request?`)) return;
      
      try {
        const requestRef = doc(db, 'requests', requestId);
        const requestSnap = await getDoc(requestRef);
        
        if (!requestSnap.exists()) {
          alert("Request not found");
          return;
        }

        const req = requestSnap.data();
        await updateDoc(requestRef, {
          status: action === 'approve' ? 'approved' : 'rejected',
          processedAt: serverTimestamp(),
          processedBy: currentUser.uid
        });

        if (action === 'approve') {
          // Remove course from user's enrollments
          const userRef = doc(db, 'users', req.userId);
          const userSnap = await getDoc(userRef);
          
          if (userSnap.exists()) {
            const enrolledCourses = userSnap.data().enrolledCourses || [];
            const updatedCourses = enrolledCourses.filter(ec => ec.courseId !== req.courseId);
            
            if (updatedCourses.length < enrolledCourses.length) {
              await updateDoc(userRef, { enrolledCourses: updatedCourses });
            }
          }
        }

        alert(`Request ${action}d successfully`);
        loadRequests();
      } catch (error) {
        console.error(`Error ${action}ing request:`, error);
        alert(`Error ${action}ing request: ${error.message}`);
      }
    };

    // Logout
    window.logout = async function() {
      try {
        await signOut(auth);
        window.location.href = "login.html";
      } catch (error) {
        console.error("Error signing out:", error);
      }
    };
  </script>
</body>
</html>
