<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --success-color: #4cc9f0;
      --danger-color: #f72585;
      --warning-color: #f8961e;
      --info-color: #4895ef;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --gray-color: #6c757d;
      --white: #ffffff;
      --sidebar-width: 250px;
      --header-height: 60px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f7fa;
      color: var(--dark-color);
      line-height: 1.6;
    }
    
    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--dark-color);
      color: var(--white);
      padding: 20px 0;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }
    
    .sidebar.active {
      transform: translateX(0);
    }
    
    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }
    
    .sidebar-header h3 {
      color: var(--white);
      margin-bottom: 10px;
    }
    
    .sidebar-menu {
      padding: 20px 0;
    }
    
    .sidebar-menu ul {
      list-style: none;
    }
    
    .sidebar-menu li {
      margin-bottom: 5px;
    }
    
    .sidebar-menu a {
      display: block;
      padding: 12px 20px;
      color: var(--white);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }
    
    .sidebar-menu a:hover {
      background: rgba(255, 255, 255, 0.1);
      border-left: 3px solid var(--primary-color);
    }
    
    .sidebar-menu a.active {
      background: rgba(255, 255, 255, 0.1);
      border-left: 3px solid var(--primary-color);
    }
    
    .sidebar-menu i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    /* Main Content Styles */
    .main-content {
      margin-left: 0;
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }
    
    .main-content.active {
      margin-left: var(--sidebar-width);
    }
    
    /* Header Styles */
    .header {
      position: sticky;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--header-height);
      background: var(--white);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 999;
    }
    
    .header-left {
      display: flex;
      align-items: center;
    }
    
    .menu-toggle {
      font-size: 1.5rem;
      cursor: pointer;
      margin-right: 20px;
      color: var(--dark-color);
    }
    
    .header-title {
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .header-right {
      display: flex;
      align-items: center;
    }
    
    .user-menu {
      position: relative;
    }
    
    .user-btn {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .user-img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      margin-right: 10px;
      background: var(--primary-color);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .user-name {
      font-weight: 500;
    }
    
    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--white);
      min-width: 200px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      padding: 10px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 1001;
    }
    
    .dropdown-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .dropdown-menu a {
      display: block;
      padding: 10px 20px;
      color: var(--dark-color);
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .dropdown-menu a:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    
    .dropdown-divider {
      height: 1px;
      background: rgba(0, 0, 0, 0.1);
      margin: 5px 0;
    }
    
    /* Content Styles */
    .content {
      padding: 20px;
    }
    
    .card {
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    
    .card-header {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
    }
    
    .card-body {
      padding: 20px;
    }
    
    /* Table Styles */
    .table-responsive {
      overflow-x: auto;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th, .table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .table th {
      background: rgba(0, 0, 0, 0.02);
      font-weight: 600;
      color: var(--dark-color);
    }
    
    .table tr:hover {
      background: rgba(0, 0, 0, 0.02);
    }
    
    /* Button Styles */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      text-decoration: none;
    }
    
    .btn i {
      margin-right: 5px;
    }
    
    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background: var(--secondary-color);
    }
    
    .btn-success {
      background: var(--success-color);
      color: var(--white);
    }
    
    .btn-success:hover {
      background: #3aa8d8;
    }
    
    .btn-danger {
      background: var(--danger-color);
      color: var(--white);
    }
    
    .btn-danger:hover {
      background: #e5177a;
    }
    
    .btn-warning {
      background: var(--warning-color);
      color: var(--white);
    }
    
    .btn-warning:hover {
      background: #e68a1a;
    }
    
    .btn-info {
      background: var(--info-color);
      color: var(--white);
    }
    
    .btn-info:hover {
      background: #3a7bc8;
    }
    
    .btn-secondary {
      background: var(--gray-color);
      color: var(--white);
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-light {
      background: var(--light-color);
      color: var(--dark-color);
    }
    
    .btn-light:hover {
      background: #e2e6ea;
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
      outline: none;
    }
    
    .form-select {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      font-size: 14px;
      background-color: var(--white);
      transition: all 0.3s ease;
    }
    
    .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
      outline: none;
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-dialog {
      background: var(--white);
      border-radius: 8px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray-color);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    
    /* Badge Styles */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-primary {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary-color);
    }
    
    .badge-success {
      background: rgba(76, 201, 240, 0.1);
      color: var(--success-color);
    }
    
    .badge-danger {
      background: rgba(247, 37, 133, 0.1);
      color: var(--danger-color);
    }
    
    .badge-warning {
      background: rgba(248, 150, 30, 0.1);
      color: var(--warning-color);
    }
    
    .badge-info {
      background: rgba(72, 149, 239, 0.1);
      color: var(--info-color);
    }
    
    .badge-secondary {
      background: rgba(108, 117, 125, 0.1);
      color: var(--gray-color);
    }
    
    /* Alert Styles */
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: rgba(76, 201, 240, 0.1);
      border-left: 4px solid var(--success-color);
      color: var(--success-color);
    }
    
    .alert-danger {
      background: rgba(247, 37, 133, 0.1);
      border-left: 4px solid var(--danger-color);
      color: var(--danger-color);
    }
    
    .alert-warning {
      background: rgba(248, 150, 30, 0.1);
      border-left: 4px solid var(--warning-color);
      color: var(--warning-color);
    }
    
    .alert-info {
      background: rgba(72, 149, 239, 0.1);
      border-left: 4px solid var(--info-color);
      color: var(--info-color);
    }
    
    /* Stats Cards */
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stats-card {
      background: var(--white);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    
    .stats-card-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 20px;
    }
    
    .stats-card-icon.primary {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary-color);
    }
    
    .stats-card-icon.success {
      background: rgba(76, 201, 240, 0.1);
      color: var(--success-color);
    }
    
    .stats-card-icon.danger {
      background: rgba(247, 37, 133, 0.1);
      color: var(--danger-color);
    }
    
    .stats-card-icon.warning {
      background: rgba(248, 150, 30, 0.1);
      color: var(--warning-color);
    }
    
    .stats-card-value {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .stats-card-label {
      color: var(--gray-color);
      font-size: 14px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      border-bottom: 2px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Responsive Styles */
    @media (max-width: 992px) {
      .sidebar {
        width: 220px;
      }
      
      .main-content.active {
        margin-left: 220px;
      }
    }
    
    @media (max-width: 768px) {
      .stats-cards {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .header-title {
        display: none;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header-actions {
        margin-top: 10px;
        width: 100%;
      }
    }
    
    @media (max-width: 576px) {
      .stats-cards {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        width: 100%;
      }
      
      .main-content.active {
        margin-left: 0;
      }
      
      .modal-dialog {
        margin: 10px;
        width: calc(100% - 20px);
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .table th, .table td {
        padding: 8px 10px;
      }
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }
    
    /* Hidden class */
    .hidden {
      display: none !important;
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    /* Custom checkbox */
    .custom-checkbox {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      cursor: pointer;
    }
    
    .custom-checkbox input {
      margin-right: 10px;
    }
    
    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Password strength indicator */
    .password-strength {
      height: 5px;
      background: #eee;
      margin-top: 5px;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .password-strength-bar {
      height: 100%;
      width: 0;
      transition: width 0.3s ease;
    }
    
    .strength-weak {
      background: #ff4d4d;
    }
    
    .strength-medium {
      background: #ffa500;
    }
    
    .strength-strong {
      background: #4CAF50;
    }
    
    /* Login modal */
    .login-modal {
      max-width: 400px;
    }
    
    .login-logo {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .login-logo i {
      font-size: 50px;
      color: var(--primary-color);
    }
    
    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      font-size: 14px;
      color: var(--gray-color);
    }
    
    .breadcrumb a {
      color: var(--primary-color);
      text-decoration: none;
      margin: 0 5px;
    }
    
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    
    .breadcrumb-separator {
      margin: 0 5px;
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }
    
    .empty-state i {
      font-size: 50px;
      color: var(--gray-color);
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .empty-state h3 {
      color: var(--gray-color);
      margin-bottom: 10px;
    }
    
    .empty-state p {
      color: var(--gray-color);
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3><i class="fas fa-cogs"></i> Admin Panel</h3>
    </div>
    <div class="sidebar-menu">
      <ul>
        <li><a href="#" class="active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="#" onclick="showSection('users')"><i class="fas fa-users"></i> Users</a></li>
        <li><a href="#" onclick="showSection('enrollments')"><i class="fas fa-user-graduate"></i> Enrollments</a></li>
        <li><a href="#" onclick="showSection('courses')"><i class="fas fa-book"></i> Courses</a></li>
        <li><a href="#" onclick="showSection('requests')"><i class="fas fa-envelope"></i> Requests</a></li>
        <li><a href="#" onclick="showSection('analytics')"><i class="fas fa-chart-line"></i> Analytics</a></li>
        <li><a href="#" onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</a></li>
      </ul>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="menu-toggle" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </div>
        <div class="header-title">Admin Dashboard</div>
      </div>
      <div class="header-right">
        <div class="user-menu">
          <div class="user-btn" onclick="toggleUserMenu()">
            <div class="user-img" id="userInitial">A</div>
            <div class="user-name">Admin</div>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="dropdown-menu">
            <a href="#"><i class="fas fa-user"></i> Profile</a>
            <a href="#"><i class="fas fa-cog"></i> Settings</a>
            <div class="dropdown-divider"></div>
            <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <div class="content">
      <!-- Dashboard Section -->
      <div id="dashboard" class="section">
        <div class="breadcrumb">
          <a href="#" onclick="showSection('dashboard')"><i class="fas fa-home"></i></a>
          <span class="breadcrumb-separator">/</span>
          <span>Dashboard</span>
        </div>
        
        <h2 class="card-title">Dashboard Overview</h2>
        
        <div class="stats-cards">
          <div class="stats-card">
            <div class="stats-card-icon primary">
              <i class="fas fa-users"></i>
            </div>
            <div class="stats-card-value" id="totalUsers">0</div>
            <div class="stats-card-label">Total Users</div>
          </div>
          
          <div class="stats-card">
            <div class="stats-card-icon success">
              <i class="fas fa-book"></i>
            </div>
            <div class="stats-card-value" id="totalCourses">0</div>
            <div class="stats-card-label">Total Courses</div>
          </div>
          
          <div class="stats-card">
            <div class="stats-card-icon warning">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div class="stats-card-value" id="totalEnrollments">0</div>
            <div class="stats-card-label">Active Enrollments</div>
          </div>
          
          <div class="stats-card">
            <div class="stats-card-icon danger">
              <i class="fas fa-envelope"></i>
            </div>
            <div class="stats-card-value" id="pendingRequests">0</div>
            <div class="stats-card-label">Pending Requests</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Recent Activity</div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Action</th>
                    <th>Details</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody id="activityTable">
                  <tr>
                    <td colspan="4">Loading activity...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div id="users" class="section hidden">
        <div class="breadcrumb">
          <a href="#" onclick="showSection('dashboard')"><i class="fas fa-home"></i></a>
          <span class="breadcrumb-separator">/</span>
          <span>Users</span>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">User Management</div>
            <div class="header-actions">
              <div class="form-group" style="margin-bottom: 0;">
                <select id="filterRole" class="form-control" style="width: auto; display: inline-block;">
                  <option value="">All Roles</option>
                  <option value="student">Student</option>
                  <option value="instructor">Instructor</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <select id="filterCourse" class="form-control" style="width: auto; display: inline-block;">
                  <option value="">All Courses</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <input type="text" id="searchUsers" class="form-control" placeholder="Search users..." style="width: auto; display: inline-block;">
              </div>
              <div class="export-buttons">
                <button class="btn btn-secondary btn-sm" onclick="exportUsers('csv')"><i class="fas fa-file-csv"></i> CSV</button>
                <button class="btn btn-secondary btn-sm" onclick="exportUsers('excel')"><i class="fas fa-file-excel"></i> Excel</button>
                <button class="btn btn-secondary btn-sm" onclick="exportUsers('pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
              </div>
              <button class="btn btn-primary" onclick="openAddUserModal()"><i class="fas fa-plus"></i> Add User</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table" id="users-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Courses</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7">Loading users...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
              <div class="pagination-info" id="usersPaginationInfo">Showing 0 of 0 users</div>
              <div class="pagination-controls">
                <button class="btn btn-light" id="usersPrevPage" disabled><i class="fas fa-chevron-left"></i></button>
                <span style="margin: 0 10px;" id="usersPageInfo">Page 1</span>
                <button class="btn btn-light" id="usersNextPage" disabled><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enrollments Section -->
      <div id="enrollments" class="section hidden">
        <div class="breadcrumb">
          <a href="#" onclick="showSection('dashboard')"><i class="fas fa-home"></i></a>
          <span class="breadcrumb-separator">/</span>
          <a href="#" onclick="showSection('users')">Users</a>
          <span class="breadcrumb-separator">/</span>
          <span id="enroll-user-name">Enrollments</span>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Enrollments for <span id="enroll-user"></span></div>
            <div class="header-actions">
              <button class="btn btn-light" onclick="showSection('users')"><i class="fas fa-arrow-left"></i> Back to Users</button>
              <button class="btn btn-primary" onclick="openAddEnrollmentModal()"><i class="fas fa-plus"></i> Add Enrollment</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table" id="enroll-table">
                <thead>
                  <tr>
                    <th>Course</th>
                    <th>Enrollment Date</th>
                    <th>Progress</th>
                    <th>Status</th>
                    <th>Score</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="6">No enrollments found</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Courses Section -->
      <div id="courses" class="section hidden">
        <div class="breadcrumb">
          <a href="#" onclick="showSection('dashboard')"><i class="fas fa-home"></i></a>
          <span class="breadcrumb-separator">/</span>
          <span>Courses</span>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Course Management</div>
            <div class="header-actions">
              <div class="form-group" style="margin-bottom: 0;">
                <select id="filterCoursesList" class="form-control" style="width: auto; display: inline-block;">
                  <option value="">All Courses</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <input type="text" id="searchCourses" class="form-control" placeholder="Search courses..." style="width: auto; display: inline-block;">
              </div>
              <button class="btn btn-primary" onclick="openAddCourseModal()"><i class="fas fa-plus"></i> Add Course</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table" id="courses-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Instructor</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="6">Loading courses...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
              <div class="pagination-info" id="coursesPaginationInfo">Showing 0 of 0 courses</div>
              <div class="pagination-controls">
                <button class="btn btn-light" id="coursesPrevPage" disabled><i class="fas fa-chevron-left"></i></button>
                <span style="margin: 0 10px;" id="coursesPageInfo">Page 1</span>
                <button class="btn btn-light" id="coursesNextPage" disabled><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Requests Section -->
      <div id="requests" class="section hidden">
        <div class="breadcrumb">
          <a href="#" onclick="showSection('dashboard')"><i class="fas fa-home"></i></a>
          <span class="breadcrumb-separator">/</span>
          <span>Unenrollment Requests</span>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Unenrollment Requests</div>
            <div class="header-actions">
              <div class="form-group" style="margin-bottom: 0;">
                <select id="filterRequestStatus" class="form-control" style="width: auto; display: inline-block;">
                  <option value="pending">Pending</option>
                  <option value="all">All</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table" id="requests-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Course</th>
                    <th>Requested At</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5">Loading requests...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Analytics Section -->
      <div id="analytics" class="section hidden">
        <div class="breadcrumb">
          <a href="#" onclick="showSection('dashboard')"><i class="fas fa-home"></i></a>
          <span class="breadcrumb-separator">/</span>
          <span>Analytics</span>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">System Analytics</div>
            <div class="header-actions">
              <select id="analyticsTimeRange" class="form-control" style="width: auto; display: inline-block;">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
                <option value="365">Last Year</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div id="analyticsCharts" style="min-height: 400px;">
              <div class="row" style="display: flex; flex-wrap: wrap; margin: -10px;">
                <div class="col-md-6" style="flex: 0 0 50%; max-width: 50%; padding: 10px;">
                  <div class="card" style="height: 100%;">
                    <div class="card-header">
                      <div class="card-title">User Registrations</div>
                    </div>
                    <div class="card-body">
                      <canvas id="userRegistrationsChart" height="300"></canvas>
                    </div>
                  </div>
                </div>
                <div class="col-md-6" style="flex: 0 0 50%; max-width: 50%; padding: 10px;">
                  <div class="card" style="height: 100%;">
                    <div class="card-header">
                      <div class="card-title">Course Enrollments</div>
                    </div>
                    <div class="card-body">
                      <canvas id="courseEnrollmentsChart" height="300"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row" style="display: flex; flex-wrap: wrap; margin: -10px; margin-top: 20px;">
                <div class="col-md-6" style="flex: 0 0 50%; max-width: 50%; padding: 10px;">
                  <div class="card" style="height: 100%;">
                    <div class="card-header">
                      <div class="card-title">User Activity</div>
                    </div>
                    <div class="card-body">
                      <canvas id="userActivityChart" height="300"></canvas>
                    </div>
                  </div>
                </div>
                <div class="col-md-6" style="flex: 0 0 50%; max-width: 50%; padding: 10px;">
                  <div class="card" style="height: 100%;">
                    <div class="card-header">
                      <div class="card-title">Course Completion</div>
                    </div>
                    <div class="card-body">
                      <canvas id="courseCompletionChart" height="300"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div id="settings" class="section hidden">
        <div class="breadcrumb">
          <a href="#" onclick="showSection('dashboard')"><i class="fas fa-home"></i></a>
          <span class="breadcrumb-separator">/</span>
          <span>Settings</span>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">System Settings</div>
          </div>
          <div class="card-body">
            <div class="tabs">
              <div class="tab active" onclick="openSettingsTab('general')">General</div>
              <div class="tab" onclick="openSettingsTab('security')">Security</div>
              <div class="tab" onclick="openSettingsTab('notifications')">Notifications</div>
              <div class="tab" onclick="openSettingsTab('backup')">Backup</div>
            </div>
            
            <div class="tab-content active" id="generalSettings">
              <form id="generalSettingsForm">
                <div class="form-group">
                  <label for="systemName">System Name</label>
                  <input type="text" id="systemName" class="form-control" placeholder="Enter system name">
                </div>
                <div class="form-group">
                  <label for="systemEmail">System Email</label>
                  <input type="email" id="systemEmail" class="form-control" placeholder="Enter system email">
                </div>
                <div class="form-group">
                  <label for="timezone">Timezone</label>
                  <select id="timezone" class="form-control">
                    <option value="UTC">UTC</option>
                    <option value="EST">Eastern Time (EST)</option>
                    <option value="CST">Central Time (CST)</option>
                    <option value="PST">Pacific Time (PST)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="dateFormat">Date Format</label>
                  <select id="dateFormat" class="form-control">
                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                  </select>
                </div>
                <div class="form-group">
                  <button type="button" class="btn btn-primary" onclick="saveGeneralSettings()">Save Settings</button>
                </div>
              </form>
            </div>
            
            <div class="tab-content" id="securitySettings">
              <form id="securitySettingsForm">
                <div class="form-group">
                  <label for="passwordPolicy">Password Policy</label>
                  <select id="passwordPolicy" class="form-control">
                    <option value="low">Low (6 characters minimum)</option>
                    <option value="medium" selected>Medium (8 characters, 1 number)</option>
                    <option value="high">High (10 characters, 1 number, 1 special)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="loginAttempts">Max Login Attempts</label>
                  <input type="number" id="loginAttempts" class="form-control" min="1" max="10" value="5">
                </div>
                <div class="form-group">
                  <label for="sessionTimeout">Session Timeout (minutes)</label>
                  <input type="number" id="sessionTimeout" class="form-control" min="5" max="1440" value="30">
                </div>
                <div class="form-group">
                  <div class="custom-checkbox">
                    <input type="checkbox" id="enable2FA">
                    <label for="enable2FA">Enable Two-Factor Authentication</label>
                  </div>
                </div>
                <div class="form-group">
                  <button type="button" class="btn btn-primary" onclick="saveSecuritySettings()">Save Settings</button>
                </div>
              </form>
            </div>
            
            <div class="tab-content" id="notificationSettings">
              <form id="notificationSettingsForm">
                <div class="form-group">
                  <div class="custom-checkbox">
                    <input type="checkbox" id="emailNotifications" checked>
                    <label for="emailNotifications">Enable Email Notifications</label>
                  </div>
                </div>
                <div class="form-group">
                  <label for="notificationEmail">Notification Email</label>
                  <input type="email" id="notificationEmail" class="form-control" placeholder="Enter notification email">
                </div>
                <div class="form-group">
                  <label>Notification Types</label>
                  <div class="custom-checkbox">
                    <input type="checkbox" id="newUserNotification" checked>
                    <label for="newUserNotification">New User Registration</label>
                  </div>
                  <div class="custom-checkbox">
                    <input type="checkbox" id="courseEnrollmentNotification" checked>
                    <label for="courseEnrollmentNotification">Course Enrollment</label>
                  </div>
                  <div class="custom-checkbox">
                    <input type="checkbox" id="unenrollmentRequestNotification" checked>
                    <label for="unenrollmentRequestNotification">Unenrollment Request</label>
                  </div>
                </div>
                <div class="form-group">
                  <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">Save Settings</button>
                </div>
              </form>
            </div>
            
            <div class="tab-content" id="backupSettings">
              <div class="form-group">
                <label>Backup Options</label>
                <div class="custom-checkbox">
                  <input type="checkbox" id="autoBackup">
                  <label for="autoBackup">Enable Automatic Backups</label>
                </div>
              </div>
              <div class="form-group">
                <label for="backupFrequency">Backup Frequency</label>
                <select id="backupFrequency" class="form-control">
                  <option value="daily">Daily</option>
                  <option value="weekly" selected>Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
              <div class="form-group">
                <label for="backupTime">Backup Time</label>
                <input type="time" id="backupTime" class="form-control" value="02:00">
              </div>
              <div class="form-group">
                <label for="backupRetention">Retention Period (days)</label>
                <input type="number" id="backupRetention" class="form-control" min="1" max="365" value="30">
              </div>
              <div class="form-group">
                <button class="btn btn-primary" onclick="createBackup()"><i class="fas fa-save"></i> Create Backup Now</button>
                <button class="btn btn-secondary" onclick="restoreBackup()"><i class="fas fa-undo"></i> Restore Backup</button>
              </div>
              <div class="form-group">
                <label>Recent Backups</label>
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Size</th>
                        <th>Type</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="backupList">
                      <tr>
                        <td colspan="4">No backups available</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modal" id="userModal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 class="modal-title" id="userModalLabel">Add User</h2>
        <button class="modal-close" onclick="closeModals()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <input type="hidden" id="userId">
          <div class="form-group">
            <label for="userStudentId">Student/Staff ID</label>
            <input type="text" id="userStudentId" class="form-control" placeholder="Enter ID">
          </div>
          <div class="form-group">
            <label for="userName">Full Name*</label>
            <input type="text" id="userName" class="form-control" placeholder="Enter full name" required>
          </div>
          <div class="form-group">
            <label for="userEmail">Email*</label>
            <input type="email" id="userEmail" class="form-control" placeholder="Enter email" required>
          </div>
          <div class="form-group">
            <label for="userPhone">Phone</label>
            <input type="tel" id="userPhone" class="form-control" placeholder="Enter phone number">
          </div>
          <div class="form-group">
            <label for="userDepartment">Department</label>
            <input type="text" id="userDepartment" class="form-control" placeholder="Enter department">
          </div>
          <div class="form-group">
            <label for="userGender">Gender</label>
            <select id="userGender" class="form-control">
              <option value="">Select Gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
              <option value="prefer-not-to-say">Prefer not to say</option>
            </select>
          </div>
          <div class="form-group">
            <label for="userRole">Role*</label>
            <select id="userRole" class="form-control" required>
              <option value="">Select Role</option>
              <option value="student">Student</option>
              <option value="instructor">Instructor</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label for="userStatus">Status</label>
            <select id="userStatus" class="form-control">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>
          <div class="form-group" id="userPasswordGroup">
            <label for="userPassword">Password</label>
            <input type="password" id="userPassword" class="form-control" placeholder="Enter password">
            <div class="password-strength">
              <div class="password-strength-bar" id="passwordStrengthBar"></div>
            </div>
            <small class="text-muted">Leave blank to generate random password</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" onclick="closeModals()">Cancel</button>
        <button class="btn btn-primary" id="userSaveBtn">Save User</button>
      </div>
    </div>
  </div>

  <!-- Enrollment Modal -->
  <div class="modal" id="enrollmentModal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 class="modal-title" id="enrollmentModalLabel">Add Enrollment</h2>
        <button class="modal-close" onclick="closeModals()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="enrollmentForm">
          <input type="hidden" id="enrollmentIndex">
          <div class="form-group">
            <label for="enrollCourseTitle">Course*</label>
            <select id="enrollCourseTitle" class="form-control" required>
              <option value="">Select Course</option>
            </select>
          </div>
          <div class="form-group">
            <label for="enrollmentDate">Enrollment Date*</label>
            <input type="date" id="enrollmentDate" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="enrollmentId">Enrollment ID</label>
            <input type="text" id="enrollmentId" class="form-control" placeholder="Enter enrollment ID">
          </div>
          <div class="form-group">
            <label for="enrollmentLanguage">Language</label>
            <input type="text" id="enrollmentLanguage" class="form-control" placeholder="Enter language">
          </div>
          <div class="form-group">
            <label for="enrollmentProgress">Progress (%)</label>
            <input type="number" id="enrollmentProgress" class="form-control" min="0" max="100" placeholder="Enter progress">
          </div>
          <div class="form-group">
            <label for="enrollmentType">Type</label>
            <select id="enrollmentType" class="form-control">
              <option value="online">Online</option>
              <option value="in-person">In-Person</option>
              <option value="hybrid">Hybrid</option>
            </select>
          </div>
          <div class="form-group">
            <label for="enrollmentCompletionStatus">Completion Status</label>
            <select id="enrollmentCompletionStatus" class="form-control">
              <option value="not-started">Not Started</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
            </select>
          </div>
          <div class="form-group">
            <label for="enrollmentScore">Score/Grade</label>
            <input type="text" id="enrollmentScore" class="form-control" placeholder="Enter score or grade">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" onclick="closeModals()">Cancel</button>
        <button class="btn btn-primary" id="enrollmentSaveBtn">Save Enrollment</button>
      </div>
    </div>
  </div>

  <!-- Course Modal -->
  <div class="modal" id="courseModal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 class="modal-title" id="courseModalLabel">Add Course</h2>
        <button class="modal-close" onclick="closeModals()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="courseForm">
          <input type="hidden" id="courseId">
          <div class="form-group">
            <label for="courseTitle">Title*</label>
            <input type="text" id="courseTitle" class="form-control" placeholder="Enter course title" required>
          </div>
          <div class="form-group">
            <label for="courseDescription">Description*</label>
            <textarea id="courseDescription" class="form-control" placeholder="Enter course description" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <label for="courseType">Type</label>
            <select id="courseType" class="form-control">
              <option value="lecture">Lecture</option>
              <option value="workshop">Workshop</option>
              <option value="seminar">Seminar</option>
              <option value="lab">Lab</option>
              <option value="online">Online</option>
            </select>
          </div>
          <div class="form-group">
            <label for="courseLanguage">Language</label>
            <input type="text" id="courseLanguage" class="form-control" placeholder="Enter language">
          </div>
          <div class="form-group">
            <label for="courseDuration">Duration</label>
            <input type="text" id="courseDuration" class="form-control" placeholder="e.g., 8 weeks, 6 months">
          </div>
          <div class="form-group">
            <label for="coursePrice">Price</label>
            <input type="text" id="coursePrice" class="form-control" placeholder="e.g., $500, Free">
          </div>
          <div class="form-group">
            <label for="courseInstructor">Instructor</label>
            <input type="text" id="courseInstructor" class="form-control" placeholder="Enter instructor name">
          </div>
          <div class="form-group">
            <label for="courseStatus">Status</label>
            <select id="courseStatus" class="form-control">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="draft">Draft</option>
              <option value="archived">Archived</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" onclick="closeModals()">Cancel</button>
        <button class="btn btn-primary" id="courseSaveBtn">Save Course</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal" id="exportModal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 class="modal-title">Export Data</h2>
        <button class="modal-close" onclick="closeModals()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="exportForm">
          <div class="form-group">
            <label>Export Format*</label>
            <div class="custom-checkbox">
              <input type="radio" id="exportCSV" name="exportFormat" value="csv" checked>
              <label for="exportCSV">CSV (Comma Separated Values)</label>
            </div>
            <div class="custom-checkbox">
              <input type="radio" id="exportExcel" name="exportFormat" value="excel">
              <label for="exportExcel">Excel (XLSX)</label>
            </div>
            <div class="custom-checkbox">
              <input type="radio" id="exportPDF" name="exportFormat" value="pdf">
              <label for="exportPDF">PDF</label>
            </div>
          </div>
          <div class="form-group">
            <label>Columns to Include*</label>
            <div id="exportColumns" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
              <!-- Columns will be added dynamically -->
            </div>
          </div>
          <div class="form-group">
            <label for="exportFileName">File Name</label>
            <input type="text" id="exportFileName" class="form-control" placeholder="Enter file name">
          </div>
          <div class="form-group">
            <div class="custom-checkbox">
              <input type="checkbox" id="exportIncludeHeaders" checked>
              <label for="exportIncludeHeaders">Include Column Headers</label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" onclick="closeModals()">Cancel</button>
        <button class="btn btn-primary" id="exportConfirmBtn">Export Data</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal active" id="loginModal">
    <div class="modal-dialog login-modal">
      <div class="modal-header">
        <h2 class="modal-title">Admin Login</h2>
      </div>
      <div class="modal-body">
        <div class="login-logo">
          <i class="fas fa-lock"></i>
        </div>
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email*</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Password*</label>
            <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
          </div>
          <div class="form-group">
            <button type="button" class="btn btn-primary btn-block" onclick="adminLogin()">Login</button>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="justify-content: center;">
        <a href="index.html" class="btn btn-light"><i class="fas fa-home"></i> Back to Home</a>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      onAuthStateChanged, 
      signOut,
      createUserWithEmailAndPassword,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      doc, 
      getDoc, 
      getDocs,
      setDoc,
      updateDoc, 
      deleteDoc, 
      addDoc, 
      query, 
      where,
      orderBy,
      limit,
      serverTimestamp,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo",
      authDomain: "pharma-quiz-b5a07.firebaseapp.com",
      databaseURL: "https://pharma-quiz-b5a07-default-rtdb.firebaseio.com",
      projectId: "pharma-quiz-b5a07",
      storageBucket: "pharma-quiz-b5a07.appspot.com",
      messagingSenderId: "161067776789",
      appId: "1:161067776789:web:88b8a61145dc5f5c31471c",
      measurementId: "G-3QRQE9HQFB"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    
    // Global state
    const sections = ['dashboard', 'users', 'enrollments', 'courses', 'requests', 'analytics', 'settings'];
    let currentUserId = null;
    let currentEnrollmentIndex = null;
    let currentCourseId = null;
    let currentUser = null;
    let usersData = [];
    let coursesData = [];
    let enrollmentsData = [];
    let requestsData = [];
    let activityData = [];
    let currentPage = {
      users: 1,
      courses: 1
    };
    const itemsPerPage = 10;
    
    // DOM Elements
    const loginModal = document.getElementById('loginModal');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    const userMenu = document.querySelector('.user-menu .dropdown-menu');
    const userInitial = document.getElementById('userInitial');
    
    // Charts
    let userRegistrationsChart = null;
    let courseEnrollmentsChart = null;
    let userActivityChart = null;
    let courseCompletionChart = null;
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Check auth state
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in
          currentUser = user;
          userInitial.textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'A';
          loginModal.classList.remove('active');
          initDashboard();
        } else {
          // User is signed out
          loginModal.classList.add('active');
        }
      });
      
      // Event listeners
      document.getElementById('userSaveBtn').addEventListener('click', saveUser);
      document.getElementById('enrollmentSaveBtn').addEventListener('click', saveEnrollment);
      document.getElementById('courseSaveBtn').addEventListener('click', saveCourse);
      document.getElementById('exportConfirmBtn').addEventListener('click', confirmExport);
      
      // Pagination controls
      document.getElementById('usersPrevPage').addEventListener('click', () => {
        if (currentPage.users > 1) {
          currentPage.users--;
          loadUsers();
        }
      });
      
      document.getElementById('usersNextPage').addEventListener('click', () => {
        currentPage.users++;
        loadUsers();
      });
      
      document.getElementById('coursesPrevPage').addEventListener('click', () => {
        if (currentPage.courses > 1) {
          currentPage.courses--;
          loadCourses();
        }
      });
      
      document.getElementById('coursesNextPage').addEventListener('click', () => {
        currentPage.courses++;
        loadCourses();
      });
      
      // Search and filter inputs
      document.getElementById('searchUsers').addEventListener('input', loadUsers);
      document.getElementById('filterRole').addEventListener('change', loadUsers);
      document.getElementById('filterCourse').addEventListener('change', loadUsers);
      document.getElementById('searchCourses').addEventListener('input', loadCourses);
      document.getElementById('filterCoursesList').addEventListener('change', loadCourses);
      document.getElementById('filterRequestStatus').addEventListener('change', loadRequests);
      document.getElementById('analyticsTimeRange').addEventListener('change', loadAnalytics);
      
      // Password strength indicator
      const passwordInput = document.getElementById('userPassword');
      if (passwordInput) {
        passwordInput.addEventListener('input', checkPasswordStrength);
      }
    });
    
    // Toggle sidebar
    function toggleSidebar() {
      sidebar.classList.toggle('active');
      mainContent.classList.toggle('active');
    }
    
    // Toggle user menu
    function toggleUserMenu() {
      userMenu.classList.toggle('active');
    }
    
    // Close all dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.user-menu')) {
        userMenu.classList.remove('active');
      }
    });
    
    // Show section
    window.showSection = function(id) {
      sections.forEach(s => {
        const section = document.getElementById(s);
        if (section) {
          section.classList.toggle('hidden', s !== id);
        }
      });
      
      // Update active menu item
      document.querySelectorAll('.sidebar-menu a').forEach(a => {
        a.classList.toggle('active', a.getAttribute('onclick')?.includes(id));
      });
      
      // Load data when section is shown
      switch(id) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'users':
          loadUsers();
          break;
        case 'courses':
          loadCourses();
          break;
        case 'requests':
          loadRequests();
          break;
        case 'analytics':
          loadAnalytics();
          break;
        case 'settings':
          loadSettings();
          break;
      }
    };
    
    // Open settings tab
    window.openSettingsTab = function(tab) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tabs .tab').forEach(t => {
        t.classList.remove('active');
      });
      
      document.getElementById(`${tab}Settings`).classList.add('active');
      document.querySelector(`.tabs .tab[onclick="openSettingsTab('${tab}')"]`).classList.add('active');
    };
    
    // Close all modals
    function closeModals() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('active');
      });
    }
    window.closeModals = closeModals;
    
    // Admin login
    window.adminLogin = async function() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!email || !password) {
        alert('Please enter both email and password');
        return;
      }
      
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Check if user is admin
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().role === 'admin') {
          // Success
          loginModal.classList.remove('active');
          initDashboard();
        } else {
          // Not admin
          await signOut(auth);
          alert('You do not have admin privileges');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert(`Login failed: ${error.message}`);
      }
    };
    
    // Logout
    window.logout = async function() {
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout error:', error);
        alert(`Logout failed: ${error.message}`);
      }
    };
    
    // Initialize dashboard
    function initDashboard() {
      showSection('dashboard');
      loadDashboard();
      
      // Set user info
      if (currentUser) {
        userInitial.textContent = currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : 'A';
      }
    }
    
    // Load dashboard data
    async function loadDashboard() {
      try {
        // Get counts
        const usersCount = (await getDocs(collection(db, 'users'))?.size || 0;
        const coursesCount = (await getDocs(collection(db, 'courses'))?.size || 0;
        const enrollmentsCount = await countEnrollments();
        const requestsCount = (await getDocs(query(collection(db, 'requests'), where('status', '==', 'pending')))?.size || 0;
        
        // Update UI
        document.getElementById('totalUsers').textContent = usersCount;
        document.getElementById('totalCourses').textContent = coursesCount;
        document.getElementById('totalEnrollments').textContent = enrollmentsCount;
        document.getElementById('pendingRequests').textContent = requestsCount;
        
        // Load recent activity
        loadRecentActivity();
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }
    
    // Count all enrollments
    async function countEnrollments() {
      let count = 0;
      const usersSnapshot = await getDocs(collection(db, 'users'));
      
      usersSnapshot.forEach(doc => {
        const userData = doc.data();
        if (userData.enrolledCourses) {
          count += userData.enrolledCourses.length;
        }
      });
      
      return count;
    }
    
    // Load recent activity
    async function loadRecentActivity() {
      try {
        const activityRef = collection(db, 'activity');
        const q = query(activityRef, orderBy('timestamp', 'desc'), limit(10));
        const snapshot = await getDocs(q);
        
        activityData = [];
        const tbody = document.getElementById('activityTable');
        tbody.innerHTML = '';
        
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="4">No recent activity</td></tr>';
          return;
        }
        
        const activityPromises = snapshot.docs.map(async doc => {
          const data = doc.data();
          let userName = 'System';
          
          if (data.userId) {
            const userDoc = await getDoc(doc(db, 'users', data.userId));
            if (userDoc.exists()) {
              userName = userDoc.data().name || 'Unknown User';
            }
          }
          
          return {
            id: doc.id,
            userName: userName,
            action: data.action,
            details: data.details,
            time: data.timestamp?.toDate().toLocaleString() || 'Unknown time'
          };
        });
        
        activityData = await Promise.all(activityPromises);
        
        activityData.forEach(activity => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${activity.userName}</td>
            <td>${activity.action}</td>
            <td>${activity.details}</td>
            <td>${activity.time}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('Error loading activity:', error);
        document.getElementById('activityTable').innerHTML = `
          <tr><td colspan="4" style="color:red;">Error loading activity: ${error.message}</td></tr>
        `;
      }
    }
    
    // Load users
    async function loadUsers() {
      const roleFilter = document.getElementById('filterRole').value;
      const courseFilter = document.getElementById('filterCourse').value;
      const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
      
      const tbody = document.querySelector('#users-table tbody');
      tbody.innerHTML = '<tr><td colspan="7">Loading users...</td></tr>';
      
      try {
        let usersQuery = collection(db, 'users');
        
        // Apply filters if needed
        if (roleFilter) {
          usersQuery = query(usersQuery, where('role', '==', roleFilter));
        }
        
        const snapshot = await getDocs(usersQuery);
        usersData = [];
        
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="7">No users found</td></tr>';
          updateUsersPagination(0);
          return;
        }
        
        // Process users
        const userPromises = snapshot.docs.map(async doc => {
          const userData = doc.data();
          const userId = doc.id;
          
          // Apply search filter
          const searchStr = `${userData.name || ''} ${userData.email || ''} ${userData.studentId || ''}`.toLowerCase();
          if (searchTerm && !searchStr.includes(searchTerm)) {
            return null;
          }
          
          // Apply course filter
          if (courseFilter) {
            const hasCourse = userData.enrolledCourses?.some(course => 
              course.title?.toLowerCase().includes(courseFilter.toLowerCase())
            );
            if (!hasCourse) return null;
          }
          
          return {
            id: userId,
            studentId: userData.studentId || '',
            name: userData.name || 'Unknown',
            email: userData.email || '',
            role: userData.role || 'student',
            status: userData.status || 'active',
            enrolledCourses: userData.enrolledCourses || [],
            phone: userData.phone || '',
            department: userData.department || '',
            gender: userData.gender || '',
            createdAt: userData.createdAt || null
          };
        });
        
        const users = await Promise.all(userPromises);
        usersData = users.filter(user => user !== null);
        
        // Populate course filter dropdown
        populateCourseFilter();
        
        // Update pagination
        updateUsersPagination(usersData.length);
        
        // Display current page
        displayUsersPage();
      } catch (error) {
        console.error('Error loading users:', error);
        tbody.innerHTML = `
          <tr><td colspan="7" style="color:red;">Error loading users: ${error.message}</td></tr>
        `;
      }
    }
    
    // Display users for current page
    function displayUsersPage() {
      const tbody = document.querySelector('#users-table tbody');
      tbody.innerHTML = '';
      
      if (usersData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No users found</td></tr>';
        return;
      }
      
      const startIndex = (currentPage.users - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, usersData.length);
      const pageUsers = usersData.slice(startIndex, endIndex);
      
      pageUsers.forEach(user => {
        const tr = document.createElement('tr');
        
        // Get enrolled courses count
        const coursesCount = user.enrolledCourses?.length || 0;
        
        // Status badge
        let statusBadge = '';
        switch(user.status) {
          case 'active':
            statusBadge = '<span class="badge badge-success">Active</span>';
            break;
          case 'inactive':
            statusBadge = '<span class="badge badge-secondary">Inactive</span>';
            break;
          case 'suspended':
            statusBadge = '<span class="badge badge-danger">Suspended</span>';
            break;
          default:
            statusBadge = '<span class="badge badge-secondary">Unknown</span>';
        }
        
        tr.innerHTML = `
          <td>${user.studentId || 'N/A'}</td>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</td>
          <td>${statusBadge}</td>
          <td>${coursesCount} course${coursesCount !== 1 ? 's' : ''}</td>
          <td class="actions">
            <button class="btn btn-info btn-sm" onclick="viewEnrollments('${user.id}', '${user.name}')">
              <i class="fas fa-user-graduate"></i>
            </button>
            <button class="btn btn-warning btn-sm" onclick="editUser('${user.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}', '${user.name}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Update users pagination
    function updateUsersPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const paginationInfo = document.getElementById('usersPaginationInfo');
      const pageInfo = document.getElementById('usersPageInfo');
      const prevBtn = document.getElementById('usersPrevPage');
      const nextBtn = document.getElementById('usersNextPage');
      
      paginationInfo.textContent = `Showing ${Math.min(itemsPerPage, totalItems)} of ${totalItems} users`;
      pageInfo.textContent = `Page ${currentPage.users} of ${totalPages}`;
      
      prevBtn.disabled = currentPage.users <= 1;
      nextBtn.disabled = currentPage.users >= totalPages;
    }
    
    // Populate course filter dropdown
    async function populateCourseFilter() {
      const select = document.getElementById('filterCourse');
      select.innerHTML = '<option value="">All Courses</option>';
      
      try {
        const coursesSnapshot = await getDocs(collection(db, 'courses'));
        const courseTitles = new Set();
        
        coursesSnapshot.forEach(doc => {
          const courseData = doc.data();
          if (courseData.title) {
            courseTitles.add(courseData.title);
          }
        });
        
        // Also check enrollments for course titles not in courses collection
        const usersSnapshot = await getDocs(collection(db, 'users'));
        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          if (userData.enrolledCourses) {
            userData.enrolledCourses.forEach(course => {
              if (course.title) {
                courseTitles.add(course.title);
              }
            });
          }
        });
        
        // Add sorted options
        Array.from(courseTitles).sort().forEach(title => {
          const option = document.createElement('option');
          option.value = title;
          option.textContent = title;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error populating course filter:', error);
      }
    }
    
    // Populate course list filter
    async function populateCourseListFilter() {
      const select = document.getElementById('filterCoursesList');
      select.innerHTML = '<option value="">All Courses</option>';
      
      try {
        const snapshot = await getDocs(collection(db, 'courses'));
        const courses = [];
        
        snapshot.forEach(doc => {
          const courseData = doc.data();
          if (courseData.title) {
            courses.push({
              id: doc.id,
              title: courseData.title
            });
          }
        });
        
        // Add sorted options
        courses.sort((a, b) => a.title.localeCompare(b.title)).forEach(course => {
          const option = document.createElement('option');
          option.value = course.title;
          option.textContent = course.title;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error populating course list filter:', error);
      }
    }
    
    // Open add user modal
    window.openAddUserModal = function() {
      document.getElementById('userModalLabel').textContent = 'Add New User';
      document.getElementById('userForm').reset();
      document.getElementById('userId').value = '';
      document.getElementById('userStatus').value = 'active';
      document.getElementById('userPasswordGroup').style.display = 'block';
      document.getElementById('userModal').classList.add('active');
    };
    
    // Edit user
    window.editUser = async function(userId) {
      try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        
        if (!userDoc.exists()) {
          alert('User not found');
          return;
        }
        
        const userData = userDoc.data();
        
        document.getElementById('userModalLabel').textContent = 'Edit User';
        document.getElementById('userId').value = userId;
        document.getElementById('userStudentId').value = userData.studentId || '';
        document.getElementById('userName').value = userData.name || '';
        document.getElementById('userEmail').value = userData.email || '';
        document.getElementById('userPhone').value = userData.phone || '';
        document.getElementById('userDepartment').value = userData.department || '';
        document.getElementById('userGender').value = userData.gender || '';
        document.getElementById('userRole').value = userData.role || 'student';
        document.getElementById('userStatus').value = userData.status || 'active';
        document.getElementById('userPasswordGroup').style.display = 'none';
        
        document.getElementById('userModal').classList.add('active');
      } catch (error) {
        console.error('Error editing user:', error);
        alert(`Error loading user: ${error.message}`);
      }
    };
    
    // Check password strength
    function checkPasswordStrength() {
      const password = document.getElementById('userPassword').value;
      const strengthBar = document.getElementById('passwordStrengthBar');
      
      if (!password) {
        strengthBar.style.width = '0%';
        return;
      }
      
      // Simple strength check
      let strength = 0;
      
      // Length
      if (password.length >= 8) strength += 1;
      if (password.length >= 12) strength += 1;
      
      // Contains numbers
      if (/\d/.test(password)) strength += 1;
      
      // Contains special chars
      if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 1;
      
      // Contains upper and lower case
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;
      
      // Update UI
      let width = 0;
      let className = '';
      
      if (strength <= 2) {
        width = 33;
        className = 'strength-weak';
      } else if (strength <= 4) {
        width = 66;
        className = 'strength-medium';
      } else {
        width = 100;
        className = 'strength-strong';
      }
      
      strengthBar.style.width = `${width}%`;
      strengthBar.className = `password-strength-bar ${className}`;
    }
    
    // Save user
    async function saveUser() {
      const userId = document.getElementById('userId').value;
      const name = document.getElementById('userName').value;
      const email = document.getElementById('userEmail').value;
      const studentId = document.getElementById('userStudentId').value;
      const phone = document.getElementById('userPhone').value;
      const department = document.getElementById('userDepartment').value;
      const gender = document.getElementById('userGender').value;
      const role = document.getElementById('userRole').value;
      const status = document.getElementById('userStatus').value;
      const password = document.getElementById('userPassword').value;
      
      if (!name || !email || !role) {
        alert('Name, email, and role are required');
        return;
      }
      
      try {
        const userData = {
          name,
          email,
          studentId,
          phone,
          department,
          gender,
          role,
          status,
          updatedAt: serverTimestamp()
        };
        
        if (userId) {
          // Update existing user
          await updateDoc(doc(db, 'users', userId), userData);
          logActivity(`Updated user: ${name}`);
          alert('User updated successfully');
        } else {
          // Create new user
          if (!password) {
            alert('Password is required for new users');
            return;
          }
          
          // First create auth user
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const newUser = userCredential.user;
          
          // Then create user document
          userData.createdAt = serverTimestamp();
          userData.enrolledCourses = [];
          
          await setDoc(doc(db, 'users', newUser.uid), userData);
          
          // Update user profile
          await updateProfile(newUser, {
            displayName: name
          });
          
          logActivity(`Created new user: ${name}`);
          alert('User created successfully');
        }
        
        closeModals();
        loadUsers();
      } catch (error) {
        console.error('Error saving user:', error);
        alert(`Error saving user: ${error.message}`);
      }
    }
    
    // Delete user
    window.deleteUser = async function(userId, userName) {
      if (!confirm(`Are you sure you want to delete ${userName || 'this user'}? This action cannot be undone.`)) {
        return;
      }
      
      try {
        // Delete user document
        await deleteDoc(doc(db, 'users', userId));
        
        // Delete auth user if exists
        if (auth.currentUser && auth.currentUser.uid === userId) {
          await auth.currentUser.delete();
        }
        
        logActivity(`Deleted user: ${userName || userId}`);
        alert('User deleted successfully');
        loadUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        alert(`Error deleting user: ${error.message}`);
      }
    };
    
    // View enrollments
    window.viewEnrollments = async function(userId, userName) {
      currentUserId = userId;
      document.getElementById('enroll-user').textContent = userName || 'User';
      document.getElementById('enroll-user-name').textContent = userName || 'Enrollments';
      
      try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        
        if (!userDoc.exists()) {
          alert('User not found');
          return;
        }
        
        const userData = userDoc.data();
        enrollmentsData = userData.enrolledCourses || [];
        
        const tbody = document.querySelector('#enroll-table tbody');
        tbody.innerHTML = '';
        
        if (enrollmentsData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6">No enrollments found</td></tr>';
          return;
        }
        
        enrollmentsData.forEach((enrollment, index) => {
          const tr = document.createElement('tr');
          
          // Progress bar
          const progress = enrollment.progress || 0;
          const progressBar = `
            <div style="width: 100%; background: #f0f0f0; border-radius: 5px;">
              <div style="width: ${progress}%; background: var(--primary-color); height: 20px; border-radius: 5px; color: white; text-align: center; font-size: 12px; line-height: 20px;">
                ${progress}%
              </div>
            </div>
          `;
          
          // Status badge
          let statusBadge = '';
          switch(enrollment.completionStatus) {
            case 'completed':
              statusBadge = '<span class="badge badge-success">Completed</span>';
              break;
            case 'in-progress':
              statusBadge = '<span class="badge badge-primary">In Progress</span>';
              break;
            case 'failed':
              statusBadge = '<span class="badge badge-danger">Failed</span>';
              break;
            default:
              statusBadge = '<span class="badge badge-secondary">Not Started</span>';
          }
          
          tr.innerHTML = `
            <td>${enrollment.title || 'Untitled Course'}</td>
            <td>${enrollment.enrollmentdate || 'N/A'}</td>
            <td>${progressBar}</td>
            <td>${statusBadge}</td>
            <td>${enrollment.score || 'N/A'}</td>
            <td class="actions">
              <button class="btn btn-warning btn-sm" onclick="editEnrollment(${index})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteEnrollment(${index})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        showSection('enrollments');
      } catch (error) {
        console.error('Error viewing enrollments:', error);
        alert(`Error loading enrollments: ${error.message}`);
      }
    };
    
    // Open add enrollment modal
    window.openAddEnrollmentModal = function() {
      document.getElementById('enrollmentModalLabel').textContent = 'Add New Enrollment';
      document.getElementById('enrollmentForm').reset();
      document.getElementById('enrollmentIndex').value = '';
      document.getElementById('enrollmentDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('enrollmentModal').classList.add('active');
      
      // Populate course dropdown
      populateCourseDropdown('enrollCourseTitle');
    };
    
    // Populate course dropdown
    async function populateCourseDropdown(selectId) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">Select Course</option>';
      
      try {
        const snapshot = await getDocs(collection(db, 'courses'));
        
        snapshot.forEach(doc => {
          const courseData = doc.data();
          if (courseData.title) {
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = courseData.title;
            select.appendChild(option);
          }
        });
      } catch (error) {
        console.error('Error populating course dropdown:', error);
      }
    }
    
    // Edit enrollment
    window.editEnrollment = async function(index) {
      currentEnrollmentIndex = index;
      const enrollment = enrollmentsData[index];
      
      if (!enrollment) {
        alert('Enrollment not found');
        return;
      }
      
      document.getElementById('enrollmentModalLabel').textContent = 'Edit Enrollment';
      document.getElementById('enrollmentIndex').value = index;
      
      // Populate form
      document.getElementById('enrollmentDate').value = enrollment.enrollmentdate || new Date().toISOString().split('T')[0];
      document.getElementById('enrollmentId').value = enrollment.Id || '';
      document.getElementById('enrollmentLanguage').value = enrollment.language || '';
      document.getElementById('enrollmentProgress').value = enrollment.progress || 0;
      document.getElementById('enrollmentType').value = enrollment.type || 'online';
      document.getElementById('enrollmentCompletionStatus').value = enrollment.completionStatus || 'not-started';
      document.getElementById('enrollmentScore').value = enrollment.score || '';
      
      // Populate course dropdown and select current course
      await populateCourseDropdown('enrollCourseTitle');
      const courseSelect = document.getElementById('enrollCourseTitle');
      
      if (enrollment.courseId) {
        // Try to find by ID first
        for (let i = 0; i < courseSelect.options.length; i++) {
          if (courseSelect.options[i].value === enrollment.courseId) {
            courseSelect.selectedIndex = i;
            break;
          }
        }
      } else if (enrollment.title) {
        // Fallback to title match
        for (let i = 0; i < courseSelect.options.length; i++) {
          if (courseSelect.options[i].text === enrollment.title) {
            courseSelect.selectedIndex = i;
            break;
          }
        }
      }
      
      document.getElementById('enrollmentModal').classList.add('active');
    };
    
    // Save enrollment
    async function saveEnrollment() {
      const index = document.getElementById('enrollmentIndex').value;
      const courseSelect = document.getElementById('enrollCourseTitle');
      const courseId = courseSelect.value;
      const courseTitle = courseSelect.options[courseSelect.selectedIndex].text;
      const enrollmentDate = document.getElementById('enrollmentDate').value;
      const enrollmentId = document.getElementById('enrollmentId').value;
      const language = document.getElementById('enrollmentLanguage').value;
      const progress = document.getElementById('enrollmentProgress').value;
      const type = document.getElementById('enrollmentType').value;
      const completionStatus = document.getElementById('enrollmentCompletionStatus').value;
      const score = document.getElementById('enrollmentScore').value;
      
      if (!courseId || !enrollmentDate) {
        alert('Course and enrollment date are required');
        return;
      }
      
      try {
        const enrollmentData = {
          courseId,
          title: courseTitle,
          enrollmentdate: enrollmentDate,
          Id: enrollmentId,
          language,
          progress: parseInt(progress) || 0,
          type,
          completionStatus,
          score
        };
        
        const userRef = doc(db, 'users', currentUserId);
        const userDoc = await getDoc(userRef);
        
        if (!userDoc.exists()) {
          alert('User not found');
          return;
        }
        
        let enrolledCourses = userDoc.data().enrolledCourses || [];
        
        if (index !== '') {
          // Update existing enrollment
          enrolledCourses[parseInt(index)] = enrollmentData;
          logActivity(`Updated enrollment for user: ${userDoc.data().name || currentUserId}`);
        } else {
          // Add new enrollment
          enrolledCourses.push(enrollmentData);
          logActivity(`Added new enrollment for user: ${userDoc.data().name || currentUserId}`);
        }
        
        await updateDoc(userRef, {
          enrolledCourses
        });
        
        closeModals();
        viewEnrollments(currentUserId);
      } catch (error) {
        console.error('Error saving enrollment:', error);
        alert(`Error saving enrollment: ${error.message}`);
      }
    }
    
    // Delete enrollment
    window.deleteEnrollment = async function(index) {
      if (!confirm('Are you sure you want to delete this enrollment?')) {
        return;
      }
      
      try {
        const userRef = doc(db, 'users', currentUserId);
        const userDoc = await getDoc(userRef);
        
        if (!userDoc.exists()) {
          alert('User not found');
          return;
        }
        
        let enrolledCourses = userDoc.data().enrolledCourses || [];
        
        if (index >= 0 && index < enrolledCourses.length) {
          const deletedCourse = enrolledCourses[index].title || 'Unknown Course';
          enrolledCourses.splice(index, 1);
          
          await updateDoc(userRef, {
            enrolledCourses
          });
          
          logActivity(`Deleted enrollment (${deletedCourse}) for user: ${userDoc.data().name || currentUserId}`);
          viewEnrollments(currentUserId);
        } else {
          alert('Invalid enrollment index');
        }
      } catch (error) {
        console.error('Error deleting enrollment:', error);
        alert(`Error deleting enrollment: ${error.message}`);
      }
    };
    
    // Load courses
    async function loadCourses() {
      const titleFilter = document.getElementById('filterCoursesList').value;
      const searchTerm = document.getElementById('searchCourses').value.toLowerCase();
      
      const tbody = document.querySelector('#courses-table tbody');
      tbody.innerHTML = '<tr><td colspan="6">Loading courses...</td></tr>';
      
      try {
        let coursesQuery = collection(db, 'courses');
        
        // Apply title filter if selected
        if (titleFilter) {
          coursesQuery = query(coursesQuery, where('title', '==', titleFilter));
        }
        
        const snapshot = await getDocs(coursesQuery);
        coursesData = [];
        
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="6">No courses found</td></tr>';
          updateCoursesPagination(0);
          return;
        }
        
        // Process courses
        snapshot.forEach(doc => {
          const courseData = doc.data();
          const courseId = doc.id;
          
          // Apply search filter
          const searchStr = `${courseData.title || ''} ${courseData.description || ''} ${courseData.instructor || ''}`.toLowerCase();
          if (searchTerm && !searchStr.includes(searchTerm)) {
            return;
          }
          
          coursesData.push({
            id: courseId,
            title: courseData.title || 'Untitled Course',
            description: courseData.description || '',
            type: courseData.type || 'lecture',
            instructor: courseData.instructor || '',
            status: courseData.status || 'active',
            language: courseData.language || '',
            duration: courseData.duration || '',
            price: courseData.price || '',
            createdAt: courseData.createdAt?.toDate() || null,
            updatedAt: courseData.updatedAt?.toDate() || null
          });
        });
        
        // Update course list filter dropdown
        populateCourseListFilter();
        
        // Update pagination
        updateCoursesPagination(coursesData.length);
        
        // Display current page
        displayCoursesPage();
      } catch (error) {
        console.error('Error loading courses:', error);
        tbody.innerHTML = `
          <tr><td colspan="6" style="color:red;">Error loading courses: ${error.message}</td></tr>
        `;
      }
    }
    
    // Display courses for current page
    function displayCoursesPage() {
      const tbody = document.querySelector('#courses-table tbody');
      tbody.innerHTML = '';
      
      if (coursesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">No courses found</td></tr>';
        return;
      }
      
      const startIndex = (currentPage.courses - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, coursesData.length);
      const pageCourses = coursesData.slice(startIndex, endIndex);
      
      pageCourses.forEach(course => {
        const tr = document.createElement('tr');
        
        // Status badge
        let statusBadge = '';
        switch(course.status) {
          case 'active':
            statusBadge = '<span class="badge badge-success">Active</span>';
            break;
          case 'inactive':
            statusBadge = '<span class="badge badge-secondary">Inactive</span>';
            break;
          case 'draft':
            statusBadge = '<span class="badge badge-warning">Draft</span>';
            break;
          case 'archived':
            statusBadge = '<span class="badge badge-info">Archived</span>';
            break;
          default:
            statusBadge = '<span class="badge badge-secondary">Unknown</span>';
        }
        
        // Truncate description
        const description = course.description.length > 50 ? 
          course.description.substring(0, 50) + '...' : 
          course.description;
        
        tr.innerHTML = `
          <td>${course.title}</td>
          <td>${description}</td>
          <td>${course.type.charAt(0).toUpperCase() + course.type.slice(1)}</td>
          <td>${course.instructor || 'N/A'}</td>
          <td>${statusBadge}</td>
          <td class="actions">
            <button class="btn btn-warning btn-sm" onclick="editCourse('${course.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteCourse('${course.id}', '${course.title}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Update courses pagination
    function updateCoursesPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const paginationInfo = document.getElementById('coursesPaginationInfo');
      const pageInfo = document.getElementById('coursesPageInfo');
      const prevBtn = document.getElementById('coursesPrevPage');
      const nextBtn = document.getElementById('coursesNextPage');
      
      paginationInfo.textContent = `Showing ${Math.min(itemsPerPage, totalItems)} of ${totalItems} courses`;
      pageInfo.textContent = `Page ${currentPage.courses} of ${totalPages}`;
      
      prevBtn.disabled = currentPage.courses <= 1;
      nextBtn.disabled = currentPage.courses >= totalPages;
    }
    
    // Open add course modal
    window.openAddCourseModal = function() {
      document.getElementById('courseModalLabel').textContent = 'Add New Course';
      document.getElementById('courseForm').reset();
      document.getElementById('courseId').value = '';
      document.getElementById('courseStatus').value = 'active';
      document.getElementById('courseModal').classList.add('active');
    };
    
    // Edit course
    window.editCourse = async function(courseId) {
      currentCourseId = courseId;
      
      try {
        const courseDoc = await getDoc(doc(db, 'courses', courseId));
        
        if (!courseDoc.exists()) {
          alert('Course not found');
          return;
        }
        
        const courseData = courseDoc.data();
        
        document.getElementById('courseModalLabel').textContent = 'Edit Course';
        document.getElementById('courseId').value = courseId;
        document.getElementById('courseTitle').value = courseData.title || '';
        document.getElementById('courseDescription').value = courseData.description || '';
        document.getElementById('courseType').value = courseData.type || 'lecture';
        document.getElementById('courseLanguage').value = courseData.language || '';
        document.getElementById('courseDuration').value = courseData.duration || '';
        document.getElementById('coursePrice').value = courseData.price || '';
        document.getElementById('courseInstructor').value = courseData.instructor || '';
        document.getElementById('courseStatus').value = courseData.status || 'active';
        
        document.getElementById('courseModal').classList.add('active');
      } catch (error) {
        console.error('Error editing course:', error);
        alert(`Error loading course: ${error.message}`);
      }
    };
    
    // Save course
    async function saveCourse() {
      const courseId = document.getElementById('courseId').value;
      const title = document.getElementById('courseTitle').value;
      const description = document.getElementById('courseDescription').value;
      const type = document.getElementById('courseType').value;
      const language = document.getElementById('courseLanguage').value;
      const duration = document.getElementById('courseDuration').value;
      const price = document.getElementById('coursePrice').value;
      const instructor = document.getElementById('courseInstructor').value;
      const status = document.getElementById('courseStatus').value;
      
      if (!title || !description) {
        alert('Title and description are required');
        return;
      }
      
      try {
        const courseData = {
          title,
          description,
          type,
          language,
          duration,
          price,
          instructor,
          status,
          updatedAt: serverTimestamp()
        };
        
        if (courseId) {
          // Update existing course
          await updateDoc(doc(db, 'courses', courseId), courseData);
          logActivity(`Updated course: ${title}`);
          alert('Course updated successfully');
        } else {
          // Add new course
          courseData.createdAt = serverTimestamp();
          await addDoc(collection(db, 'courses'), courseData);
          logActivity(`Created new course: ${title}`);
          alert('Course added successfully');
        }
        
        closeModals();
        loadCourses();
        populateCourseFilter(); // Update filter dropdowns
        populateCourseListFilter();
      } catch (error) {
        console.error('Error saving course:', error);
        alert(`Error saving course: ${error.message}`);
      }
    }
    
    // Delete course
    window.deleteCourse = async function(courseId, courseTitle) {
      if (!confirm(`Are you sure you want to delete "${courseTitle || 'this course'}"? This will not remove it from user enrollments.`)) {
        return;
      }
      
      try {
        await deleteDoc(doc(db, 'courses', courseId));
        logActivity(`Deleted course: ${courseTitle || courseId}`);
        alert('Course deleted successfully');
        loadCourses();
        populateCourseFilter(); // Update filter dropdowns
        populateCourseListFilter();
      } catch (error) {
        console.error('Error deleting course:', error);
        alert(`Error deleting course: ${error.message}`);
      }
    };
    
    // Load requests
    async function loadRequests() {
      const statusFilter = document.getElementById('filterRequestStatus').value;
      
      const tbody = document.querySelector('#requests-table tbody');
      tbody.innerHTML = '<tr><td colspan="5">Loading requests...</td></tr>';
      
      try {
        let requestsQuery = collection(db, 'requests');
        
        if (statusFilter !== 'all') {
          requestsQuery = query(requestsQuery, where('status', '==', statusFilter));
        }
        
        const snapshot = await getDocs(requestsQuery);
        requestsData = [];
        
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="5">No requests found</td></tr>';
          return;
        }
        
        // Process requests
        const requestPromises = snapshot.docs.map(async doc => {
          const requestData = doc.data();
          const requestId = doc.id;
          
          let userName = 'Unknown User';
          let userEmail = '';
          let courseTitle = 'Unknown Course';
          
          // Get user info
          if (requestData.userId) {
            const userDoc = await getDoc(doc(db, 'users', requestData.userId));
            if (userDoc.exists()) {
              const user = userDoc.data();
              userName = user.name || 'Unknown User';
              userEmail = user.email || '';
            }
          }
          
          // Get course info
          if (requestData.courseId) {
            const courseDoc = await getDoc(doc(db, 'courses', requestData.courseId));
            if (courseDoc.exists()) {
              courseTitle = courseDoc.data().title || 'Unknown Course';
            }
          }
          
          // Status badge
          let statusBadge = '';
          switch(requestData.status) {
            case 'pending':
              statusBadge = '<span class="badge badge-warning">Pending</span>';
              break;
            case 'approved':
              statusBadge = '<span class="badge badge-success">Approved</span>';
              break;
            case 'rejected':
              statusBadge = '<span class="badge badge-danger">Rejected</span>';
              break;
            default:
              statusBadge = '<span class="badge badge-secondary">Unknown</span>';
          }
          
          return {
            id: requestId,
            userId: requestData.userId,
            userName,
            userEmail,
            courseId: requestData.courseId,
            courseTitle,
            status: requestData.status,
            statusBadge,
            requestedAt: requestData.requestedAt?.toDate().toLocaleString() || 'Unknown',
            reason: requestData.reason || ''
          };
        });
        
        requestsData = await Promise.all(requestPromises);
        
        // Clear and populate table
        tbody.innerHTML = '';
        
        requestsData.forEach(request => {
          const tr = document.createElement('tr');
          
          tr.innerHTML = `
            <td>${request.userName} <small>(${request.userEmail})</small></td>
            <td>${request.courseTitle}</td>
            <td>${request.requestedAt}</td>
            <td>${request.statusBadge}</td>
            <td class="actions">
              ${request.status === 'pending' ? `
                <button class="btn btn-success btn-sm" onclick="handleRequest('${request.id}', 'approve')">
                  <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn btn-danger btn-sm" onclick="handleRequest('${request.id}', 'reject')">
                  <i class="fas fa-times"></i> Reject
                </button>
              ` : ''}
              <button class="btn btn-info btn-sm" onclick="viewRequestDetails('${request.id}')">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('Error loading requests:', error);
        tbody.innerHTML = `
          <tr><td colspan="5" style="color:red;">Error loading requests: ${error.message}</td></tr>
        `;
      }
    }
    
    // Handle request (approve/reject)
    window.handleRequest = async function(requestId, action) {
      if (!confirm(`Are you sure you want to ${action} this request?`)) {
        return;
      }
      
      try {
        const requestRef = doc(db, 'requests', requestId);
        const requestDoc = await getDoc(requestRef);
        
        if (!requestDoc.exists()) {
          alert('Request not found');
          return;
        }
        
        const requestData = requestDoc.data();
        const newStatus = action === 'approve' ? 'approved' : 'rejected';
        
        // Update request status
        await updateDoc(requestRef, {
          status: newStatus,
          processedAt: serverTimestamp(),
          processedBy: currentUser.uid
        });
        
        // If approved, remove the course from user's enrollments
        if (action === 'approve') {
          const userRef = doc(db, 'users', requestData.userId);
          const userDoc = await getDoc(userRef);
          
          if (userDoc.exists()) {
            const userData = userDoc.data();
            const enrolledCourses = userData.enrolledCourses || [];
            
            // Remove the course
            const updatedCourses = enrolledCourses.filter(course => 
              course.courseId !== requestData.courseId
            );
            
            // Update user if courses changed
            if (updatedCourses.length < enrolledCourses.length) {
              await updateDoc(userRef, {
                enrolledCourses: updatedCourses
              });
            }
          }
        }
        
        logActivity(`${action === 'approve' ? 'Approved' : 'Rejected'} unenrollment request for user: ${requestData.userId}`);
        alert(`Request ${action}d successfully`);
        loadRequests();
      } catch (error) {
        console.error(`Error ${action}ing request:`, error);
        alert(`Error ${action}ing request: ${error.message}`);
      }
    };
    
    // View request details
    window.viewRequestDetails = function(requestId) {
      const request = requestsData.find(r => r.id === requestId);
      
      if (!request) {
        alert('Request not found');
        return;
      }
      
      let details = `
        <h4>Request Details</h4>
        <p><strong>User:</strong> ${request.userName} (${request.userEmail})</p>
        <p><strong>Course:</strong> ${request.courseTitle}</p>
        <p><strong>Status:</strong> ${request.statusBadge}</p>
        <p><strong>Requested At:</strong> ${request.requestedAt}</p>
      `;
      
      if (request.reason) {
        details += `<p><strong>Reason:</strong> ${request.reason}</p>`;
      }
      
      alert(details);
    };
    
    // Load analytics
    async function loadAnalytics() {
      const days = parseInt(document.getElementById('analyticsTimeRange').value) || 30;
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(endDate.getDate() - days);
      
      try {
        // User registrations data
        const usersQuery = query(
          collection(db, 'users'),
          where('createdAt', '>=', startDate),
          where('createdAt', '<=', endDate)
        );
        
        const usersSnapshot = await getDocs(usersQuery);
        const userRegistrations = Array(days).fill(0);
        
        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          const createdAt = userData.createdAt?.toDate();
          
          if (createdAt) {
            const dayDiff = Math.floor((endDate - createdAt) / (1000 * 60 * 60 * 24));
            if (dayDiff >= 0 && dayDiff < days) {
              userRegistrations[days - 1 - dayDiff]++;
            }
          }
        });
        
        // Course enrollments data
        const enrollmentsData = Array(days).fill(0);
        const usersEnrollmentsSnapshot = await getDocs(collection(db, 'users'));
        
        usersEnrollmentsSnapshot.forEach(userDoc => {
          const userData = userDoc.data();
          const enrollments = userData.enrolledCourses || [];
          
          enrollments.forEach(enrollment => {
            const enrollmentDate = new Date(enrollment.enrollmentdate);
            if (isNaN(enrollmentDate.getTime())) return;
            
            if (enrollmentDate >= startDate && enrollmentDate <= endDate) {
              const dayDiff = Math.floor((endDate - enrollmentDate) / (1000 * 60 * 60 * 24));
              if (dayDiff >= 0 && dayDiff < days) {
                enrollmentsData[days - 1 - dayDiff]++;
              }
            }
          });
        });
        
        // Generate labels (dates)
        const labels = [];
        for (let i = days - 1; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        }
        
        // Initialize or update charts
        initCharts(labels, userRegistrations, enrollmentsData);
      } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('analyticsCharts').innerHTML = `
          <div class="alert alert-danger">Error loading analytics: ${error.message}</div>
        `;
      }
    }
    
    // Initialize charts
    function initCharts(labels, userRegistrations, courseEnrollments) {
      const chartOptions = {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      };
      
      // User Registrations Chart
      const userRegCtx = document.getElementById('userRegistrationsChart').getContext('2d');
      if (userRegistrationsChart) {
        userRegistrationsChart.data.labels = labels;
        userRegistrationsChart.data.datasets[0].data = userRegistrations;
        userRegistrationsChart.update();
      } else {
        userRegistrationsChart = new Chart(userRegCtx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'User Registrations',
              data: userRegistrations,
              backgroundColor: 'rgba(67, 97, 238, 0.2)',
              borderColor: 'rgba(67, 97, 238, 1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true
            }]
          },
          options: chartOptions
        });
      }
      
      // Course Enrollments Chart
      const courseEnrollCtx = document.getElementById('courseEnrollmentsChart').getContext('2d');
      if (courseEnrollmentsChart) {
        courseEnrollmentsChart.data.labels = labels;
        courseEnrollmentsChart.data.datasets[0].data = courseEnrollments;
        courseEnrollmentsChart.update();
      } else {
        courseEnrollmentsChart = new Chart(courseEnrollCtx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Course Enrollments',
              data: courseEnrollments,
              backgroundColor: 'rgba(76, 201, 240, 0.7)',
              borderColor: 'rgba(76, 201, 240, 1)',
              borderWidth: 1
            }]
          },
          options: chartOptions
        });
      }
      
      // User Activity Chart (placeholder - would need actual activity data)
      const userActivityCtx = document.getElementById('userActivityChart').getContext('2d');
      if (!userActivityChart) {
        userActivityChart = new Chart(userActivityCtx, {
          type: 'doughnut',
          data: {
            labels: ['Active', 'Inactive', 'New'],
            datasets: [{
              data: [65, 25, 10],
              backgroundColor: [
                'rgba(67, 97, 238, 0.7)',
                'rgba(108, 117, 125, 0.7)',
                'rgba(76, 201, 240, 0.7)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top',
              }
            }
          }
        });
      }
      
      // Course Completion Chart (placeholder - would need actual completion data)
      const courseCompletionCtx = document.getElementById('courseCompletionChart').getContext('2d');
      if (!courseCompletionChart) {
        courseCompletionChart = new Chart(courseCompletionCtx, {
          type: 'pie',
          data: {
            labels: ['Completed', 'In Progress', 'Not Started'],
            datasets: [{
              data: [45, 35, 20],
              backgroundColor: [
                'rgba(76, 201, 240, 0.7)',
                'rgba(248, 150, 30, 0.7)',
                'rgba(108, 117, 125, 0.7)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top',
              }
            }
          }
        });
      }
    }
    
    // Load settings
    async function loadSettings() {
      try {
        const settingsDoc = await getDoc(doc(db, 'settings', 'system'));
        
        if (settingsDoc.exists()) {
          const settings = settingsDoc.data();
          
          // General settings
          if (settings.general) {
            document.getElementById('systemName').value = settings.general.systemName || '';
            document.getElementById('systemEmail').value = settings.general.systemEmail || '';
            document.getElementById('timezone').value = settings.general.timezone || 'UTC';
            document.getElementById('dateFormat').value = settings.general.dateFormat || 'MM/DD/YYYY';
          }
          
          // Security settings
          if (settings.security) {
            document.getElementById('passwordPolicy').value = settings.security.passwordPolicy || 'medium';
            document.getElementById('loginAttempts').value = settings.security.loginAttempts || 5;
            document.getElementById('sessionTimeout').value = settings.security.sessionTimeout || 30;
            document.getElementById('enable2FA').checked = settings.security.enable2FA || false;
          }
          
          // Notification settings
          if (settings.notifications) {
            document.getElementById('emailNotifications').checked = settings.notifications.emailNotifications || false;
            document.getElementById('notificationEmail').value = settings.notifications.notificationEmail || '';
            document.getElementById('newUserNotification').checked = settings.notifications.newUserNotification || false;
            document.getElementById('courseEnrollmentNotification').checked = settings.notifications.courseEnrollmentNotification || false;
            document.getElementById('unenrollmentRequestNotification').checked = settings.notifications.unenrollmentRequestNotification || false;
          }
          
          // Backup settings
          if (settings.backup) {
            document.getElementById('autoBackup').checked = settings.backup.autoBackup || false;
            document.getElementById('backupFrequency').value = settings.backup.backupFrequency || 'weekly';
            document.getElementById('backupTime').value = settings.backup.backupTime || '02:00';
            document.getElementById('backupRetention').value = settings.backup.backupRetention || 30;
          }
        }
        
        // Load backup list
        loadBackupList();
      } catch (error) {
        console.error('Error loading settings:', error);
        alert(`Error loading settings: ${error.message}`);
      }
    }
    
    // Save general settings
    async function saveGeneralSettings() {
      try {
        const settings = {
          general: {
            systemName: document.getElementById('systemName').value,
            systemEmail: document.getElementById('systemEmail').value,
            timezone: document.getElementById('timezone').value,
            dateFormat: document.getElementById('dateFormat').value,
            updatedAt: serverTimestamp()
          }
        };
        
        await setDoc(doc(db, 'settings', 'system'), settings, { merge: true });
        logActivity('Updated general settings');
        alert('General settings saved successfully');
      } catch (error) {
        console.error('Error saving general settings:', error);
        alert(`Error saving general settings: ${error.message}`);
      }
    }
    
    // Save security settings
    async function saveSecuritySettings() {
      try {
        const settings = {
          security: {
            passwordPolicy: document.getElementById('passwordPolicy').value,
            loginAttempts: parseInt(document.getElementById('loginAttempts').value),
            sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
            enable2FA: document.getElementById('enable2FA').checked,
            updatedAt: serverTimestamp()
          }
        };
        
        await setDoc(doc(db, 'settings', 'system'), settings, { merge: true });
        logActivity('Updated security settings');
        alert('Security settings saved successfully');
      } catch (error) {
        console.error('Error saving security settings:', error);
        alert(`Error saving security settings: ${error.message}`);
      }
    }
    
    // Save notification settings
    async function saveNotificationSettings() {
      try {
        const settings = {
          notifications: {
            emailNotifications: document.getElementById('emailNotifications').checked,
            notificationEmail: document.getElementById('notificationEmail').value,
            newUserNotification: document.getElementById('newUserNotification').checked,
            courseEnrollmentNotification: document.getElementById('courseEnrollmentNotification').checked,
            unenrollmentRequestNotification: document.getElementById('unenrollmentRequestNotification').checked,
            updatedAt: serverTimestamp()
          }
        };
        
        await setDoc(doc(db, 'settings', 'system'), settings, { merge: true });
        logActivity('Updated notification settings');
        alert('Notification settings saved successfully');
      } catch (error) {
        console.error('Error saving notification settings:', error);
        alert(`Error saving notification settings: ${error.message}`);
      }
    }
    
    // Load backup list
    async function loadBackupList() {
      try {
        // In a real app, you would list files from your storage bucket
        // This is a placeholder implementation
        const backupList = document.getElementById('backupList');
        backupList.innerHTML = '<tr><td colspan="4">No backups available</td></tr>';
        
        // Example of how you might implement this with Firebase Storage:
        /*
        const storageRef = ref(storage, 'backups/');
        const backups = await listAll(storageRef);
        
        if (backups.items.length === 0) {
          backupList.innerHTML = '<tr><td colspan="4">No backups available</td></tr>';
          return;
        }
        
        backupList.innerHTML = '';
        
        backups.items.forEach(async (item) => {
          const metadata = await getMetadata(item);
          const tr = document.createElement('tr');
          
          tr.innerHTML = `
            <td>${new Date(metadata.timeCreated).toLocaleString()}</td>
            <td>${formatBytes(metadata.size)}</td>
            <td>${metadata.customMetadata?.type || 'Full'}</td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="downloadBackup('${item.name}')">
                <i class="fas fa-download"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteBackup('${item.name}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          backupList.appendChild(tr);
        });
        */
      } catch (error) {
        console.error('Error loading backup list:', error);
        document.getElementById('backupList').innerHTML = `
          <tr><td colspan="4" style="color:red;">Error loading backups: ${error.message}</td></tr>
        `;
      }
    }
    
    // Format bytes to human-readable format
    function formatBytes(bytes, decimals = 2) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
    
    // Create backup
    async function createBackup() {
      try {
        // In a real app, you would:
        // 1. Export all collections to JSON
        // 2. Compress the data
        // 3. Upload to Firebase Storage
        // This is a simplified version
        
        alert('Backup process started. You will be notified when complete.');
        logActivity('Created system backup');
        
        // Simulate backup process
        setTimeout(() => {
          alert('Backup completed successfully');
          loadBackupList();
        }, 3000);
      } catch (error) {
        console.error('Error creating backup:', error);
        alert(`Error creating backup: ${error.message}`);
      }
    }
    
    // Restore backup
    async function restoreBackup() {
      if (!confirm('Are you sure you want to restore from backup? This will overwrite current data.')) {
        return;
      }
      
      try {
        // In a real app, you would:
        // 1. Let user select a backup file
        // 2. Download and decompress the data
        // 3. Import into Firestore
        // This is a simplified version
        
        alert('Restore process started. You will be notified when complete.');
        logActivity('Initiated system restore');
        
        // Simulate restore process
        setTimeout(() => {
          alert('Restore completed successfully');
          location.reload(); // Refresh to load restored data
        }, 3000);
      } catch (error) {
        console.error('Error restoring backup:', error);
        alert(`Error restoring backup: ${error.message}`);
      }
    }
    
    // Export users data
    window.exportUsers = function(format) {
      if (usersData.length === 0) {
        alert('No users data to export');
        return;
      }
      
      // Prepare columns for selection
      const columnsContainer = document.getElementById('exportColumns');
      columnsContainer.innerHTML = '';
      
      // Get all possible columns from the first user
      const sampleUser = usersData[0];
      const allColumns = Object.keys(sampleUser).filter(key => key !== 'id');
      
      allColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'custom-checkbox';
        div.innerHTML = `
          <input type="checkbox" id="export_${column}" checked>
          <label for="export_${column}">${column.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</label>
        `;
        columnsContainer.appendChild(div);
      });
      
      // Set default filename
      document.getElementById('exportFileName').value = `users_export_${new Date().toISOString().split('T')[0]}`;
      
      // Show export modal
      document.getElementById(`export${format.toUpperCase()}`).checked = true;
      document.getElementById('exportModal').classList.add('active');
    };
    
    // Confirm export
    async function confirmExport() {
      const format = document.querySelector('input[name="exportFormat"]:checked').value;
      const filename = document.getElementById('exportFileName').value || 'export';
      const includeHeaders = document.getElementById('exportIncludeHeaders').checked;
      
      // Get selected columns
      const selectedColumns = [];
      document.querySelectorAll('#exportColumns input[type="checkbox"]:checked').forEach(checkbox => {
        selectedColumns.push(checkbox.id.replace('export_', ''));
      });
      
      if (selectedColumns.length === 0) {
        alert('Please select at least one column to export');
        return;
      }
      
      // Prepare data
      const data = usersData.map(user => {
        const row = {};
        selectedColumns.forEach(col => {
          row[col] = user[col];
        });
        return row;
      });
      
      // Export based on format
      switch(format) {
        case 'csv':
          exportToCSV(data, filename, includeHeaders);
          break;
        case 'excel':
          exportToExcel(data, filename, includeHeaders);
          break;
        case 'pdf':
          exportToPDF(data, filename, includeHeaders);
          break;
      }
      
      closeModals();
    }
    
    // Export to CSV
    function exportToCSV(data, filename, includeHeaders) {
      let csv = '';
      
      // Add headers
      if (includeHeaders) {
        const headers = Object.keys(data[0]).join(',');
        csv += headers + '\r\n';
      }
      
      // Add data
      data.forEach(row => {
        const values = Object.values(row).map(value => {
          if (typeof value === 'object') {
            return JSON.stringify(value);
          }
          return `"${value}"`;
        });
        csv += values.join(',') + '\r\n';
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${filename}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Export to Excel
    function exportToExcel(data, filename, includeHeaders) {
      // Create worksheet
      const ws = XLSX.utils.json_to_sheet(data, { skipHeader: !includeHeaders });
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Users');
      
      // Export
      XLSX.writeFile(wb, `${filename}.xlsx`);
    }
    
    // Export to PDF
    function exportToPDF(data, filename, includeHeaders) {
      // This is a simplified version - in a real app you'd use jsPDF with more formatting
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.text('Users Export', 14, 15);
      
      // Prepare columns and rows
      const columns = Object.keys(data[0]).map(col => 
        col.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
      );
      const rows = data.map(row => Object.values(row));
      
      // Add table
      doc.autoTable({
        head: includeHeaders ? [columns] : [],
        body: rows,
        startY: 20,
        styles: {
          fontSize: 8,
          cellPadding: 2
        }
      });
      
      // Save
      doc.save(`${filename}.pdf`);
    }
    
    // Log activity
    async function logActivity(action) {
      try {
        await addDoc(collection(db, 'activity'), {
          action: action,
          userId: currentUser?.uid || 'system',
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error('Error logging activity:', error);
      }
    }
    
    // Initialize dashboard
    function initDashboard() {
      showSection('dashboard');
      loadDashboard();
      
      // Set user info
      if (currentUser) {
        userInitial.textContent = currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : 'A';
      }
    }
  </script>
</body>
</html>
