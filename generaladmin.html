<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HU Jama'aa - Admin Panel V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #1A5D1A; /* Darker Green */
            --primary-light: #5F8D4E; /* Lighter Green */
            --secondary-color: #A4BE7B; /* Accent Green */
            --accent-color: #EAE7B1; /* Light Yellow/Beige */
            --bg-color: #F8F9FA; /* Very Light Grey */
            --card-bg: #FFFFFF;
            --text-color: #343A40;
            --text-light: #6C757D;
            --border-color: #E9ECEF;
            --white: #ffffff;
            --danger-color: #DC3545;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --info-color: #17A2B8;

            --border-radius: 10px;
            --box-padding: 20px; /* Slightly reduced padding */
            --shadow: 0 3px 8px rgba(0, 0, 0, 0.07);
            --shadow-hover: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            min-height: 100vh;
            font-size: 15px;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 100%;
            padding: 0;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: var(--white);
            padding: 15px var(--box-padding);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.3rem; /* Slightly smaller */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 i {
            font-size: 1.1rem;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem; /* Slightly larger icon */
            cursor: pointer;
            position: relative;
            transition: var(--transition);
            padding: 5px;
        }

        .btn-icon:hover {
            opacity: 0.85;
        }

        /* Admin Panel Indicator */
        .admin-badge {
            background-color: var(--accent-color);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Account Dropdown */
        .account-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 10px); /* Position below button */
            background-color: var(--white);
            min-width: 220px;
            box-shadow: var(--shadow-hover);
            z-index: 1001; /* Ensure it's above nav */
            border-radius: var(--border-radius);
            overflow: hidden;
            animation: fadeIn 0.2s ease-out;
            border: 1px solid var(--border-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-content a {
            color: var(--text-color);
            padding: 12px 18px; /* Adjusted padding */
            text-decoration: none;
            display: flex; /* Use flex for alignment */
            align-items: center;
            font-size: 0.9rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            border-bottom: 1px solid var(--border-color); /* Separator */
        }
        .dropdown-content a:last-child {
            border-bottom: none;
        }

        .dropdown-content a:hover {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }

        .dropdown-content a i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            color: var(--primary-light);
        }
        .dropdown-content a:hover i {
            color: var(--primary-color);
        }

        .dropdown-content a.logout-link i {
             color: var(--danger-color);
        }
         .dropdown-content a.logout-link:hover {
             background-color: rgba(220, 53, 69, 0.1);
             color: var(--danger-color);
        }


        .account-dropdown:hover .dropdown-content,
        .account-dropdown .btn-icon:focus + .dropdown-content { /* Show on focus too */
            display: block;
        }


        .user-name {
            margin-right: 8px;
            font-size: 0.9rem;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
            color: var(--accent-color); /* Lighter color for name */
        }

        /* Main Content Area */
        .main-content {
            padding: var(--box-padding);
            padding-bottom: 40px; /* More space at bottom */
        }

        /* Admin Navigation */
        .admin-nav {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .admin-nav-item {
            padding: 14px 18px; /* Adjusted padding */
            text-align: center;
            cursor: pointer;
            flex: 1;
            transition: var(--transition);
            border-bottom: 3px solid transparent; /* Thinner indicator */
            font-size: 0.95rem; /* Slightly larger */
            font-weight: 500;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .admin-nav-item.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
            background-color: rgba(26, 93, 26, 0.05); /* Subtle active background */
        }

        .admin-nav-item:not(.active):hover {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .admin-nav-item i {
            font-size: 1rem;
            margin-top: -2px; /* Align icon better */
        }

        /* Section Styling */
        .admin-section {
             animation: sectionFadeIn 0.4s ease-out;
        }
         @keyframes sectionFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: var(--box-padding);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
            /* transform: translateY(-2px); // Subtle lift removed for cleaner look */
        }

        .card-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.2rem; /* Slightly smaller title */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title i {
            font-size: 1rem; /* Smaller icon */
        }

        /* Table Styles */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            border: 1px solid var(--border-color); /* Border around table */
            border-radius: calc(var(--border-radius) - 1px); /* Match card radius */
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px; /* Reduced min-width */
        }

        .data-table th, .data-table td {
            padding: 12px 15px; /* Adjusted padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem; /* Slightly smaller table text */
            vertical-align: middle; /* Better alignment */
        }

        .data-table th {
            background-color: var(--bg-color); /* Lighter header */
            color: var(--text-color);
            font-weight: 600; /* Bold header text */
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

         .data-table tbody tr:hover {
            background-color: rgba(164, 190, 123, 0.1); /* Subtle hover */
        }

        .data-table td .user-info {
             display: flex;
             flex-direction: column;
        }
         .data-table td .user-info strong {
             font-weight: 500;
         }
         .data-table td .user-info small {
             font-size: 0.8rem;
             color: var(--text-light);
         }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px; /* Smaller badges */
            border-radius: 15px;
            font-size: 0.75rem; /* Smaller font */
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: capitalize; /* Nicer display */
            border: 1px solid transparent;
        }

        /* Define badge colors */
        .badge-primary { background-color: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; } /* Hifz */
        .badge-info { background-color: #e0f7fa; color: #007bff; border-color: #80deea; }    /* Qirat */
        .badge-warning { background-color: #fff8e1; color: #ff8f00; border-color: #ffcc80; } /* Nezer */
        .badge-secondary { background-color: #f8f9fa; color: #6c757d; border-color: #dee2e6; } /* Default */
        .badge-success { background-color: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .badge-danger { background-color: #fdecea; color: #c62828; border-color: #ef9a9a; }
        .badge-light { background-color: #f8f9fa; color: #6c757d; border-color: #dee2e6; }


        /* Buttons */
        .btn {
            padding: 10px 18px; /* Adjusted padding */
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            text-decoration: none; /* For link buttons */
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn i {
            margin-top: -1px;
        }

        .btn-block { width: 100%; }

        .btn-primary { background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-light); border-color: var(--primary-light); box-shadow: var(--shadow); }

        .btn-outline { background-color: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }
        .btn-outline:hover:not(:disabled) { background-color: rgba(26, 93, 26, 0.05); }

        .btn-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; border-color: #bd2130; box-shadow: var(--shadow); }

        .btn-success { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        .btn-success:hover:not(:disabled) { background-color: #218838; border-color: #1e7e34; box-shadow: var(--shadow); }

        .btn-warning { background-color: var(--warning-color); color: var(--text-color); border-color: var(--warning-color); }
        .btn-warning:hover:not(:disabled) { background-color: #e0a800; border-color: #d39e00; box-shadow: var(--shadow); }

        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: calc(var(--border-radius) - 2px); }

        /* Form Elements */
        .form-group { margin-bottom: 18px; } /* Reduced margin */
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .form-control {
            width: 100%;
            padding: 12px; /* Adjusted padding */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            transition: var(--transition);
            background-color: var(--white); /* Ensure background */
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(95, 141, 78, 0.15); /* Focus ring */
        }
         select.form-control {
             appearance: none; /* Custom dropdown arrow */
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
             background-repeat: no-repeat;
             background-position: right 0.75rem center;
             background-size: 16px 12px;
             padding-right: 2.5rem; /* Space for arrow */
         }

        textarea.form-control { min-height: 100px; resize: vertical; }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Smaller min width */
            gap: 20px; /* Reduced gap */
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px; /* Adjusted padding */
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 4px; /* Thinner top border */
            background: var(--primary-color);
        }
        /* Specific colors for stat cards */
        .stat-card:nth-child(1)::before { background: var(--info-color); }
        .stat-card:nth-child(2)::before { background: var(--success-color); }
        .stat-card:nth-child(3)::before { background: var(--primary-light); }
        .stat-card:nth-child(4)::before { background: var(--warning-color); }


        .stat-card h3 {
            color: var(--text-light); /* Lighter title */
            margin-bottom: 8px;
            font-size: 0.85rem; /* Smaller title */
            font-weight: 600; /* Bolder */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card p {
            font-size: 1.8rem; /* Slightly smaller number */
            font-weight: 700;
            color: var(--text-color);
            line-height: 1.2; /* Adjust line height */
        }
        .stat-card .loading-text .spinner { margin: 5px auto 0; } /* Center spinner */

        /* Empty State & Loading */
        .empty-state, .loading-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        .empty-state i, .loading-state i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--border-color); /* Lighter icon */
            opacity: 0.8;
        }
        .empty-state p { font-size: 1rem; max-width: 400px; margin: 0 auto 15px; }

        .loading-state { display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner {
            width: 40px; height: 40px; /* Smaller spinner */
            border: 4px solid rgba(26, 93, 26, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s linear infinite; /* Faster spin */
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text .spinner { width: 20px; height: 20px; border-width: 3px; } /* Inline spinner */

        /* Modal Styles */
        .modal {
            display: none; /* Use JS to show/hide */
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            z-index: 2000;
            align-items: center; justify-content: center;
            padding: 20px;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal.active { display: flex; opacity: 1; }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            width: 100%; max-width: 550px; /* Slightly narrower */
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); /* Start slightly smaller */
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
        }
        .modal.active .modal-content { transform: scale(1); }

        .modal-header {
            padding: 15px 20px; /* Adjusted padding */
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title {
            font-size: 1.25rem; /* Slightly smaller */
            color: var(--primary-color); font-weight: 600;
            display: flex; align-items: center; gap: 10px;
        }
        .modal-close {
            background: none; border: none; font-size: 1.6rem; cursor: pointer;
            color: var(--text-light); transition: var(--transition);
            padding: 5px; line-height: 1;
        }
        .modal-close:hover { color: var(--danger-color); transform: rotate(90deg); }

        .modal-body { padding: 25px 20px; }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: flex-end; gap: 10px;
        }

        /* Notification */
        .notification {
            position: fixed; top: 20px; right: 20px;
            padding: 12px 20px; /* Adjusted padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            z-index: 3000;
            display: flex; align-items: center; gap: 12px;
            transform: translateX(110%);
            transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); /* Bounce effect */
            font-size: 0.9rem; /* Smaller font */
            border-left: 5px solid; /* Accent border */
        }
        .notification.show { transform: translateX(0); }
        .notification i { font-size: 1.2rem; }

        .notification-success { background-color: #e8f5e9; color: #2e7d32; border-color: var(--success-color); }
        .notification-success i { color: var(--success-color); }
        .notification-error { background-color: #fdecea; color: #c62828; border-color: var(--danger-color); }
        .notification-error i { color: var(--danger-color); }

        /* Action Buttons (Dashboard) */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Adjust size */
            gap: 15px;
            margin-top: 25px;
            margin-bottom: 30px;
        }

        .action-button {
            padding: 18px; /* Adjusted padding */
            border-radius: var(--border-radius);
            background: var(--card-bg);
            box-shadow: var(--shadow);
            transition: var(--transition);
            color: var(--text-color);
            text-decoration: none;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-align: center;
            border: 1px solid var(--border-color);
        }
        .action-button:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            color: var(--primary-color);
            border-color: var(--secondary-color); /* Subtle border highlight */
        }
        .action-button i {
            font-size: 2rem; /* Smaller icon */
            margin-bottom: 12px;
            color: var(--primary-light);
            transition: color 0.3s ease;
        }
         .action-button:hover i {
             color: var(--primary-color);
         }
        .action-button h3 { font-size: 1rem; margin-bottom: 5px; font-weight: 600; }
        .action-button p { font-size: 0.8rem; color: var(--text-light); line-height: 1.4; }

        /* Utility */
        .hidden { display: none; }
        .mb-3 { margin-bottom: 1.5rem; } /* Standard margin bottom */
        .mt-2 { margin-top: 0.5rem; }
        .text-muted { color: var(--text-light) !important; }

        /* Responsive */
        @media (max-width: 992px) {
            .admin-nav { flex-wrap: wrap; }
            .admin-nav-item { flex: 1 0 50%; font-size: 0.9rem; padding: 12px; }
            .action-buttons { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
        }

        @media (max-width: 768px) {
            :root { --box-padding: 15px; }
            .header h1 { font-size: 1.2rem; }
            .main-content { padding: 15px; }
            .stats-container { grid-template-columns: 1fr 1fr; gap: 15px; }
            .stat-card p { font-size: 1.6rem; }
            .card-title { font-size: 1.1rem; }
            .action-buttons { grid-template-columns: 1fr 1fr; } /* Two columns on smaller screens */
        }

        @media (max-width: 576px) {
            .header { padding: 12px 15px; }
            .header h1 { font-size: 1.1rem; gap: 8px; }
             .header .admin-badge { font-size: 0.65rem; padding: 3px 8px; }
            .user-name { max-width: 80px; font-size: 0.85rem; }
            .btn-icon { font-size: 1.3rem; }
             .dropdown-content { min-width: 180px; }
             .dropdown-content a { padding: 10px 15px; font-size: 0.85rem; }

            .admin-nav-item { flex: 1 0 100%; padding: 12px; border-bottom-width: 2px; } /* Stack nav items */
            .stats-container { grid-template-columns: 1fr; } /* Single column stats */
            .action-buttons { grid-template-columns: 1fr; gap: 10px; } /* Single column actions */
            .action-button { padding: 15px; }
            .action-button i { font-size: 1.8rem; }
            .action-button h3 { font-size: 1rem; }

            .modal-content { max-width: 95%; }
            .modal-title { font-size: 1.1rem; }
            .modal-footer { flex-direction: column; }
            .modal-footer .btn { width: 100%; }

            .data-table th, .data-table td { padding: 10px 12px; font-size: 0.85rem; }
            .data-table th { font-size: 0.75rem; }
        }

    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>
                <i class="fas fa-shield-alt"></i>
                <span id="page-section-title">Dashboard</span> <span class="admin-badge" id="user-role-badge">MODERATOR</span>
            </h1>
            <div class="header-actions">
                <div class="account-dropdown">
                    <div style="display: flex; align-items: center; cursor: pointer;">
                        <span class="user-name" id="user-name-display">...</span>
                        <button class="btn-icon" id="account-btn" aria-label="Account Menu">
                            <i class="fas fa-user-circle"></i>
                        </button>
                    </div>
                    <div class="dropdown-content" id="account-dropdown">
                        <a href="#" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                        <a href="#" data-section="courses"><i class="fas fa-book-open"></i> Courses</a>
                        <a href="#" data-section="users"><i class="fas fa-users"></i> Users</a>
                        <a href="#" data-section="enrollments"><i class="fas fa-clipboard-list"></i> Enrollments</a>
                        <a href="#" id="logout-btn" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <nav class="admin-nav">
            <div class="admin-nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="admin-nav-item" data-section="courses">
                <i class="fas fa-book-open"></i> Courses
            </div>
            <div class="admin-nav-item" data-section="users">
                <i class="fas fa-users"></i> Users
            </div>
            <div class="admin-nav-item" data-section="enrollments">
                <i class="fas fa-clipboard-list"></i> Enrollments
            </div>
        </nav>

        <main class="main-content" id="main-content">

            <div id="dashboard-section" class="admin-section">
                <div class="stats-container">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <p id="total-users"><span class="loading-text"><span class="spinner"></span></span></p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Courses</h3>
                        <p id="total-courses"><span class="loading-text"><span class="spinner"></span></span></p>
                    </div>
                    <div class="stat-card">
                        <h3>Active Enrollments</h3>
                        <p id="total-enrollments"><span class="loading-text"><span class="spinner"></span></span></p>
                    </div>
                    <div class="stat-card">
                        <h3>Overflow Users</h3>
                        <p id="overflow-users"><span class="loading-text"><span class="spinner"></span></span></p>
                    </div>
                </div>

                <div class="action-buttons">
                    <a href="#" data-section="users" class="action-button admin-nav-trigger">
                        <i class="fas fa-users-cog"></i>
                        <h3>Manage Users</h3>
                        <p>View & manage system users</p>
                    </a>
                    <a href="#" data-section="enrollments" class="action-button admin-nav-trigger">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>Enrollments</h3>
                        <p>Manage course enrollments</p>
                    </a>
                    <a href="reports.html" class="action-button">
                        <i class="fas fa-chart-line"></i> <h3>Reports</h3>
                        <p>View system analytics</p>
                    </a>
                    <a href="settings.html" class="action-button">
                        <i class="fas fa-cogs"></i> <h3>Settings</h3>
                        <p>Configure system settings</p>
                    </a>
                </div>

                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-history"></i>
                        Recent Enrollments (Top 3)
                    </h2>
                    <div class="table-responsive">
                        <table class="data-table" id="recent-enrollments-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Course</th>
                                    <th>Type</th>
                                    <th>Language</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="loading-state"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="courses-section" class="admin-section hidden">
                 <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h2 class="card-title" style="margin-bottom: 0; border-bottom: none; padding-bottom: 0;">
                           <i class="fas fa-book-open"></i> Course Management
                        </h2>
                        <button class="btn btn-primary" id="add-course-btn">
                            <i class="fas fa-plus"></i> Add New Course
                        </button>
                    </div>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                         <div class="filter-item" style="flex: 1; min-width: 150px;">
                            <label for="course-type-filter" class="form-group label" style="font-size: 0.8rem; margin-bottom: 4px;">Filter by Type</label>
                            <select id="course-type-filter" class="form-control form-control-sm">
                                <option value="all">All Types</option>
                                </select>
                        </div>
                        <div class="filter-item" style="flex: 1; min-width: 150px;">
                            <label for="course-language-filter" class="form-group label" style="font-size: 0.8rem; margin-bottom: 4px;">Filter by Language</label>
                            <select id="course-language-filter" class="form-control form-control-sm">
                                <option value="all">All Languages</option>
                               </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table" id="courses-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Language</th>
                                    <th>Enrollments</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="loading-state"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="users-section" class="admin-section hidden">
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i> User Management
                    </h2>
                     <p class="text-muted mb-3">View and manage registered users.</p>
                    <div class="table-responsive">
                        <table class="data-table" id="users-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Enrolled</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="loading-state"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="enrollments-section" class="admin-section hidden">
                 <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-clipboard-list"></i> Enrollment Management
                    </h2>
                     <p class="text-muted mb-3">View all course enrollments across the system.</p>
                    <div class="table-responsive">
                        <table class="data-table" id="enrollments-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Course</th>
                                    <th>Type</th>
                                    <th>Language</th>
                                    <th>Enrollment Date</th>
                                    <th>Status</th> </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="loading-state"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div class="modal" id="course-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="course-modal-title"><i class="fas fa-book"></i> Add New Course</h3>
                <button class="modal-close" id="close-course-modal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="course-form">
                    <input type="hidden" id="course-id">
                    <div class="form-group">
                        <label for="course-title">Course Title *</label>
                        <input type="text" id="course-title" class="form-control" required placeholder="e.g., Advanced Tajweed">
                    </div>
                    <div class="form-group">
                        <label for="course-type">Course Type *</label>
                        <input type="text" id="course-type" class="form-control" required list="course-type-list" placeholder="e.g., Qirat, Hifz or Custom Type">
                        <datalist id="course-type-list">
                            <option value="Qirat">
                            <option value="Hifz">
                            <option value="Nezer">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="course-language">Language *</label>
                         <input type="text" id="course-language" class="form-control" required list="course-language-list" placeholder="e.g., Amharic, Oromifa or Custom Language">
                         <datalist id="course-language-list">
                             <option value="Amharic">
                             <option value="Oromifa">
                             <option value="Arabic">
                             <option value="English">
                         </datalist>
                    </div>
                    <div class="form-group">
                        <label for="course-description">Description</label>
                        <textarea id="course-description" class="form-control" rows="3" placeholder="Optional: Brief description of the course..."></textarea>
                    </div>
                     <div class="form-group">
                        <small class="text-muted">* Required fields</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-course" type="button"><i class="fas fa-times"></i> Cancel</button>
                <button class="btn btn-primary" id="save-course" type="button"><i class="fas fa-save"></i> Save Course</button>
            </div>
        </div>
    </div>

    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirm-title"><i class="fas fa-exclamation-triangle text-danger"></i> Confirm Action</h3>
                <button class="modal-close" id="close-confirm-modal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-message">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-confirm" type="button"><i class="fas fa-times"></i> Cancel</button>
                <button class="btn btn-danger" id="confirm-action" type="button"><i class="fas fa-check"></i> Confirm</button>
            </div>
        </div>
    </div>

    <div class="notification hidden" id="notification">
        <span id="notification-message">Success!</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc,
            query, where, serverTimestamp, orderBy, limit // Added limit
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo", // KEEP YOUR KEY SECRET
            authDomain: "pharma-quiz-b5a07.firebaseapp.com",
            projectId: "pharma-quiz-b5a07",
            storageBucket: "pharma-quiz-b5a07.appspot.com",
            messagingSenderId: "161067776789",
            appId: "1:161067776789:web:88b8a61145dc5f5c31471c",
            measurementId: "G-3QRQE9HQFB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const mainContent = document.getElementById('main-content');
        const pageSectionTitle = document.getElementById('page-section-title');
        const userNameDisplay = document.getElementById('user-name-display');
        const userRoleBadge = document.getElementById('user-role-badge');
        const logoutBtn = document.getElementById('logout-btn');
        const accountDropdownLinks = document.querySelectorAll('#account-dropdown a[data-section]');

        // Sections
        const sections = {
            dashboard: document.getElementById('dashboard-section'),
            courses: document.getElementById('courses-section'),
            users: document.getElementById('users-section'),
            enrollments: document.getElementById('enrollments-section')
        };

        // Navigation
        const adminNavItems = document.querySelectorAll('.admin-nav-item');
        const dashboardActionLinks = document.querySelectorAll('.action-button.admin-nav-trigger');

        // Dashboard Elements
        const recentEnrollmentsTableBody = document.getElementById('recent-enrollments-table').querySelector('tbody');
        const totalUsersEl = document.getElementById('total-users');
        const totalCoursesEl = document.getElementById('total-courses');
        const totalEnrollmentsEl = document.getElementById('total-enrollments');
        const overflowUsersEl = document.getElementById('overflow-users');

        // Courses Elements
        const coursesTableBody = document.getElementById('courses-table').querySelector('tbody');
        const addCourseBtn = document.getElementById('add-course-btn');
        const courseTypeFilter = document.getElementById('course-type-filter');
        const courseLanguageFilter = document.getElementById('course-language-filter');

        // Users Elements
        const usersTableBody = document.getElementById('users-table').querySelector('tbody');

        // Enrollments Elements
        const enrollmentsTableBody = document.getElementById('enrollments-table').querySelector('tbody');

        // Modals & Forms
        const courseModal = document.getElementById('course-modal');
        const courseModalTitle = document.getElementById('course-modal-title');
        const courseForm = document.getElementById('course-form');
        const courseIdInput = document.getElementById('course-id');
        const courseTitleInput = document.getElementById('course-title');
        const courseTypeInput = document.getElementById('course-type');
        const courseLanguageInput = document.getElementById('course-language');
        const courseDescriptionInput = document.getElementById('course-description');
        const saveCourseBtn = document.getElementById('save-course');
        const cancelCourseBtn = document.getElementById('cancel-course');
        const closeCourseModalBtn = document.getElementById('close-course-modal');
        const courseTypeList = document.getElementById('course-type-list');
        const courseLanguageList = document.getElementById('course-language-list');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const cancelConfirmBtn = document.getElementById('cancel-confirm');
        const confirmActionBtn = document.getElementById('confirm-action');
        const closeConfirmModalBtn = document.getElementById('close-confirm-modal');

        // Notification
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');

        // --- App State ---
        let currentUser = null;
        let userData = null;
        let allUsers = [];
        let allCourses = [];
        let allEnrollments = []; // Processed enrollments with details
        let overflowUsersCount = 0;
        let pendingAction = null;
        let isAdmin = false; // Track admin role specifically

        // --- Initialization ---
        function initApp() {
            setupEventListeners();
            checkAuthState();
        }

        function setupEventListeners() {
            // Main Navigation (Top Bar)
            adminNavItems.forEach(item => {
                item.addEventListener('click', () => switchSection(item.getAttribute('data-section')));
            });

            // Account Dropdown Navigation
             accountDropdownLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchSection(link.getAttribute('data-section'));
                     // Optional: close dropdown after click
                    document.getElementById('account-dropdown').style.display = 'none';
                    setTimeout(() => document.getElementById('account-dropdown').style.display = '', 50); // Allow hover to work again
                });
            });

             // Dashboard Action Button Navigation
            dashboardActionLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchSection(link.getAttribute('data-section'));
                });
            });

            // Logout
            logoutBtn.addEventListener('click', handleLogout);

            // Course Modal
            addCourseBtn?.addEventListener('click', openAddCourseModal);
            saveCourseBtn.addEventListener('click', saveCourse);
            cancelCourseBtn.addEventListener('click', () => closeCourseModal());
            closeCourseModalBtn.addEventListener('click', () => closeCourseModal());

            // Confirm Modal
            cancelConfirmBtn.addEventListener('click', () => closeConfirmModal());
            confirmActionBtn.addEventListener('click', executePendingAction);
            closeConfirmModalBtn.addEventListener('click', () => closeConfirmModal());

            // Course Filters
            courseTypeFilter?.addEventListener('change', filterAndDisplayCourses);
            courseLanguageFilter?.addEventListener('change', filterAndDisplayCourses);

            // Dynamic listeners for table actions (using event delegation)
             coursesTableBody.addEventListener('click', handleCourseTableAction);
             // Add similar listeners for usersTableBody and enrollmentsTableBody when actions are implemented
        }

        function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    showLoadingState('user'); // Indicate user data loading
                    await loadUserData(user.uid);

                    if (!userData || (userData.role !== 'moderator' && userData.role !== 'admin')) {
                        showNotification('Access Denied. You do not have permission to view this page.', 'error', 5000);
                        await handleLogout(); // Log out unauthorized user
                        window.location.href = 'login.html?reason=unauthorized'; // Redirect
                        return;
                    }

                    isAdmin = userData.role === 'admin'; // Set specific admin flag
                    updateHeaderUI();

                    // Load all necessary data for the admin panel
                    await loadAllData();
                    populateDatalists(); // Populate suggestion lists after loading courses
                    switchSection('dashboard'); // Start on dashboard

                } else {
                    // No user logged in, redirect to login
                    window.location.href = 'login.html?reason=not_logged_in';
                }
            });
        }

        // --- UI Update Functions ---

        function updateHeaderUI() {
            userNameDisplay.textContent = userData?.name || currentUser?.displayName || "User";
            userRoleBadge.textContent = userData?.role || 'Unknown';
            userRoleBadge.textContent = userRoleBadge.textContent.toUpperCase();
        }

        function switchSection(sectionId) {
            if (!sectionId || !sections[sectionId]) {
                console.warn(`Invalid section ID: ${sectionId}. Defaulting to dashboard.`);
                sectionId = 'dashboard';
            }

            // Hide all sections
            Object.values(sections).forEach(section => section.classList.add('hidden'));

            // Show the target section
            sections[sectionId].classList.remove('hidden');

            // Update active state in navigation
            adminNavItems.forEach(item => {
                item.classList.toggle('active', item.getAttribute('data-section') === sectionId);
            });

            // Update header title
            const sectionName = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
            pageSectionTitle.textContent = sectionName; // Update dynamic title

            // Potentially load or refresh data specific to the section if needed
            // Example: if (sectionId === 'users' && !usersLoaded) loadUsers();
        }

        function showLoadingState(type = 'table', tableBody = null) {
            const spinnerHtml = '<div class="spinner"></div>';
            const loadingRowHtml = `<tr><td colspan="100%" class="loading-state">${spinnerHtml}</td></tr>`; // Colspan 100% covers all columns

             if (type === 'user') {
                userNameDisplay.textContent = 'Loading...';
            } else if (type === 'stats') {
                 totalUsersEl.innerHTML = `<span class="loading-text">${spinnerHtml}</span>`;
                 totalCoursesEl.innerHTML = `<span class="loading-text">${spinnerHtml}</span>`;
                 totalEnrollmentsEl.innerHTML = `<span class="loading-text">${spinnerHtml}</span>`;
                 overflowUsersEl.innerHTML = `<span class="loading-text">${spinnerHtml}</span>`;
            } else if (type === 'table' && tableBody) {
                tableBody.innerHTML = loadingRowHtml;
            }
        }

         function showEmptyState(tableBody, message = "No data found.", iconClass = "fa-folder-open", colspan = 5) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="${colspan}" class="empty-state">
                        <i class="fas ${iconClass}"></i>
                        <p>${message}</p>
                    </td>
                </tr>`;
        }

        function showNotification(message, type = 'success', duration = 3000) {
            notification.className = `notification notification-${type}`; // Base + type class
            notificationMessage.textContent = message;

            // Add appropriate icon
            const icon = notification.querySelector('i');
            if (icon) icon.remove(); // Remove previous icon if any
            const newIcon = document.createElement('i');
            newIcon.className = `fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}`;
            notification.prepend(newIcon);

            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('show');
            }, 10); // Small delay to allow transition

            setTimeout(() => {
                notification.classList.remove('show');
                // Wait for transition to finish before hiding completely
                setTimeout(() => notification.classList.add('hidden'), 400);
            }, duration);
        }


        // --- Data Loading and Processing ---

        async function loadUserData(userId) {
            try {
                const userDocRef = doc(db, "users", userId);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    userData = userDocSnap.data();
                } else {
                    console.warn("User document not found in Firestore for UID:", userId);
                    userData = null; // Explicitly set to null if not found
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showNotification('Error loading your user data. Please refresh.', 'error');
                userData = null;
            }
        }

        async function loadAllData() {
            console.log("Loading all admin data...");
            showLoadingState('stats');
            showLoadingState('table', recentEnrollmentsTableBody);
            showLoadingState('table', coursesTableBody);
            showLoadingState('table', usersTableBody);
            showLoadingState('table', enrollmentsTableBody);

            try {
                // Parallel fetching (faster)
                const [usersSnapshot, coursesSnapshot] = await Promise.all([
                    getDocs(query(collection(db, "users"), orderBy("name"))),
                    getDocs(query(collection(db, "courses"), orderBy("title")))
                ]);

                // Process Users
                allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Process Courses
                allCourses = coursesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateCourseFilters(); // Populate filters once courses are loaded

                // Process Enrollments and Calculate Overflow
                processEnrollmentsAndOverflow();

                // Update UI
                updateStats();
                displayRecentEnrollments(); // Display top 3
                filterAndDisplayCourses(); // Initial display of courses
                displayUsers();
                displayAllEnrollments();

                console.log("Admin data loaded successfully.");

            } catch (error) {
                console.error("Error loading all data:", error);
                showNotification('Failed to load administrative data. Please refresh the page.', 'error', 5000);
                // Show error in tables as well
                 showEmptyState(recentEnrollmentsTableBody, "Error loading data.", "fa-exclamation-triangle", 5);
                 showEmptyState(coursesTableBody, "Error loading data.", "fa-exclamation-triangle", 5);
                 showEmptyState(usersTableBody, "Error loading data.", "fa-exclamation-triangle", 6);
                 showEmptyState(enrollmentsTableBody, "Error loading data.", "fa-exclamation-triangle", 6);
            }
        }

        function processEnrollmentsAndOverflow() {
            allEnrollments = [];
            overflowUsersCount = 0;
            const tempOverflowUsers = new Set(); // Use a Set to count unique users easily

            allUsers.forEach(user => {
                if (user.enrolledCourses && Array.isArray(user.enrolledCourses) && user.enrolledCourses.length > 0) {
                    const isOverflowUser = user.enrolledCourses.length > 3;
                    if (isOverflowUser) {
                        tempOverflowUsers.add(user.id);
                    }

                    user.enrolledCourses.forEach((enrollment, index) => {
                        const courseDetails = allCourses.find(c => c.id === enrollment.id) || {};
                        allEnrollments.push({
                            userId: user.id,
                            userName: user.name || "Unknown User",
                            userEmail: user.email,
                            userDepartment: user.department || "N/A",
                            courseId: enrollment.id,
                            courseTitle: courseDetails.title || enrollment.title || "Unknown Course",
                            courseType: courseDetails.type || enrollment.type || "N/A",
                            courseLanguage: courseDetails.language || enrollment.language || "N/A",
                            enrollmentDate: enrollment.enrollmentDate?.toDate ? enrollment.enrollmentDate.toDate() : (enrollment.enrollmentDate ? new Date(enrollment.enrollmentDate) : null), // Handle Timestamps and strings
                            isOverflow: index >= 3, // Mark enrollments beyond the 3rd as overflow
                            verification: enrollment.overflow || null // Include verification status if present
                        });
                    });
                }
            });

             // Sort all enrollments by date (newest first) after processing
            allEnrollments.sort((a, b) => (b.enrollmentDate || 0) - (a.enrollmentDate || 0));

            overflowUsersCount = tempOverflowUsers.size;
        }

        function updateStats() {
            totalUsersEl.textContent = allUsers.length;
            totalCoursesEl.textContent = allCourses.length;
            totalEnrollmentsEl.textContent = allEnrollments.filter(e => !e.isOverflow).length; // Count only non-overflow as "active"? Or maybe total? Let's do total for now.
             totalEnrollmentsEl.textContent = allEnrollments.length; // Count all enrollments
            overflowUsersEl.textContent = overflowUsersCount;
        }

        // --- Display Functions ---

        function displayRecentEnrollments() {
            const recent = allEnrollments.slice(0, 3); // Get only the top 3

            if (recent.length === 0) {
                showEmptyState(recentEnrollmentsTableBody, "No recent enrollments found.", "fa-history", 5);
                return;
            }

            recentEnrollmentsTableBody.innerHTML = recent.map(enrollment => `
                <tr>
                    <td>
                        <div class="user-info">
                            <strong>${enrollment.userName}</strong>
                            <small>${enrollment.userEmail}</small>
                        </div>
                    </td>
                    <td>${enrollment.courseTitle}</td>
                    <td><span class="badge ${getTypeBadgeClass(enrollment.courseType)}">${enrollment.courseType || 'N/A'}</span></td>
                    <td>${enrollment.courseLanguage || 'N/A'}</td>
                    <td>${formatDate(enrollment.enrollmentDate)}</td>
                </tr>
            `).join('');
        }

        function filterAndDisplayCourses() {
             const typeFilter = courseTypeFilter.value?.toLowerCase();
             const languageFilter = courseLanguageFilter.value?.toLowerCase();

             const filteredCourses = allCourses.filter(course => {
                 const typeMatch = typeFilter === 'all' || course.type?.toLowerCase() === typeFilter;
                 const languageMatch = languageFilter === 'all' || course.language?.toLowerCase() === languageFilter;
                 return typeMatch && languageMatch;
             });

             displayCourses(filteredCourses);
        }

        function displayCourses(coursesToDisplay) {
            if (coursesToDisplay.length === 0) {
                if (courseTypeFilter.value === 'all' && courseLanguageFilter.value === 'all') {
                     showEmptyState(coursesTableBody, "No courses created yet.", "fa-book", 5);
                } else {
                     showEmptyState(coursesTableBody, "No courses match the current filters.", "fa-filter", 5);
                }
                return;
            }

            coursesTableBody.innerHTML = coursesToDisplay.map(course => {
                const enrollmentCount = allEnrollments.filter(e => e.courseId === course.id).length;
                return `
                    <tr data-course-id="${course.id}">
                        <td>
                            <strong>${course.title}</strong>
                            ${course.description ? `<small class="text-muted" style="display: block; margin-top: 4px;">${escapeHtml(course.description)}</small>` : ''}
                        </td>
                        <td><span class="badge ${getTypeBadgeClass(course.type)}">${course.type || 'N/A'}</span></td>
                        <td>${course.language || 'N/A'}</td>
                        <td>
                            <span class="badge ${enrollmentCount > 0 ? 'badge-secondary' : 'badge-light'}">
                                ${enrollmentCount}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-outline" data-action="edit-course" data-id="${course.id}" title="Edit Course">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" data-action="delete-course" data-id="${course.id}" title="Delete Course" ${!isAdmin ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function displayUsers() {
             if (allUsers.length === 0) {
                showEmptyState(usersTableBody, "No users found in the system.", "fa-users-slash", 6);
                return;
            }

             usersTableBody.innerHTML = allUsers.map(user => {
                 const enrolledCount = user.enrolledCourses?.length || 0;
                 return `
                    <tr data-user-id="${user.id}">
                        <td>
                             <div class="user-info">
                                <strong>${user.name || 'No Name'}</strong>
                                <small>${user.id}</small> </div>
                        </td>
                        <td>${user.email || 'No Email'}</td>
                         <td><span class="badge ${user.role === 'admin' ? 'badge-danger' : (user.role === 'moderator' ? 'badge-warning' : 'badge-light')}">${user.role || 'user'}</span></td>
                        <td>${user.department || 'N/A'}</td>
                        <td><span class="badge badge-secondary">${enrolledCount}</span></td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-outline" disabled title="Edit User (Not Implemented)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" disabled title="Delete User (Not Implemented)" ${!isAdmin ? 'disabled' : ''}>
                                    <i class="fas fa-user-slash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                 `;
             }).join('');
        }

        function displayAllEnrollments() {
            if (allEnrollments.length === 0) {
                showEmptyState(enrollmentsTableBody, "No enrollments recorded yet.", "fa-clipboard", 6);
                return;
            }

             enrollmentsTableBody.innerHTML = allEnrollments.map(enrollment => {
                 const statusBadge = enrollment.isOverflow
                    ? `<span class="badge badge-warning">Overflow ${enrollment.verification ? `(${enrollment.verification})` : ''}</span>`
                    : `<span class="badge badge-success">Active</span>`;

                 return `
                    <tr data-enrollment-id="${enrollment.userId}-${enrollment.courseId}"> <td>
                            <div class="user-info">
                                <strong>${enrollment.userName}</strong>
                                <small>${enrollment.userEmail}</small>
                            </div>
                        </td>
                        <td>${enrollment.courseTitle}</td>
                        <td><span class="badge ${getTypeBadgeClass(enrollment.courseType)}">${enrollment.courseType || 'N/A'}</span></td>
                        <td>${enrollment.courseLanguage || 'N/A'}</td>
                        <td>${formatDate(enrollment.enrollmentDate)}</td>
                        <td>${statusBadge}</td>
                         </tr>
                 `;
             }).join('');
        }

         function populateCourseFilters() {
            const types = new Set(allCourses.map(c => c.type).filter(Boolean));
            const languages = new Set(allCourses.map(c => c.language).filter(Boolean));

            courseTypeFilter.innerHTML = '<option value="all">All Types</option>';
            types.forEach(type => courseTypeFilter.add(new Option(type, type)));

            courseLanguageFilter.innerHTML = '<option value="all">All Languages</option>';
            languages.forEach(lang => courseLanguageFilter.add(new Option(lang, lang)));
        }

         function populateDatalists() {
             const types = new Set(allCourses.map(c => c.type).filter(Boolean));
             const languages = new Set(allCourses.map(c => c.language).filter(Boolean));

             // Add predefined options first if they aren't already in the set
             ['Qirat', 'Hifz', 'Nezer'].forEach(t => types.add(t));
             ['Amharic', 'Oromifa', 'Arabic', 'English'].forEach(l => languages.add(l));

             courseTypeList.innerHTML = '';
             types.forEach(type => courseTypeList.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(type)}">`));

             courseLanguageList.innerHTML = '';
             languages.forEach(lang => courseLanguageList.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(lang)}">`));
         }


        // --- Course Management ---

        function openAddCourseModal() {
            courseModalTitle.innerHTML = '<i class="fas fa-plus-circle"></i> Add New Course';
            courseForm.reset();
            courseIdInput.value = ''; // Ensure ID is cleared
            courseModal.classList.add('active');
             // Populate datalists in case new types/langs were added since last load
             populateDatalists();
        }

        function openEditCourseModal(courseId) {
            const course = allCourses.find(c => c.id === courseId);
            if (!course) {
                showNotification('Course not found.', 'error');
                return;
            }

            courseModalTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Course';
            courseForm.reset(); // Reset first
            courseIdInput.value = course.id;
            courseTitleInput.value = course.title;
            courseTypeInput.value = course.type || '';
            courseLanguageInput.value = course.language || '';
            courseDescriptionInput.value = course.description || '';

            courseModal.classList.add('active');
             // Populate datalists in case new types/langs were added since last load
             populateDatalists();
        }

        function closeCourseModal() {
            courseModal.classList.remove('active');
            courseForm.reset();
            courseIdInput.value = '';
        }

        async function saveCourse() {
            const id = courseIdInput.value; // Will be empty for new courses
            const title = courseTitleInput.value.trim();
            const type = courseTypeInput.value.trim(); // Trim custom inputs
            const language = courseLanguageInput.value.trim(); // Trim custom inputs
            const description = courseDescriptionInput.value.trim();

            if (!title || !type || !language) {
                showNotification('Please fill in Title, Type, and Language.', 'error');
                return;
            }

             // Show saving indicator on button? (Optional)
             saveCourseBtn.disabled = true;
             saveCourseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';


            try {
                const courseRef = id ? doc(db, "courses", id) : doc(collection(db, "courses")); // Get ref for new or existing

                const courseData = {
                    title: title,
                    type: type,
                    language: language,
                    description: description || null, // Store null if empty
                    updatedAt: serverTimestamp(),
                    // Add createdAt only if it's a new course
                    ...( !id && { createdAt: serverTimestamp() } )
                     // Add createdBy/updatedBy if needed:
                     // createdBy: currentUser.uid,
                     // updatedBy: currentUser.uid
                };

                if (id) {
                    await updateDoc(courseRef, courseData);
                    showNotification(`Course "${title}" updated successfully.`, 'success');
                } else {
                    await setDoc(courseRef, courseData);
                    showNotification(`Course "${title}" created successfully.`, 'success');
                }

                closeCourseModal();
                await loadAllData(); // Reload all data to reflect the change everywhere

            } catch (error) {
                console.error("Error saving course:", error);
                showNotification(`Failed to save course: ${error.message}`, 'error');
            } finally {
                 // Reset button state
                 saveCourseBtn.disabled = false;
                 saveCourseBtn.innerHTML = '<i class="fas fa-save"></i> Save Course';
            }
        }

        function confirmDeleteCourse(courseId) {
            if (!isAdmin) {
                showNotification('Only Admins can delete courses.', 'error');
                return;
            }
            const course = allCourses.find(c => c.id === courseId);
            if (!course) return;

             // Check if course has enrollments BEFORE showing confirmation
             const enrollmentCount = allEnrollments.filter(e => e.courseId === courseId).length;
             if (enrollmentCount > 0) {
                 showNotification(`Cannot delete "${course.title}". It has ${enrollmentCount} enrollment(s). Remove enrollments first.`, 'error', 5000);
                 return;
             }


            pendingAction = {
                type: 'delete-course',
                payload: { courseId: courseId, courseTitle: course.title }
            };

            confirmTitle.innerHTML = '<i class="fas fa-trash text-danger"></i> Delete Course';
            confirmMessage.innerHTML = `Are you sure you want to permanently delete the course: <strong>"${escapeHtml(course.title)}"</strong>?<br><br>This action cannot be undone.`;
            confirmModal.classList.add('active');
            // Focus the confirm button for accessibility
            confirmActionBtn.focus();
        }

        async function deleteCourse(courseId) {
            console.log(`Attempting to delete course: ${courseId}`);
             // Double-check enrollments (though checked before modal)
             const enrollmentCount = allEnrollments.filter(e => e.courseId === courseId).length;
             if (enrollmentCount > 0) {
                  showNotification(`Deletion cancelled. Course still has ${enrollmentCount} enrollments.`, 'error', 5000);
                  return; // Prevent deletion if enrollments exist
             }

             // Show deleting indicator (Optional)
             confirmActionBtn.disabled = true;
             confirmActionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

            try {
                await deleteDoc(doc(db, "courses", courseId));
                showNotification('Course deleted successfully.', 'success');
                await loadAllData(); // Reload data

            } catch (error) {
                console.error("Error deleting course:", error);
                showNotification(`Failed to delete course: ${error.message}`, 'error');
            } finally {
                closeConfirmModal();
                // Reset button state
                confirmActionBtn.disabled = false;
                confirmActionBtn.innerHTML = '<i class="fas fa-check"></i> Confirm';
            }
        }

        function handleCourseTableAction(event) {
             const button = event.target.closest('button[data-action]');
             if (!button) return;

             const action = button.dataset.action;
             const id = button.dataset.id;

             if (action === 'edit-course') {
                 openEditCourseModal(id);
             } else if (action === 'delete-course') {
                 confirmDeleteCourse(id);
             }
        }


        // --- Confirmation Modal Logic ---
        function closeConfirmModal() {
            confirmModal.classList.remove('active');
            pendingAction = null; // Clear pending action
        }

        function executePendingAction() {
            if (!pendingAction || !pendingAction.type) return;

            console.log("Executing pending action:", pendingAction.type);

            switch (pendingAction.type) {
                case 'delete-course':
                    deleteCourse(pendingAction.payload.courseId);
                    break;
                // Add cases for other confirmable actions (e.g., delete user) here
                default:
                    console.warn('Unknown pending action type:', pendingAction.type);
            }
            // The action function itself should call closeConfirmModal on success/error
            // But we clear pendingAction here regardless
            // pendingAction = null; // Clearing is now done inside closeConfirmModal or the action
        }

        // --- Authentication ---
        async function handleLogout(event) {
            if(event) event.preventDefault(); // Prevent default link behavior if called from link
            console.log("Logging out...");
            try {
                await signOut(auth);
                // Redirect is handled by onAuthStateChanged listener
                // window.location.href = 'login.html?reason=logged_out';
            } catch (error) {
                console.error("Error signing out:", error);
                showNotification('Error signing out. Please try again.', 'error');
            }
        }

        // --- Utility Functions ---
        function getTypeBadgeClass(type) {
            const typeLower = type?.toLowerCase() || '';
            switch (typeLower) {
                case 'qirat': return 'badge-info';
                case 'hifz': return 'badge-primary'; // Changed Hifz to primary style
                case 'nezer': return 'badge-warning';
                default: return 'badge-secondary'; // Default for custom or unknown
            }
        }

        function formatDate(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return 'Unknown';
            }
            try {
                // More concise format: Jan 15, 2024
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            } catch (e) {
                console.warn("Error formatting date:", date, e);
                return 'Invalid Date';
            }
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Global Access & Init ---
        // Make functions accessible from inline HTML onclick if needed (though delegated listeners are preferred)
        // window.editCourse = openEditCourseModal; // No longer needed with delegation
        // window.confirmDeleteCourse = confirmDeleteCourse; // No longer needed with delegation

        // Start the application once the DOM is ready
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
