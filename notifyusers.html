<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Haramaya Jama'aa</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    /* ====== CORE STRUCTURE & RESETS ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
      color: #333;
      min-height: 100vh;
      overflow-x: hidden;
      padding-top: 70px;
      display: flex;
      flex-direction: column;
      position: relative;
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      transition: background 0.5s ease, color 0.5s ease;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    main {
        flex-grow: 1;
    }

    a {
      text-decoration: none;
      color: inherit;
      transition: color 0.3s ease;
    }

    /* ====== ENHANCED HEADER ====== */
    header {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.7rem 1.5rem;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 300;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.07);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }

    .header-title-area {
        flex-grow: 1;
        text-align: center;
        margin: 0 1rem;
    }

    .header-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #2c3e50;
      letter-spacing: 0.5px;
      display: inline-block;
    }

    /* ====== ACCOUNT DROPDOWN ====== */
    .account-wrapper {
      position: relative;
      cursor: pointer;
      flex-shrink: 0;
    }

    .account-icon {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #fff;
    }

    .account-icon:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(102, 166, 255, 0.4);
    }

    .account-dropdown {
      position: absolute;
      top: 58px;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 10px;
      overflow: hidden;
      display: none;
      z-index: 400;
      box-shadow: 0 10px 35px rgba(0,0,0,0.12);
      min-width: 240px;
      animation: fadeInDropdown 0.25s ease-out;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(0,0,0,0.07);
      transform-origin: top right;
    }

    @keyframes fadeInDropdown {
      from { opacity: 0; transform: translateY(-10px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .account-dropdown a,
    .account-dropdown div {
      color: #444;
      padding: 0.9rem 1.3rem;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      transition: background-color 0.2s ease, color 0.2s ease, padding-left 0.2s ease;
      font-weight: 500;
      font-size: 0.95rem;
    }

    #user-role-display {
      font-size: 0.85em;
      color: #5a67d8;
      font-weight: bold;
      background-color: rgba(90, 103, 216, 0.05);
      border-bottom: 1px solid rgba(90, 103, 216, 0.1);
      order: -1;
    }
    #user-role-display i { color: #5a67d8; }

    #admin-panel-link {
        color: #d53f8c;
        font-weight: 600;
    }
     #admin-panel-link i {
        color: #d53f8c;
     }
     #admin-panel-link:hover {
         background-color: rgba(213, 63, 140, 0.06);
         color: #b83280;
     }
     #admin-panel-link:hover i {
         color: #b83280;
     }

    .account-dropdown a:last-child,
    .account-dropdown div:last-child { border-bottom: none; }

    .account-dropdown a:hover,
    .account-dropdown div:not(#user-role-display):not(#admin-panel-link):hover {
      background: rgba(102, 166, 255, 0.1);
      padding-left: 1.6rem;
      color: #3b82f6;
    }

    .account-dropdown i {
      width: 18px;
      color: #60a5fa;
      text-align: center;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .account-dropdown a:hover i,
    .account-dropdown div:not(#user-role-display):not(#admin-panel-link):hover i {
        color: #3b82f6;
    }

    /* ====== ADMIN CONTENT AREA ====== */
    .admin-container {
      display: flex;
      min-height: calc(100vh - 70px);
    }

    .admin-sidebar {
      width: 250px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-right: 1px solid rgba(0, 0, 0, 0.05);
      padding: 1.5rem 0;
      position: fixed;
      height: calc(100vh - 70px);
      z-index: 200;
      transition: all 0.3s ease;
    }

    .admin-main {
      flex: 1;
      margin-left: 250px;
      padding: 2rem;
    }

    .admin-section {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .admin-section h2 {
      color: #2c3e50;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      border-bottom: 2px solid #e0e7ff;
      padding-bottom: 0.5rem;
    }

    .admin-section h3 {
      color: #3b82f6;
      margin: 1.5rem 0 1rem;
      font-size: 1.2rem;
    }

    /* Sidebar Navigation */
    .admin-nav {
      list-style: none;
    }

    .admin-nav li {
      margin-bottom: 0.5rem;
    }

    .admin-nav a {
      display: flex;
      align-items: center;
      padding: 0.8rem 1.5rem;
      color: #4a5568;
      transition: all 0.2s ease;
    }

    .admin-nav a:hover {
      background: rgba(102, 166, 255, 0.1);
      color: #3b82f6;
    }

    .admin-nav a i {
      width: 24px;
      margin-right: 0.8rem;
      text-align: center;
    }

    .admin-nav a.active {
      background: rgba(102, 166, 255, 0.2);
      color: #3b82f6;
      border-left: 3px solid #3b82f6;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #4a5568;
    }

    .form-control {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.2s ease;
      background: #f8fafc;
    }

    .form-control:focus {
      outline: none;
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.3);
      background: white;
    }

    textarea.form-control {
      min-height: 120px;
      resize: vertical;
    }

    .select2-container {
      width: 100% !important;
    }

    .select2-selection {
      padding: 0.8rem 1rem !important;
      height: auto !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 8px !important;
      background: #f8fafc !important;
    }

    .select2-selection:focus {
      outline: none;
      border-color: #93c5fd !important;
      box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.3) !important;
      background: white !important;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-size: 1rem;
    }

    .btn i {
      margin-right: 0.5rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* Table Styles */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
    }

    .admin-table th,
    .admin-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .admin-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #4a5568;
    }

    .admin-table tr:hover {
      background: #f8fafc;
    }

    .table-actions {
      display: flex;
      gap: 0.5rem;
    }

    .table-actions .btn {
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
    }

    /* Tabs */
    .admin-tabs {
      display: flex;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 1.5rem;
    }

    .admin-tab {
      padding: 0.8rem 1.5rem;
      cursor: pointer;
      color: #64748b;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .admin-tab:hover {
      color: #3b82f6;
    }

    .admin-tab.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Floating particles decoration */
    .particle {
      position: fixed;
      background: rgba(102, 166, 255, 0.15);
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
      animation: particleFloat 25s linear infinite;
    }

    @keyframes particleFloat {
        0% { transform: translateY(105vh) scale(0.5) rotate(0deg); opacity: 0; }
        50% { opacity: 0.8; }
        100% { transform: translateY(-100px) scale(1.2) rotate(720deg); opacity: 0; }
    }

    /* ====== FOOTER ====== */
     footer {
        background-color: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 1.5rem 2rem;
        text-align: center;
        font-size: 0.9rem;
        color: #4a5568;
        margin-top: 3rem;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        z-index: 10;
        position: relative;
     }
     footer a {
         color: #3b82f6;
         font-weight: 500;
     }
      footer a:hover {
         text-decoration: underline;
      }

    /* ====== FLOATING LOGO ====== */
     .floating-logo {
         position: fixed;
         bottom: 20px;
         left: 20px;
         z-index: 500;
         background-color: rgba(255, 255, 255, 0.8);
         backdrop-filter: blur(10px);
         -webkit-backdrop-filter: blur(10px);
         padding: 10px;
         border-radius: 50%;
         box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
         transition: transform 0.3s ease, box-shadow 0.3s ease;
         display: flex;
         align-items: center;
         justify-content: center;
     }
      .floating-logo img {
          display: block;
          max-height: 45px;
          width: auto;
          border-radius: 50%;
      }
      .floating-logo:hover {
          transform: scale(1.1);
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }

    /* ====== UTILITIES & THEME TOGGLE ====== */
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1 0%, #a78bfa 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      z-index: 500;
      transition: all 0.3s ease;
      border: none;
    }
    .theme-toggle:hover {
      transform: scale(1.1) rotate(10deg);
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
    }

    /* Loading animation */
    .loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
     body.dark .loading {
         background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
     }
    .loading-circle {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(0, 0, 0, 0.2);
      border-radius: 50%;
      border-top-color: #66a6ff;
      animation: spin 1s ease-in-out infinite;
    }
     body.dark .loading-circle {
         border: 5px solid rgba(255, 255, 255, 0.2);
         border-top-color: #a78bfa;
     }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ====== DARK THEME STYLES ====== */
    body.dark {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      animation-name: gradientBGDark;
    }

     @keyframes gradientBGDark {
        0% { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        50% { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        100% { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    }

    body.dark header {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: #e2e8f0;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    body.dark .header-title {
         color: #f1f5f9;
    }
    body.dark .account-icon {
        background: linear-gradient(135deg, #475569 0%, #334155 100%);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }
     body.dark .account-icon:hover {
          box-shadow: 0 5px 15px rgba(71, 85, 105, 0.4);
     }
    body.dark .account-dropdown {
      background: rgba(30, 41, 59, 0.98);
      color: #e2e8f0;
      border: 1px solid rgba(255, 255, 255, 0.1);
       box-shadow: 0 10px 35px rgba(0,0,0,0.2);
    }
    body.dark .account-dropdown a,
    body.dark .account-dropdown div {
      color: #e2e8f0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
     body.dark #user-role-display {
        color: #a78bfa;
        background-color: rgba(167, 139, 250, 0.08);
        border-bottom: 1px solid rgba(167, 139, 250, 0.1);
    }
    body.dark #user-role-display i { color: #a78bfa; }

     body.dark #admin-panel-link {
        color: #f472b6;
        font-weight: 600;
     }
      body.dark #admin-panel-link i { color: #f472b6; }
      body.dark #admin-panel-link:hover {
         background-color: rgba(244, 114, 182, 0.08);
         color: #ec4899;
      }
       body.dark #admin-panel-link:hover i { color: #ec4899; }

    body.dark .account-dropdown a:hover,
    body.dark .account-dropdown div:not(#user-role-display):not(#admin-panel-link):hover {
      color: #93c5fd;
      background: rgba(255, 255, 255, 0.04);
    }
    body.dark .account-dropdown i { color: #93c5fd; }
    body.dark .account-dropdown a:hover i,
    body.dark .account-dropdown div:not(#user-role-display):not(#admin-panel-link):hover i {
         color: #93c5fd;
    }

    body.dark .admin-sidebar {
      background: rgba(15, 23, 42, 0.8);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark .admin-nav a {
      color: #94a3b8;
    }

    body.dark .admin-nav a:hover {
      color: #93c5fd;
      background: rgba(255, 255, 255, 0.05);
    }

    body.dark .admin-nav a.active {
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
      border-left-color: #93c5fd;
    }

    body.dark .admin-section {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    body.dark .admin-section h2 {
      color: #f1f5f9;
      border-bottom-color: rgba(147, 197, 253, 0.2);
    }

    body.dark .admin-section h3 {
      color: #93c5fd;
    }

    body.dark .form-label {
      color: #cbd5e1;
    }

    body.dark .form-control {
      background: #1e293b;
      border-color: #334155;
      color: #e2e8f0;
    }

    body.dark .form-control:focus {
      background: #1e293b;
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.2);
    }

    body.dark .select2-selection {
      background: #1e293b !important;
      border-color: #334155 !important;
      color: #e2e8f0 !important;
    }

    body.dark .select2-selection:focus {
      background: #1e293b !important;
      border-color: #93c5fd !important;
    }

    body.dark .admin-table th,
    body.dark .admin-table td {
      border-bottom-color: #334155;
    }

    body.dark .admin-table th {
      background: #1e293b;
      color: #cbd5e1;
    }

    body.dark .admin-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    body.dark .admin-tabs {
      border-bottom-color: #334155;
    }

    body.dark .admin-tab {
      color: #94a3b8;
    }

    body.dark .admin-tab:hover {
      color: #93c5fd;
    }

    body.dark .admin-tab.active {
      color: #93c5fd;
      border-bottom-color: #93c5fd;
    }

    body.dark footer {
        background-color: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        color: #94a3b8;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
     body.dark footer a { color: #93c5fd; }

     body.dark .floating-logo {
         background-color: rgba(30, 41, 59, 0.8);
         backdrop-filter: blur(10px);
         -webkit-backdrop-filter: blur(10px);
         box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
     }
      body.dark .floating-logo:hover {
         box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      }

     body.dark .theme-toggle {
         background: linear-gradient(135deg, #475569 0%, #334155 100%);
         box-shadow: 0 5px 15px rgba(0,0,0,0.3);
     }
     body.dark .theme-toggle:hover {
          box-shadow: 0 8px 20px rgba(0,0,0,0.4);
     }

    /* ====== RESPONSIVENESS ====== */
    @media (max-width: 992px) {
      .admin-sidebar {
        transform: translateX(-100%);
      }
      .admin-sidebar.show {
        transform: translateX(0);
      }
      .admin-main {
        margin-left: 0;
      }
      .sidebar-toggle {
        display: block;
      }
    }

    @media (max-width: 768px) {
      body { padding-top: 60px; }
      header { padding: 0.6rem 1rem; }
      .header-title-area { margin: 0 0.5rem; }
      .header-title { font-size: 1.2rem; }

      .account-icon { width: 38px; height: 38px; font-size: 1.4rem; }
      .account-dropdown { top: 52px; min-width: 220px; }

      .admin-main { padding: 1rem; }
      .admin-section { padding: 1.5rem; }

      footer { padding: 1rem 1.5rem; font-size: 0.85rem; margin-top: 2rem; }
      .floating-logo { bottom: 15px; left: 15px; padding: 8px; }
      .floating-logo img { max-height: 35px; }
      .theme-toggle { bottom: 15px; right: 15px; width: 40px; height: 40px; font-size: 1rem; }
    }

    @media (max-width: 480px) {
      .header-title { font-size: 1.1rem; }
      .admin-section { padding: 1.2rem; }
      .floating-logo img { max-height: 30px; }
    }

    /* Confirmation Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .modal-overlay.show .modal {
      transform: translateY(0);
    }
    
    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #2d3748;
    }
    
    .modal-message {
      margin-bottom: 1.5rem;
      color: #4a5568;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.8rem;
    }
    
    .modal-btn {
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .modal-btn-cancel {
      background: #f1f5f9;
      color: #64748b;
      border: none;
    }
    
    .modal-btn-cancel:hover {
      background: #e2e8f0;
    }
    
    .modal-btn-confirm {
      background: #3b82f6;
      color: white;
      border: none;
    }
    
    .modal-btn-confirm:hover {
      background: #2563eb;
    }
    
    /* Dark mode modal styles */
    body.dark .modal {
      background: #1e293b;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    body.dark .modal-title {
      color: #f1f5f9;
    }
    
    body.dark .modal-message {
      color: #94a3b8;
    }
    
    body.dark .modal-btn-cancel {
      background: #334155;
      color: #e2e8f0;
    }
    
    body.dark .modal-btn-cancel:hover {
      background: #475569;
    }
  </style>
</head>
<body class=""> 
  <div class="loading" id="loading">
    <div class="loading-circle"></div>
  </div>

  <header>
    <div class="header-title-area">
        <span class="header-title" id="header-title">Admin Dashboard</span>
    </div>
    
    <div class="account-wrapper" id="account-btn">
      <div class="account-icon" id="account-img">
          <i class="fas fa-user"></i>
      </div>
      <div class="account-dropdown" id="account-dropdown">
        <div id="not-logged-in">
          <a href="login.html"><i class="fas fa-sign-in-alt"></i> Log In</a>
          <a href="explore.html"><i class="fas fa-compass"></i> Explore Courses</a>
        </div>
        <div id="logged-in" style="display: none;">
          <div id="user-role-display" style="display: none;">
             <i class="fas fa-shield-halved"></i> <span id="role-text">Admin</span>
          </div>
          <a href="generaladmin.html" id="admin-panel-link" style="display: none;">
               <i class="fas fa-user-shield"></i> Admin Panel
           </a>
          <a href="profile.html" id="profile-link"><i class="fas fa-user-circle"></i> My Profile</a>
          <a href="dashboard.html"><i class="fas fa-book-open"></i> Enrollment</a>
          <a href="progress.html"><i class="fas fa-chart-line"></i> Progression</a>
          <a href="interact.html"><i class="fas fa-comments"></i> Interact</a>
          <a href="support.html"><i class="fas fa-headset"></i>help</a>
          <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </div>
  </header>

  <div class="admin-container">
    <aside class="admin-sidebar">
      <nav>
        <ul class="admin-nav">
          <li><a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
          <li><a href="#announcements"><i class="fas fa-bullhorn"></i> Announcements</a></li>
          <li><a href="#courses"><i class="fas fa-book"></i> Courses</a></li>
          <li><a href="#notifications"><i class="fas fa-bell"></i> Notifications</a></li>
          <li><a href="#users"><i class="fas fa-users"></i> Users</a></li>
          <li><a href="#settings"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
      </nav>
    </aside>

    <main class="admin-main">
      <!-- Dashboard Section -->
      <section id="dashboard" class="admin-section">
        <h2>Admin Dashboard</h2>
        <p>Welcome to the Haramaya Jama'aa Admin Panel. Use the sidebar to navigate to different sections.</p>
        
        <div class="admin-tabs">
          <div class="admin-tab active" data-tab="stats">Statistics</div>
          <div class="admin-tab" data-tab="recent">Recent Activity</div>
        </div>
        
        <div class="tab-content active" id="stats-tab">
          <div class="dashboard-widgets" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
            <div class="widget">
              <div class="widget-header">
                <div>
                  <h3 class="widget-title">Total Users</h3>
                  <p class="widget-description">Registered users</p>
                </div>
                <div class="widget-icon"><i class="fas fa-users"></i></div>
              </div>
              <div class="widget-value" id="total-users">0</div>
            </div>
            
            <div class="widget">
              <div class="widget-header">
                <div>
                  <h3 class="widget-title">Active Courses</h3>
                  <p class="widget-description">Available courses</p>
                </div>
                <div class="widget-icon"><i class="fas fa-book"></i></div>
              </div>
              <div class="widget-value" id="total-courses">0</div>
            </div>
            
            <div class="widget">
              <div class="widget-header">
                <div>
                  <h3 class="widget-title">Announcements</h3>
                  <p class="widget-description">This month</p>
                </div>
                <div class="widget-icon"><i class="fas fa-bullhorn"></i></div>
              </div>
              <div class="widget-value" id="month-announcements">0</div>
            </div>
            
            <div class="widget">
              <div class="widget-header">
                <div>
                  <h3 class="widget-title">Notifications</h3>
                  <p class="widget-description">Sent today</p>
                </div>
                <div class="widget-icon"><i class="fas fa-bell"></i></div>
              </div>
              <div class="widget-value" id="today-notifications">0</div>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="recent-tab">
          <h3>Recent Activity</h3>
          <table class="admin-table">
            <thead>
              <tr>
                <th>Action</th>
                <th>User</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="recent-activity">
              <tr>
                <td colspan="3">Loading recent activity...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Announcements Section -->
      <section id="announcements" class="admin-section" style="display: none;">
        <h2>Manage Announcements</h2>
        
        <div class="admin-tabs">
          <div class="admin-tab active" data-tab="create-announcement">Create Announcement</div>
          <div class="admin-tab" data-tab="view-announcements">View Announcements</div>
        </div>
        
        <div class="tab-content active" id="create-announcement-tab">
          <form id="announcement-form">
            <div class="form-group">
              <label for="announcement-title" class="form-label">Title</label>
              <input type="text" id="announcement-title" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="announcement-content" class="form-label">Content</label>
              <textarea id="announcement-content" class="form-control" required></textarea>
            </div>
            
            <div class="form-group">
              <label for="announcement-priority" class="form-label">Priority</label>
              <select id="announcement-priority" class="form-control">
                <option value="normal">Normal</option>
                <option value="important">Important</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
            
            <div class="form-group">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Publish Announcement
              </button>
            </div>
          </form>
        </div>
        
        <div class="tab-content" id="view-announcements-tab">
          <div class="form-group">
            <input type="text" id="announcement-search" class="form-control" placeholder="Search announcements...">
          </div>
          
          <table class="admin-table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Priority</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="announcements-list">
              <tr>
                <td colspan="4">Loading announcements...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Courses Section -->
      <section id="courses" class="admin-section" style="display: none;">
        <h2>Manage Courses</h2>
        
        <div class="admin-tabs">
          <div class="admin-tab active" data-tab="create-course">Create Course</div>
          <div class="admin-tab" data-tab="view-courses">View Courses</div>
        </div>
        
        <div class="tab-content active" id="create-course-tab">
          <form id="course-form">
            <div class="form-group">
              <label for="course-title" class="form-label">Course Title</label>
              <input type="text" id="course-title" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="course-code" class="form-label">Course Code</label>
              <input type="text" id="course-code" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="course-description" class="form-label">Description</label>
              <textarea id="course-description" class="form-control" required></textarea>
            </div>
            
            <div class="form-group">
              <label for="course-department" class="form-label">Department</label>
              <select id="course-department" class="form-control">
                <option value="pharmacy">Pharmacy</option>
                <option value="medicine">Medicine</option>
                <option value="nursing">Nursing</option>
                <option value="public_health">Public Health</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="course-instructor" class="form-label">Instructor</label>
              <input type="text" id="course-instructor" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="course-duration" class="form-label">Duration (weeks)</label>
              <input type="number" id="course-duration" class="form-control" min="1" value="12" required>
            </div>
            
            <div class="form-group">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Course
              </button>
            </div>
          </form>
        </div>
        
        <div class="tab-content" id="view-courses-tab">
          <div class="form-group">
            <input type="text" id="course-search" class="form-control" placeholder="Search courses...">
          </div>
          
          <table class="admin-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Title</th>
                <th>Department</th>
                <th>Instructor</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="courses-list">
              <tr>
                <td colspan="5">Loading courses...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Notifications Section -->
      <section id="notifications" class="admin-section" style="display: none;">
        <h2>Send Notifications</h2>
        
        <form id="notification-form">
          <div class="form-group">
            <label for="notification-title" class="form-label">Title</label>
            <input type="text" id="notification-title" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="notification-message" class="form-label">Message</label>
            <textarea id="notification-message" class="form-control" required></textarea>
          </div>
          
          <div class="form-group">
            <label for="notification-type" class="form-label">Notification Type</label>
            <select id="notification-type" class="form-control">
              <option value="info">Information</option>
              <option value="warning">Warning</option>
              <option value="alert">Alert</option>
              <option value="reminder">Reminder</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="notification-recipients" class="form-label">Recipients</label>
            <select id="notification-recipients" class="form-control" multiple>
              <option value="all">All Users</option>
              <option value="pharmacy">Pharmacy Students</option>
              <option value="medicine">Medicine Students</option>
              <option value="nursing">Nursing Students</option>
              <option value="public_health">Public Health Students</option>
              <option value="instructors">Instructors</option>
              <option value="admins">Admins</option>
            </select>
          </div>
          
          <div class="form-group">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i> Send Notification
            </button>
          </div>
        </form>
        
        <h3>Recent Notifications</h3>
        <table class="admin-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Type</th>
              <th>Recipients</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="notifications-list">
            <tr>
              <td colspan="4">Loading notifications...</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Users Section -->
      <section id="users" class="admin-section" style="display: none;">
        <h2>User Management</h2>
        
        <div class="form-group">
          <input type="text" id="user-search" class="form-control" placeholder="Search users...">
        </div>
        
        <table class="admin-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Department</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-list">
            <tr>
              <td colspan="6">Loading users...</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Settings Section -->
      <section id="settings" class="admin-section" style="display: none;">
        <h2>System Settings</h2>
        
        <form id="settings-form">
          <div class="form-group">
            <label for="system-name" class="form-label">System Name</label>
            <input type="text" id="system-name" class="form-control" value="Haramaya Jama'aa">
          </div>
          
          <div class="form-group">
            <label for="maintenance-mode" class="form-label">Maintenance Mode</label>
            <select id="maintenance-mode" class="form-control">
              <option value="false">Disabled</option>
              <option value="true">Enabled</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="registration-open" class="form-label">Course Registration</label>
            <select id="registration-open" class="form-control">
              <option value="true">Open</option>
              <option value="false">Closed</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="default-role" class="form-label">Default User Role</label>
            <select id="default-role" class="form-control">
              <option value="student">Student</option>
              <option value="instructor">Instructor</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          
          <div class="form-group">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Save Settings
            </button>
          </div>
        </form>
      </section>
    </main>
  </div>
  
  <footer>
      &copy; <span id="footer-year"></span> Haramaya Jama'aa Group. All Rights Reserved. | <a href="#top">Back to Top</a>
  </footer>

  <div class="floating-logo">
       <img src="haramaya.png" alt="Haramaya Logo">
  </div>

  <div class="theme-toggle" id="theme-toggle">
    <i class="fas fa-moon"></i>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmation-modal">
    <div class="modal">
      <div class="modal-title" id="modal-title">Confirm Action</div>
      <div class="modal-message" id="modal-message">Are you sure you want to perform this action?</div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" id="modal-cancel">Cancel</button>
        <button class="modal-btn modal-btn-confirm" id="modal-confirm">Confirm</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script type="module">
    // Firebase modules.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      collection, 
      query, 
      where, 
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      serverTimestamp,
      orderBy,
      limit,
      onSnapshot,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    // === YOUR PROVIDED FIREBASE CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyBQyNVWh1BtCkXlBfuS7jHAa36FTklZayo",
      authDomain: "pharma-quiz-b5a07.firebaseapp.com",
      databaseURL: "https://pharma-quiz-b5a07-default-rtdb.firebaseio.com",
      projectId: "pharma-quiz-b5a07",
      storageBucket: "pharma-quiz-b5a07.appspot.com",
      messagingSenderId: "161067776789",
      appId: "1:161067776789:web:88b8a61145dc5f5c31471c",
      measurementId: "G-3QRQE9HQFB"
    };
    // =====================================

    const app = initializeApp(firebaseConfig);
    let analytics;
    if (firebaseConfig.measurementId) {
        try {
             analytics = getAnalytics(app);
             console.log("Firebase Analytics initialized.");
        } catch (error) {
            console.warn("Could not initialize Firebase Analytics:", error);
        }
    }
    const auth = getAuth();
    const db = getFirestore(app);

    // --- Global Variables ---
    let currentUserRole = null;
    let currentUserId = null;
    let listeners = [];

    // --- DOM Elements ---
    const loadingScreen = document.getElementById('loading');
    const themeToggle = document.getElementById('theme-toggle');
    const accountBtn = document.getElementById("account-btn");
    const accountDropdown = document.getElementById("account-dropdown");
    const notLoggedInDiv = document.getElementById("not-logged-in");
    const loggedInDiv = document.getElementById("logged-in");
    const logoutBtn = document.getElementById("logout-btn");
    const profileLink = document.getElementById("profile-link");
    const userRoleDisplay = document.getElementById("user-role-display");
    const adminPanelLink = document.getElementById("admin-panel-link");
    const footerYear = document.getElementById("footer-year");
    
    // Admin sections
    const adminSections = document.querySelectorAll('.admin-section');
    const adminNavLinks = document.querySelectorAll('.admin-nav a');
    const adminTabs = document.querySelectorAll('.admin-tab');
    
    // Forms
    const announcementForm = document.getElementById('announcement-form');
    const courseForm = document.getElementById('course-form');
    const notificationForm = document.getElementById('notification-form');
    const settingsForm = document.getElementById('settings-form');
    
    // Modal
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalCancel = document.getElementById('modal-cancel');
    const modalConfirm = document.getElementById('modal-confirm');
    
    // Initialize Select2
    $(document).ready(function() {
      $('#notification-recipients').select2({
        placeholder: "Select recipients",
        allowClear: true
      });
    });

    // --- Initial Setup ---

    // Footer Year
    if (footerYear) {
        footerYear.textContent = new Date().getFullYear();
    }

    // Theme Persistence
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    // Function to apply theme
    const applyTheme = (theme) => {
        if (theme === 'dark') {
            document.body.classList.add('dark');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            localStorage.setItem('theme', 'dark');
        } else {
            document.body.classList.remove('dark');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            localStorage.setItem('theme', 'light');
        }
        createParticles();
    };

    // Set initial theme based on saved preference or system preference
    if (savedTheme) {
        applyTheme(savedTheme);
    } else {
        applyTheme(prefersDark ? 'dark' : 'light');
    }

    // Hide loading screen
    setTimeout(() => {
      if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        loadingScreen.style.visibility = 'hidden';
        loadingScreen.style.pointerEvents = 'none';
      }
    }, 800);

    // Create floating particles
    function createParticles() {
        const colorsLight = ['rgba(102, 166, 255, 0.1)', 'rgba(137, 247, 254, 0.1)', 'rgba(99, 102, 241, 0.1)'];
        const colorsDark = ['rgba(167, 139, 250, 0.06)', 'rgba(96, 165, 250, 0.06)', 'rgba(56, 189, 248, 0.06)'];
        const isDark = document.body.classList.contains('dark');
        const colors = isDark ? colorsDark : colorsLight;

        document.querySelectorAll('.particle').forEach(p => p.remove());
        const particleContainer = document.body;

        for (let i = 0; i < 12; i++) {
            const particle = document.createElement('div');
            particle.classList.add('particle');

            const size = Math.random() * 6 + 3;
            const startX = Math.random() * 100;
            const duration = Math.random() * 25 + 20;
            const delay = Math.random() * 15;

            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${startX}vw`;
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            particle.style.animation = `particleFloat ${duration}s linear ${delay}s infinite`;
            particle.style.bottom = `-${size}px`;

            particleContainer.appendChild(particle);
        }
    }

    // Theme toggle functionality
    themeToggle.addEventListener('click', () => {
        const isDark = document.body.classList.contains('dark');
        applyTheme(isDark ? 'light' : 'dark');
    });

    // Initialize particles on load
    createParticles();

    /* ACCOUNT DROPDOWN */
    accountBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isDisplayed = accountDropdown.style.display === "block";
      accountDropdown.style.display = isDisplayed ? "none" : "block";
    });

    document.addEventListener("click", (e) => {
      if (accountDropdown && accountBtn && !accountBtn.contains(e.target) && !accountDropdown.contains(e.target)) {
        accountDropdown.style.display = "none";
      }
    });

    /* AUTHENTICATION */
    onAuthStateChanged(auth, (user) => {
        if(profileLink) profileLink.href = "profile.html";
        if(userRoleDisplay) userRoleDisplay.style.display = "none";
        if(adminPanelLink) adminPanelLink.style.display = "none";

      if (user) {
        currentUserId = user.uid;
        if(loggedInDiv) loggedInDiv.style.display = "block";
        if(notLoggedInDiv) notLoggedInDiv.style.display = "none";
        loadUserData(user.uid);
      } else {
        currentUserId = null;
        if(loggedInDiv) loggedInDiv.style.display = "none";
        if(notLoggedInDiv) notLoggedInDiv.style.display = "block";
        currentUserRole = null;
        
        // Clean up listeners when user logs out
        listeners.forEach(unsubscribe => unsubscribe());
        listeners = [];
        
        // Redirect to login if not authenticated
        window.location.href = "login.html";
      }
       if(accountDropdown) accountDropdown.style.display = "none";
    });

    /* Load User Data from Firestore */
    async function loadUserData(userId) {
      try {
        const userDocRef = doc(db, "users", userId);
        const userDocSnap = await getDoc(userDocRef);

        if (userDocSnap.exists()) {
          const userData = userDocSnap.data();

          // --- ROLE HANDLING ---
          currentUserRole = userData.role || 'user';

          if (currentUserRole === 'admin') {
            if(profileLink) profileLink.href = "admin.html";
            if(userRoleDisplay) userRoleDisplay.style.display = "flex";
            if(adminPanelLink) adminPanelLink.style.display = "flex";
            
            // Initialize admin features
            initAdminDashboard();
            
            if (!sessionStorage.getItem('adminNotified')) {
              showModal('Welcome, Admin!', 'You have successfully accessed the admin dashboard with full privileges.');
              sessionStorage.setItem('adminNotified', 'true');
            }
          } else {
            // Non-admin users shouldn't be here - redirect to home
            window.location.href = "index.html";
          }
        } else {
          console.warn("User document not found in Firestore for UID:", userId);
          window.location.href = "index.html";
        }
      } catch (error) {
        console.error("Error loading user data:", error);
        window.location.href = "index.html";
      }
    }
    
    /* ADMIN DASHBOARD FUNCTIONS */
    function initAdminDashboard() {
      // Navigation
      setupNavigation();
      
      // Tabs
      setupTabs();
      
      // Forms
      setupForms();
      
      // Load initial data
      loadDashboardStats();
      loadAnnouncements();
      loadCourses();
      loadNotifications();
      loadUsers();
      loadSettings();
    }
    
    function setupNavigation() {
      adminNavLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Hide all sections
          adminSections.forEach(section => {
            section.style.display = 'none';
          });
          
          // Show selected section
          const sectionId = link.getAttribute('href').substring(1);
          document.getElementById(sectionId).style.display = 'block';
          
          // Update active nav link
          adminNavLinks.forEach(navLink => {
            navLink.classList.remove('active');
          });
          link.classList.add('active');
        });
      });
    }
    
    function setupTabs() {
      adminTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          const tabContainer = tab.closest('.admin-tabs');
          const contentContainer = tabContainer.nextElementSibling;
          
          // Update active tab
          tabContainer.querySelectorAll('.admin-tab').forEach(t => {
            t.classList.remove('active');
          });
          tab.classList.add('active');
          
          // Show corresponding content
          contentContainer.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`${tabId}-tab`).classList.add('active');
        });
      });
    }
    
    function setupForms() {
      // Announcement Form
      if (announcementForm) {
        announcementForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const title = document.getElementById('announcement-title').value;
          const content = document.getElementById('announcement-content').value;
          const priority = document.getElementById('announcement-priority').value;
          
          try {
            await addDoc(collection(db, 'announcements'), {
              title,
              content,
              priority,
              authorId: currentUserId,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
              keywords: generateKeywords(title + ' ' + content)
            });
            
            showModal('Success', 'Announcement published successfully!');
            announcementForm.reset();
            loadAnnouncements();
          } catch (error) {
            console.error('Error publishing announcement:', error);
            showModal('Error', 'Failed to publish announcement. Please try again.');
          }
        });
      }
      
      // Course Form
      if (courseForm) {
        courseForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const title = document.getElementById('course-title').value;
          const code = document.getElementById('course-code').value;
          const description = document.getElementById('course-description').value;
          const department = document.getElementById('course-department').value;
          const instructor = document.getElementById('course-instructor').value;
          const duration = document.getElementById('course-duration').value;
          
          try {
            await addDoc(collection(db, 'courses'), {
              title,
              code,
              description,
              department,
              instructor,
              duration: parseInt(duration),
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
              keywords: generateKeywords(title + ' ' + code + ' ' + description)
            });
            
            showModal('Success', 'Course created successfully!');
            courseForm.reset();
            loadCourses();
          } catch (error) {
            console.error('Error creating course:', error);
            showModal('Error', 'Failed to create course. Please try again.');
          }
        });
      }
      
      // Notification Form
      if (notificationForm) {
        notificationForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const title = document.getElementById('notification-title').value;
          const message = document.getElementById('notification-message').value;
          const type = document.getElementById('notification-type').value;
          const recipients = Array.from(document.getElementById('notification-recipients').selectedOptions)
            .map(option => option.value);
          
          if (recipients.length === 0) {
            showModal('Error', 'Please select at least one recipient.');
            return;
          }
          
          try {
            // Get users to notify based on selection
            let usersQuery;
            if (recipients.includes('all')) {
              usersQuery = query(collection(db, 'users'));
            } else {
              usersQuery = query(collection(db, 'users'), where('department', 'in', recipients));
            }
            
            const usersSnapshot = await getDocs(usersQuery);
            const batch = writeBatch(db);
            
            usersSnapshot.forEach(userDoc => {
              const notificationRef = doc(collection(db, `users/${userDoc.id}/notifications`));
              batch.set(notificationRef, {
                title,
                message,
                type,
                read: false,
                createdAt: serverTimestamp()
              });
            });
            
            await batch.commit();
            
            // Save notification record
            await addDoc(collection(db, 'notifications'), {
              title,
              message,
              type,
              recipients,
              sentBy: currentUserId,
              sentAt: serverTimestamp(),
              userCount: usersSnapshot.size
            });
            
            showModal('Success', `Notification sent to ${usersSnapshot.size} users!`);
            notificationForm.reset();
            $('#notification-recipients').val(null).trigger('change');
            loadNotifications();
          } catch (error) {
            console.error('Error sending notifications:', error);
            showModal('Error', 'Failed to send notifications. Please try again.');
          }
        });
      }
      
      // Settings Form
      if (settingsForm) {
        settingsForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const systemName = document.getElementById('system-name').value;
          const maintenanceMode = document.getElementById('maintenance-mode').value === 'true';
          const registrationOpen = document.getElementById('registration-open').value === 'true';
          const defaultRole = document.getElementById('default-role').value;
          
          try {
            await updateDoc(doc(db, 'system/settings'), {
              systemName,
              maintenanceMode,
              registrationOpen,
              defaultRole,
              updatedAt: serverTimestamp(),
              updatedBy: currentUserId
            });
            
            showModal('Success', 'Settings updated successfully!');
          } catch (error) {
            console.error('Error updating settings:', error);
            showModal('Error', 'Failed to update settings. Please try again.');
          }
        });
      }
    }
    
    function generateKeywords(text) {
      const words = text.toLowerCase().split(/\s+/);
      const uniqueWords = [...new Set(words)];
      return uniqueWords.filter(word => word.length > 2);
    }
    
    /* DATA LOADING FUNCTIONS */
    async function loadDashboardStats() {
      try {
        // Total users
        const usersQuery = query(collection(db, 'users'));
        const usersSnapshot = await getDocs(usersQuery);
        document.getElementById('total-users').textContent = usersSnapshot.size;
        
        // Total courses
        const coursesQuery = query(collection(db, 'courses'));
        const coursesSnapshot = await getDocs(coursesQuery);
        document.getElementById('total-courses').textContent = coursesSnapshot.size;
        
        // This month's announcements
        const monthAgo = new Date();
        monthAgo.setMonth(monthAgo.getMonth() - 1);
        
        const announcementsQuery = query(
          collection(db, 'announcements'),
          where('createdAt', '>=', monthAgo)
        );
        const announcementsSnapshot = await getDocs(announcementsQuery);
        document.getElementById('month-announcements').textContent = announcementsSnapshot.size;
        
        // Today's notifications
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const notificationsQuery = query(
          collection(db, 'notifications'),
          where('sentAt', '>=', today)
        );
        const notificationsSnapshot = await getDocs(notificationsQuery);
        document.getElementById('today-notifications').textContent = notificationsSnapshot.size;
        
        // Recent activity
        const activityQuery = query(
          collection(db, 'activity'),
          orderBy('timestamp', 'desc'),
          limit(10)
        );
        
        const unsubscribe = onSnapshot(activityQuery, (snapshot) => {
          const activityList = document.getElementById('recent-activity');
          activityList.innerHTML = '';
          
          snapshot.forEach(doc => {
            const activity = doc.data();
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${activity.action}</td>
              <td>${activity.userName || 'System'}</td>
              <td>${formatTime(activity.timestamp?.toDate())}</td>
            `;
            
            activityList.appendChild(row);
          });
        });
        
        listeners.push(unsubscribe);
      } catch (error) {
        console.error('Error loading dashboard stats:', error);
      }
    }
    
    async function loadAnnouncements() {
      try {
        const announcementsQuery = query(
          collection(db, 'announcements'),
          orderBy('createdAt', 'desc')
        );
        
        const unsubscribe = onSnapshot(announcementsQuery, (snapshot) => {
          const announcementsList = document.getElementById('announcements-list');
          announcementsList.innerHTML = '';
          
          snapshot.forEach(doc => {
            const announcement = doc.data();
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${announcement.title}</td>
              <td><span class="badge ${getPriorityBadgeClass(announcement.priority)}">${announcement.priority}</span></td>
              <td>${formatDate(announcement.createdAt?.toDate())}</td>
              <td class="table-actions">
                <button class="btn btn-secondary btn-sm" data-id="${doc.id}" data-action="edit-announcement">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" data-id="${doc.id}" data-action="delete-announcement">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            `;
            
            announcementsList.appendChild(row);
          });
          
          // Add event listeners to action buttons
          document.querySelectorAll('[data-action="edit-announcement"]').forEach(btn => {
            btn.addEventListener('click', () => editAnnouncement(btn.dataset.id));
          });
          
          document.querySelectorAll('[data-action="delete-announcement"]').forEach(btn => {
            btn.addEventListener('click', () => confirmDeleteAnnouncement(btn.dataset.id));
          });
        });
        
        listeners.push(unsubscribe);
      } catch (error) {
        console.error('Error loading announcements:', error);
      }
    }
    
    async function loadCourses() {
      try {
        const coursesQuery = query(
          collection(db, 'courses'),
          orderBy('title')
        );
        
        const unsubscribe = onSnapshot(coursesQuery, (snapshot) => {
          const coursesList = document.getElementById('courses-list');
          coursesList.innerHTML = '';
          
          snapshot.forEach(doc => {
            const course = doc.data();
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${course.code}</td>
              <td>${course.title}</td>
              <td>${formatDepartment(course.department)}</td>
              <td>${course.instructor}</td>
              <td class="table-actions">
                <button class="btn btn-secondary btn-sm" data-id="${doc.id}" data-action="edit-course">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" data-id="${doc.id}" data-action="delete-course">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            `;
            
            coursesList.appendChild(row);
          });
          
          // Add event listeners to action buttons
          document.querySelectorAll('[data-action="edit-course"]').forEach(btn => {
            btn.addEventListener('click', () => editCourse(btn.dataset.id));
          });
          
          document.querySelectorAll('[data-action="delete-course"]').forEach(btn => {
            btn.addEventListener('click', () => confirmDeleteCourse(btn.dataset.id));
          });
        });
        
        listeners.push(unsubscribe);
      } catch (error) {
        console.error('Error loading courses:', error);
      }
    }
    
    async function loadNotifications() {
      try {
        const notificationsQuery = query(
          collection(db, 'notifications'),
          orderBy('sentAt', 'desc'),
          limit(10)
        );
        
        const unsubscribe = onSnapshot(notificationsQuery, (snapshot) => {
          const notificationsList = document.getElementById('notifications-list');
          notificationsList.innerHTML = '';
          
          snapshot.forEach(doc => {
            const notification = doc.data();
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${notification.title}</td>
              <td><span class="badge ${getTypeBadgeClass(notification.type)}">${notification.type}</span></td>
              <td>${formatRecipients(notification.recipients)}</td>
              <td>${formatTime(notification.sentAt?.toDate())}</td>
            `;
            
            notificationsList.appendChild(row);
          });
        });
        
        listeners.push(unsubscribe);
      } catch (error) {
        console.error('Error loading notifications:', error);
      }
    }
    
    async function loadUsers() {
      try {
        const usersQuery = query(
          collection(db, 'users'),
          orderBy('displayName')
        );
        
        const unsubscribe = onSnapshot(usersQuery, (snapshot) => {
          const usersList = document.getElementById('users-list');
          usersList.innerHTML = '';
          
          snapshot.forEach(doc => {
            const user = doc.data();
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${user.displayName || 'No name'}</td>
              <td>${user.email}</td>
              <td>${formatRole(user.role)}</td>
              <td>${formatDepartment(user.department)}</td>
              <td><span class="badge ${user.disabled ? 'badge-danger' : 'badge-success'}">${user.disabled ? 'Disabled' : 'Active'}</span></td>
              <td class="table-actions">
                <button class="btn btn-secondary btn-sm" data-id="${doc.id}" data-action="edit-user">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn ${user.disabled ? 'btn-success' : 'btn-warning'} btn-sm" data-id="${doc.id}" data-action="toggle-user">
                  <i class="fas ${user.disabled ? 'fa-check' : 'fa-ban'}"></i>
                </button>
              </td>
            `;
            
            usersList.appendChild(row);
          });
          
          // Add event listeners to action buttons
          document.querySelectorAll('[data-action="edit-user"]').forEach(btn => {
            btn.addEventListener('click', () => editUser(btn.dataset.id));
          });
          
          document.querySelectorAll('[data-action="toggle-user"]').forEach(btn => {
            btn.addEventListener('click', () => toggleUserStatus(btn.dataset.id));
          });
        });
        
        listeners.push(unsubscribe);
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }
    
    async function loadSettings() {
      try {
        const settingsDoc = await getDoc(doc(db, 'system/settings'));
        
        if (settingsDoc.exists()) {
          const settings = settingsDoc.data();
          document.getElementById('system-name').value = settings.systemName || 'Haramaya Jama\'aa';
          document.getElementById('maintenance-mode').value = settings.maintenanceMode ? 'true' : 'false';
          document.getElementById('registration-open').value = settings.registrationOpen ? 'true' : 'false';
          document.getElementById('default-role').value = settings.defaultRole || 'student';
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }
    
    /* CRUD OPERATIONS */
    async function editAnnouncement(id) {
      try {
        const announcementDoc = await getDoc(doc(db, 'announcements', id));
        
        if (announcementDoc.exists()) {
          const announcement = announcementDoc.data();
          
          // Fill form
          document.getElementById('announcement-title').value = announcement.title;
          document.getElementById('announcement-content').value = announcement.content;
          document.getElementById('announcement-priority').value = announcement.priority;
          
          // Switch to create tab
          document.querySelector('[data-tab="create-announcement"]').click();
          
          // TODO: Update form to handle edits
          showModal('Edit Mode', 'Announcement loaded for editing. (Note: Edit functionality not fully implemented in this example)');
        }
      } catch (error) {
        console.error('Error loading announcement for edit:', error);
        showModal('Error', 'Failed to load announcement for editing.');
      }
    }
    
    async function confirmDeleteAnnouncement(id) {
      showModal(
        'Confirm Delete', 
        'Are you sure you want to delete this announcement? This action cannot be undone.',
        async () => {
          try {
            await deleteDoc(doc(db, 'announcements', id));
            showModal('Success', 'Announcement deleted successfully!');
          } catch (error) {
            console.error('Error deleting announcement:', error);
            showModal('Error', 'Failed to delete announcement.');
          }
        }
      );
    }
    
    async function editCourse(id) {
      try {
        const courseDoc = await getDoc(doc(db, 'courses', id));
        
        if (courseDoc.exists()) {
          const course = courseDoc.data();
          
          // Fill form
          document.getElementById('course-title').value = course.title;
          document.getElementById('course-code').value = course.code;
          document.getElementById('course-description').value = course.description;
          document.getElementById('course-department').value = course.department;
          document.getElementById('course-instructor').value = course.instructor;
          document.getElementById('course-duration').value = course.duration;
          
          // Switch to create tab
          document.querySelector('[data-tab="create-course"]').click();
          
          // TODO: Update form to handle edits
          showModal('Edit Mode', 'Course loaded for editing. (Note: Edit functionality not fully implemented in this example)');
        }
      } catch (error) {
        console.error('Error loading course for edit:', error);
        showModal('Error', 'Failed to load course for editing.');
      }
    }
    
    async function confirmDeleteCourse(id) {
      showModal(
        'Confirm Delete', 
        'Are you sure you want to delete this course? This action cannot be undone.',
        async () => {
          try {
            await deleteDoc(doc(db, 'courses', id));
            showModal('Success', 'Course deleted successfully!');
          } catch (error) {
            console.error('Error deleting course:', error);
            showModal('Error', 'Failed to delete course.');
          }
        }
      );
    }
    
    async function editUser(id) {
      showModal('Info', 'User edit functionality would be implemented here.');
    }
    
    async function toggleUserStatus(id) {
      try {
        const userDoc = await getDoc(doc(db, 'users', id));
        
        if (userDoc.exists()) {
          const currentStatus = userDoc.data().disabled || false;
          
          await updateDoc(doc(db, 'users', id), {
            disabled: !currentStatus,
            updatedAt: serverTimestamp()
          });
          
          showModal('Success', `User ${!currentStatus ? 'disabled' : 'enabled'} successfully!`);
        }
      } catch (error) {
        console.error('Error toggling user status:', error);
        showModal('Error', 'Failed to update user status.');
      }
    }
    
    /* UTILITY FUNCTIONS */
    function formatDate(date) {
      if (!date) return 'N/A';
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }
    
    function formatTime(date) {
      if (!date) return 'Just now';
      
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) return 'Just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
      return `${Math.floor(diffInSeconds / 86400)} days ago`;
    }
    
    function formatDepartment(dept) {
      if (!dept) return 'N/A';
      
      const departmentNames = {
        'pharmacy': 'Pharmacy',
        'medicine': 'Medicine',
        'nursing': 'Nursing',
        'public_health': 'Public Health'
      };
      
      return departmentNames[dept] || dept;
    }
    
    function formatRole(role) {
      if (!role) return 'Student';
      
      const roleNames = {
        'student': 'Student',
        'instructor': 'Instructor',
        'admin': 'Admin'
      };
      
      return roleNames[role] || role;
    }
    
    function formatRecipients(recipients) {
      if (!recipients || recipients.length === 0) return 'None';
      if (recipients.includes('all')) return 'All Users';
      
      const recipientNames = {
        'pharmacy': 'Pharmacy',
        'medicine': 'Medicine',
        'nursing': 'Nursing',
        'public_health': 'Public Health',
        'instructors': 'Instructors',
        'admins': 'Admins'
      };
      
      return recipients.map(r => recipientNames[r] || r).join(', ');
    }
    
    function getPriorityBadgeClass(priority) {
      const badgeClasses = {
        'normal': 'badge-secondary',
        'important': 'badge-warning',
        'urgent': 'badge-danger'
      };
      
      return badgeClasses[priority] || 'badge-secondary';
    }
    
    function getTypeBadgeClass(type) {
      const badgeClasses = {
        'info': 'badge-info',
        'warning': 'badge-warning',
        'alert': 'badge-danger',
        'reminder': 'badge-primary'
      };
      
      return badgeClasses[type] || 'badge-secondary';
    }
    
    function showModal(title, message, confirmCallback = null) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      
      // Store the callback
      if (confirmCallback) {
        modalConfirm.onclick = () => {
          confirmCallback();
          confirmationModal.classList.remove('show');
        };
      } else {
        modalConfirm.onclick = () => {
          confirmationModal.classList.remove('show');
        };
      }
      
      confirmationModal.classList.add('show');
    }
    
    /* LOGOUT FUNCTION */
    async function handleLogout() {
      try {
          await signOut(auth);
          console.log("Logout successful");
          sessionStorage.removeItem('adminNotified');
      } catch (error) {
          console.error("Logout failed:", error);
          showModal("Error", "Logout failed. Please try again.");
      }
    }
    
    // Show logout confirmation modal
    if(logoutBtn) logoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      showModal(
        "Confirm Logout", 
        "Are you sure you want to log out?",
        handleLogout
      );
    });
    
    // Modal cancel button
    if (modalCancel) {
      modalCancel.addEventListener('click', () => {
        confirmationModal.classList.remove('show');
      });
    }
  </script>
</body>
</html>
